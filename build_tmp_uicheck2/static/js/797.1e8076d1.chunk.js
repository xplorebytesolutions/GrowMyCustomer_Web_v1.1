/*! For license information please see 797.1e8076d1.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkxbytechat_ui=self.webpackChunkxbytechat_ui||[]).push([[797],{29792:(e,t,n)=>{n.d(t,{A:()=>m});var l=n(65043),s=n(35713),i=n(69008),a=n(60069),o=n(79378),r=n(57488),d=n(35870);const c="signalr-realtime-failed";function u(e){const t=String((null===e||void 0===e?void 0:e.name)||""),n=String((null===e||void 0===e?void 0:e.message)||e||"").toLowerCase();return"AbortError"===t||n.includes("stopped during negotiation")||n.includes("abort")||n.includes("canceled")||n.includes("cancelled")}function m(){let{onMessageReceived:e,onUnreadChanged:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const[n,m]=(0,l.useState)(null),[v,g]=(0,l.useState)(!1),x=(0,l.useRef)(null),h=(0,l.useRef)(!1),p=(0,l.useRef)(!1);return(0,l.useEffect)((()=>{h.current=!0;const n=function(){const e=("https://api.xplorebyte.com/api".trim()||"http://localhost:7113/api").replace(/\/+$/,"");return"".concat(e,"/hubs/inbox")}();if(!localStorage.getItem(d.TOKEN_KEY))return console.warn("SignalR skipped: No auth token found."),g(!1),()=>{h.current=!1};let l=n;const v=localStorage.getItem("sa_selectedBusinessId");v&&(l+="?bizId=".concat(encodeURIComponent(v)));const f=(new s.$).withUrl(l,{accessTokenFactory:()=>localStorage.getItem(d.TOKEN_KEY)||"",transport:i.w.WebSockets|i.w.LongPolling}).withAutomaticReconnect([0,2e3,5e3,1e4]).configureLogging(a.$.Information).build();x.current=f,m(f),e&&f.on("ReceiveInboxMessage",e),t&&f.on("UnreadCountChanged",t),f.onreconnecting((()=>{h.current&&g(!1)})),f.onreconnected((()=>{h.current&&(g(!0),r.oR.dismiss(c))})),f.onclose((e=>{h.current&&(g(!1),u(e)||r.oR.error("Real-time connection failed.",{toastId:c}))}));return(async()=>{if(!p.current){p.current=!0;try{if(await f.start(),!h.current)return;g(!0),r.oR.dismiss(c),console.log("\u2705 SignalR connected:",l)}catch(e){if(!h.current)return;if(u(e))return;g(!1);const t=String((null===e||void 0===e?void 0:e.message)||e||"").toLowerCase();t.includes("401")||t.includes("unauthorized")?r.oR.error("SignalR unauthorized. Your session may have expired.",{toastId:c}):r.oR.error("Real-time connection failed.",{toastId:c}),console.error("\u274c SignalR start failed:",e)}finally{p.current=!1}}})(),()=>{h.current=!1;try{e&&f.off("ReceiveInboxMessage",e),t&&f.off("UnreadCountChanged",t)}catch(n){}f&&f.state!==o.j.Disconnected&&f.stop().catch((()=>{}))}}),[e,t]),{connection:n,isConnected:v}}},35327:(e,t,n)=>{n.d(t,{A:()=>l});const l=(0,n(77784).A)("mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]])},80797:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Ee});var l=n(89379),s=n(65043),i=n(73216),a=n(57488),o=n(29792);const r=n(35870).default;function d(e){var t,n,l,s,i,a,o,r,d,c,u,m,v,g;if(!e)return!1;const x=null!==(t=null!==(n=null!==(l=null!==(s=null!==(i=null!==(a=e.isInbound)&&void 0!==a?a:e.IsInbound)&&void 0!==i?i:e.isIncoming)&&void 0!==s?s:e.IsIncoming)&&void 0!==l?l:e.inbound)&&void 0!==n?n:e.Inbound)&&void 0!==t?t:null;if("boolean"===typeof x)return x;if("string"===typeof x){const e=x.toLowerCase().trim();if("true"===e)return!0;if("false"===e)return!1}const h=null!==(o=null!==(r=null!==(d=null!==(c=null!==(u=null!==(m=e.direction)&&void 0!==m?m:e.Direction)&&void 0!==u?u:e.dir)&&void 0!==c?c:e.messageDirection)&&void 0!==d?d:e.messageDir)&&void 0!==r?r:e.DirectionType)&&void 0!==o?o:"",p=null!==(v=null!==(g=e.status)&&void 0!==g?g:e.deliveryStatus)&&void 0!==v?v:"",f=String(h).toLowerCase().trim(),b=String(p).toLowerCase().trim();return"in"===f||"inbound"===f||"incoming"===f||"received"===f||"customer"===f||"from"===f||f.startsWith("in")||"received"===b||"incoming"===b}function c(e){if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString()}function u(e){if(!e)return"-";const t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}function m(e,t){var n,l;return null!==(n=null===(l=(e||t||"?").trim()[0])||void 0===l?void 0:l.toUpperCase())&&void 0!==n?n:"?"}function v(e){if(!e||Number.isNaN(e.getTime()))return"";const t=new Date,n=t.toDateString(),l=new Date;l.setDate(t.getDate()-1);const s=l.toDateString(),i=e.toDateString();return i===n?"Today":i===s?"Yesterday":e.toLocaleDateString(void 0,{day:"2-digit",month:"short",year:"numeric"})}function g(e){const t=String(null!==e&&void 0!==e?e:"").trim().toLowerCase();return"pending"===t?"Pending":"closed"===t?"Closed":"Open"}const x=e=>{var t,n,l,s,i,a;if(Array.isArray(e))return{items:e,nextCursor:null,hasMore:!1};const o=null!==(t=null!==(n=null===e||void 0===e?void 0:e.items)&&void 0!==n?n:null===e||void 0===e?void 0:e.Items)&&void 0!==t?t:[],r=null!==(l=null!==(s=null===e||void 0===e?void 0:e.nextCursor)&&void 0!==s?s:null===e||void 0===e?void 0:e.NextCursor)&&void 0!==l?l:null,d=null!==(i=null!==(a=null===e||void 0===e?void 0:e.hasMore)&&void 0!==a?a:null===e||void 0===e?void 0:e.HasMore)&&void 0!==i?i:null!==r&&""!==r;return{items:Array.isArray(o)?o:[],nextCursor:r||null,hasMore:Boolean(d)}},h=50,p=50,f=10485760,b=new Set(["image/jpeg","image/png","image/webp","application/pdf","video/mp4","video/3gpp","audio/mpeg","audio/mp4","audio/aac","audio/ogg"]),y=e=>{const t=String(e||"").split(";")[0].toLowerCase().trim();return"application/pdf"===t?"document":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":"image"},w=e=>{if(null===e||void 0===e)return null;if("string"===typeof e&&""===e.trim())return null;const t=Number(e);return Number.isFinite(t)?t:null},N=e=>{const t=w(e);return null!==t&&t>=-90&&t<=90?t:null},j=e=>{const t=w(e);return null!==t&&t>=-180&&t<=180?t:null},I=e=>"/chat-inbox/media/".concat(encodeURIComponent(String(e||"").trim()),"/content"),S=e=>"chatInbox:activeTab:".concat(e||"global"),A=new Set(["live","unassigned","my","closed","history"]),C=()=>{try{const e=localStorage.getItem("businessId"),t=localStorage.getItem(S(e))||localStorage.getItem(S("global")),n=String(t||"").trim();return A.has(n)?n:null}catch(e){return null}};function R(){var e,t,u,m,w,A,R,M;const k=(0,i.Zp)(),{connection:T,isConnected:L}=(0,o.A)(),[P,D]=(0,s.useState)((()=>C()||"live")),[U,E]=(0,s.useState)("all"),[F,O]=(0,s.useState)("");(0,s.useEffect)((()=>{try{const e=localStorage.getItem("businessId");localStorage.setItem(S("global"),P),e&&localStorage.setItem(S(e),P)}catch(e){}}),[P]);const[W,B]=(0,s.useState)([]),[q,z]=(0,s.useState)(!1),[_,V]=(0,s.useState)(null),[K,H]=(0,s.useState)(!1),[Q,Y]=(0,s.useState)(!1),[G,$]=(0,s.useState)(null),[X,Z]=(0,s.useState)(""),[J,ee]=(0,s.useState)([]),[te,ne]=(0,s.useState)(!1),[le,se]=(0,s.useState)(null),[ie,ae]=(0,s.useState)(!1),[oe,re]=(0,s.useState)(!1),[de,ce]=(0,s.useState)(!1),[ue,me]=(0,s.useState)(!1),[ve,ge]=(0,s.useState)(!1),[xe,he]=(0,s.useState)(!1),[pe,fe]=(0,s.useState)([]),[be,ye]=(0,s.useState)(!1),[we,Ne]=(0,s.useState)(null),[je,Ie]=(0,s.useState)(!1),[Se,Ae]=(0,s.useState)(""),[Ce,Re]=(0,s.useState)(!1),[Me,ke]=(0,s.useState)(""),[Te,Le]=(0,s.useState)(""),[Pe,De]=(0,s.useState)(""),[Ue,Ee]=(0,s.useState)(!1),[Fe,Oe]=(0,s.useState)(null),[We,Be]=(0,s.useState)(""),[qe,ze]=(0,s.useState)(!1),[_e,Ve]=(0,s.useState)(null),[Ke,He]=(0,s.useState)(""),[Qe,Ye]=(0,s.useState)(""),[Ge,$e]=(0,s.useState)(""),[Xe,Ze]=(0,s.useState)(!1),[Je,et]=(0,s.useState)({open:!1,type:null,id:null,title:""}),[tt,nt]=(0,s.useState)(!1),[lt,st]=(0,s.useState)(!1),[it,at]=(0,s.useState)(null),[ot,rt]=(0,s.useState)(!0),[dt,ct]=(0,s.useState)((()=>{try{const e=localStorage.getItem("chatInbox:showDetails");return null===e||"true"===e}catch(e){return!0}}));(0,s.useEffect)((()=>{try{localStorage.setItem("chatInbox:showDetails",String(dt))}catch(e){}}),[dt]);const[ut,mt]=(0,s.useState)(!0),[vt,gt]=(0,s.useState)(!0),xt=(0,s.useRef)(null),ht=(0,s.useRef)(null),pt=(0,s.useRef)(new Map),ft=(0,s.useRef)(new Map),bt=(0,s.useRef)(null),yt=(0,s.useRef)(0),wt=(0,s.useRef)(null),Nt=(0,s.useRef)(null),jt=(0,s.useRef)(new Map),It=(0,s.useRef)(new Map),St=(0,s.useRef)(new Map),At=(0,s.useRef)(new Map),[Ct,Rt]=(0,s.useState)({}),[Mt,kt]=(0,s.useState)({}),[Tt,Lt]=(0,s.useState)({open:!1,type:null,mediaId:null,url:null,fileName:null,items:null,index:0,loading:!1}),Pt=(0,s.useRef)(J),Dt=(0,s.useRef)(Tt),Ut=(0,s.useRef)(new Map),Et=(0,s.useRef)(null),Ft=(0,s.useRef)(null),Ot=(0,s.useRef)(G),Wt=(0,s.useRef)(_),Bt=(0,s.useRef)(K),qt=(0,s.useRef)(Q),zt=(0,s.useRef)(le),_t=(0,s.useRef)(ie),Vt=(0,s.useRef)(oe);(0,s.useEffect)((()=>()=>{for(const n of jt.current.values())try{URL.revokeObjectURL(n)}catch(e){}for(const n of At.current.values())try{URL.revokeObjectURL(n)}catch(t){}jt.current.clear(),It.current.clear(),St.current.clear(),At.current.clear(),Ut.current.clear()}),[]),(0,s.useEffect)((()=>{Pt.current=J}),[J]),(0,s.useEffect)((()=>{Dt.current=Tt}),[Tt]);const Kt=(0,s.useCallback)(((e,t)=>{const n=String(e||"").trim();if(!n||!t)return;const s=jt.current.get(n);if(s&&s!==t)try{URL.revokeObjectURL(s)}catch(i){}jt.current.set(n,t),Rt((e=>(0,l.A)((0,l.A)({},e),{},{[n]:t})))}),[]),Ht=(0,s.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=String(e||"").trim();if(!n)return null;const l=St.current.get(n);if(l)return l;const s=Boolean(null===t||void 0===t?void 0:t.silent),i=r.get(I(n),{responseType:"blob",__silentToast:!0}).then((e=>(null===e||void 0===e?void 0:e.data)||null)).catch((e=>{var t,n;(console.error("Failed to fetch media content:",e),s)||a.oR.error((null===(t=e.response)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.message)||"Failed to load media preview. Please retry.");return null})).finally((()=>{St.current.delete(n)}));return St.current.set(n,i),i}),[]),Qt=(0,s.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=String(e||"").trim();if(!n)return null;const l=jt.current.get(n);if(l)return l;const s=It.current.get(n);if(s)return s;const i=(async()=>{const e=await Ht(n,t);if(!e)return null;if("undefined"===typeof URL||"function"!==typeof URL.createObjectURL)return null;const l=URL.createObjectURL(e);return Kt(n,l),l})().catch((e=>{var t,n;return console.error("Failed to fetch media content:",e),a.oR.error((null===(t=e.response)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.message)||"Failed to load media preview. Please retry."),null})).finally((()=>{It.current.delete(n)}));return It.current.set(n,i),i}),[Ht,Kt]),Yt=(0,s.useCallback)((()=>{const e=(Array.isArray(Pt.current)?Pt.current:[]).map((e=>{var t,n,l,s,i,a,o,r,d;if("image"!==String(null!==(t=null!==(n=null===e||void 0===e?void 0:e.mediaType)&&void 0!==n?n:null===e||void 0===e?void 0:e.MediaType)&&void 0!==t?t:"").trim().toLowerCase())return null;const c=String(null!==(l=null!==(s=null===e||void 0===e?void 0:e.mediaId)&&void 0!==s?s:null===e||void 0===e?void 0:e.MediaId)&&void 0!==l?l:"").trim();if(!c)return null;return{mediaId:c,fileName:String(null!==(i=null!==(a=null===e||void 0===e?void 0:e.fileName)&&void 0!==a?a:null===e||void 0===e?void 0:e.FileName)&&void 0!==i?i:"").trim()||null,sentAt:null!==(o=null!==(r=null!==(d=null===e||void 0===e?void 0:e.sentAt)&&void 0!==d?d:null===e||void 0===e?void 0:e.sentAtUtc)&&void 0!==r?r:null===e||void 0===e?void 0:e.createdAt)&&void 0!==o?o:null}})).filter(Boolean);e.sort(((e,t)=>(null!==e&&void 0!==e&&e.sentAt?Date.parse(e.sentAt):0)-(null!==t&&void 0!==t&&t.sentAt?Date.parse(t.sentAt):0)));const t=new Set;return e.filter((e=>!(null===e||void 0===e||!e.mediaId)&&(!t.has(e.mediaId)&&(t.add(e.mediaId),!0))))}),[]),Gt=(0,s.useCallback)((async e=>{var t,n,l,s,i,a;const o=null!==(t=null!==(n=null===e||void 0===e?void 0:e.mediaId)&&void 0!==n?n:null===e||void 0===e?void 0:e.MediaId)&&void 0!==t?t:null,r=String(null!==(l=null!==(s=null===e||void 0===e?void 0:e.mediaType)&&void 0!==s?s:null===e||void 0===e?void 0:e.MediaType)&&void 0!==l?l:"").trim().toLowerCase();if(!o||"image"!==r&&"document"!==r&&"video"!==r)return;const d=(null===e||void 0===e?void 0:e.localPreviewUrl)||await Qt(String(o),{silent:!1});if(!d)return;const c=String(null!==(i=null!==(a=null===e||void 0===e?void 0:e.fileName)&&void 0!==a?a:null===e||void 0===e?void 0:e.FileName)&&void 0!==i?i:"").trim();if("image"===r){var u,m;const e=Yt(),t=String(o).trim();let n=e.findIndex((e=>e.mediaId===t));n<0&&(e.push({mediaId:t,fileName:c||null,sentAt:null}),n=e.length-1);const l=null===(u=e[n-1])||void 0===u?void 0:u.mediaId,s=null===(m=e[n+1])||void 0===m?void 0:m.mediaId;return l&&Qt(l,{silent:!0}),s&&Qt(s,{silent:!0}),void Lt({open:!0,type:"image",mediaId:t,url:d,fileName:c||null,items:e,index:n,loading:!1})}if("video"===r){const e=String(o).trim();return void Lt({open:!0,type:"video",mediaId:e,url:d,fileName:c||null,items:null,index:0,loading:!1})}const v=document.createElement("a");v.href=d,v.target="_blank",v.rel="noreferrer noopener",c&&(v.download=c),v.click()}),[Yt,Qt]),$t=(0,s.useCallback)((()=>{Lt({open:!1,type:null,mediaId:null,url:null,fileName:null,items:null,index:0,loading:!1})}),[]),Xt=(0,s.useCallback)((async e=>{var t,n;const s=Dt.current;if(null===s||void 0===s||!s.open||"image"!==s.type)return;const i=Array.isArray(s.items)?s.items:[];if(0===i.length)return;const a=Number(e);if(!Number.isFinite(a)||a<0||a>=i.length)return;if(a===s.index&&s.url)return;const o=i[a];if(null===o||void 0===o||!o.mediaId)return;Lt((e=>(0,l.A)((0,l.A)({},e),{},{loading:!0})));const r=await Qt(o.mediaId,{silent:!1});if(!r)return void Lt((e=>(0,l.A)((0,l.A)({},e),{},{loading:!1})));const d=null===(t=i[a-1])||void 0===t?void 0:t.mediaId,c=null===(n=i[a+1])||void 0===n?void 0:n.mediaId;d&&Qt(d,{silent:!0}),c&&Qt(c,{silent:!0}),Lt((e=>(0,l.A)((0,l.A)({},e),{},{open:!0,type:"image",mediaId:o.mediaId,url:r,fileName:o.fileName||null,items:i,index:a,loading:!1})))}),[Qt]),Zt=(0,s.useCallback)((()=>{const e=Dt.current;null!==e&&void 0!==e&&e.open&&"image"===e.type&&(!Array.isArray(e.items)||e.items.length<=1||e.index<=0||Xt(e.index-1))}),[Xt]),Jt=(0,s.useCallback)((()=>{const e=Dt.current;null!==e&&void 0!==e&&e.open&&"image"===e.type&&(!Array.isArray(e.items)||e.items.length<=1||e.index>=e.items.length-1||Xt(e.index+1))}),[Xt]),en=(0,s.useCallback)((e=>{const t=String(e||"").trim();t&&Qt(t,{silent:!0})}),[Qt]),tn=(0,s.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s=String(e||"").trim();if(!s)return;if(Mt[s])return;if(Ut.current.has(s))return;const i=(async()=>{const e=String((null===t||void 0===t?void 0:t.localPreviewUrl)||"").trim(),i=Boolean(null===t||void 0===t?void 0:t.skipRemote),a=await(async()=>{if(e)try{const t=await fetch(e);if(null!==t&&void 0!==t&&t.ok)return await t.blob()}catch(t){}return i?null:await Ht(s,{silent:!0})})();if(a)if("undefined"!==typeof document&&"undefined"!==typeof URL&&"function"===typeof a.arrayBuffer)try{let e=Ft.current;e||(Et.current||(Et.current=n.e(321).then(n.bind(n,321))),e=await Et.current,Ft.current=e);try{var o;const t=null===(o=e)||void 0===o?void 0:o.GlobalWorkerOptions;if(t&&!t.workerSrc){const e=("undefined"!==typeof process&&process,"");t.workerSrc="".concat(e,"/pdf.worker.min.mjs")}}catch(u){}const t=await a.arrayBuffer(),i=await e.getDocument({data:t,disableWorker:!0}).promise,g=Number(null===i||void 0===i?void 0:i.numPages)||null;let x=null;try{var r;const e=await i.getPage(1),t=e.getViewport({scale:.35}),n=document.createElement("canvas"),l=null===(r=n.getContext)||void 0===r?void 0:r.call(n,"2d");var d;if(l)n.width=Math.max(1,Math.floor(t.width)),n.height=Math.max(1,Math.floor(t.height)),await e.render({canvasContext:l,viewport:t}).promise,x=n.toDataURL("image/png"),null===(d=e.cleanup)||void 0===d||d.call(e)}catch(m){x=null}finally{try{var c;await(null===(c=i.destroy)||void 0===c?void 0:c.call(i))}catch(v){}}kt((e=>(0,l.A)((0,l.A)({},e),{},{[s]:{pages:g,sizeBytes:Number(a.size)||null,thumbDataUrl:x}})))}catch(g){console.error("Failed to generate PDF preview:",g),kt((e=>(0,l.A)((0,l.A)({},e),{},{[s]:{pages:null,sizeBytes:Number(a.size)||null,thumbDataUrl:null}})))}else kt((e=>(0,l.A)((0,l.A)({},e),{},{[s]:{pages:null,sizeBytes:Number(a.size)||null,thumbDataUrl:null}})))})().finally((()=>{Ut.current.delete(s)}));Ut.current.set(s,i),await i}),[Ht,Mt]);(0,s.useEffect)((()=>{Ot.current=G}),[G]),(0,s.useEffect)((()=>{Wt.current=_}),[_]),(0,s.useEffect)((()=>{Bt.current=K}),[K]),(0,s.useEffect)((()=>{qt.current=Q}),[Q]),(0,s.useEffect)((()=>{zt.current=le}),[le]),(0,s.useEffect)((()=>{_t.current=ie}),[ie]),(0,s.useEffect)((()=>{Vt.current=oe}),[oe]);const nn=(0,s.useCallback)((()=>{xt.current&&xt.current.scrollIntoView({behavior:"auto",block:"end"})}),[]),ln=(0,s.useMemo)((()=>localStorage.getItem("userId")),[]),sn=(0,s.useMemo)((()=>W.find((e=>e.id===G))||null),[W,G]),an=(0,s.useRef)(null);(0,s.useEffect)((()=>{an.current=sn}),[sn]);const on=(0,s.useRef)([]);(0,s.useEffect)((()=>{on.current=W}),[W]);const rn=(0,s.useCallback)((e=>{if(!e)return null;const t=e.id?pt.current.get(e.id):null;return t||(e.contactId&&ft.current.get(e.contactId)||null)}),[]),dn=(0,s.useCallback)((e=>e&&ft.current.get(e)||null),[]),cn=(0,s.useCallback)(((e,t)=>{if(!e)return;const n={localUnread:Math.max(0,Number(t)||0),updatedAt:Date.now()};e.id&&pt.current.set(e.id,n),e.contactId&&ft.current.set(e.contactId,n)}),[]),un=(0,s.useCallback)((e=>{const t=rn(e);return t?"number"!==typeof t.localUnread?null:t.localUnread:null}),[rn]),mn=(0,s.useCallback)((e=>{e&&cn(e,0)}),[cn]),vn=(0,s.useMemo)((()=>(null===sn||void 0===sn?void 0:sn.contactId)||null),[sn]),gn=null!==(e=null===sn||void 0===sn?void 0:sn.within24h)&&void 0!==e&&e,xn="Closed"===(null!==(t=g(null===sn||void 0===sn?void 0:sn.status))&&void 0!==t?t:"Open"),hn=!(null===sn||void 0===sn||!sn.assignedToUserId),pn=!(null===sn||void 0===sn||!sn.isAssignedToMe)||!(null===sn||void 0===sn||!sn.assignedToUserId)&&ln&&sn.assignedToUserId===ln,fn=pn?"You":(null===sn||void 0===sn?void 0:sn.assignedToUserName)||"Agent";(0,s.useEffect)((()=>{Oe(null),Be(""),Ve(null),He(""),Ye(""),$e("")}),[vn]);const bn=(0,s.useMemo)((()=>{let e=[...W];const t="history"===P?"older":P;if("all"!==U&&(e=e.filter((e=>e.numberId===U))),F.trim()){const t=F.trim().toLowerCase();e=e.filter((e=>{var n,l,s;return(null===(n=e.contactName)||void 0===n?void 0:n.toLowerCase().includes(t))||(null===(l=e.contactPhone)||void 0===l?void 0:l.toLowerCase().includes(t))||(null===(s=e.lastMessagePreview)||void 0===s?void 0:s.toLowerCase().includes(t))}))}return e="closed"===t?e.filter((e=>"Closed"===g(e.status))):e.filter((e=>"Closed"!==g(e.status))),"live"===t?e=e.filter((e=>e.within24h)):"older"===t?e=e.filter((e=>!e.within24h)):"unassigned"===t?e=e.filter((e=>!e.assignedToUserId)):"my"===t&&ln&&(e=e.filter((e=>e.assignedToUserId===ln))),e.sort(((e,t)=>{const n=e.unreadCount>0,l=t.unreadCount>0;if(n&&!l)return-1;if(!n&&l)return 1;const s=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-s})),e}),[W,P,U,F,ln]),yn=(0,s.useCallback)((async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{reset:t=!1,append:n=!1,limit:s=h}=e;if(n){if(!Bt.current)return;if(!Wt.current)return;if(qt.current)return}try{t&&(z(!0),V(null),H(!1)),n&&Y(!0);const e=localStorage.getItem("businessId");if(!e)return void a.oR.error("Missing business context. Please login again to load inbox.");const i={businessId:e,tab:"history"===P?"older":P,numberId:U&&"all"!==U?U:void 0,search:F||void 0,limit:s,paged:!0,cursor:n?Wt.current:void 0},o=await r.get("/chat-inbox/conversations",{params:i}),{items:d,nextCursor:c,hasMore:u}=x(o.data),m=Ot.current,v=d.map((e=>{var t,n;const l=m&&e.id===m,s=un(e);return{id:e.id,contactId:e.contactId,contactName:e.contactName,contactPhone:e.contactPhone,lastMessagePreview:e.lastMessagePreview,lastMessageAt:e.lastMessageAt,unreadCount:l?0:(null!==(t=null!==s&&void 0!==s?s:e.unreadCount)&&void 0!==t?t:e.UnreadCount)||0,status:null!==(n=g(e.status))&&void 0!==n?n:"Open",numberId:e.numberId,numberLabel:e.numberLabel,within24h:!!e.within24h,assignedToUserId:e.assignedToUserId||null,assignedToUserName:e.assignedToUserName||null,isAssignedToMe:!!e.isAssignedToMe,sourceType:e.sourceType||"WhatsApp",sourceName:e.sourceName||"WhatsApp",mode:e.mode||"Live",firstSeenAt:e.firstSeenAt,lastInboundAt:e.lastInboundAt,lastOutboundAt:e.lastOutboundAt}})),h=e=>{var t,n;return String(null!==(t=null!==(n=null===e||void 0===e?void 0:e.id)&&void 0!==n?n:null===e||void 0===e?void 0:e.contactId)&&void 0!==t?t:null===e||void 0===e?void 0:e.contactPhone)};B((e=>{if(t)return v;if(!n)return e;const s=new Map(e.map((e=>[h(e),e]))),i=e.map(h);return v.forEach((e=>{const t=h(e);if(!t)return;s.has(t)||i.push(t);const n=s.get(t);s.set(t,n?(0,l.A)((0,l.A)({},n),e):e)})),i.map((e=>s.get(e))).filter(Boolean)})),V(c),H(u),!Ot.current&&v.length>0&&$(v[0].id)}catch(d){var i,o;console.error("Failed to load inbox conversations:",d),a.oR.error((null===(i=d.response)||void 0===i||null===(o=i.data)||void 0===o?void 0:o.message)||"Failed to load inbox conversations.")}finally{t&&z(!1),n&&Y(!1)}}),[P,U,F,un]),wn=(0,s.useCallback)((async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{limit:t,silent:n}=e;if(!n)return yn({reset:!0,limit:null!==t&&void 0!==t?t:h});try{const e=localStorage.getItem("businessId");if(!e)return void a.oR.error("\u274c Missing business context. Please login again to load inbox.");const n={businessId:e,tab:"history"===P?"older":P,numberId:U&&"all"!==U?U:void 0,search:F||void 0,limit:null!==t&&void 0!==t?t:h,paged:!0},s=await r.get("/chat-inbox/conversations",{params:n}),{items:i}=x(s.data),o=Ot.current,d=i.map((e=>{var t,n;const l=o&&e.id===o,s=un(e);return{id:e.id,contactId:e.contactId,contactName:e.contactName,contactPhone:e.contactPhone,lastMessagePreview:e.lastMessagePreview,lastMessageAt:e.lastMessageAt,unreadCount:l?0:(null!==(t=null!==s&&void 0!==s?s:e.unreadCount)&&void 0!==t?t:e.UnreadCount)||0,status:null!==(n=g(e.status))&&void 0!==n?n:"Open",numberId:e.numberId,numberLabel:e.numberLabel,within24h:!!e.within24h,assignedToUserId:e.assignedToUserId||null,assignedToUserName:e.assignedToUserName||null,isAssignedToMe:!!e.isAssignedToMe,sourceType:e.sourceType||"WhatsApp",sourceName:e.sourceName||"WhatsApp",mode:e.mode||"Live",firstSeenAt:e.firstSeenAt,lastInboundAt:e.lastInboundAt,lastOutboundAt:e.lastOutboundAt}}));B((e=>{const t=new Map(e.map((e=>[e.id,e]))),n=Ot.current,s=d.map((e=>{var s,i;const a=t.get(e.id);if(!a)return e;const o=un(e);return n&&e.id===n?(0,l.A)((0,l.A)((0,l.A)({},a),e),{},{unreadCount:0}):0===(null!==(s=e.unreadCount)&&void 0!==s?s:0)&&(null!==(i=a.unreadCount)&&void 0!==i?i:0)>0&&"number"!==typeof o?(0,l.A)((0,l.A)((0,l.A)({},a),e),{},{unreadCount:a.unreadCount}):(0,l.A)((0,l.A)({},a),e)})),i=new Set(s.map((e=>e.id))),a=e.filter((e=>!i.has(e.id)));return[...s,...a]})),!Ot.current&&d.length>0&&$(d[0].id)}catch(o){var s,i;console.error("\u274c Failed to load inbox conversations:",o),a.oR.error((null===(s=o.response)||void 0===s||null===(i=s.data)||void 0===i?void 0:i.message)||"Failed to load inbox conversations.")}finally{e.silent||z(!1)}}),[P,U,F,yn,un]);(0,s.useEffect)((()=>{yn({reset:!0,limit:h})}),[P,U,F,yn]);const Nn=(0,s.useCallback)((async()=>{const e=localStorage.getItem("businessId");if(e){ye(!0);try{const t=await r.get("/chat-inbox/agents",{params:{businessId:e}}),n=(Array.isArray(t.data)?t.data:[]).map((e=>{var t,n,l,s,i,a,o,r,d;return{userId:null!==(t=null!==(n=e.userId)&&void 0!==n?n:e.id)&&void 0!==t?t:null,name:null!==(l=null!==(s=null!==(i=null!==(a=e.name)&&void 0!==a?a:e.fullName)&&void 0!==i?i:e.displayName)&&void 0!==s?s:e.email)&&void 0!==l?l:"Agent",email:null!==(o=e.email)&&void 0!==o?o:null,roleName:null!==(r=null!==(d=e.roleName)&&void 0!==d?d:e.role)&&void 0!==r?r:null}})).filter((e=>e.userId));fe(n)}catch(t){fe([])}finally{ye(!1)}}}),[]);(0,s.useEffect)((()=>{Nn()}),[Nn]);const jn=(0,s.useCallback)((async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{reset:t=!1,prepend:n=!1,limit:l=p}=e,s=Ot.current;if(!s)return void(t&&(ee([]),se(null),ae(!1)));if(n){if(!_t.current)return;if(!zt.current)return;if(Vt.current)return}const i=on.current.find((e=>e.id===s));if(!i)return void(t&&(ee([]),se(null),ae(!1)));const o=localStorage.getItem("businessId");if(!o)return void a.oR.error("Missing business context. Please login again to load messages.");const c=yt.current+1;yt.current=c,bt.current&&bt.current.abort();const u=new AbortController;bt.current=u;try{t&&(ne(!0),ee([]),se(null),ae(!1),ht.current="reset"),n&&(re(!0),ht.current="prepend");const e={businessId:o,limit:l,paged:!0,cursor:n?zt.current:void 0,contactId:i.contactId||void 0,contactPhone:i.contactPhone||void 0},s=await r.get("/chat-inbox/messages",{params:e,signal:u.signal}),{items:a,nextCursor:m,hasMore:v}=x(s.data);if(yt.current!==c)return;const g=a.map((e=>{var t,n,l,s,i,a,o,r,c,u,m,v,g,x,h,p,f,b,y,w,N,j,I,S,A,C,R,M,k,T,L,P,D,U,E,F,O,W,B,q,z,_,V;const K=d(e),H=null!==(t=null!==(n=null!==(l=null!==(s=e.direction)&&void 0!==s?s:e.Direction)&&void 0!==l?l:e.dir)&&void 0!==n?n:e.messageDirection)&&void 0!==t?t:"",Q=null!==(i=e.status)&&void 0!==i?i:"",Y=null!==(a=null!==(o=e.providerMessageId)&&void 0!==o?o:e.ProviderMessageId)&&void 0!==a?a:null,G=null!==(r=null!==(c=null!==(u=e.messageLogId)&&void 0!==u?u:e.MessageLogId)&&void 0!==c?c:e.messageLogID)&&void 0!==r?r:null,$=null!==(m=null!==(v=null!==(g=null!==(x=null!==(h=null!==(p=null!==(f=e.messageId)&&void 0!==f?f:e.MessageId)&&void 0!==p?p:e.wamid)&&void 0!==h?h:e.Wamid)&&void 0!==x?x:e.waMessageId)&&void 0!==g?g:e.WaMessageId)&&void 0!==v?v:Y)&&void 0!==m?m:null,X=null!==(b=null!==(y=e.clientMessageId)&&void 0!==y?y:e.ClientMessageId)&&void 0!==b?b:null;return{id:null!==(w=null!==(N=e.id)&&void 0!==N?N:G)&&void 0!==w?w:$,serverId:null!==(j=null!==G&&void 0!==G?G:e.id)&&void 0!==j?j:null,messageLogId:null!==(I=null!==G&&void 0!==G?G:e.id)&&void 0!==I?I:null,messageId:$,providerMessageId:Y,clientMessageId:X,direction:H||(K?"in":"out"),isInbound:K,text:e.text||e.message||e.body||e.content||e.messageText||e.MessageText||e.messageContent||e.MessageContent||e.renderedBody||e.RenderedBody||"",mediaId:null!==(S=null!==(A=e.mediaId)&&void 0!==A?A:e.MediaId)&&void 0!==S?S:null,mediaType:null!==(C=null!==(R=e.mediaType)&&void 0!==R?R:e.MediaType)&&void 0!==C?C:null,fileName:null!==(M=null!==(k=e.fileName)&&void 0!==k?k:e.FileName)&&void 0!==M?M:null,mimeType:null!==(T=null!==(L=e.mimeType)&&void 0!==L?L:e.MimeType)&&void 0!==T?T:null,locationLatitude:null!==(P=null!==(D=null!==(U=e.locationLatitude)&&void 0!==U?U:e.LocationLatitude)&&void 0!==D?D:e.latitude)&&void 0!==P?P:null,locationLongitude:null!==(E=null!==(F=null!==(O=e.locationLongitude)&&void 0!==O?O:e.LocationLongitude)&&void 0!==F?F:e.longitude)&&void 0!==E?E:null,locationName:null!==(W=null!==(B=null!==(q=e.locationName)&&void 0!==q?q:e.LocationName)&&void 0!==B?B:e.name)&&void 0!==W?W:null,locationAddress:null!==(z=null!==(_=null!==(V=e.locationAddress)&&void 0!==V?V:e.LocationAddress)&&void 0!==_?_:e.address)&&void 0!==z?z:null,sentAt:e.sentAtUtc||e.sentAt||e.createdAt||e.timestamp,status:Q,errorMessage:e.errorMessage}})).reverse(),h=e=>{var t,n,l,s,i;return String(null!==(t=null!==(n=null!==(l=null!==(s=null!==(i=e.messageLogId)&&void 0!==i?i:e.serverId)&&void 0!==s?s:e.messageId)&&void 0!==l?l:e.providerMessageId)&&void 0!==n?n:e.clientMessageId)&&void 0!==t?t:e.id)};t?ee(g):n&&ee((e=>{const t=new Set(e.map(h));return[...g.filter((e=>!t.has(h(e)))),...e]})),se(m),ae(v)}catch(g){var m,v;if("CanceledError"===(null===g||void 0===g?void 0:g.name)||"ERR_CANCELED"===(null===g||void 0===g?void 0:g.code))return;if(yt.current!==c)return;console.error("Failed to load messages:",g),a.oR.error((null===(m=g.response)||void 0===m||null===(v=m.data)||void 0===v?void 0:v.message)||"Failed to load messages."),t&&ee([])}finally{if(yt.current!==c)return;t&&ne(!1),n&&re(!1),bt.current===u&&(bt.current=null)}}),[]);(0,s.useEffect)((()=>{const e=setInterval((()=>{wn({silent:!0,limit:100})}),25e3);return()=>clearInterval(e)}),[wn]),(0,s.useEffect)((()=>{if(bt.current&&bt.current.abort(),wt.current&&clearTimeout(wt.current),!G)return ee([]),se(null),ae(!1),void ne(!1);ee([]),se(null),ae(!1),ne(!0),ht.current="reset";return wt.current=setTimeout((()=>{(async()=>{await jn({reset:!0,limit:p})})()}),200),()=>{wt.current&&clearTimeout(wt.current)}}),[G,jn]),(0,s.useEffect)((()=>{if(G)return B((e=>e.map((e=>e.id===G?(0,l.A)((0,l.A)({},e),{},{unreadCount:0}):e)))),sn&&mn(sn),Nt.current&&clearTimeout(Nt.current),Nt.current=setTimeout((()=>{const e=localStorage.getItem("businessId"),t=null===sn||void 0===sn?void 0:sn.contactId;if(!e||!t)return;const n={businessId:e,contactId:t,lastReadAtUtc:(new Date).toISOString()};r.post("/chat-inbox/mark-read",n).catch((e=>{console.error("Failed to mark conversation as read:",e)})),T&&L&&T.invoke("MarkAsRead",t).catch((e=>{console.warn("SignalR MarkAsRead failed:",e)}))}),200),()=>{Nt.current&&clearTimeout(Nt.current)}}),[G,null===sn||void 0===sn?void 0:sn.contactId,T,L,mn]);const In=(0,s.useCallback)((async()=>{if(vn)try{var e,t;Ie(!0);const n=await r.get("/crm/contact-summary/".concat(vn)),l=null!==(e=null===(t=n.data)||void 0===t?void 0:t.data)&&void 0!==e?e:n.data;Ne(l||null)}catch(n){console.error("\u274c Failed to load contact summary:",n),Ne(null)}finally{Ie(!1)}else Ne(null)}),[vn]);(0,s.useEffect)((()=>{vn?In():Ne(null)}),[vn,In]);const Sn=(0,s.useCallback)((async e=>{if(!vn)return void a.oR.warn("No contact selected.");const t=(null===e||void 0===e?void 0:e.id)||(null===e||void 0===e?void 0:e.tagId),n=(null===e||void 0===e?void 0:e.tagName)||(null===e||void 0===e?void 0:e.name)||"tag";if(t){if(!it){Ne((e=>{if(!e)return e;const n=e=>Array.isArray(e)?e.filter((e=>((null===e||void 0===e?void 0:e.id)||(null===e||void 0===e?void 0:e.tagId))!==t)):e;return(0,l.A)((0,l.A)({},e),{},{tags:n(e.tags),contactTags:n(e.contactTags),contactTagsDto:n(e.contactTagsDto)})})),at(t);try{const e={contactIds:[vn],tagId:t};try{await r.request({url:"/contacts/bulk-unassign-tag",method:"DELETE",data:e})}catch(d){var s;const t=null===d||void 0===d||null===(s=d.response)||void 0===s?void 0:s.status;if(404!==t&&405!==t)throw d;await r.post("/contacts/bulk-unassign-tag",e)}a.oR.success('Removed "'.concat(n,'"')),await In()}catch(c){var i,o;console.error("Failed to remove tag:",c),a.oR.error((null===c||void 0===c||null===(i=c.response)||void 0===i||null===(o=i.data)||void 0===o?void 0:o.message)||'Failed to remove "'.concat(n,'".')),await In()}finally{at(null)}}}else a.oR.error("Cannot remove this tag (missing tagId).")}),[vn,it,In]);(0,s.useEffect)((()=>{if(!G)return;if(te)return;if(0===J.length)return;"prepend"!==ht.current?(ht.current=null,nn()):ht.current=null}),[J,te,G,nn]);const An=(0,s.useMemo)((()=>{const e=[];let t=null;return J.forEach((n=>{const s=n.sentAt?new Date(n.sentAt):null,i=s?s.toDateString():"unknown";i!==t&&(s&&e.push({type:"separator",id:"sep-".concat(i),label:v(s)}),t=i),e.push((0,l.A)({type:"message"},n))})),e}),[J]),Cn=(0,s.useCallback)((e=>{var t,n,s,i;if(!e)return;const a=null!==(t=null!==(n=e.contactId)&&void 0!==n?n:e.ContactId)&&void 0!==t?t:null,o=null!==(s=null!==(i=e.conversationId)&&void 0!==i?i:e.ConversationId)&&void 0!==s?s:null,r=function(e){var t,n,l,s,i,a,o,r,c,u,m,v,g,x,h,p,f,b,y,w,N,j,I,S,A,C,R,M,k,T,L,P,D,U,E,F,O,W,B,q,z,_,V,K,H,Q,Y,G,$,X,Z,J,ee,te,ne,le,se,ie,ae,oe,re,de,ce,ue,me,ve,ge,xe,he,pe,fe,be,ye,we,Ne,je;if(!e)return null;const Ie=null!==(t=null!==(n=e.providerMessageId)&&void 0!==n?n:e.ProviderMessageId)&&void 0!==t?t:null,Se=null!==(l=null!==(s=null!==(i=e.messageLogId)&&void 0!==i?i:e.MessageLogId)&&void 0!==s?s:e.messageLogID)&&void 0!==l?l:null,Ae=null!==(a=null!==(o=null!==(r=null!==(c=null!==(u=null!==(m=null!==(v=null!==(g=e.messageId)&&void 0!==g?g:e.MessageId)&&void 0!==v?v:e.wamid)&&void 0!==m?m:e.Wamid)&&void 0!==u?u:e.waMessageId)&&void 0!==c?c:e.WaMessageId)&&void 0!==r?r:e.providerMessageId)&&void 0!==o?o:e.ProviderMessageId)&&void 0!==a?a:null,Ce=null!==(x=null!==(h=null!==(p=e.clientMessageId)&&void 0!==p?p:e.ClientMessageId)&&void 0!==h?h:e.clientId)&&void 0!==x?x:null,Re=null!==(f=null!==(b=null!==(y=null!==(w=null!==(N=e.id)&&void 0!==N?N:e.Id)&&void 0!==w?w:Se)&&void 0!==y?y:Ae)&&void 0!==b?b:Ce)&&void 0!==f?f:"".concat(Date.now(),"-").concat(Math.random().toString(16).slice(2)),Me=null!==(j=null!==(I=null!==(S=null!==(A=null!==(C=null!==(R=null!==(M=null!==(k=null!==(T=null!==(L=e.text)&&void 0!==L?L:e.message)&&void 0!==T?T:e.body)&&void 0!==k?k:e.content)&&void 0!==M?M:e.messageText)&&void 0!==R?R:e.MessageText)&&void 0!==C?C:e.messageContent)&&void 0!==A?A:e.MessageContent)&&void 0!==S?S:e.renderedBody)&&void 0!==I?I:e.RenderedBody)&&void 0!==j?j:"";let ke=null!==(P=null!==(D=e.mediaId)&&void 0!==D?D:e.MediaId)&&void 0!==P?P:null,Te=null!==(U=null!==(E=e.mediaType)&&void 0!==E?E:e.MediaType)&&void 0!==U?U:null;const Le=null!==(F=null!==(O=e.fileName)&&void 0!==O?O:e.FileName)&&void 0!==F?F:null,Pe=null!==(W=null!==(B=e.mimeType)&&void 0!==B?B:e.MimeType)&&void 0!==W?W:null;let De=null!==(q=null!==(z=null!==(_=e.locationLatitude)&&void 0!==_?_:e.LocationLatitude)&&void 0!==z?z:e.latitude)&&void 0!==q?q:null,Ue=null!==(V=null!==(K=null!==(H=e.locationLongitude)&&void 0!==H?H:e.LocationLongitude)&&void 0!==K?K:e.longitude)&&void 0!==V?V:null,Ee=null!==(Q=null!==(Y=null!==(G=e.locationName)&&void 0!==G?G:e.LocationName)&&void 0!==Y?Y:e.name)&&void 0!==Q?Q:null,Fe=null!==($=null!==(X=null!==(Z=e.locationAddress)&&void 0!==Z?Z:e.LocationAddress)&&void 0!==X?X:e.address)&&void 0!==$?$:null;const Oe=null!==(J=null!==(ee=null!==(te=null!==(ne=e.type)&&void 0!==ne?ne:e.Type)&&void 0!==te?te:e.messageType)&&void 0!==ee?ee:e.MessageType)&&void 0!==J?J:null;!Te&&Oe&&(Te=Oe),Te||(e.image||e.Image?Te="image":e.video||e.Video?Te="video":e.audio||e.Audio?Te="audio":e.document||e.Document?Te="document":(e.location||e.Location)&&(Te="location")),"string"===typeof Te&&(Te=Te.toLowerCase().trim());const We="image"===Te?null!==(le=null!==(se=e.image)&&void 0!==se?se:e.Image)&&void 0!==le?le:null:"video"===Te?null!==(ie=null!==(ae=e.video)&&void 0!==ae?ae:e.Video)&&void 0!==ie?ie:null:"audio"===Te?null!==(oe=null!==(re=e.audio)&&void 0!==re?re:e.Audio)&&void 0!==oe?oe:null:"document"===Te?null!==(de=null!==(ce=e.document)&&void 0!==ce?ce:e.Document)&&void 0!==de?de:null:"location"===Te&&null!==(ue=null!==(me=e.location)&&void 0!==me?me:e.Location)&&void 0!==ue?ue:null;var Be,qe,ze,_e,Ve,Ke,He,Qe,Ye,Ge,$e,Xe,Ze,Je;!ke&&We&&"object"===typeof We&&(ke=null!==(Be=null!==(qe=We.id)&&void 0!==qe?qe:We.mediaId)&&void 0!==Be?Be:null),"location"===Te&&We&&"object"===typeof We&&(De=null!==(ze=null!==(_e=null!==(Ve=De)&&void 0!==Ve?Ve:We.latitude)&&void 0!==_e?_e:We.Latitude)&&void 0!==ze?ze:null,Ue=null!==(Ke=null!==(He=null!==(Qe=Ue)&&void 0!==Qe?Qe:We.longitude)&&void 0!==He?He:We.Longitude)&&void 0!==Ke?Ke:null,Ee=null!==(Ye=null!==(Ge=null!==($e=Ee)&&void 0!==$e?$e:We.name)&&void 0!==Ge?Ge:We.Name)&&void 0!==Ye?Ye:null,Fe=null!==(Xe=null!==(Ze=null!==(Je=Fe)&&void 0!==Je?Je:We.address)&&void 0!==Ze?Ze:We.Address)&&void 0!==Xe?Xe:null);const et=d(e),tt=null!==(ve=null!==(ge=null!==(xe=e.direction)&&void 0!==xe?xe:e.Direction)&&void 0!==ge?ge:e.dir)&&void 0!==ve?ve:"",nt=null!==(he=null!==(pe=null!==(fe=e.status)&&void 0!==fe?fe:e.deliveryStatus)&&void 0!==pe?pe:e.Status)&&void 0!==he?he:"";return{id:Re,providerMessageId:Ie,messageLogId:null!==Se&&void 0!==Se?Se:null,serverId:null!==Se&&void 0!==Se?Se:null,messageId:Ae,clientMessageId:Ce,direction:tt||(et?"in":"out"),isInbound:et,text:Me,mediaId:ke,mediaType:Te,fileName:Le,mimeType:Pe,locationLatitude:De,locationLongitude:Ue,locationName:Ee,locationAddress:Fe,sentAt:null!==(be=null!==(ye=null!==(we=null!==(Ne=e.createdAt)&&void 0!==Ne?Ne:e.sentAt)&&void 0!==we?we:e.sentAtUtc)&&void 0!==ye?ye:e.timestamp)&&void 0!==be?be:(new Date).toISOString(),status:nt,errorMessage:null!==(je=e.errorMessage)&&void 0!==je?je:null}}(e);if(!r)return;const c=String(r.mediaType||"").trim().toLowerCase(),u=Boolean(r.mediaId)&&("image"===c||"document"===c||"video"===c||"audio"===c),m=N(r.locationLatitude),v=j(r.locationLongitude),x="location"===c&&null!==m&&null!==v;ee((t=>{const n=an.current;if(!n)return t;if(!(o&&n.id&&n.id===o||a&&n.contactId&&n.contactId===a||e.contactPhone&&n.contactPhone&&n.contactPhone===e.contactPhone))return t;const s=t.findIndex((t=>((e,t,n)=>{const l=(null===t||void 0===t?void 0:t.messageId)||(null===n||void 0===n?void 0:n.messageId)||(null===n||void 0===n?void 0:n.MessageId)||(null===n||void 0===n?void 0:n.wamid)||(null===n||void 0===n?void 0:n.Wamid)||null,s=(null===t||void 0===t?void 0:t.clientMessageId)||(null===n||void 0===n?void 0:n.clientMessageId)||(null===n||void 0===n?void 0:n.ClientMessageId)||(null===n||void 0===n?void 0:n.clientId)||null;return!(null===e||void 0===e||!e.messageId||!l||e.messageId!==l)||!(null===e||void 0===e||!e.clientMessageId||!s||e.clientMessageId!==s)||!(null===e||void 0===e||!e.id||null===t||void 0===t||!t.id||e.id!==t.id)||!(null===e||void 0===e||!e.id||!l||e.id!==l)||!(null===e||void 0===e||!e.serverId||null===t||void 0===t||!t.id||e.serverId!==t.id)})(t,r,e)));if(s>=0){var i,d,c;const e=t[s],n=(0,l.A)((0,l.A)((0,l.A)({},e),r),{},{text:r.text||e.text,sentAt:r.sentAt||e.sentAt,status:r.status||e.status,messageId:r.messageId||e.messageId||null,clientMessageId:r.clientMessageId||e.clientMessageId||null,serverId:null!==(i=e.serverId)&&void 0!==i?i:null,errorMessage:null!==(d=null!==(c=r.errorMessage)&&void 0!==c?c:e.errorMessage)&&void 0!==d?d:null}),a=[...t];return a[s]=n,a}return!(!r.text||0===String(r.text).trim().length)||u||x?[...t,r]:t}));let h=!1;B((t=>{const n=an.current;return t.map((t=>{var s;if(!(o&&t.id===o||a&&t.contactId===a||e.contactPhone&&t.contactPhone===e.contactPhone))return t;h=!0;const i=!!n&&(n.id&&t.id===n.id||n.contactId&&t.contactId===n.contactId),d=un(t),m="number"===typeof d?d:null!==(s=t.unreadCount)&&void 0!==s?s:0,v=r.isInbound&&!i?m+1:m;"number"===typeof d&&r.isInbound&&!i&&cn(t,v);const p=String(r.text||"").trim(),f=u?"image"===c?"Photo":"document"===c?String(r.fileName||"").trim()||"PDF":"video"===c?String(r.fileName||"").trim()||"Video":String(r.fileName||"").trim()||"Audio":x?String(r.locationName||"").trim()||"Location":null;return(0,l.A)((0,l.A)({},t),{},{lastMessagePreview:p||f||t.lastMessagePreview,lastMessageAt:r.sentAt||t.lastMessageAt,lastInboundAt:r.isInbound&&r.sentAt||t.lastInboundAt,lastOutboundAt:r.isInbound?t.lastOutboundAt:r.sentAt||t.lastOutboundAt,within24h:!!r.isInbound||t.within24h,status:r.isInbound&&"Closed"===g(t.status)?"Open":t.status,unreadCount:i?0:v})}))})),h||wn({silent:!0,limit:100})}),[wn,un,cn]),Rn=(0,s.useCallback)((e=>{if(e)if(e.refresh)wn({silent:!0,limit:100});else if(e.contactId){if(!("number"===typeof e.unreadCount&&!Number.isNaN(e.unreadCount)))return;const t=an.current,n=dn(e.contactId),s="number"===typeof(null===n||void 0===n?void 0:n.localUnread)?n.localUnread:null;B((n=>n.map((n=>{if(n.contactId!==e.contactId)return n;const i=!!t&&(t.id&&n.id===t.id||t.contactId&&n.contactId===t.contactId||t.contactPhone&&n.contactPhone===t.contactPhone);if("number"===typeof s){const t=e.unreadCount>0?Math.max(s,1):0;return i||t===s||cn(n,t),(0,l.A)((0,l.A)({},n),{},{unreadCount:i?0:t})}return(0,l.A)((0,l.A)({},n),{},{unreadCount:i?0:e.unreadCount})}))))}else if(Array.isArray(e.items)){const t=new Map;if(e.items.forEach((e=>{null!==e&&void 0!==e&&e.contactId&&"number"===typeof e.unreadCount&&t.set(e.contactId,e.unreadCount)})),0===t.size)return;const n=an.current;B((e=>e.map((e=>{if(!t.has(e.contactId))return e;const s=t.get(e.contactId),i=un(e),a=!!n&&(n.id&&e.id===n.id||n.contactId&&e.contactId===n.contactId||n.contactPhone&&e.contactPhone===n.contactPhone);if("number"===typeof i){const t=s>0?Math.max(i,1):0;return a||t===i||cn(e,t),(0,l.A)((0,l.A)({},e),{},{unreadCount:a?0:t})}return(0,l.A)((0,l.A)({},e),{},{unreadCount:a?0:s})}))))}}),[wn,dn,un,cn]),Mn=(0,s.useCallback)((e=>{var t,n,s,i,a,o,r,d,c,u;if(!e)return;const m=an.current;if(!m)return;const v=null!==(t=null!==(n=e.contactId)&&void 0!==n?n:e.ContactId)&&void 0!==t?t:null;if(v&&m.contactId&&m.contactId!==v)return;const g=null!==(s=null!==(i=e.messageLogId)&&void 0!==i?i:e.MessageLogId)&&void 0!==s?s:null,x=null!==(a=null!==(o=e.providerMessageId)&&void 0!==o?o:e.ProviderMessageId)&&void 0!==a?a:null,h=null!==(r=null!==(d=e.messageId)&&void 0!==d?d:e.MessageId)&&void 0!==r?r:null,p=null!==(c=null!==(u=e.status)&&void 0!==u?u:e.Status)&&void 0!==c?c:null;if(!p)return;const f=e=>{const t=String(e||"").trim().toLowerCase();return t?"failed"===t||"error"===t||t.includes("fail")?99:"read"===t||"seen"===t||"viewed"===t||t.includes("read")?4:"delivered"===t||t.includes("deliver")?3:"sent"===t?2:"queued"===t||"sending"===t||"pending"===t||t.includes("queue")||t.includes("send")||t.includes("progress")?1:0:0};ee((e=>e.map((e=>{const t=!!g&&(e.id===g||e.serverId===g),n=!!x&&(e.providerMessageId===x||e.messageId===x||e.id===x),s=!!h&&(e.messageId===h||e.id===h);if(!(t||n||s))return e;const i=f(e.status);return f(p)<i?e:(0,l.A)((0,l.A)({},e),{},{status:p})}))))}),[]);(0,s.useEffect)((()=>{if(T&&L)return T.on("ReceiveInboxMessage",Cn),T.on("UnreadCountChanged",Rn),T.on("MessageStatusChanged",Mn),()=>{T.off("ReceiveInboxMessage",Cn),T.off("UnreadCountChanged",Rn),T.off("MessageStatusChanged",Mn)}}),[T,L,Cn,Rn,Mn]);const kn=async e=>{var t,n,s,i,o,d,c,u,m,v,g,x,h,p,f,b,w;if(!sn)return void a.oR.warn("Please select a conversation first.");if(xn)return void a.oR.warn("This conversation is closed. Reopen it to reply.");if(!gn)return void a.oR.warn("This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.");const I=null!==(t=null!==(n=null===e||void 0===e?void 0:e.mediaId)&&void 0!==n?n:null===e||void 0===e?void 0:e.MediaId)&&void 0!==t?t:null,S=null!==(s=null!==(i=null===e||void 0===e?void 0:e.mediaType)&&void 0!==i?i:null===e||void 0===e?void 0:e.MediaType)&&void 0!==s?s:null,A=null!==(o=null!==(d=null===e||void 0===e?void 0:e.fileName)&&void 0!==d?d:null===e||void 0===e?void 0:e.FileName)&&void 0!==o?o:null,C=null!==(c=null!==(u=null===e||void 0===e?void 0:e.mimeType)&&void 0!==u?u:null===e||void 0===e?void 0:e.MimeType)&&void 0!==c?c:null,R=null!==(m=null===e||void 0===e?void 0:e.localPreviewUrl)&&void 0!==m?m:null,M=null!==(v=null!==(g=null===e||void 0===e?void 0:e.locationLatitude)&&void 0!==g?g:null===e||void 0===e?void 0:e.LocationLatitude)&&void 0!==v?v:null,k=null!==(x=null!==(h=null===e||void 0===e?void 0:e.locationLongitude)&&void 0!==h?h:null===e||void 0===e?void 0:e.LocationLongitude)&&void 0!==x?x:null,T=null!==(p=null!==(f=null===e||void 0===e?void 0:e.locationName)&&void 0!==f?f:null===e||void 0===e?void 0:e.LocationName)&&void 0!==p?p:null,L=null!==(b=null!==(w=null===e||void 0===e?void 0:e.locationAddress)&&void 0!==w?w:null===e||void 0===e?void 0:e.LocationAddress)&&void 0!==b?b:null,P="string"===typeof(null===e||void 0===e?void 0:e.text)?e.text:"string"===typeof(null===e||void 0===e?void 0:e.Text)?e.Text:X,D=String(P||"").trim(),U=Boolean(String(I||"").trim()),E=N(M),F=j(k),O=null!==E&&null!==F;if(O&&(U||D))return void a.oR.error("Location message cannot include text or an attachment.");if(!U&&!D&&!O)return void a.oR.warn("Type a message before sending.");const W=O?"location":String(S||"").trim().toLowerCase()||(U?y(C):"");if(U&&"audio"===W&&D)return void a.oR.error("Audio messages do not support captions.");const q=localStorage.getItem("businessId");if(!q)return void a.oR.error("Missing business context. Please login again.");if(de)return;const z="temp-".concat(Date.now()),_=(new Date).toISOString();R&&At.current.set(z,R);const V={id:z,clientMessageId:z,direction:"out",isInbound:!1,text:D,mediaId:U?String(I).trim():null,mediaType:O?"location":U?W:null,fileName:U?A:null,mimeType:U?C:null,localPreviewUrl:U?R:null,locationLatitude:O?E:null,locationLongitude:O?F:null,locationName:O?T:null,locationAddress:O?L:null,sentAt:_,status:"Queued",errorMessage:null};ee((e=>[...e,V])),Z(""),ce(!0);try{var K,H,Q,Y,G,$,J,te,ne,le,se,ie,ae,oe,re,ue;const e={businessId:q,conversationId:sn.id,contactId:sn.contactId,to:sn.contactPhone,text:O?null:D||null,mediaId:U?String(I).trim():null,mediaType:O?"location":U?W:null,fileName:U?A:null,mimeType:U?C:null,locationLatitude:O?E:null,locationLongitude:O?F:null,locationName:O?T:null,locationAddress:O?L:null,numberId:sn.numberId,clientMessageId:z},t=(await r.post("/chat-inbox/send-message",e)).data||{},n=t.sentAtUtc||t.sentAt||V.sentAt,s=n instanceof Date?n.toISOString():n,i=(e=>{const t=String(e||"").trim().toLowerCase();return t?t.includes("fail")||t.includes("error")||t.includes("reject")?"Failed":t.includes("read")||"seen"===t||"viewed"===t?"Read":t.includes("deliver")?"Delivered":"sent"===t?"Sent":(t.includes("queue")||"queued"===t||t.includes("send")||"sending"===t||"pending"===t||t.includes("accept")||t.includes("submit")||t.includes("process")||t.includes("progress"),"Queued"):null})(t.status)||"Queued",a=null!==(K=null!==(H=t.mediaId)&&void 0!==H?H:t.MediaId)&&void 0!==K?K:null,o=null!==(Q=null!==(Y=t.mediaType)&&void 0!==Y?Y:t.MediaType)&&void 0!==Q?Q:null,d=null!==(G=null!==($=t.fileName)&&void 0!==$?$:t.FileName)&&void 0!==G?G:null,c=null!==(J=null!==(te=t.mimeType)&&void 0!==te?te:t.MimeType)&&void 0!==J?J:null,u=null!==(ne=null!==(le=t.locationLatitude)&&void 0!==le?le:t.LocationLatitude)&&void 0!==ne?ne:null,m=null!==(se=null!==(ie=t.locationLongitude)&&void 0!==ie?ie:t.LocationLongitude)&&void 0!==se?se:null,v=null!==(ae=null!==(oe=t.locationName)&&void 0!==oe?oe:t.LocationName)&&void 0!==ae?ae:null,g=null!==(re=null!==(ue=t.locationAddress)&&void 0!==ue?ue:t.LocationAddress)&&void 0!==re?re:null;ee((e=>e.map((e=>{var n,r,x,h,p,f,b,y,w,N,j,I,S;return e.id===z?(0,l.A)((0,l.A)({},e),{},{id:e.id,serverId:null!==(n=t.id)&&void 0!==n?n:null,messageId:null!==(r=null!==(x=null!==(h=null!==(p=t.messageId)&&void 0!==p?p:t.wamid)&&void 0!==h?h:t.waMessageId)&&void 0!==x?x:t.providerMessageId)&&void 0!==r?r:null,sentAt:s,status:i,errorMessage:t.errorMessage||null,mediaId:null!==(f=null!==a&&void 0!==a?a:e.mediaId)&&void 0!==f?f:null,mediaType:null!==(b=null!==o&&void 0!==o?o:e.mediaType)&&void 0!==b?b:null,fileName:null!==(y=null!==d&&void 0!==d?d:e.fileName)&&void 0!==y?y:null,mimeType:null!==(w=null!==c&&void 0!==c?c:e.mimeType)&&void 0!==w?w:null,locationLatitude:null!==(N=null!==u&&void 0!==u?u:e.locationLatitude)&&void 0!==N?N:null,locationLongitude:null!==(j=null!==m&&void 0!==m?m:e.locationLongitude)&&void 0!==j?j:null,locationName:null!==(I=null!==v&&void 0!==v?v:e.locationName)&&void 0!==I?I:null,locationAddress:null!==(S=null!==g&&void 0!==g?g:e.locationAddress)&&void 0!==S?S:null}):e}))));const x=D||(O?String(T||"").trim()||"Location":U?"document"===W?"PDF sent".concat(A?": ".concat(A):""):"video"===W?"Video sent".concat(A?": ".concat(A):""):"audio"===W?"Audio sent".concat(A?": ".concat(A):""):"Image sent".concat(A?": ".concat(A):""):"");B((e=>e.map((e=>e.id===sn.id?(0,l.A)((0,l.A)({},e),{},{lastMessagePreview:x,lastMessageAt:s,lastOutboundAt:s}):e))))}catch(ge){var me,ve;console.error("\u274c Failed to send message:",ge),a.oR.error((null===(me=ge.response)||void 0===me||null===(ve=me.data)||void 0===ve?void 0:ve.message)||"Failed to send message. Please retry."),ee((e=>e.map((e=>e.id===z?(0,l.A)((0,l.A)({},e),{},{status:"Failed",errorMessage:"Not delivered"}):e))))}finally{ce(!1),nn()}};(0,s.useEffect)((()=>{const e=Array.isArray(J)?J.slice(-8):[];for(const t of e){const e=String((null===t||void 0===t?void 0:t.mediaId)||"").trim();if(!e)continue;const n=String((null===t||void 0===t?void 0:t.mediaType)||"").trim().toLowerCase();"image"!==n&&"video"!==n&&"audio"!==n||(null!==t&&void 0!==t&&t.localPreviewUrl||jt.current.has(e)||Qt(e,{silent:!0}))}}),[J,Qt]),(0,s.useEffect)((()=>{const e=Array.isArray(J)?J.slice(-4):[];for(const t of e){const e=String((null===t||void 0===t?void 0:t.mediaId)||"").trim();if(!e)continue;if("document"!==String((null===t||void 0===t?void 0:t.mediaType)||"").trim().toLowerCase())continue;const n=(null===t||void 0===t?void 0:t.localPreviewUrl)||null,l="string"===typeof(null===t||void 0===t?void 0:t.id)&&String(t.id).startsWith("temp-");tn(e,{localPreviewUrl:n,skipRemote:l&&!n})}}),[J,tn]);const Tn=()=>{tt||et({open:!1,type:null,id:null,title:""})},Ln=(null!==(u=null!==(m=null!==(w=null===we||void 0===we?void 0:we.tags)&&void 0!==w?w:null===we||void 0===we?void 0:we.contactTags)&&void 0!==m?m:null===we||void 0===we?void 0:we.contactTagsDto)&&void 0!==u?u:[])||[],Pn=null!==(A=null===we||void 0===we?void 0:we.recentNotes)&&void 0!==A?A:[],Dn=null!==(R=null===we||void 0===we?void 0:we.nextReminder)&&void 0!==R?R:null,Un=null!==(M=null===we||void 0===we?void 0:we.recentTimeline)&&void 0!==M?M:[];return{activeTab:P,allConversations:W,closeConfirm:Tn,confirmBusy:tt,confirmState:Je,connection:T,contactSummary:we,conversationsHasMore:K,conversationsNextCursor:_,conversationsRef:on,currentUserId:ln,editNoteContent:We,editReminderDescription:Ge,editReminderDueAt:Qe,editReminderTitle:Ke,editingNoteId:Fe,editingReminderId:_e,executeDelete:async()=>{if(null!==Je&&void 0!==Je&&Je.id&&null!==Je&&void 0!==Je&&Je.type){nt(!0);try{"note"===Je.type?(await r.delete("/notes/".concat(Je.id)),a.oR.info("Note deleted.")):"reminder"===Je.type&&(await r.delete("/reminders/".concat(Je.id)),a.oR.info("Reminder deleted.")),await In()}catch(n){var e,t;console.error("Delete failed:",n),a.oR.error((null===(e=n.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.message)||"Delete failed.")}finally{nt(!1),Tn()}}},fetchConversations:wn,fetchConversationsPage:yn,filteredConversations:bn,agents:pe,isAgentsLoading:be,handleAddNote:async()=>{if(!sn||!vn)return void a.oR.warn("Select a conversation with a linked contact to add notes.");const e=Se.trim();if(!e)return void a.oR.warn("Type something for the note before saving.");if(Ce)return;const t=e.length>50?"".concat(e.substring(0,50),"\u2026"):e,n={contactId:vn,title:t,content:e,source:"Inbox",createdBy:localStorage.getItem("userName")||localStorage.getItem("email")||"Agent",isPinned:!1,isInternal:!0};Re(!0);try{await r.post("/notes",n),a.oR.success("Note added."),Ae(""),await In()}catch(d){var l,s,i,o;console.error("Failed to add note:",d),a.oR.error((null===(l=d.response)||void 0===l||null===(s=l.data)||void 0===s?void 0:s.message)||(null===(i=d.response)||void 0===i||null===(o=i.data)||void 0===o?void 0:o.title)||"Failed to add note from inbox.")}finally{Re(!1)}},handleAddReminder:async()=>{if(!sn||!vn)return void a.oR.warn("Select a conversation with a linked contact to add reminders.");const e=Me.trim();if(!e)return void a.oR.warn("Enter a reminder title.");if(!Te)return void a.oR.warn("Choose a due date/time for the reminder.");const t=c(Te);if(!t)return void a.oR.error("Invalid reminder date/time.");if(Ue)return;const n={contactId:vn,title:e,description:Pe||"",dueAt:t,reminderType:"FollowUp",priority:2,isRecurring:!1,recurrencePattern:"",sendWhatsappNotification:!1,linkedCampaign:"",status:"Pending",createdBy:localStorage.getItem("userName")||localStorage.getItem("email")||"Agent"};Ee(!0);try{await r.post("/reminders",n),a.oR.success("Reminder added."),ke(""),Le(""),De(""),await In()}catch(d){var l,s,i,o;console.error("Failed to add reminder:",d),a.oR.error((null===(l=d.response)||void 0===l||null===(s=l.data)||void 0===s?void 0:s.message)||(null===(i=d.response)||void 0===i||null===(o=i.data)||void 0===o?void 0:o.title)||"Failed to add reminder from inbox.")}finally{Ee(!1)}},handleAssignToMe:async()=>{if(!sn||!sn.contactId)return void a.oR.warn("Select a conversation before assigning.");const e=localStorage.getItem("businessId"),t=localStorage.getItem("userId");if(e&&t){if(!ve){ge(!0);try{const n={businessId:e,contactId:sn.contactId,userId:t};await r.post("/chat-inbox/assign",n),B((e=>e.map((e=>e.id===sn.id?(0,l.A)((0,l.A)({},e),{},{assignedToUserId:t,assignedToUserName:"You",isAssignedToMe:!0}):e)))),await wn({silent:!0,limit:100}),a.oR.success("Conversation assigned to you.")}catch(i){var n,s;console.error("Failed to assign conversation:",i),a.oR.error((null===(n=i.response)||void 0===n||null===(s=n.data)||void 0===s?void 0:s.message)||"Failed to assign conversation.")}finally{ge(!1)}}}else a.oR.error("Missing business or user context. Please login again.")},handleAssignToAgent:async e=>{if(!sn||!sn.contactId)return void a.oR.warn("Select a conversation before assigning.");const t=localStorage.getItem("businessId");if(!t)return void a.oR.error("Missing business context. Please login again.");const n=String(null!==e&&void 0!==e?e:"").trim();if(n){if(!ve){ge(!0);try{var s,i;const e={businessId:t,contactId:sn.contactId,userId:n};await r.post("/chat-inbox/assign",e);const o=localStorage.getItem("userId"),d=null!==(s=null===(i=pe.find((e=>String(e.userId)===String(n))))||void 0===i?void 0:i.name)&&void 0!==s?s:"Agent";B((e=>e.map((e=>e.id===sn.id?(0,l.A)((0,l.A)({},e),{},{assignedToUserId:n,assignedToUserName:o&&String(o)===String(n)?"You":d,isAssignedToMe:o&&String(o)===String(n)}):e)))),await wn({silent:!0,limit:100});const c="history"===P?"older":P;"unassigned"!==c&&"my"!==c||$(null),a.oR.success("Conversation assigned.")}catch(c){var o,d;console.error("Failed to assign conversation:",c),a.oR.error((null===(o=c.response)||void 0===o||null===(d=o.data)||void 0===d?void 0:d.message)||"Failed to assign conversation.")}finally{ge(!1)}}}else a.oR.error("Select a valid agent to assign.")},handleComposerKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),!de&&X.trim()&&kn())},handleOpenFullCrm:()=>{sn?vn?k("/app/crm/contacts/".concat(vn)):a.oR.info("No contact is linked to this conversation yet."):a.oR.info("Select a conversation first to open full CRM.")},handleReceiveInboxMessage:Cn,handleRemoveTag:Sn,handleSendMessage:kn,handleUploadAndSendMedia:async e=>{if(!e)return;if(!sn)return void a.oR.warn("Please select a conversation first.");if(xn)return void a.oR.warn("This conversation is closed. Reopen it to reply.");if(!gn)return void a.oR.warn("This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.");if(ue||de)return;if(!localStorage.getItem("businessId"))return void a.oR.error("Missing business context. Please login again.");const t=Number(e.size)||0;if(!t)return void a.oR.error("Selected file is empty.");if(t>f)return void a.oR.error("File is too large. Max allowed is 10MB.");const n=(()=>{const t=String(e.type||"").split(";")[0].trim();if(t)return t;const n=String(e.name||"").toLowerCase().trim();return n.endsWith(".pdf")?"application/pdf":n.endsWith(".mp4")?"video/mp4":n.endsWith(".3gp")||n.endsWith(".3gpp")?"video/3gpp":n.endsWith(".mp3")?"audio/mpeg":n.endsWith(".m4a")?"audio/mp4":n.endsWith(".aac")?"audio/aac":n.endsWith(".ogg")?"audio/ogg":""})();if(!b.has(n))return void a.oR.error("Unsupported file type. Allowed: images (jpg/png/webp), PDF, MP4 video, and audio (mp3/m4a/aac/ogg).");me(!0);let l=null,s=!1;try{var i,o,d,c,u,m,v,g,x;try{"undefined"!==typeof URL&&"function"===typeof URL.createObjectURL&&(l=URL.createObjectURL(e))}catch(w){l=null}const t=new FormData;t.append("file",e);const h=await r.post("/chat-inbox/media/upload",t,{headers:{"Content-Type":"multipart/form-data"}}),p=(null===h||void 0===h?void 0:h.data)||{},f=null!==(i=null!==(o=p.mediaId)&&void 0!==o?o:p.MediaId)&&void 0!==i?i:null,b=null!==(d=null!==(c=p.mediaType)&&void 0!==c?c:p.MediaType)&&void 0!==d?d:null;if(!f)return void a.oR.error("Upload succeeded but mediaId was missing.");const N=String(b||"").trim().toLowerCase()||y(n);s=!0,await kn({text:X,mediaId:f,mediaType:N,fileName:null!==(u=null!==(m=null!==(v=p.fileName)&&void 0!==v?v:p.FileName)&&void 0!==m?m:e.name)&&void 0!==u?u:null,mimeType:null!==(g=null!==(x=p.mimeType)&&void 0!==x?x:p.MimeType)&&void 0!==g?g:n,localPreviewUrl:l})}catch(N){var h,p;console.error("\u274c Failed to upload media:",N),a.oR.error((null===(h=N.response)||void 0===h||null===(p=h.data)||void 0===p?void 0:p.message)||"Failed to upload file. Please retry.")}finally{if(l&&!s)try{URL.revokeObjectURL(l)}catch(j){}me(!1)}},handleSendLocation:async()=>{if(sn)if(xn)a.oR.warn("This conversation is closed. Reopen it to reply.");else if(gn){if(!ue&&!de)if("undefined"!==typeof navigator&&navigator.geolocation){a.oR.info("Fetching your current location\u2026");try{var e,t;const n=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:12e3,maximumAge:0})})),l=null===n||void 0===n||null===(e=n.coords)||void 0===e?void 0:e.latitude,s=null===n||void 0===n||null===(t=n.coords)||void 0===t?void 0:t.longitude;if(!Number.isFinite(l)||!Number.isFinite(s))return void a.oR.error("Failed to read your coordinates.");await kn({locationLatitude:l,locationLongitude:s,locationName:null,locationAddress:null})}catch(n){const e=null===n||void 0===n?void 0:n.code;1===e?a.oR.error("Location permission denied."):2===e?a.oR.error("Location unavailable."):3===e?a.oR.error("Location request timed out."):a.oR.error("Failed to fetch location.")}}else a.oR.error("Geolocation is not available in this browser.")}else a.oR.warn("This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.");else a.oR.warn("Please select a conversation first.")},handleOpenMedia:Gt,handleCloseMediaViewer:$t,ensureImagePreview:en,ensurePdfPreview:tn,handleUnassign:async()=>{if(!sn||!sn.contactId)return void a.oR.warn("Select a conversation before unassigning.");const e=localStorage.getItem("businessId");if(e){if(!ve){ge(!0);try{const t={businessId:e,contactId:sn.contactId};await r.post("/chat-inbox/unassign",t),B((e=>e.map((e=>e.id===sn.id?(0,l.A)((0,l.A)({},e),{},{assignedToUserId:null,assignedToUserName:null,isAssignedToMe:!1}):e)))),await wn({silent:!0,limit:100});"my"===("history"===P?"older":P)&&$(null),a.oR.info("Conversation unassigned.")}catch(s){var t,n;console.error("Failed to unassign conversation:",s),a.oR.error((null===(t=s.response)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.message)||"Failed to unassign conversation.")}finally{ge(!1)}}}else a.oR.error("Missing business context. Please login again.")},handleUnreadCountChanged:Rn,handleUpdateConversationStatus:async e=>{if(!sn||!sn.contactId)return void a.oR.warn("Select a conversation before updating status.");if(!pn)return void a.oR.error("Not allowed to update this conversation.");const t=localStorage.getItem("businessId");if(!t)return void a.oR.error("Missing business context. Please login again.");const n=g(e);if(!n)return void a.oR.error("Invalid status. Use Open, Pending, or Closed.");if(xe)return;const s="history"===P?"older":P;he(!0);try{const e={businessId:t,contactId:sn.contactId,status:n};try{await r.post("/chat-inbox/set-status",e)}catch(c){var i;if(404!==(null===c||void 0===c||null===(i=c.response)||void 0===i?void 0:i.status))throw c;await r.post("/chat-inbox/status",e)}B((e=>e.map((e=>e.id===sn.id?(0,l.A)((0,l.A)({},e),{},{status:n}):e)))),("closed"===s&&"Closed"!==n||"closed"!==s&&"Closed"===n)&&$(null),await wn({silent:!0,limit:100}),a.oR.success("Status updated.")}catch(u){var o,d;console.error("Failed to update status:",u),a.oR.error((null===(o=u.response)||void 0===o||null===(d=o.data)||void 0===d?void 0:d.message)||"Failed to update status.")}finally{he(!1)}},handleUpdateNote:async e=>{var t;if(null===e||void 0===e||!e.id)return;const n=We.trim();if(!n)return void a.oR.warn("Note content cannot be empty.");if(!vn)return;if(qe)return;const l=n.length>50?"".concat(n.substring(0,50),"\u2026"):n,s={contactId:vn,title:l,content:n,source:e.source||"Inbox",createdBy:localStorage.getItem("userName")||localStorage.getItem("email")||"Agent",isPinned:!!e.isPinned,isInternal:null===(t=e.isInternal)||void 0===t||t};ze(!0);try{await r.put("/notes/".concat(e.id),s),a.oR.success("Note updated."),Oe(null),Be(""),await In()}catch(d){var i,o;console.error("Failed to update note:",d),a.oR.error((null===(i=d.response)||void 0===i||null===(o=i.data)||void 0===o?void 0:o.message)||"Failed to update note.")}finally{ze(!1)}},handleUpdateReminder:async e=>{var t;if(null===e||void 0===e||!e.id)return;if(!vn)return;const n=Ke.trim();if(!n)return void a.oR.warn("Reminder title cannot be empty.");const l=c(Qe);if(!l)return void a.oR.warn("Pick a valid due date/time.");if(Xe)return;const s={contactId:vn,title:n,description:Ge||"",dueAt:l,status:e.status||"Pending",reminderType:e.reminderType||"FollowUp",priority:null!==(t=e.priority)&&void 0!==t?t:2,isRecurring:!!e.isRecurring,recurrencePattern:e.recurrencePattern||"",sendWhatsappNotification:!!e.sendWhatsappNotification,linkedCampaign:e.linkedCampaign||"",createdBy:localStorage.getItem("userName")||localStorage.getItem("email")||"Agent"};Ze(!0);try{await r.put("/reminders/".concat(e.id),s),a.oR.success("Reminder updated."),Ve(null),He(""),Ye(""),$e(""),await In()}catch(d){var i,o;console.error("Failed to update reminder:",d),a.oR.error((null===(i=d.response)||void 0===i||null===(o=i.data)||void 0===o?void 0:o.message)||"Failed to update reminder.")}finally{Ze(!1)}},headerAssignedName:fn,headerIsAssigned:hn,headerIsAssignedToMe:pn,isAssigning:ve,isConnected:L,isLoading:q,isConversationsLoadingMore:Q,isMessagesLoading:te,isMessagesLoadingOlder:oe,isSavingNote:Ce,isSavingReminder:Ue,isSending:de,isUploadingMedia:ue,isSummaryLoading:je,isTagModalOpen:lt,isUpdatingStatus:xe,isUpdatingNote:qe,isUpdatingReminder:Xe,isWithin24h:gn,isConversationClosed:xn,messages:J,messagesEndRef:xt,messagesHasMore:ie,messagesNextCursor:le,fetchMessagesPage:jn,messagesWithSeparators:An,navigate:k,newMessage:X,nextReminder:Dn,noteDraft:Se,openDeleteConfirm:(e,t)=>{et({open:!0,type:e,id:(null===t||void 0===t?void 0:t.id)||null,title:"note"===e?"Delete note?":"Delete reminder?"})},recentNotes:Pn,recentTimeline:Un,refreshContactSummary:In,reminderDescription:Pe,reminderDueAt:Te,reminderTitle:Me,removingTagId:it,scrollToBottom:nn,searchTerm:F,selectedContactId:vn,selectedConversation:sn,selectedConversationId:G,selectedConversationRef:an,selectedNumberId:U,setActiveTab:D,setAllConversations:B,setConfirmBusy:nt,setConfirmState:et,setContactSummary:Ne,setEditNoteContent:Be,setEditReminderDescription:$e,setEditReminderDueAt:Ye,setEditReminderTitle:He,setEditingNoteId:Oe,setEditingReminderId:Ve,setIsAssigning:ge,setIsLoading:z,setIsMessagesLoading:ne,setIsSavingNote:Re,setIsSavingReminder:Ee,setIsSending:ce,setIsUploadingMedia:me,setIsSummaryLoading:Ie,setIsTagModalOpen:st,setIsUpdatingNote:ze,setIsUpdatingReminder:Ze,setMessages:ee,setNewMessage:Z,setNoteDraft:Ae,setReminderDescription:De,setReminderDueAt:Le,setReminderTitle:ke,setRemovingTagId:at,setSearchTerm:O,setSelectedConversationId:$,setSelectedNumberId:E,setShowCrmPanel:mt,setShowDetails:ct,setShowMiniTimeline:gt,setShowRightPanel:rt,showCrmPanel:ut,showDetails:dt,showMiniTimeline:vt,showRightPanel:ot,tagsList:Ln,mediaObjectUrlById:Ct,pdfPreviewById:Mt,mediaViewer:Tt,handleMediaViewerPrev:Zt,handleMediaViewerNext:Jt,handleMediaViewerSelectIndex:Xt}}var M=n(40614),k=n(70579);function T(e){let{open:t,title:n,message:l,confirmText:s="Confirm",cancelText:i="Cancel",danger:a=!1,loading:o=!1,onConfirm:r,onCancel:d}=e;return t?(0,k.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:(0,k.jsxs)("div",{className:"w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl",children:[(0,k.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,k.jsxs)("div",{children:[(0,k.jsx)("h3",{className:"text-sm font-semibold text-slate-900",children:n}),(0,k.jsx)("p",{className:"mt-1 text-xs text-slate-600",children:l})]}),(0,k.jsx)("button",{type:"button",onClick:d,className:"rounded-lg p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600",children:(0,k.jsx)(M.A,{className:"h-4 w-4"})})]}),(0,k.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,k.jsx)("button",{type:"button",onClick:d,disabled:o,className:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60",children:i}),(0,k.jsx)("button",{type:"button",onClick:r,disabled:o,className:"rounded-lg px-3 py-1.5 text-xs font-semibold text-white disabled:opacity-60 ".concat(a?"bg-rose-600 hover:bg-rose-700":"bg-emerald-600 hover:bg-emerald-700"),children:o?"Working\u2026":s})]})]})}):null}function L(e){let{isOpen:t,onClose:n,contactId:l,currentTags:i,onTagAdded:o}=e;const[d,c]=s.useState([]),[u,m]=s.useState(""),[v,g]=s.useState(!1),[x,h]=s.useState(!1);s.useEffect((()=>{if(!t)return;(async()=>{try{var e;g(!0);const t=await r.get("/tags/get-tags"),n=(null===(e=t.data)||void 0===e?void 0:e.data)||t.data||[],l=new Set((i||[]).map((e=>e.id||e.tagId))),s=n.filter((e=>!l.has(e.id)));c(s),m(s.length>0?s[0].id:"")}catch(t){console.error("Failed to load tags for Inbox:",t),a.oR.error("Failed to load tags"),c([])}finally{g(!1)}})()}),[t,i]);return t?(0,k.jsx)("div",{className:"fixed inset-0 z-40 flex items-center justify-center bg-black/40",children:(0,k.jsxs)("div",{className:"w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl",children:[(0,k.jsx)("h2",{className:"mb-3 text-sm font-semibold text-slate-900",children:"Add tag to this contact"}),v?(0,k.jsx)("p",{className:"text-xs text-slate-500",children:"Loading tags\u2026"}):0===d.length?(0,k.jsxs)("div",{className:"space-y-3",children:[(0,k.jsx)("p",{className:"text-xs text-slate-500",children:"No new tags available. Create tags in the CRM workspace first, or this contact already has all tags."}),(0,k.jsx)("div",{className:"flex justify-end pt-1",children:(0,k.jsx)("button",{type:"button",onClick:n,className:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50",children:"Close"})})]}):(0,k.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),u)if(l)try{h(!0),await r.post("/contacts/bulk-assign-tag",{contactIds:[l],tagId:u}),a.oR.success("Tag added to this contact"),o&&o(),n()}catch(i){var t,s;console.error("Failed to assign tag from Inbox:",i);const e=(null===(t=i.response)||void 0===t||null===(s=t.data)||void 0===s?void 0:s.message)||"Failed to assign tag";a.oR.error(e)}finally{h(!1)}else a.oR.error("No contact selected.");else a.oR.warn("Select a tag to add.")},className:"space-y-4",children:[(0,k.jsxs)("div",{children:[(0,k.jsx)("label",{className:"mb-1 block text-xs font-medium text-slate-600",children:"Select tag"}),(0,k.jsx)("select",{className:"w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500",value:u,onChange:e=>m(e.target.value),disabled:x,children:d.map((e=>(0,k.jsx)("option",{value:e.id,children:e.name||e.tagName||"Tag"},e.id)))})]}),(0,k.jsxs)("div",{className:"flex justify-end gap-2 pt-1",children:[(0,k.jsx)("button",{type:"button",onClick:n,disabled:x,className:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50",children:"Cancel"}),(0,k.jsx)("button",{type:"submit",disabled:x||0===d.length,className:"rounded-lg bg-emerald-600 px-4 py-1.5 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",children:x?"Adding\u2026":"Add tag"})]})]})]})}):null}var P=n(91286),D=n(34537),U=n(92382),E=n(39292),F=n(2580);function O(e){var t,n,l,s;const i=Number(null!==(t=null===e||void 0===e?void 0:e.optStatus)&&void 0!==t?t:null===e||void 0===e||null===(n=e.contact)||void 0===n?void 0:n.optStatus),a=Number(null!==(l=null===e||void 0===e?void 0:e.channelStatus)&&void 0!==l?l:null===e||void 0===e||null===(s=e.contact)||void 0===s?void 0:s.channelStatus),o=[];return 2===i&&o.push({key:"opted-out",label:"Opted out",className:"border-amber-200 bg-amber-50 text-amber-700"}),2===a?o.push({key:"invalid",label:"Invalid",className:"border-rose-200 bg-rose-50 text-rose-700"}):1===a&&o.push({key:"blocked",label:"Blocked",className:"border-orange-200 bg-orange-50 text-orange-700"}),o}function W(e){let{conv:t,isSelected:n,onClick:l}=e;return(0,k.jsxs)("button",{type:"button",onClick:l,className:"w-full flex items-start gap-3 px-3 py-2.5 text-left border-b border-slate-100 hover:bg-white transition ".concat(n?"bg-white":"bg-slate-50"),children:[(0,k.jsxs)("div",{className:"relative",children:[(0,k.jsx)("div",{className:"w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700",children:m(t.contactName,t.contactPhone)}),t.unreadCount>0&&(0,k.jsx)("span",{className:"absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-semibold rounded-full px-1.5 py-[1px]",children:t.unreadCount})]}),(0,k.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,k.jsxs)("div",{className:"flex items-center justify-between mb-0.5",children:[(0,k.jsxs)("div",{className:"flex flex-col",children:[(0,k.jsxs)("div",{className:"flex items-center gap-1.5 min-w-0",children:[(0,k.jsx)("span",{className:"text-xs font-semibold text-slate-800 truncate",children:t.contactName||t.contactPhone||"Unknown"}),O(t).map((e=>(0,k.jsx)("span",{className:"inline-flex items-center rounded-full border px-1.5 py-[1px] text-[9px] font-medium ".concat(e.className),children:e.label},e.key)))]}),(0,k.jsx)("span",{className:"text-[10px] text-slate-400",children:t.contactPhone})]}),(0,k.jsx)("span",{className:"text-[10px] text-slate-400 ml-2",children:t.lastMessageAt?new Date(t.lastMessageAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"-"})]}),(0,k.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,k.jsx)("p",{className:"text-[11px] text-slate-600 truncate pr-4",children:t.lastMessagePreview||"No recent message"}),(0,k.jsxs)("div",{className:"flex flex-col items-end gap-0.5",children:[(0,k.jsx)("span",{className:"text-[9px] px-1.5 py-[1px] rounded-full border ".concat(t.within24h?"bg-emerald-50 text-emerald-700 border-emerald-100":"bg-slate-50 text-slate-500 border-slate-200"),children:t.within24h?"24h window":"Outside 24h"}),t.assignedToUserName&&(0,k.jsx)("span",{className:"text-[9px] text-slate-400",children:t.assignedToUserName})]})]})]})]})}const B=[{id:"all",label:"All numbers"},{id:"wa-1",label:"+91 98765 43210"},{id:"wa-2",label:"+91 99887 77665"}],q=[{id:"live",label:"Live"},{id:"unassigned",label:"Unassigned"},{id:"my",label:"My"},{id:"closed",label:"Closed"},{id:"history",label:"History"}];function z(e){let{activeTab:t,setActiveTab:n,selectedNumberId:l,setSelectedNumberId:s,searchTerm:i,setSearchTerm:a,filteredConversations:o,isLoading:r,conversationsHasMore:d,isConversationsLoadingMore:c,onLoadMoreConversations:u,selectedConversationId:m,setSelectedConversationId:v,isConnected:g}=e;return(0,k.jsxs)("div",{className:"w-[360px] border-r border-slate-200 flex flex-col",children:[(0,k.jsxs)("div",{className:"px-4 py-3 border-b border-slate-200 bg-white flex flex-col gap-3",children:[(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)(P.A,{className:"w-4 h-4 text-emerald-600"}),(0,k.jsx)("span",{className:"text-sm font-semibold text-slate-800",children:"Chat Inbox"}),(0,k.jsxs)("span",{className:"ml-auto inline-flex items-center gap-1 text-[10px] text-slate-500",children:[(0,k.jsx)(D.A,{className:"w-3 h-3 ".concat(g?"text-emerald-500":"text-slate-400")}),g?"Live":"Offline"]})]}),(0,k.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,k.jsxs)("div",{className:"relative",children:[(0,k.jsx)("select",{value:l,onChange:e=>s(e.target.value),className:"appearance-none bg-slate-50 border border-slate-200 text-xs rounded-full pl-3 pr-7 py-1.5 text-slate-700 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500",children:B.map((e=>(0,k.jsx)("option",{value:e.id,children:e.label},e.id)))}),(0,k.jsx)(U.A,{className:"w-3 h-3 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none"})]}),(0,k.jsxs)("div",{className:"flex-1 flex items-center bg-slate-50 border border-slate-200 rounded-full px-2",children:[(0,k.jsx)(E.A,{className:"w-3.5 h-3.5 text-slate-400 mr-1"}),(0,k.jsx)("input",{type:"text",placeholder:"Search name, number, message...",value:i,onChange:e=>a(e.target.value),className:"w-full bg-transparent border-none text-xs text-slate-700 focus:outline-none"})]})]}),(0,k.jsxs)("div",{className:"flex items-center gap-3 text-[11px] font-medium",children:[q.map((e=>(0,k.jsx)("button",{type:"button",onClick:()=>n(e.id),className:"pb-1 border-b-2 transition-colors ".concat(t===e.id?"border-emerald-600 text-emerald-700":"border-transparent text-slate-500 hover:text-emerald-600"),children:e.label},e.id))),(0,k.jsxs)("button",{type:"button",className:"ml-auto inline-flex items-center gap-1 text-[11px] text-slate-500 hover:text-slate-700",children:[(0,k.jsx)(F.A,{className:"w-3 h-3"}),"More"]})]})]}),(0,k.jsxs)("div",{className:"relative flex-1 overflow-y-auto bg-slate-50",children:[r&&(0,k.jsx)("div",{className:"absolute inset-0 z-10 bg-slate-50/70 backdrop-blur-[1px] flex justify-center pt-6",children:(0,k.jsx)("div",{className:"text-xs text-slate-500",children:"Loading chats..."})}),!r&&0===o.length&&(0,k.jsx)("div",{className:"p-4 text-xs text-slate-400 italic",children:"No conversations found for this filter."}),o.map((e=>(0,k.jsx)(W,{conv:e,isSelected:m===e.id,onClick:()=>v(e.id)},e.id))),d&&(0,k.jsx)("div",{className:"p-3 flex justify-center",children:(0,k.jsx)("button",{type:"button",onClick:u,disabled:c,className:"w-full rounded-lg border px-3 py-2 text-xs font-medium ".concat(c?"bg-slate-100 text-slate-400 border-slate-200 cursor-wait":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"),children:c?"Loading...":"Load more"})})]})]})}var _=n(7104),V=n(64830),K=n(28006),H=n(9463),Q=n(38326),Y=n(75088),G=n(42574),$=n(35327),X=n(14459),Z=n(76833),J=n(20073),ee=n(57922),te=n(72494),ne=n(65086),le=n(74961),se=n(77819),ie=n(63771);function ae(e){let{status:t,variant:n="onLight"}=e;const l=String(t||"").trim().toLowerCase();if(!l)return null;const s="onDark"===n?{failed:"text-rose-300",read:"text-emerald-300",delivered:"text-white/70",sent:"text-white/70",inFlight:"text-white/70"}:{failed:"text-rose-600",read:"text-emerald-600",delivered:"text-slate-500",sent:"text-slate-500",inFlight:"text-slate-500"};if("failed"===l||"error"===l||l.includes("fail")||l.includes("reject"))return(0,k.jsx)("span",{title:t,className:"inline-flex items-center text-[10px] ".concat(s.failed),children:(0,k.jsx)(se.A,{className:"w-3 h-3"})});if("read"===l||"seen"===l||"viewed"===l||l.includes("read"))return(0,k.jsx)("span",{title:t,className:"inline-flex items-center text-[10px] ".concat(s.read),children:(0,k.jsx)(ie.A,{className:"w-3 h-3"})});if("delivered"===l||l.includes("deliver"))return(0,k.jsx)("span",{title:t,className:"inline-flex items-center text-[10px] ".concat(s.delivered),children:(0,k.jsx)(ie.A,{className:"w-3 h-3"})});if("sent"===l)return(0,k.jsx)("span",{title:t,className:"inline-flex items-center text-[10px] ".concat(s.sent),children:(0,k.jsx)(ie.A,{className:"w-3 h-3"})});"sending"===l||"queued"===l||"pending"===l||l.includes("queue")||l.includes("send")||l.includes("accept")||l.includes("submit")||l.includes("process")||l.includes("progress");return(0,k.jsx)("span",{title:t,className:"inline-flex items-center text-[10px] ".concat(s.inFlight),children:(0,k.jsx)(Y.A,{className:"w-3 h-3"})})}var oe=n(76996),re=n(4717),de=n(71360),ce=n(9855);const ue=(0,n(77784).A)("circle-help",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);function me(e){let{onInsert:t,onClose:n,scope:l="All"}=e;const i=(0,s.useRef)(null),a=(0,s.useRef)(null),o=(0,s.useRef)([]),[d,c]=(0,s.useState)(""),[u,m]=(0,s.useState)([]),[v,g]=(0,s.useState)(!1),[x,h]=(0,s.useState)(-1),[p,f]=(0,s.useState)((()=>l||"All")),b=(0,s.useMemo)((()=>{const e=String(p||"All").toLowerCase();return"business"===e||"personal"===e?e:"all"}),[p]),[y,w]=(0,s.useState)(!1),[N,j]=(0,s.useState)(""),[I,S]=(0,s.useState)(""),[A,C]=(0,s.useState)(""),[R,M]=(0,s.useState)("Personal"),[T,L]=(0,s.useState)(!1),[P,D]=(0,s.useState)(""),[U,F]=(0,s.useState)(null),[O,W]=(0,s.useState)(!1),B=(0,s.useCallback)((async()=>{const e={};d&&(e.q=d),b&&(e.scope=b);const t=await r.get("/quick-replies",{params:e});return Array.isArray(t.data)?t.data:[]}),[d,b]);(0,s.useEffect)((()=>{if(y)return;let e=!1;g(!0);const t=setTimeout((()=>{B().then((t=>{e||(m(t),h(t.length>0?0:-1))})).catch((()=>{e||(m([]),h(-1))})).finally((()=>{e||g(!1)}))}),200);return()=>{clearTimeout(t),e=!0}}),[d,b,y,B]),(0,s.useEffect)((()=>{var e;O&&(null===(e=i.current)||void 0===e||e.focus())}),[O]),(0,s.useEffect)((()=>{y||O||v||a.current&&requestAnimationFrame((()=>{var e;return null===(e=a.current)||void 0===e?void 0:e.focus()}))}),[y,O,v]),(0,s.useEffect)((()=>{const e=o.current[x];e&&"function"===typeof e.scrollIntoView&&e.scrollIntoView({block:"nearest"})}),[x]);const q=(0,s.useCallback)((e=>{e&&"function"===typeof t&&t(e)}),[t]);return(0,k.jsx)("div",{className:"flex flex-col flex-1 min-h-0 overflow-hidden",children:y?(0,k.jsxs)("div",{className:"flex flex-col h-full min-h-0",children:[(0,k.jsxs)("div",{className:"shrink-0 flex items-center gap-2",children:[(0,k.jsx)("div",{className:"text-[12px] font-semibold text-slate-800",children:"New quick reply"}),(0,k.jsx)("div",{className:"flex-1"}),(0,k.jsx)("button",{className:"text-[11px] px-3 py-1.5 rounded-md text-white bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300",onClick:async()=>{if(D(""),N.trim()&&I.trim()){L(!0);try{var e,t;const n={title:N.trim(),body:I,tagsCsv:A.trim()||null,scope:"Business"===R?2:0},l=await r.post("/quick-replies",n),s=!0===(null===l||void 0===l||null===(e=l.data)||void 0===e?void 0:e.success);D(s?"Saved.":(null===l||void 0===l||null===(t=l.data)||void 0===t?void 0:t.message)||"Failed to save."),s&&(j(""),S(""),C(""),w(!1),f(R),c(""))}catch(n){D("Failed to save.")}finally{L(!1)}}else D("Title and message are required.")},type:"button",disabled:T,children:T?"Saving...":"Save"}),(0,k.jsx)("button",{className:"text-[11px] text-slate-500 hover:text-slate-700 px-2 py-1.5",onClick:()=>w(!1),type:"button",disabled:T,children:"Cancel"})]}),(0,k.jsxs)("div",{className:"mt-2 flex-1 min-h-0 overflow-y-auto space-y-2 pr-1",children:[(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)("label",{className:"text-[11px] text-slate-600 w-16",children:"Scope"}),(0,k.jsx)("div",{className:"flex items-center gap-3",children:["Personal","Business"].map((e=>(0,k.jsxs)("label",{className:"text-[11px] flex items-center gap-1",children:[(0,k.jsx)("input",{type:"radio",name:"qr-scope",value:e,checked:R===e,onChange:()=>M(e)}),e]},e)))})]}),(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)("label",{className:"text-[11px] text-slate-600 w-16",children:"Title"}),(0,k.jsx)("input",{className:"flex-1 border border-slate-200 rounded-xl px-2.5 py-2 text-[12px] text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400",value:N,onChange:e=>j(e.target.value),placeholder:"e.g., Greeting (EN)"})]}),(0,k.jsxs)("div",{className:"flex items-start gap-2",children:[(0,k.jsx)("label",{className:"text-[11px] text-slate-600 w-16 mt-2",children:"Body"}),(0,k.jsx)("textarea",{className:"flex-1 border border-slate-200 rounded-xl px-2.5 py-2 text-[12px] text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400 h-24 resize-none",value:I,onChange:e=>S(e.target.value),placeholder:"Type the message..."})]}),(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)("label",{className:"text-[11px] text-slate-600 w-16",children:"Tags"}),(0,k.jsx)("input",{className:"flex-1 border border-slate-200 rounded-xl px-2.5 py-2 text-[12px] text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400",value:A,onChange:e=>C(e.target.value),placeholder:"e.g., greeting,eng"})]}),P&&(0,k.jsx)("div",{className:"text-[11px] px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-700",children:P})]})]}):(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"shrink-0",children:[(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)("div",{className:"inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-1 py-0.5",children:["All","Business","Personal"].map((e=>{const t=p===e;return(0,k.jsx)("button",{type:"button",onClick:()=>f(e),className:"px-2.5 py-1 text-[11px] rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-400/30 ".concat(t?"bg-emerald-600 text-white":"text-slate-700 hover:text-slate-900 hover:bg-slate-50"),children:e},e)}))}),(0,k.jsx)("button",{className:"h-7 w-7 inline-flex items-center justify-center rounded-md border border-slate-200 bg-white text-slate-500 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200 focus:outline-none focus:ring-2 focus:ring-emerald-400/40",onClick:()=>w(!0),type:"button",title:"New quick reply","aria-label":"New quick reply",children:(0,k.jsx)(de.A,{className:"w-4 h-4"})}),(0,k.jsx)("div",{className:"ml-auto flex items-center gap-1",children:(0,k.jsx)("button",{type:"button",className:"h-7 w-7 inline-flex items-center justify-center rounded-md border ".concat(O?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:text-slate-700"),onClick:()=>W((e=>!e)),title:"Search","aria-label":"Search quick replies",children:(0,k.jsx)(E.A,{className:"w-4 h-4"})})})]}),O?(0,k.jsx)("div",{className:"mt-2",children:(0,k.jsx)("input",{ref:i,className:"w-full border border-slate-200 rounded-lg px-2.5 py-1.5 text-[12px] text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400 bg-white",placeholder:"Search saved replies...",value:d,onChange:e=>c(e.target.value),onKeyDown:e=>{if("Escape"===e.key)return e.preventDefault(),e.stopPropagation(),w(!1),void(null===n||void 0===n||n());if(!y){if("ArrowDown"===e.key)return e.preventDefault(),void h((e=>Math.min(e+1,Math.max(0,u.length-1))));if("ArrowUp"===e.key)return e.preventDefault(),void h((e=>Math.max(e-1,-1)));var t;if("Enter"===e.key)if(x>=0&&x<u.length)e.preventDefault(),q(null===(t=u[x])||void 0===t?void 0:t.body),null===n||void 0===n||n()}}})}):null,(0,k.jsx)("div",{className:"mt-2 h-px bg-slate-200/70"}),P?(0,k.jsx)("div",{className:"mt-2 text-[11px] px-2.5 py-2 rounded-lg bg-slate-50 border border-slate-200 text-slate-700",children:P}):null]}),(0,k.jsxs)("div",{className:"flex-1 min-h-0 flex flex-col mt-2 overflow-hidden",children:[(0,k.jsx)("div",{ref:a,tabIndex:0,onKeyDown:e=>{if("Escape"===e.key)return e.preventDefault(),void(null===n||void 0===n||n());if(!y){if("ArrowDown"===e.key)return e.preventDefault(),void h((e=>Math.min(e+1,Math.max(0,u.length-1))));if("ArrowUp"===e.key)return e.preventDefault(),void h((e=>Math.max(e-1,0)));var t;if("Enter"===e.key)if(x>=0&&x<u.length)e.preventDefault(),q(null===(t=u[x])||void 0===t?void 0:t.body),null===n||void 0===n||n()}},className:"flex-1 min-h-0 overflow-y-auto overscroll-contain pr-1 focus:outline-none",children:v?(0,k.jsx)("div",{className:"text-[11px] text-slate-500 p-2",children:"Loading..."}):0===u.length?(0,k.jsxs)("div",{className:"py-6 text-center",children:[(0,k.jsx)("div",{className:"text-[13px] font-semibold text-slate-800",children:"Create your first quick reply"}),(0,k.jsx)("div",{className:"mt-1 text-[12px] text-slate-600",children:"Click + to add one."})]}):(0,k.jsx)("div",{className:"bg-white",children:(0,k.jsx)("div",{className:"divide-y divide-slate-100",children:u.map(((e,t)=>{const l=t===x,s=U===e.id;return(0,k.jsxs)("div",{ref:e=>{o.current[t]=e},className:"group flex items-start gap-2 px-2 py-2 transition-colors cursor-pointer ".concat(l?"bg-emerald-50 active:bg-emerald-100":"bg-white hover:bg-slate-50 active:bg-slate-100"),onMouseEnter:()=>h(t),children:[(0,k.jsxs)("button",{type:"button",className:"flex-1 text-left min-w-0 focus:outline-none",onClick:()=>{q(e.body),null===n||void 0===n||n()},title:e.tagsCsv||"",children:[(0,k.jsx)("div",{className:"text-[13px] font-semibold text-slate-900 truncate leading-snug",children:e.title}),(0,k.jsx)("div",{className:"mt-0.5 text-[12px] text-slate-600 truncate leading-snug",children:e.body})]}),(0,k.jsxs)("div",{className:"flex items-center gap-1 mt-0.5",children:[(0,k.jsx)("span",{className:"text-[11px] text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity",children:"Enter \u21b5"}),(0,k.jsx)("button",{type:"button",className:"inline-flex items-center justify-center h-7 w-7 rounded-md border transition-all ".concat(s?"opacity-100 bg-slate-50 text-slate-400 border-slate-200 cursor-wait":"opacity-0 group-hover:opacity-100 bg-white text-slate-400 border-slate-200 hover:bg-rose-50 hover:text-rose-700 hover:border-rose-200"),title:"Delete",disabled:s,onClick:()=>(async e=>{if(null===e||void 0===e||!e.id||U)return;if(window.confirm("Delete this quick reply?")){F(e.id);try{var t;const l=await r.delete("/quick-replies/".concat(e.id));var n;if(!0!==(null===l||void 0===l||null===(t=l.data)||void 0===t?void 0:t.success))return void D((null===l||void 0===l||null===(n=l.data)||void 0===n?void 0:n.message)||"Failed to delete.");m((t=>t.filter((t=>t.id!==e.id))))}catch(l){D("Failed to delete.")}finally{F(null)}}})(e),children:(0,k.jsx)(ce.A,{className:"w-3.5 h-3.5"})})]})]},e.id)}))})})}),(0,k.jsxs)("div",{className:"shrink-0 pt-1.5 flex items-center justify-between text-[11px] text-slate-500",children:[(0,k.jsxs)("div",{children:["Scope: ",(0,k.jsx)("span",{className:"uppercase",children:b})]}),(0,k.jsx)("button",{type:"button",className:"inline-flex items-center justify-center h-7 w-7 rounded-md text-slate-500 hover:text-slate-700 hover:bg-slate-100",title:"\u2191\u2193 navigate \u2022 Enter insert \u2022 Esc close","aria-label":"Keyboard shortcuts",onClick:()=>{},children:(0,k.jsx)(ue,{className:"w-4 h-4"})})]})]})]})})}const ve=[{id:"quickReply",label:"Quick replies",Icon:J.A},{id:"notes",label:"Notes",Icon:oe.A},{id:"template",label:"Templates",Icon:re.A}],ge={quickReply:"Quick replies UI goes here",notes:"Notes UI goes here",tag:"Tag UI goes here",template:"Template UI goes here"};function xe(e){let{openTab:t,setOpenTab:n,composerRef:l,onQuickReplyInsert:i}=e;const a=null!==t,o=ve.find((e=>e.id===t))||null,r=ve.find((e=>"notes"===e.id))||null,d=ve.filter((e=>"notes"!==e.id)),c=s.useCallback((()=>{"function"===typeof n&&n(null)}),[n]);s.useEffect((()=>{if(!a)return;const e=e=>{const t=e.target;if(!(t instanceof Node))return;const n=null===l||void 0===l?void 0:l.current;n&&(n.contains(t)||c())},t=e=>{"Escape"===e.key&&c()};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t,{capture:!0}),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t,{capture:!0})}}),[a,c,l]);return(0,k.jsx)("div",{className:"relative w-full",children:(0,k.jsxs)("div",{id:"chatinbox-composer-panel","aria-hidden":!a,className:"absolute left-0 right-0 bottom-full mb-1 overflow-hidden rounded-lg border border-slate-200/80 bg-white shadow-sm transform-gpu transition-[transform,opacity] duration-150 ease-out flex flex-col max-h-[240px] ".concat(a?"opacity-100 translate-y-0 pointer-events-auto":"opacity-0 translate-y-2 pointer-events-none"),children:[(0,k.jsxs)("div",{className:"shrink-0 flex items-center gap-2 px-2 pt-2 pb-1.5 border-b border-slate-200/70",children:[(0,k.jsxs)("div",{className:"flex items-center gap-3 min-w-0 flex-1",role:"tablist","aria-label":"Composer tools",children:[d.map((e=>{const l=t===e.id,s=e.Icon;return(0,k.jsxs)("button",{type:"button",role:"tab","aria-selected":l,className:"inline-flex items-center gap-1.5 text-[13px] leading-none px-0.5 pb-1 border-b-2 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300/70 rounded-sm ".concat(l?"border-emerald-600 text-slate-900 font-semibold":"border-transparent text-slate-600 hover:text-slate-800"),onClick:()=>null===n||void 0===n?void 0:n(e.id),children:[s?(0,k.jsx)(s,{className:"w-3.5 h-3.5 ".concat(l?"text-emerald-600":"text-slate-400")}):null,e.label]},e.id)})),r?(()=>{const e=t===r.id,l=r.Icon;return(0,k.jsxs)("button",{type:"button",role:"tab","aria-selected":e,className:"ml-auto inline-flex items-center gap-1.5 text-[13px] leading-none px-0.5 pb-1 border-b-2 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300/70 rounded-sm ".concat(e?"border-emerald-600 text-slate-900 font-semibold":"border-transparent text-slate-600 hover:text-slate-800"),onClick:()=>null===n||void 0===n?void 0:n(r.id),children:[l?(0,k.jsx)(l,{className:"w-3.5 h-3.5 ".concat(e?"text-emerald-600":"text-slate-400")}):null,r.label]},r.id)})():null]}),(0,k.jsx)("button",{type:"button",className:"inline-flex items-center justify-center w-7 h-7 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100",onClick:c,"aria-label":"Close",children:(0,k.jsx)(M.A,{className:"w-4 h-4"})})]}),(0,k.jsx)("div",{className:"flex-1 min-h-0 p-2.5 overflow-hidden flex flex-col",children:"quickReply"===t?(0,k.jsx)("div",{className:"flex-1 min-h-0 overflow-hidden",children:(0,k.jsx)(me,{onInsert:e=>null===i||void 0===i?void 0:i(e),onClose:c,scope:"All"})}):(0,k.jsx)("div",{className:"h-full overflow-y-auto",children:(0,k.jsxs)("div",{className:"rounded-md border border-slate-200 bg-white p-3 text-[12px] text-slate-700",children:[(0,k.jsx)("div",{className:"font-medium text-slate-800",children:(null===o||void 0===o?void 0:o.label)||"Tools"}),(0,k.jsx)("div",{className:"mt-1 text-[11px] text-slate-500",children:o?ge[o.id]:"Coming soon"})]})})})]})})}const he=[{char:"\ud83d\ude00",name:"grinning"},{char:"\ud83d\ude01",name:"beaming"},{char:"\ud83d\ude02",name:"joy"},{char:"\ud83e\udd23",name:"rofl"},{char:"\ud83d\ude0a",name:"smile"},{char:"\ud83d\ude42",name:"slight_smile"},{char:"\ud83d\ude09",name:"wink"},{char:"\ud83d\ude0d",name:"heart_eyes"},{char:"\ud83d\ude18",name:"kiss"},{char:"\ud83d\ude0b",name:"yum"},{char:"\ud83d\ude0e",name:"cool"},{char:"\ud83e\udd29",name:"star_struck"},{char:"\ud83e\udd73",name:"partying"},{char:"\ud83d\ude07",name:"innocent"},{char:"\ud83e\udd17",name:"hug"},{char:"\ud83d\ude05",name:"sweat_smile"},{char:"\ud83d\ude0c",name:"relieved"},{char:"\ud83d\ude34",name:"sleep"},{char:"\ud83e\udd14",name:"think"},{char:"\ud83d\ude44",name:"doubt"},{char:"\ud83d\ude10",name:"neutral"},{char:"\ud83d\ude2e",name:"open_mouth"},{char:"\ud83d\ude22",name:"cry"},{char:"\ud83d\ude2d",name:"sob"},{char:"\ud83d\ude21",name:"angry"},{char:"\ud83d\ude31",name:"scream"},{char:"\ud83e\udd2f",name:"mind_blown"},{char:"\ud83e\udd12",name:"sick"},{char:"\ud83e\udd15",name:"injured"},{char:"\ud83e\udd27",name:"sneeze"},{char:"\ud83e\udd76",name:"cold"},{char:"\ud83e\udd75",name:"hot"},{char:"\ud83d\udc4d",name:"thumbs_up"},{char:"\ud83d\udc4e",name:"thumbs_down"},{char:"\ud83d\ude4f",name:"pray"},{char:"\ud83d\udc4f",name:"clap"},{char:"\ud83d\ude4c",name:"raised_hands"},{char:"\ud83e\udd1d",name:"handshake"},{char:"\ud83d\udcaa",name:"muscle"},{char:"\ud83e\udef6",name:"heart_hands"},{char:"\u2764\ufe0f",name:"red_heart"},{char:"\ud83d\udc9b",name:"yellow_heart"},{char:"\ud83d\udc9a",name:"green_heart"},{char:"\ud83d\udc99",name:"blue_heart"},{char:"\ud83d\udc9c",name:"purple_heart"},{char:"\ud83d\udda4",name:"black_heart"},{char:"\ud83d\udc94",name:"broken_heart"},{char:"\u2728",name:"sparkles"},{char:"\ud83d\udd25",name:"fire"},{char:"\u2b50",name:"star"},{char:"\u2705",name:"check"},{char:"\u274c",name:"cross"},{char:"\u26a0\ufe0f",name:"warning"},{char:"\u23f3",name:"hourglass"},{char:"\ud83d\udccc",name:"pin"},{char:"\ud83d\udccd",name:"round_pushpin"},{char:"\ud83d\udcc5",name:"calendar"},{char:"\ud83d\uded2",name:"shopping"},{char:"\ud83d\udcb0",name:"money"},{char:"\ud83c\udf89",name:"tada"},{char:"\ud83c\udf8a",name:"confetti"},{char:"\ud83d\udcac",name:"speech"},{char:"\u2709\ufe0f",name:"envelope"},{char:"\ud83d\udcde",name:"telephone"},{char:"\u23f0",name:"alarm"},{char:"\u23f2\ufe0f",name:"timer"},{char:"\ud83e\uddfe",name:"receipt"},{char:"\ud83d\udee0\ufe0f",name:"tools"},{char:"\ud83e\udde0",name:"brain"}];function pe(e){let{onPick:t,onClose:n}=e;const l=(0,s.useRef)(null),[i,a]=(0,s.useState)("");(0,s.useEffect)((()=>{const e=e=>{l.current&&(l.current.contains(e.target)||null===n||void 0===n||n())};return document.addEventListener("mousedown",e,{capture:!0}),()=>document.removeEventListener("mousedown",e,{capture:!0})}),[n]);const o=(0,s.useMemo)((()=>{const e=i.trim().toLowerCase();return e?he.filter((t=>t.name.includes(e))):he}),[i]);return(0,k.jsxs)("div",{ref:l,className:"w-80 rounded-xl border border-slate-200 bg-white shadow-lg p-2",role:"dialog","aria-label":"Emoji picker",children:[(0,k.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,k.jsx)("input",{autoFocus:!0,className:"flex-1 border border-slate-200 rounded-lg px-2.5 py-1.5 text-[12px] text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400",placeholder:"Search emoji...",value:i,onChange:e=>a(e.target.value),onKeyDown:e=>{"Escape"===e.key&&(e.preventDefault(),e.stopPropagation(),null===n||void 0===n||n())}}),(0,k.jsx)("button",{className:"text-[11px] text-slate-500 hover:text-slate-700 px-2 py-1.5",onClick:()=>null===n||void 0===n?void 0:n(),type:"button",children:"Close"})]}),(0,k.jsx)("div",{className:"grid grid-cols-10 gap-1 overflow-y-hidden",children:o.map((e=>(0,k.jsx)("button",{type:"button",className:"h-7 w-7 flex items-center justify-center rounded-lg hover:bg-slate-100",title:e.name.replace(/_/g," "),onClick:()=>null===t||void 0===t?void 0:t(e.char),children:(0,k.jsx)("span",{className:"text-lg",children:e.char})},e.char+e.name)))})]})}const fe=e=>{const t=Number(e);if(!Number.isFinite(t)||t<=0)return null;const n=["B","KB","MB","GB"];let l=t,s=0;for(;l>=1024&&s<n.length-1;)l/=1024,s+=1;const i=l>=100?0:l>=10?1:2;return"".concat(l.toFixed(i)," ").concat(n[s])},be=e=>{var t,n,l,s,i,a;const o=String(null!==(t=null!==(n=null===e||void 0===e?void 0:e.mediaType)&&void 0!==n?n:null===e||void 0===e?void 0:e.MediaType)&&void 0!==t?t:"").trim().toLowerCase(),r=String(null!==(l=null!==(s=null===e||void 0===e?void 0:e.mimeType)&&void 0!==s?s:null===e||void 0===e?void 0:e.MimeType)&&void 0!==l?l:"").split(";")[0].trim().toLowerCase(),d=String(null!==(i=null!==(a=null===e||void 0===e?void 0:e.fileName)&&void 0!==a?a:null===e||void 0===e?void 0:e.FileName)&&void 0!==i?i:"").trim().toLowerCase();if("location"===o)return"location";if(r){if("application/pdf"===r)return"document";if(r.startsWith("image/"))return"image";if(r.startsWith("video/"))return"video";if(r.startsWith("audio/"))return"audio"}if(d){if(d.endsWith(".pdf"))return"document";if(d.endsWith(".mp4")||d.endsWith(".3gp")||d.endsWith(".3gpp")||d.endsWith(".webm")||d.endsWith(".mov"))return"video";if(d.endsWith(".mp3")||d.endsWith(".m4a")||d.endsWith(".aac")||d.endsWith(".ogg")||d.endsWith(".wav"))return"audio"}return o},ye=e=>{if(!e)return null;try{return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch(t){return null}},we=e=>{let{text:t,mediaType:n,fileName:l}=e;const s=String(t||"").trim();if(!s)return!1;const i=String(n||"").trim().toLowerCase(),a=String(l||"").trim().toLowerCase(),o=s.toLowerCase().replace(/\s+/g," ").trim();return!(!a||o!==a)||("image"===i?"photo"===o||"image"===o||(!!o.startsWith("image sent")||!!o.startsWith("photo sent")):"document"===i?"pdf"===o||"document"===o||(!!o.startsWith("pdf sent")||!!o.startsWith("document sent")):"video"===i?"video"===o||!!o.startsWith("video sent"):"audio"===i?"audio"===o||!!o.startsWith("audio sent"):"location"===i&&("location"===o||!!o.startsWith("location sent")))};function Ne(e){let{timeText:t,showStatus:n,status:l,className:s}=e;return t?(0,k.jsxs)("div",{className:s,children:[(0,k.jsx)("span",{children:t}),n&&(0,k.jsx)(ae,{status:l,variant:"onDark"})]}):null}function je(e){let{msg:t,isInbound:n,pdfMeta:l,onOpen:i,ensurePdfPreview:a}=e;const o=String((null===t||void 0===t?void 0:t.mediaId)||"").trim();s.useEffect((()=>{o&&(null===a||void 0===a||a(o))}),[o,a]);const r=String((null===t||void 0===t?void 0:t.fileName)||"").trim()||"Document.pdf",d="number"===typeof(null===l||void 0===l?void 0:l.pages)&&l.pages>0?l.pages:null,c=fe(null===l||void 0===l?void 0:l.sizeBytes),u=["PDF",d?"".concat(d," pages"):null,c||null].filter(Boolean).join(" \xb7 ");return(0,k.jsx)("button",{type:"button",onClick:()=>null===i||void 0===i?void 0:i(t),className:"relative w-[320px] max-w-full text-left rounded-lg overflow-hidden border ".concat(n?"bg-slate-50 border-slate-200":"bg-black/15 border-black/10"),title:"Open PDF",children:(0,k.jsxs)("div",{className:"flex items-stretch",children:[(0,k.jsx)("div",{className:"w-[88px] h-[64px] bg-black/10 flex items-center justify-center overflow-hidden",children:null!==l&&void 0!==l&&l.thumbDataUrl?(0,k.jsx)("img",{src:l.thumbDataUrl,alt:"PDF preview",className:"w-full h-full object-cover",loading:"lazy"}):(0,k.jsx)("div",{className:"flex items-center gap-2 text-[12px] font-semibold",children:(0,k.jsx)("span",{className:"inline-flex items-center justify-center w-8 h-8 rounded bg-rose-600 text-white text-[11px]",children:"PDF"})})}),(0,k.jsxs)("div",{className:"flex-1 px-3 py-2 min-w-0",children:[(0,k.jsx)("div",{className:"text-[13px] font-semibold truncate",children:r}),(0,k.jsx)("div",{className:"text-[11px] mt-0.5 ".concat(n?"text-slate-500":"text-white/80"),children:u})]}),(0,k.jsx)("div",{className:"px-3 py-2 flex items-center",children:(0,k.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center ".concat(n?"bg-slate-200 text-slate-700":"bg-black/20 text-white"),children:(0,k.jsx)(_.A,{className:"w-4 h-4"})})})]})})}function Ie(e){let{msg:t,isInbound:n,previewUrl:l,onOpen:i,ensureImagePreview:a,timeText:o,status:r,showStatus:d}=e;const c=String((null===t||void 0===t?void 0:t.mediaId)||"").trim();return s.useEffect((()=>{c&&(l||null===a||void 0===a||a(c))}),[c,l,a]),(0,k.jsxs)("button",{type:"button",onClick:()=>null===i||void 0===i?void 0:i(t),className:"relative block w-[240px] max-w-full aspect-[4/3] rounded-lg overflow-hidden border border-black/10",title:"Open image",children:[l?(0,k.jsx)("img",{src:l,alt:(null===t||void 0===t?void 0:t.fileName)||"Image",className:"absolute inset-0 w-full h-full object-cover",loading:"lazy"}):(0,k.jsx)("div",{className:"absolute inset-0 ".concat(n?"bg-slate-200/70":"bg-black/15")}),!l&&(0,k.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,k.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center ".concat(n?"bg-white/80 text-slate-700":"bg-black/30 text-white"),children:(0,k.jsx)(_.A,{className:"w-5 h-5"})})}),(0,k.jsx)(Ne,{timeText:o,showStatus:d,status:r,className:"absolute bottom-1 right-1 px-1.5 py-[1px] rounded bg-black/45 text-white text-[10px] leading-none flex items-center gap-0.5"})]})}function Se(e){let{msg:t,isInbound:n,previewUrl:l,onOpen:i,ensureMediaPreview:a,timeText:o,status:r,showStatus:d}=e;const c=String((null===t||void 0===t?void 0:t.mediaId)||"").trim();return s.useEffect((()=>{c&&(l||null===a||void 0===a||a(c))}),[c,l,a]),(0,k.jsxs)("button",{type:"button",onClick:()=>null===i||void 0===i?void 0:i(t),className:"relative block w-[240px] max-w-full aspect-[4/3] rounded-lg overflow-hidden border border-black/10",title:"Open video",children:[l?(0,k.jsx)("video",{src:l,className:"absolute inset-0 w-full h-full object-cover",muted:!0,playsInline:!0,preload:"metadata"}):(0,k.jsx)("div",{className:"absolute inset-0 ".concat(n?"bg-slate-200/70":"bg-black/15")}),(0,k.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,k.jsx)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center ".concat(n?"bg-white/80 text-slate-700":"bg-black/30 text-white"),children:(0,k.jsx)(V.A,{className:"w-6 h-6"})})}),!l&&(0,k.jsx)("div",{className:"absolute left-3 bottom-3 w-8 h-8 rounded-full bg-black/30 text-white flex items-center justify-center",children:(0,k.jsx)(_.A,{className:"w-4 h-4"})}),(0,k.jsx)(Ne,{timeText:o,showStatus:d,status:r,className:"absolute bottom-1 right-1 px-1.5 py-[1px] rounded bg-black/45 text-white text-[10px] leading-none flex items-center gap-0.5"})]})}function Ae(e){let{msg:t,isInbound:n,previewUrl:l,ensureMediaPreview:i}=e;const a=String((null===t||void 0===t?void 0:t.mediaId)||"").trim();s.useEffect((()=>{a&&(l||null===i||void 0===i||i(a))}),[a,l,i]);const o=String((null===t||void 0===t?void 0:t.fileName)||"").trim()||"Audio";return(0,k.jsx)("div",{className:"w-[320px] max-w-full rounded-lg border overflow-hidden ".concat(n?"bg-slate-50 border-slate-200":"bg-black/15 border-black/10"),children:(0,k.jsxs)("div",{className:"px-3 py-2",children:[(0,k.jsx)("div",{className:"text-[13px] font-semibold truncate",children:o}),(0,k.jsx)("div",{className:"mt-2",children:l?(0,k.jsx)("audio",{controls:!0,src:l,className:"w-full",preload:"metadata"}):(0,k.jsxs)("div",{className:"h-10 flex items-center justify-between px-3 rounded bg-black/10",children:[(0,k.jsx)("span",{className:"text-[12px] ".concat(n?"text-slate-500":"text-white/80"),children:"Loading audio..."}),(0,k.jsx)(_.A,{className:"w-4 h-4 ".concat(n?"text-slate-600":"text-white")})]})})]})})}function Ce(e){var t,n,l,s,i,a,o,r,d,c,u,m;let{msg:v,isInbound:g}=e;const x=null!==(t=null!==(n=null!==(l=null===v||void 0===v?void 0:v.locationLatitude)&&void 0!==l?l:null===v||void 0===v?void 0:v.LocationLatitude)&&void 0!==n?n:null===v||void 0===v?void 0:v.latitude)&&void 0!==t?t:null,h=null!==(s=null!==(i=null!==(a=null===v||void 0===v?void 0:v.locationLongitude)&&void 0!==a?a:null===v||void 0===v?void 0:v.LocationLongitude)&&void 0!==i?i:null===v||void 0===v?void 0:v.longitude)&&void 0!==s?s:null,p=String(null!==(o=null!==(r=null!==(d=null===v||void 0===v?void 0:v.locationName)&&void 0!==d?d:null===v||void 0===v?void 0:v.LocationName)&&void 0!==r?r:null===v||void 0===v?void 0:v.name)&&void 0!==o?o:"").trim(),f=String(null!==(c=null!==(u=null!==(m=null===v||void 0===v?void 0:v.locationAddress)&&void 0!==m?m:null===v||void 0===v?void 0:v.LocationAddress)&&void 0!==u?u:null===v||void 0===v?void 0:v.address)&&void 0!==c?c:"").trim(),b=Number.isFinite(Number(x))&&Number.isFinite(Number(h)),y=b?"https://www.google.com/maps?q=".concat(encodeURIComponent("".concat(Number(x),",").concat(Number(h)))):null;return(0,k.jsx)("a",{href:y||"#",target:y?"_blank":void 0,rel:y?"noreferrer noopener":void 0,onClick:e=>{y||e.preventDefault()},className:"block w-[320px] max-w-full rounded-lg border overflow-hidden ".concat(g?"bg-slate-50 border-slate-200":"bg-black/15 border-black/10"),title:y?"Open in Google Maps":"Location",children:(0,k.jsxs)("div",{className:"flex items-center gap-3 px-3 py-3",children:[(0,k.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center ".concat(g?"bg-slate-200 text-slate-700":"bg-black/25 text-white"),children:(0,k.jsx)(K.A,{className:"w-5 h-5"})}),(0,k.jsxs)("div",{className:"min-w-0",children:[(0,k.jsx)("div",{className:"text-[13px] font-semibold truncate",children:p||"Location"}),f?(0,k.jsx)("div",{className:"text-[11px] mt-0.5 truncate ".concat(g?"text-slate-500":"text-white/80"),children:f}):b?(0,k.jsxs)("div",{className:"text-[11px] mt-0.5 ".concat(g?"text-slate-500":"text-white/80"),children:[Number(x).toFixed(5),", ",Number(h).toFixed(5)]}):null]})]})})}function Re(e){let{viewer:t,onClose:n,onPrev:l,onNext:i,onSelectIndex:a,mediaObjectUrlById:o,ensureImagePreview:r}=e;const d=Boolean(null===t||void 0===t?void 0:t.open),c=null===t||void 0===t?void 0:t.url,u=null===t||void 0===t?void 0:t.type,m=Boolean(null===t||void 0===t?void 0:t.loading),v=Array.isArray(null===t||void 0===t?void 0:t.items)?t.items:[],g=Number.isFinite(Number(null===t||void 0===t?void 0:t.index))&&Number(null===t||void 0===t?void 0:t.index)>=0?Number(t.index):0,x="image"===u&&v.length>1&&g>0,h="image"===u&&v.length>1&&g<v.length-1;return s.useEffect((()=>{if(!d)return;const e=e=>{"Escape"===e.key&&(null===n||void 0===n||n()),"ArrowLeft"===e.key&&x&&(null===l||void 0===l||l()),"ArrowRight"===e.key&&h&&(null===i||void 0===i||i())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)}),[d,n,l,i,x,h]),s.useEffect((()=>{var e,t,n,l,s;if(!d)return;const i=null===(e=document)||void 0===e||null===(t=e.body)||void 0===t||null===(n=t.style)||void 0===n?void 0:n.overflow;return null!==(l=document)&&void 0!==l&&null!==(s=l.body)&&void 0!==s&&s.style&&(document.body.style.overflow="hidden"),()=>{var e,t;null!==(e=document)&&void 0!==e&&null!==(t=e.body)&&void 0!==t&&t.style&&(document.body.style.overflow=i||"")}}),[d]),d&&c?(0,k.jsxs)("div",{className:"fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",onClick:()=>null===n||void 0===n?void 0:n(),children:["image"===u&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),x&&(null===l||void 0===l||l())},className:"absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 ".concat(x?"":"opacity-40 cursor-not-allowed"),"aria-label":"Previous image",disabled:!x,children:(0,k.jsx)(H.A,{className:"w-6 h-6"})}),(0,k.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),h&&(null===i||void 0===i||i())},className:"absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 ".concat(h?"":"opacity-40 cursor-not-allowed"),"aria-label":"Next image",disabled:!h,children:(0,k.jsx)(Q.A,{className:"w-6 h-6"})})]}),(0,k.jsx)("button",{type:"button",onClick:()=>null===n||void 0===n?void 0:n(),className:"absolute top-4 right-4 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70","aria-label":"Close",children:(0,k.jsx)(M.A,{className:"w-5 h-5"})}),(0,k.jsx)("div",{className:"max-w-[92vw] max-h-[92vh]",onClick:e=>e.stopPropagation(),children:"image"===u?(0,k.jsxs)("div",{className:"relative",children:[(0,k.jsx)("img",{src:c,alt:(null===t||void 0===t?void 0:t.fileName)||"Image",className:"max-w-[92vw] max-h-[92vh] object-contain rounded-lg"}),m&&(0,k.jsx)("div",{className:"absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg",children:(0,k.jsx)("div",{className:"w-12 h-12 rounded-full bg-black/40 flex items-center justify-center",children:(0,k.jsx)(_.A,{className:"w-6 h-6 text-white"})})})]}):"video"===u?(0,k.jsx)("video",{src:c,controls:!0,autoPlay:!0,playsInline:!0,className:"max-w-[92vw] max-h-[92vh] object-contain rounded-lg bg-black"}):null}),"image"===u&&v.length>1&&(0,k.jsx)("div",{className:"absolute left-1/2 -translate-x-1/2 bottom-4 w-[min(900px,92vw)]",onClick:e=>e.stopPropagation(),children:(0,k.jsx)("div",{className:"px-2 py-2 rounded-xl bg-black/45",children:(0,k.jsx)("div",{className:"flex gap-2 overflow-x-auto",children:v.map(((e,t)=>{const n=String((null===e||void 0===e?void 0:e.mediaId)||"").trim();if(!n)return null;const l=(null===o||void 0===o?void 0:o[n])||(t===g?c:null),s=t===g;return(0,k.jsx)("button",{type:"button",className:"relative shrink-0 w-[64px] h-[44px] rounded-md overflow-hidden border ".concat(s?"border-white":"border-white/20 hover:border-white/40"),onMouseEnter:()=>null===r||void 0===r?void 0:r(n),onClick:()=>null===a||void 0===a?void 0:a(t),title:(null===e||void 0===e?void 0:e.fileName)||"Image",children:l?(0,k.jsx)("img",{src:l,alt:"thumbnail",className:"w-full h-full object-cover",loading:"lazy"}):(0,k.jsx)("div",{className:"w-full h-full bg-white/10 flex items-center justify-center",children:(0,k.jsx)(_.A,{className:"w-4 h-4 text-white/70"})})},n)}))})})})]}):null}function Me(e){let{selectedConversation:t,messages:n,mediaObjectUrlById:l,pdfPreviewById:i,mediaViewer:a,handleMediaViewerPrev:o,handleMediaViewerNext:r,handleMediaViewerSelectIndex:d,messagesEndRef:c,messagesWithSeparators:v,messagesHasMore:g,newMessage:x,setNewMessage:h,isSending:p,isUploadingMedia:f,handleSendMessage:b,handleUploadAndSendMedia:y,handleSendLocation:w,handleOpenMedia:N,handleCloseMediaViewer:j,ensureImagePreview:I,ensurePdfPreview:S,handleComposerKeyDown:A,headerIsAssigned:C,headerIsAssignedToMe:R,headerAssignedName:M,isWithin24h:T,normalizedStatus:L,statusPillClass:P,agents:D,isAgentsLoading:E,currentUserId:F,isAssigning:O,handleAssignToMe:W,handleAssignToAgent:B,handleUnassign:q,isUpdatingStatus:z,handleUpdateConversationStatus:_,isMessagesLoading:V,isMessagesLoadingOlder:se,onLoadOlderMessages:ie,isConversationClosed:oe,showRightPanel:re,setShowRightPanel:de,assigneeMenuOpen:ce,setAssigneeMenuOpen:ue,statusMenuOpen:me,setStatusMenuOpen:ve}=e;const ge=s.useRef(null),he=s.useRef(null),[fe,Ne]=s.useState(null),[Me,ke]=s.useState(!1),Te=s.useRef(null),Le=s.useRef(null),{hasAllAccess:Pe,role:De,can:Ue}=(0,ne.h)()||{},Ee=String(De||"").toLowerCase(),Fe=["admin","superadmin","business","partner"].includes(Ee)||Boolean(Pe),Oe=Boolean(Fe||"function"===typeof Ue&&Ue(le.FK.INBOX_CHAT_ASSIGN)),We=s.useMemo((()=>(null!==D&&void 0!==D?D:[]).filter((e=>!F||String(e.userId)!==String(F))).filter((e=>!(e=>{var t,n,l,s,i,a,o;if(null!==(t=null!==(n=null!==(l=null!==(s=null===e||void 0===e?void 0:e.isBusinessOwner)&&void 0!==s?s:null===e||void 0===e?void 0:e.IsBusinessOwner)&&void 0!==l?l:null===e||void 0===e?void 0:e.isOwner)&&void 0!==n?n:null===e||void 0===e?void 0:e.IsOwner)&&void 0!==t&&t)return!0;const r=String(null!==(i=null!==(a=null!==(o=null===e||void 0===e?void 0:e.roleName)&&void 0!==o?o:null===e||void 0===e?void 0:e.roleCode)&&void 0!==a?a:null===e||void 0===e?void 0:e.role)&&void 0!==i?i:"").toLowerCase().trim();return"business"===r||"businessowner"===r||"business owner"===r||"owner"===r})(e)))),[D,F]),Be=s.useCallback((async()=>{const e=ge.current;if(!e||"function"!==typeof ie)return void await(null===ie||void 0===ie?void 0:ie());const t=e.scrollHeight,n=e.scrollTop;await ie(),requestAnimationFrame((()=>{requestAnimationFrame((()=>{const e=ge.current;if(!e)return;const l=e.scrollHeight;e.scrollTop=n+(l-t)}))}))}),[ie]),qe=!t||oe||!T||p||f,ze=s.useCallback((e=>{var t,n,l,s;const i=Te.current;if(!i)return void h((t=>t?"".concat(t).concat(e):e));const a=null!==(t=i.selectionStart)&&void 0!==t?t:null!==(n=null===x||void 0===x?void 0:x.length)&&void 0!==n?n:0,o=null!==(l=i.selectionEnd)&&void 0!==l?l:null!==(s=null===x||void 0===x?void 0:x.length)&&void 0!==s?s:0,r=null!==x&&void 0!==x?x:"",d=r.slice(0,a)+e+r.slice(o);h(d),requestAnimationFrame((()=>{i.focus();const t=a+e.length;i.setSelectionRange(t,t)}))}),[x,h]);return(0,k.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,k.jsx)(Re,{viewer:a,onClose:j,onPrev:o,onNext:r,onSelectIndex:d,mediaObjectUrlById:l,ensureImagePreview:I}),(0,k.jsx)("div",{className:"h-[64px] border-b border-slate-200 bg-white flex items-center justify-between px-4",children:t?(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"flex items-center gap-3",children:[(0,k.jsx)("div",{className:"w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700",children:m(t.contactName,t.contactPhone)}),(0,k.jsxs)("div",{children:[(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)("span",{className:"text-sm font-semibold text-slate-800",children:t.contactName||t.contactPhone}),(0,k.jsx)("span",{className:"text-[11px] text-slate-400",children:t.contactPhone})]}),(0,k.jsxs)("div",{className:"flex items-center gap-3 text-[11px] text-slate-400 mt-0.5",children:[(0,k.jsxs)("span",{className:"flex items-center gap-1",children:[(0,k.jsx)(Y.A,{className:"w-3 h-3"}),t.lastInboundAt?u(t.lastInboundAt):"Last inbound: -"]}),(0,k.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-[1px] rounded-full text-[10px] border ".concat(T?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-rose-50 text-rose-700 border-rose-200"),children:[(0,k.jsx)(Y.A,{className:"w-3 h-3"}),T?"Within 24h":"Outside 24h"]})]})]})]}),(0,k.jsxs)("div",{className:"flex items-center gap-2 text-[11px] text-slate-500",children:[(0,k.jsxs)("span",{className:"flex items-center gap-1",children:[(0,k.jsx)(G.A,{className:"w-3 h-3"}),t.sourceName||"WhatsApp"]}),(0,k.jsxs)("span",{className:"flex items-center gap-1",children:[(0,k.jsx)($.A,{className:"w-3 h-3"}),t.mode||"Live"]}),(0,k.jsxs)("div",{className:"relative ml-2",children:[(0,k.jsxs)("button",{type:"button","aria-label":"Assignee",onClick:()=>{ve(!1),ue((e=>!e))},disabled:O,className:"inline-flex items-center gap-1 rounded-full border bg-white px-3 py-[3px] text-[11px] ".concat(O?"border-slate-200 text-slate-400 cursor-wait":"border-slate-200 text-slate-700 hover:bg-slate-50"),children:[(0,k.jsx)(X.A,{className:"w-3 h-3"}),C?R?"You":M||"Agent":"Unassigned",(0,k.jsx)(U.A,{className:"w-3 h-3"})]}),ce&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsx)("button",{type:"button","aria-label":"Close assignee menu",className:"fixed inset-0 z-10 cursor-default",onClick:()=>ue(!1)}),(0,k.jsxs)("div",{className:"absolute right-0 mt-2 w-64 rounded-xl border border-slate-200 bg-white shadow-lg overflow-hidden z-20",children:[(0,k.jsx)("div",{className:"px-3 py-2 text-[10px] text-slate-500 border-b border-slate-100",children:"Agent List"}),(0,k.jsx)("button",{type:"button",className:"w-full text-left px-3 py-2 text-[11px] text-slate-700 hover:bg-slate-50 disabled:opacity-50",onClick:()=>{ue(!1),W()},disabled:!F||R,children:"Assign to me"}),(0,k.jsx)("div",{className:"max-h-56 overflow-y-auto",children:Oe?(0,k.jsxs)(k.Fragment,{children:[E&&(0,k.jsx)("div",{className:"px-3 py-2 text-[11px] text-slate-400",children:"Loading agents..."}),!E&&We.map((e=>(0,k.jsxs)("button",{type:"button",className:"w-full text-left px-3 py-2 text-[11px] text-slate-700 hover:bg-slate-50",onClick:()=>{ue(!1),B(e.userId)},children:["Assign to ",e.name,e.roleName?(0,k.jsxs)("span",{className:"ml-1 text-[10px] text-slate-400",children:["(",e.roleName,")"]}):null]},e.userId))),!E&&0===We.length&&(0,k.jsx)("div",{className:"px-3 py-2 text-[11px] text-slate-400",children:"No other agents found."})]}):(0,k.jsx)("div",{className:"px-3 py-2 text-[11px] text-slate-500",children:"You can only assign to yourself. Ask an admin to reassign."})}),C&&(R||Oe)&&(0,k.jsx)("button",{type:"button",className:"w-full text-left px-3 py-2 text-[11px] text-rose-700 hover:bg-rose-50 border-t border-slate-100 disabled:opacity-50",onClick:()=>{ue(!1),q()},disabled:O,children:"Unassign"})]})]})]}),(0,k.jsxs)("div",{className:"relative",children:[(0,k.jsxs)("button",{type:"button","aria-label":"Status",onClick:()=>{R&&(ue(!1),ve((e=>!e)))},disabled:!R||z,title:R?"Update status":"Assign to yourself to update status",className:"inline-flex items-center gap-1 rounded-full border px-3 py-[3px] text-[11px] ".concat(!R||z?"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed":"".concat(P," hover:opacity-90")),children:[(0,k.jsx)(Z.A,{className:"w-3 h-3"}),L,(0,k.jsx)(U.A,{className:"w-3 h-3"})]}),me&&R&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsx)("button",{type:"button","aria-label":"Close status menu",className:"fixed inset-0 z-10 cursor-default",onClick:()=>ve(!1)}),(0,k.jsx)("div",{className:"absolute right-0 mt-2 w-40 rounded-xl border border-slate-200 bg-white shadow-lg overflow-hidden z-20",children:["Open","Pending","Closed"].map((e=>(0,k.jsx)("button",{type:"button",className:"w-full text-left px-3 py-2 text-[11px] hover:bg-slate-50 ".concat("Closed"===e?"text-rose-700":"Pending"===e?"text-amber-700":"text-emerald-700"),onClick:()=>{ve(!1),_(e)},children:e},e)))})]})]}),(0,k.jsx)("button",{type:"button",onClick:()=>de((e=>!e)),"aria-label":re?"Hide details panel":"Show details panel",title:re?"Hide details":"Show details",className:"ml-2 inline-flex h-8 w-8 items-center justify-center rounded-full border border-transparent text-emerald-600 hover:bg-slate-50 hover:text-emerald-700",children:re?(0,k.jsx)(Q.A,{className:"h-4 w-4"}):(0,k.jsx)(H.A,{className:"h-4 w-4"})})]})]}):(0,k.jsx)("div",{className:"text-xs text-slate-400",children:"Select a conversation to start chatting."})}),(0,k.jsxs)("div",{ref:ge,className:"flex-1 overflow-y-auto bg-slate-50 px-4 py-3",children:[!t&&(0,k.jsx)("div",{className:"h-full flex items-center justify-center text-xs text-slate-400",children:"No conversation selected."}),t&&(0,k.jsxs)("div",{className:"flex flex-col gap-2 text-xs",children:[g&&(0,k.jsx)("div",{className:"flex justify-center",children:(0,k.jsx)("button",{type:"button",onClick:Be,disabled:se,className:"rounded-full border px-3 py-1 text-[11px] font-medium ".concat(se?"bg-slate-100 text-slate-400 border-slate-200 cursor-wait":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"),children:se?"Loading older...":"Load older messages"})}),V&&(0,k.jsx)("div",{className:"text-slate-400",children:"Loading messages..."}),!V&&0===n.length&&(0,k.jsx)("div",{className:"text-slate-400 italic",children:"No messages yet for this contact."}),!V&&v.length>0&&v.map((e=>{var t,n,s,a,o,r,d,c,u,m,v,g;if("separator"===e.type)return(0,k.jsx)("div",{className:"flex justify-center my-2",children:(0,k.jsx)("span",{className:"px-3 py-0.5 rounded-full bg-slate-100 text-[10px] text-slate-500",children:e.label})},e.id);const x=e,h=!!x.isInbound,p=String(null!==(t=null!==(n=x.mediaId)&&void 0!==n?n:x.MediaId)&&void 0!==t?t:"").trim(),f=be(x),b="location"===f||Boolean(p)&&("image"===f||"document"===f||"video"===f||"audio"===f),y=ye(x.sentAt),w=!x.isInbound,j=null!==(s=null!==(a=x.fileName)&&void 0!==a?a:x.FileName)&&void 0!==s?s:"",A=String(x.text||"").trim(),C=!b||"location"!==f&&(A&&!we({text:A,mediaType:f,fileName:j})),R=b&&C&&A?x.text:null,M=!b||"document"===f||"audio"===f||"location"===f||("image"===f||"video"===f)&&Boolean(R),T=b?M?"p-2 pb-4":"p-2":"px-3 py-2 pb-4",L=M?h?"pr-8":"pr-12":"pr-0",P=String(null!==(o=null!==(r=null!==(d=null!==(c=null!==(u=null!==(m=x.id)&&void 0!==m?m:x.messageLogId)&&void 0!==u?u:x.serverId)&&void 0!==c?c:x.messageId)&&void 0!==d?d:x.providerMessageId)&&void 0!==r?r:x.clientMessageId)&&void 0!==o?o:"".concat(null!==(v=x.sentAt)&&void 0!==v?v:"unknown","-").concat(h?"in":"out","-").concat(String(null!==(g=x.text)&&void 0!==g?g:"").slice(0,32)));return(0,k.jsx)("div",{className:"flex ".concat(h?"justify-start":"justify-end"),children:(0,k.jsxs)("div",{className:"relative max-w-[70%] ".concat(T," shadow-md ").concat(h?"bg-white text-slate-900 border border-slate-200/70 rounded-xl rounded-tl-sm":"bg-[#117957] text-white border border-emerald-950/20 rounded-xl rounded-tr-sm"),children:[(0,k.jsx)("span",{"aria-hidden":"true",className:"absolute top-2 w-3 h-3 rotate-45 ".concat(h?"left-[-5px] bg-white border-l border-b border-slate-200/70":"right-[-5px] bg-[#117957] border-r border-t border-emerald-950/20")}),(0,k.jsx)("div",{className:"whitespace-pre-wrap break-words ".concat(L),children:(()=>{const e=f,t=p&&(x.localPreviewUrl||(null===l||void 0===l?void 0:l[p]))||null;return b?(0,k.jsxs)("div",{className:"space-y-1",children:["image"===e?(0,k.jsx)(Ie,{msg:x,isInbound:h,previewUrl:t,onOpen:N,ensureImagePreview:I,timeText:M?null:y,status:x.status,showStatus:w}):"document"===e?(0,k.jsx)(je,{msg:x,isInbound:h,pdfMeta:p?null===i||void 0===i?void 0:i[p]:null,onOpen:N,ensurePdfPreview:S}):"video"===e?(0,k.jsx)(Se,{msg:x,isInbound:h,previewUrl:t,onOpen:N,ensureMediaPreview:I,timeText:M?null:y,status:x.status,showStatus:w}):"audio"===e?(0,k.jsx)(Ae,{msg:x,isInbound:h,previewUrl:t,ensureMediaPreview:I}):"location"===e?(0,k.jsx)(Ce,{msg:x,isInbound:h}):x.text||"-",R&&(0,k.jsx)("div",{className:"text-[13px]",children:R})]}):x.text||"-"})()}),M&&(0,k.jsxs)("div",{className:"absolute bottom-[2px] right-2 text-[10px] leading-none flex items-center gap-0.5 ".concat(h?"text-slate-500":"text-white/70"),children:[y,!x.isInbound&&(0,k.jsx)(ae,{status:x.status,variant:"onDark"})]}),x.errorMessage&&(0,k.jsx)("div",{className:"mt-0.5 text-[10px] text-rose-200",children:x.errorMessage})]})},P)})),(0,k.jsx)("div",{ref:c})]})]}),(0,k.jsxs)("div",{className:"border-t border-slate-200 bg-white px-4 py-3",children:[t&&oe&&(0,k.jsxs)("div",{className:"text-[11px] text-rose-600 mb-2",children:["This conversation is ",(0,k.jsx)("span",{className:"font-semibold",children:"closed"}),". Reopen it to send a reply."]}),t&&!oe&&!T&&(0,k.jsxs)("div",{className:"text-[11px] text-amber-600 mb-2",children:["This conversation is ",(0,k.jsx)("span",{className:"font-semibold",children:"outside"})," ","the 24-hour WhatsApp window. Free-form replies are disabled here. Use approved templates (campaigns / flows) to re-engage."]}),(0,k.jsxs)("div",{ref:he,className:"relative space-y-2",children:[(0,k.jsx)(xe,{openTab:fe,setOpenTab:Ne,composerRef:he,onQuickReplyInsert:e=>{ze(e)}}),(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsxs)("button",{type:"button",onClick:()=>{ke(!1),Ne((e=>"quickReply"===e?null:"quickReply"))},disabled:qe,className:"h-9 inline-flex items-center gap-1.5 rounded-lg border px-3 text-[12px] font-medium ".concat(qe?"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed":"bg-white text-slate-700 border-slate-200 hover:bg-slate-50"),title:"Quick replies",children:[(0,k.jsx)(J.A,{className:"w-4 h-4"}),"Quick reply"]}),(0,k.jsxs)("div",{className:"relative",children:[(0,k.jsx)("button",{type:"button",className:"h-9 w-9 inline-flex items-center justify-center rounded-lg border ".concat(qe?"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed":"bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:text-slate-800"),title:"Emoji",disabled:qe,"aria-expanded":Me,onClick:()=>{Ne(null),ke((e=>!e))},children:(0,k.jsx)(ee.A,{className:"w-4 h-4"})}),Me&&!qe&&(0,k.jsx)("div",{className:"absolute left-0 bottom-full mb-2 z-50",children:(0,k.jsx)(pe,{onPick:e=>{ze(e),ke(!1)},onClose:()=>ke(!1)})})]}),(0,k.jsx)("input",{ref:Le,type:"file",accept:"image/*,application/pdf,video/mp4,video/3gpp,audio/mpeg,audio/mp4,audio/aac,audio/ogg",className:"hidden",onChange:e=>{var t;const n=(null===(t=e.target.files)||void 0===t?void 0:t[0])||null;e.target.value="",n&&(null===y||void 0===y||y(n))}}),(0,k.jsx)("button",{type:"button",className:"h-9 w-9 inline-flex items-center justify-center rounded-lg border ".concat(qe?"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed":"bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:text-slate-800"),title:qe?"Attach":"Attach (image/PDF/video/audio)",disabled:qe,onClick:()=>{var e;return null===(e=Le.current)||void 0===e?void 0:e.click()},children:(0,k.jsx)(te.A,{className:"w-4 h-4"})}),(0,k.jsx)("button",{type:"button",className:"h-9 w-9 inline-flex items-center justify-center rounded-lg border ".concat(qe?"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed":"bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:text-slate-800"),title:qe?"Location":"Send current location",disabled:qe,onClick:()=>null===w||void 0===w?void 0:w(),children:(0,k.jsx)(K.A,{className:"w-4 h-4"})}),(0,k.jsx)("textarea",{ref:Te,rows:1,value:x,onChange:e=>h(e.target.value),onKeyDown:e=>{if("Escape"===e.key&&Me)return e.preventDefault(),e.stopPropagation(),void ke(!1);if(!qe&&"/"===e.key&&!e.shiftKey&&!e.altKey&&!e.ctrlKey&&!e.metaKey){var t,n,l,s;const i=null!==x&&void 0!==x?x:"",a=null!==(t=null===(n=e.currentTarget)||void 0===n?void 0:n.selectionStart)&&void 0!==t?t:i.length,o=null!==(l=null===(s=e.currentTarget)||void 0===s?void 0:s.selectionEnd)&&void 0!==l?l:i.length,r=0===a&&0===o;if(0===i.length||r)return e.preventDefault(),ke(!1),void Ne("quickReply")}null===A||void 0===A||A(e)},placeholder:t?oe?"Conversation is closed.":T?"Type a reply.":"24h window expired - send via template campaign.":"Select a conversation first.",disabled:!t||oe||!T||p||f,className:"flex-1 resize-none border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 ".concat(t&&!oe&&T?"bg-white":"bg-slate-50 text-slate-400 cursor-not-allowed")}),(0,k.jsx)("button",{type:"button",onClick:()=>null===b||void 0===b?void 0:b(),disabled:p||f||!x.trim()||!t||oe||!T,className:"bg-emerald-600 text-white text-sm font-medium px-4 py-2 rounded-lg shadow-sm ".concat(p||f||!x.trim()||!t||oe||!T?"opacity-60 cursor-not-allowed":"hover:bg-emerald-700"),children:f?"Uploading...":p?"Sending...":"Send"})]})]})]})]})}var ke=n(29350),Te=n(19233),Le=n(65505),Pe=n(70764);function De(e){let{selectedConversation:t,selectedContactId:n,contactSummary:l,isSummaryLoading:i,showRightPanel:a,setShowDetails:o,showCrmPanel:r,showDetails:d,tagsList:c,recentNotes:m,recentTimeline:v,nextReminder:g,handleOpenFullCrm:x,handleRemoveTag:h,removingTagId:p,setIsTagModalOpen:f,normalizedStatus:b,openDeleteConfirm:y,handleAddReminder:w,handleUpdateReminder:N,isSavingReminder:j,isUpdatingReminder:I,reminderTitle:S,setReminderTitle:A,reminderDueAt:C,setReminderDueAt:R,reminderDescription:T,setReminderDescription:L,editingReminderId:P,setEditingReminderId:E,editReminderTitle:F,setEditReminderTitle:O,editReminderDueAt:W,setEditReminderDueAt:B,editReminderDescription:q,setEditReminderDescription:z,handleAddNote:_,handleUpdateNote:V,isSavingNote:K,isUpdatingNote:Y,noteDraft:G,setNoteDraft:$,editingNoteId:Z,setEditingNoteId:J,editNoteContent:ee,setEditNoteContent:te}=e;const[ne,le]=s.useState(!1),[se,ie]=s.useState(!1),[ae,re]=s.useState(!1);return a?(0,k.jsx)("div",{className:"border-l border-slate-200 bg-white flex flex-col transition-all duration-300 ease-in-out ".concat(d?"w-80":"w-12"),children:d?(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"h-[64px] border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0",children:[(0,k.jsxs)("div",{className:"flex items-center gap-2",children:[(0,k.jsx)(X.A,{className:"w-4 h-4 text-slate-500"}),(0,k.jsx)("span",{className:"text-xs font-semibold text-slate-800",children:"Contact & CRM"})]}),(0,k.jsx)("div",{className:"flex items-center gap-2",children:(0,k.jsxs)("button",{type:"button",onClick:()=>o((e=>!e)),className:"text-[11px] text-slate-500 hover:text-slate-700 flex items-center gap-1",children:["Hide",(0,k.jsx)(Q.A,{className:"w-3 h-3"})]})})]}),(0,k.jsx)("div",{className:"p-4 text-xs text-slate-600 overflow-y-auto flex flex-col gap-3 flex-1",children:t?(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{children:[(0,k.jsx)("div",{className:"font-semibold text-slate-800 mb-0.5",children:t.contactName||t.contactPhone||"Unknown contact"}),(0,k.jsx)("div",{className:"text-slate-500",children:t.contactPhone}),(null===l||void 0===l?void 0:l.leadSource)&&(0,k.jsxs)("div",{className:"text-[11px] text-slate-400 mt-0.5",children:["Lead source:"," ",(0,k.jsx)("span",{className:"text-slate-600",children:l.leadSource})]})]}),(0,k.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-[11px]",children:[(0,k.jsxs)("div",{className:"bg-slate-50 rounded-md p-2",children:[(0,k.jsx)("div",{className:"text-slate-400",children:"First seen"}),(0,k.jsx)("div",{className:"font-medium",children:u(t.firstSeenAt)})]}),(0,k.jsxs)("div",{className:"bg-slate-50 rounded-md p-2",children:[(0,k.jsx)("div",{className:"text-slate-400",children:"Last inbound"}),(0,k.jsx)("div",{className:"font-medium",children:u(t.lastInboundAt)})]}),(0,k.jsxs)("div",{className:"bg-slate-50 rounded-md p-2",children:[(0,k.jsx)("div",{className:"text-slate-400",children:"Last outbound"}),(0,k.jsx)("div",{className:"font-medium",children:u(t.lastOutboundAt)})]}),(0,k.jsxs)("div",{className:"bg-slate-50 rounded-md p-2",children:[(0,k.jsx)("div",{className:"text-slate-400",children:"Status"}),(0,k.jsx)("div",{className:"font-medium",children:b})]})]}),(0,k.jsx)("div",{className:"h-px bg-slate-200 my-2"}),i&&(0,k.jsx)("div",{className:"text-[11px] text-slate-400",children:"Loading CRM data..."}),!i&&!l&&(0,k.jsx)("div",{className:"text-[11px] text-slate-400 italic",children:"No CRM data yet. Add a note or reminder from the CRM workspace to enrich this contact."}),!i&&l&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"order-1",children:[(0,k.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,k.jsxs)("div",{className:"flex items-center gap-1",children:[(0,k.jsx)(ke.A,{className:"w-3 h-3 text-slate-400"}),(0,k.jsx)("span",{className:"font-semibold text-[11px] text-slate-700",children:"Tags"})]}),n&&(0,k.jsx)("button",{type:"button",onClick:()=>f(!0),className:"text-[11px] font-medium text-emerald-600 hover:text-emerald-700",children:"+ Tag"})]}),(0,k.jsx)("div",{className:"flex flex-wrap gap-1",children:c.length>0?c.map(((e,t)=>{const n=(null===e||void 0===e?void 0:e.id)||(null===e||void 0===e?void 0:e.tagId)||"idx-".concat(t),l=(null===e||void 0===e?void 0:e.tagName)||(null===e||void 0===e?void 0:e.name)||"Tag",s=(null===e||void 0===e?void 0:e.colorHex)||"#EEF2FF",i=p===((null===e||void 0===e?void 0:e.id)||(null===e||void 0===e?void 0:e.tagId));return(0,k.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 text-[10px] rounded-full font-medium border border-slate-200",style:{backgroundColor:s},children:[(0,k.jsx)("span",{children:l}),(0,k.jsx)("button",{type:"button",onClick:()=>h(e),disabled:!!p,className:"ml-0.5 inline-flex items-center justify-center rounded-full border border-slate-200 bg-white/70 p-[2px] ".concat(p?"opacity-50 cursor-not-allowed":"hover:bg-white"),title:"Remove tag",children:(0,k.jsx)(M.A,{className:"h-3 w-3 text-slate-600"})}),i&&(0,k.jsx)("span",{className:"ml-1 text-[9px] text-slate-500",children:"removing..."})]},n)})):(0,k.jsxs)("span",{className:"text-[11px] text-slate-400",children:["No tags yet. Use"," ",(0,k.jsx)("span",{className:"font-semibold",children:"+ Tag"})," or full CRM to add tags."]})})]}),(0,k.jsxs)("div",{className:"order-3 pt-3 border-t border-slate-200/70",children:[(0,k.jsx)("div",{className:"flex items-center justify-between mb-1",children:(0,k.jsxs)("div",{className:"flex items-center gap-1",children:[(0,k.jsx)(Te.A,{className:"w-3 h-3 text-slate-400"}),(0,k.jsx)("span",{className:"font-semibold text-[11px] text-slate-700",children:"Next reminder"})]})}),g?(0,k.jsxs)("div",{className:"group relative bg-amber-50 border border-amber-100 rounded-md p-2",children:[(0,k.jsxs)("div",{className:"absolute right-2 top-2 flex gap-1 opacity-0 group-hover:opacity-100 transition",children:[(0,k.jsx)("button",{type:"button",onClick:()=>{E(g.id),O(g.title||"");const e=g.dueAt?new Date(g.dueAt):null,t=e?"".concat(e.getFullYear(),"-").concat(String(e.getMonth()+1).padStart(2,"0"),"-").concat(String(e.getDate()).padStart(2,"0"),"T").concat(String(e.getHours()).padStart(2,"0"),":").concat(String(e.getMinutes()).padStart(2,"0")):"";B(t),z(g.description||"")},className:"rounded-md border border-amber-200 bg-white/70 p-1 text-amber-700 hover:bg-white",title:"Edit reminder",children:(0,k.jsx)(Le.A,{className:"h-3.5 w-3.5"})}),(0,k.jsx)("button",{type:"button",onClick:()=>y("reminder",g),className:"rounded-md border border-amber-200 bg-white/70 p-1 text-rose-600 hover:bg-white",title:"Delete reminder",children:(0,k.jsx)(ce.A,{className:"h-3.5 w-3.5"})})]}),P===g.id?(0,k.jsxs)("div",{className:"space-y-2",children:[(0,k.jsx)("input",{type:"text",value:F,onChange:e=>O(e.target.value),className:"w-full border border-amber-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500"}),(0,k.jsx)("input",{type:"datetime-local",value:W,onChange:e=>B(e.target.value),className:"w-full border border-amber-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500"}),(0,k.jsx)("textarea",{rows:2,value:q,onChange:e=>z(e.target.value),className:"w-full border border-amber-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500"}),(0,k.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,k.jsx)("button",{type:"button",onClick:()=>{E(null),O(""),B(""),z("")},disabled:I,className:"rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60",children:"Cancel"}),(0,k.jsx)("button",{type:"button",onClick:()=>N(g),disabled:I,className:"rounded-md bg-emerald-600 px-2 py-1 text-[11px] font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",children:I?"Saving...":"Save"})]})]}):(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"flex items-center justify-between",children:[(0,k.jsx)("span",{className:"text-[11px] font-semibold text-amber-800",children:g.title}),(0,k.jsx)("span",{className:"text-[10px] text-amber-700",children:u(g.dueAt)})]}),g.description&&(0,k.jsx)("div",{className:"mt-0.5 text-[11px] text-amber-900",children:g.description}),g.status&&(0,k.jsxs)("div",{className:"mt-0.5 text-[10px] text-amber-700",children:["Status: ",g.status]})]})]}):(0,k.jsx)("span",{className:"text-[11px] text-slate-400",children:"No upcoming reminder for this contact."}),n&&(0,k.jsx)("div",{className:"mt-2",children:ne?(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,k.jsx)("div",{className:"text-[11px] text-slate-500",children:"Quick reminder"}),(0,k.jsx)("button",{type:"button",onClick:()=>{le(!1),A(""),R(""),L("")},disabled:j,className:"text-[11px] text-slate-500 hover:text-slate-700 disabled:opacity-60",children:"Cancel"})]}),(0,k.jsx)("input",{type:"text",value:S,onChange:e=>A(e.target.value),placeholder:"Reminder title",className:"w-full mb-1 border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500"}),(0,k.jsx)("input",{type:"datetime-local",value:C,onChange:e=>R(e.target.value),className:"w-full mb-1 border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500"}),(0,k.jsx)("textarea",{rows:2,value:T,onChange:e=>L(e.target.value),placeholder:"Optional description",className:"w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500"}),(0,k.jsx)("div",{className:"mt-1 flex justify-end",children:(0,k.jsx)("button",{type:"button",onClick:async()=>{const e=null===w||void 0===w?void 0:w();if(e&&"function"===typeof e.then)try{await e,le(!1)}catch(t){}else le(!1)},disabled:j||!S.trim()||!C,className:"px-2 py-[3px] rounded-md text-[11px] font-medium ".concat(!j&&S.trim()&&C?"bg-amber-600 text-white hover:bg-amber-700":"bg-slate-200 text-slate-500 cursor-not-allowed"),children:j?"Saving...":"Add reminder"})})]}):(0,k.jsx)("button",{type:"button",onClick:()=>le(!0),className:"inline-flex items-center gap-1 rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50",children:"+ Add reminder"})})]}),(0,k.jsxs)("div",{className:"order-2 pt-3 border-t border-slate-200/70",children:[(0,k.jsx)("div",{className:"flex items-center justify-between mb-1",children:(0,k.jsxs)("div",{className:"flex items-center gap-1",children:[(0,k.jsx)(oe.A,{className:"w-3 h-3 text-slate-400"}),(0,k.jsx)("span",{className:"font-semibold text-[11px] text-slate-700",children:"Recent notes"})]})}),m.length>0?(0,k.jsx)("div",{className:"space-y-1.5",children:m.map((e=>(0,k.jsxs)("div",{className:"group relative bg-slate-50 border border-slate-100 rounded-md p-2",children:[(0,k.jsxs)("div",{className:"absolute right-2 top-2 flex gap-1 opacity-0 group-hover:opacity-100 transition",children:[(0,k.jsx)("button",{type:"button",onClick:()=>{J(e.id),te(e.content||e.text||"")},className:"rounded-md border border-slate-200 bg-white/70 p-1 text-slate-600 hover:bg-white",title:"Edit note",children:(0,k.jsx)(Le.A,{className:"h-3.5 w-3.5"})}),(0,k.jsx)("button",{type:"button",onClick:()=>y("note",e),className:"rounded-md border border-slate-200 bg-white/70 p-1 text-rose-600 hover:bg-white",title:"Delete note",children:(0,k.jsx)(ce.A,{className:"h-3.5 w-3.5"})})]}),Z===e.id?(0,k.jsxs)("div",{className:"space-y-2",children:[(0,k.jsx)("textarea",{rows:3,value:ee,onChange:e=>te(e.target.value),className:"w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500"}),(0,k.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,k.jsx)("button",{type:"button",onClick:()=>{J(null),te("")},disabled:Y,className:"rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60",children:"Cancel"}),(0,k.jsx)("button",{type:"button",onClick:()=>V(e),disabled:Y,className:"rounded-md bg-emerald-600 px-2 py-1 text-[11px] font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",children:Y?"Saving...":"Save"})]})]}):(0,k.jsxs)(k.Fragment,{children:[(0,k.jsx)("div",{className:"text-[11px] text-slate-700",children:e.content||e.text||"(no content)"}),(0,k.jsxs)("div",{className:"mt-0.5 text-[10px] text-slate-400 flex justify-between",children:[(0,k.jsx)("span",{children:e.createdByName||e.createdBy||"Agent"}),(0,k.jsx)("span",{children:e.createdAt?new Date(e.createdAt).toLocaleString():""})]})]})]},e.id)))}):(0,k.jsx)("span",{className:"text-[11px] text-slate-400",children:"No notes yet."}),n&&(0,k.jsx)("div",{className:"mt-2",children:se?(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,k.jsx)("div",{className:"text-[11px] text-slate-500",children:"Add a quick note"}),(0,k.jsx)("button",{type:"button",onClick:()=>{ie(!1),$("")},disabled:K,className:"text-[11px] text-slate-500 hover:text-slate-700 disabled:opacity-60",children:"Cancel"})]}),(0,k.jsx)("textarea",{rows:2,value:G,onChange:e=>$(e.target.value),placeholder:"Type an internal note about this contact",className:"w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500"}),(0,k.jsx)("div",{className:"mt-1 flex justify-end",children:(0,k.jsx)("button",{type:"button",onClick:async()=>{const e=null===_||void 0===_?void 0:_();if(e&&"function"===typeof e.then)try{await e,ie(!1)}catch(t){}else ie(!1)},disabled:K||!G.trim(),className:"px-2 py-[3px] rounded-md text-[11px] font-medium ".concat(K||!G.trim()?"bg-slate-200 text-slate-500 cursor-not-allowed":"bg-emerald-600 text-white hover:bg-emerald-700"),children:K?"Saving...":"Add note"})})]}):(0,k.jsx)("button",{type:"button",onClick:()=>ie(!0),className:"inline-flex items-center gap-1 rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50",children:"+ Add note"})})]}),(0,k.jsxs)("div",{className:"order-4 pt-3 border-t border-slate-200/70",children:[(0,k.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,k.jsxs)("div",{className:"flex items-center gap-1",children:[(0,k.jsx)(D.A,{className:"w-3 h-3 text-slate-400"}),(0,k.jsx)("span",{className:"font-semibold text-[11px] text-slate-700",children:"Recent activity"})]}),(0,k.jsx)("button",{type:"button",onClick:()=>re((e=>!e)),className:"inline-flex items-center justify-center rounded-md p-1 text-slate-500 hover:text-slate-700 hover:bg-slate-50","aria-expanded":ae,"aria-label":ae?"Collapse activity":"Expand activity",children:ae?(0,k.jsx)(U.A,{className:"w-4 h-4"}):(0,k.jsx)(Q.A,{className:"w-4 h-4"})})]}),ae?v.length>0?(0,k.jsx)("div",{className:"space-y-1.5",children:v.map((e=>(0,k.jsxs)("div",{className:"bg-slate-50 border border-slate-100 rounded-md p-2",children:[(0,k.jsx)("div",{className:"text-[11px] text-slate-700",children:e.title||e.shortDescription||e.description||"Activity"}),(0,k.jsxs)("div",{className:"mt-0.5 text-[10px] text-slate-400 flex justify-between",children:[(0,k.jsx)("span",{children:e.source||e.category||e.eventType||""}),(0,k.jsx)("span",{children:e.createdAt?new Date(e.createdAt).toLocaleString():""})]})]},e.id)))}):(0,k.jsx)("span",{className:"text-[11px] text-slate-400",children:"No recent activity logged yet."}):null]})]})]}):(0,k.jsx)("div",{className:"text-slate-400 italic",children:"Select a conversation to see CRM info."})}),r&&(0,k.jsxs)("div",{className:"border-t border-slate-200 p-3 text-[11px] text-slate-500 shrink-0",children:["This mini-CRM view uses your existing Contacts, Tags, Notes, Reminders, and Timeline data. Use"," ",n?(0,k.jsxs)("button",{type:"button",onClick:x,className:"inline-flex items-center gap-1 rounded-full border border-emerald-200 bg-emerald-50 px-2 py-[2px] text-[11px] font-medium text-emerald-700 hover:bg-emerald-100 align-middle",children:[(0,k.jsx)(Pe.A,{className:"w-3 h-3"}),"Open full CRM"]}):(0,k.jsx)("span",{className:"font-semibold text-slate-700",children:"Open full CRM"})," ","for a 360 view."]})]}):(0,k.jsxs)("div",{className:"flex flex-col items-center py-4 gap-4",children:[(0,k.jsx)("button",{type:"button",onClick:()=>o(!0),className:"p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-700",title:"Show Contact & CRM",children:(0,k.jsx)(H.A,{className:"w-5 h-5"})}),(0,k.jsx)("div",{className:"flex-1 w-full flex justify-center overflow-hidden",children:(0,k.jsx)("div",{style:{writingMode:"vertical-rl"},className:"rotate-180 text-xs font-semibold text-slate-400 whitespace-nowrap tracking-wider uppercase select-none flex items-center gap-2",children:"Contact & CRM"})})]})}):null}function Ue(e){const{activeTab:t,agents:n,closeConfirm:l,confirmBusy:i,confirmState:a,contactSummary:o,currentUserId:r,editNoteContent:d,editReminderDescription:c,editReminderDueAt:u,editReminderTitle:m,editingNoteId:v,editingReminderId:g,executeDelete:x,fetchConversationsPage:h,filteredConversations:p,handleAddNote:f,handleAddReminder:b,handleAssignToMe:y,handleAssignToAgent:w,handleComposerKeyDown:N,handleOpenFullCrm:j,handleOpenMedia:I,handleCloseMediaViewer:S,handleMediaViewerPrev:A,handleMediaViewerNext:C,handleMediaViewerSelectIndex:R,ensureImagePreview:M,ensurePdfPreview:P,handleRemoveTag:D,handleSendMessage:U,handleUploadAndSendMedia:E,handleSendLocation:F,handleUnassign:O,handleUpdateConversationStatus:W,handleUpdateNote:B,handleUpdateReminder:q,headerAssignedName:_,headerIsAssigned:V,headerIsAssignedToMe:K,isAssigning:H,isConnected:Q,isLoading:Y,isConversationsLoadingMore:G,isMessagesLoading:$,isMessagesLoadingOlder:X,isSavingNote:Z,isSavingReminder:J,isSending:ee,isUploadingMedia:te,isSummaryLoading:ne,isTagModalOpen:le,isConversationClosed:se,isUpdatingStatus:ie,isUpdatingNote:ae,isUpdatingReminder:oe,isWithin24h:re,isAgentsLoading:de,mediaObjectUrlById:ce,pdfPreviewById:ue,mediaViewer:me,messages:ve,messagesEndRef:ge,messagesHasMore:xe,fetchMessagesPage:he,messagesWithSeparators:pe,newMessage:fe,nextReminder:be,noteDraft:ye,openDeleteConfirm:we,recentNotes:Ne,recentTimeline:je,refreshContactSummary:Ie,reminderDescription:Se,reminderDueAt:Ae,reminderTitle:Ce,removingTagId:Re,searchTerm:ke,selectedContactId:Te,selectedConversation:Le,selectedConversationId:Pe,selectedNumberId:Ue,setActiveTab:Ee,setEditNoteContent:Fe,setEditReminderDescription:Oe,setEditReminderDueAt:We,setEditReminderTitle:Be,setEditingNoteId:qe,setEditingReminderId:ze,setIsTagModalOpen:_e,setNewMessage:Ve,setNoteDraft:Ke,setReminderDescription:He,setReminderDueAt:Qe,setReminderTitle:Ye,setSearchTerm:Ge,setSelectedConversationId:$e,setSelectedNumberId:Xe,setShowDetails:Ze,setShowRightPanel:Je,showCrmPanel:et,showDetails:tt,showRightPanel:nt,tagsList:lt,conversationsHasMore:st}=e,[it,at]=s.useState(!1),[ot,rt]=s.useState(!1);s.useEffect((()=>{at(!1),rt(!1)}),[Pe]);const dt=s.useMemo((()=>{var e;const t=String(null!==(e=null===Le||void 0===Le?void 0:Le.status)&&void 0!==e?e:"").trim().toLowerCase();return"pending"===t?"Pending":"closed"===t?"Closed":"Open"}),[null===Le||void 0===Le?void 0:Le.status]),ct="Closed"===dt?"bg-slate-100 text-slate-700 border-slate-200":"Pending"===dt?"bg-amber-50 text-amber-800 border-amber-200":"bg-emerald-50 text-emerald-800 border-emerald-200";return(0,k.jsxs)("div",{className:"h-full flex bg-slate-50",children:[(0,k.jsx)(z,{activeTab:t,setActiveTab:Ee,selectedNumberId:Ue,setSelectedNumberId:Xe,searchTerm:ke,setSearchTerm:Ge,filteredConversations:p,isLoading:Y,conversationsHasMore:st,isConversationsLoadingMore:G,onLoadMoreConversations:()=>h({append:!0}),selectedConversationId:Pe,setSelectedConversationId:$e,isConnected:Q}),(0,k.jsx)(Me,{selectedConversation:Le,messages:ve,mediaObjectUrlById:ce,pdfPreviewById:ue,mediaViewer:me,handleMediaViewerPrev:A,handleMediaViewerNext:C,handleMediaViewerSelectIndex:R,messagesEndRef:ge,messagesWithSeparators:pe,messagesHasMore:xe,newMessage:fe,setNewMessage:Ve,isSending:ee,isUploadingMedia:te,handleSendMessage:U,handleUploadAndSendMedia:E,handleSendLocation:F,handleOpenMedia:I,handleCloseMediaViewer:S,ensureImagePreview:M,ensurePdfPreview:P,handleComposerKeyDown:N,headerIsAssigned:V,headerIsAssignedToMe:K,headerAssignedName:_,isWithin24h:re,normalizedStatus:dt,statusPillClass:ct,agents:n,isAgentsLoading:de,currentUserId:r,isAssigning:H,handleAssignToMe:y,handleAssignToAgent:w,handleUnassign:O,isUpdatingStatus:ie,handleUpdateConversationStatus:W,isMessagesLoading:$,isMessagesLoadingOlder:X,onLoadOlderMessages:()=>he({prepend:!0}),isConversationClosed:se,showRightPanel:nt,setShowRightPanel:Je,assigneeMenuOpen:it,setAssigneeMenuOpen:at,statusMenuOpen:ot,setStatusMenuOpen:rt}),(0,k.jsx)(De,{selectedConversation:Le,selectedContactId:Te,contactSummary:o,isSummaryLoading:ne,showRightPanel:nt,setShowDetails:Ze,showCrmPanel:et,showDetails:tt,tagsList:lt,recentNotes:Ne,recentTimeline:je,nextReminder:be,handleOpenFullCrm:j,handleRemoveTag:D,removingTagId:Re,setIsTagModalOpen:_e,normalizedStatus:dt,openDeleteConfirm:we,handleAddReminder:b,handleUpdateReminder:q,isSavingReminder:J,isUpdatingReminder:oe,reminderTitle:Ce,setReminderTitle:Ye,reminderDueAt:Ae,setReminderDueAt:Qe,reminderDescription:Se,setReminderDescription:He,editingReminderId:g,setEditingReminderId:ze,editReminderTitle:m,setEditReminderTitle:Be,editReminderDueAt:u,setEditReminderDueAt:We,editReminderDescription:c,setEditReminderDescription:Oe,handleAddNote:f,handleUpdateNote:B,isSavingNote:Z,isUpdatingNote:ae,noteDraft:ye,setNoteDraft:Ke,editingNoteId:v,setEditingNoteId:qe,editNoteContent:d,setEditNoteContent:Fe}),(0,k.jsx)(L,{isOpen:le,onClose:()=>_e(!1),contactId:Te,currentTags:lt,onTagAdded:Ie}),(0,k.jsx)(T,{open:a.open,title:a.title,message:"This action cannot be undone.",confirmText:"Delete",cancelText:"Cancel",danger:!0,loading:i,onCancel:l,onConfirm:x})]})}function Ee(){const e=R();return(0,k.jsx)(Ue,(0,l.A)({},e))}}}]);
//# sourceMappingURL=797.1e8076d1.chunk.js.map