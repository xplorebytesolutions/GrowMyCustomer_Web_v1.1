{"version":3,"file":"static/js/640.44b1a4ac.chunk.js","mappings":"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","sources":["hooks/useSignalR.js","../node_modules/dayjs/plugin/isToday.js","../node_modules/dayjs/plugin/isYesterday.js","pages/Inbox/InboxContext.jsx","pages/Inbox/components/InboxSidebar.jsx","hooks/useNotificationSound.js","pages/Inbox/components/ChatBubble.jsx","pages/Inbox/components/ChatWindow.jsx","pages/Inbox/components/QuickReplyPicker.jsx","pages/Inbox/components/EmojiPicker.jsx","pages/Inbox/components/ChatInput.jsx","pages/Inbox/components/ContactSidebar.jsx","pages/Inbox/components/ChatHeader.jsx","pages/Inbox/InboxWrapper.jsx"],"sourcesContent":["// ðŸ“„ src/hooks/useSignalR.js\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport * as signalR from \"@microsoft/signalr\";\r\nimport { toast } from \"react-toastify\";\r\nimport { TOKEN_KEY } from \"../api/axiosClient\"; // single source of truth\r\n\r\nconst REALTIME_TOAST_ID = \"signalr-realtime-failed\";\r\n\r\nfunction getHubUrl() {\r\n  const raw =\r\n    (process.env.REACT_APP_API_BASE_URL &&\r\n      process.env.REACT_APP_API_BASE_URL.trim()) ||\r\n    \"http://localhost:7113/api\";\r\n\r\n  const base = raw.replace(/\\/+$/, \"\");\r\n  return `${base}/hubs/inbox`; // => .../api/hubs/inbox\r\n}\r\n\r\nfunction isIgnorableSignalRError(err) {\r\n  const name = String(err?.name || \"\");\r\n  const msg = String(err?.message || err || \"\").toLowerCase();\r\n\r\n  return (\r\n    name === \"AbortError\" ||\r\n    msg.includes(\"stopped during negotiation\") ||\r\n    msg.includes(\"abort\") ||\r\n    msg.includes(\"canceled\") ||\r\n    msg.includes(\"cancelled\")\r\n  );\r\n}\r\n\r\nexport default function useSignalR({\r\n  onMessageReceived,\r\n  onUnreadChanged,\r\n} = {}) {\r\n  const [connection, setConnection] = useState(null);\r\n  const [isConnected, setIsConnected] = useState(false);\r\n\r\n  const connRef = useRef(null);\r\n  const mountedRef = useRef(false);\r\n  const startingRef = useRef(false);\r\n\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n\r\n    const hubUrl = getHubUrl();\r\n    const token = localStorage.getItem(TOKEN_KEY);\r\n\r\n    if (!token) {\r\n      console.warn(\"SignalR skipped: No auth token found.\");\r\n      setIsConnected(false);\r\n      return () => {\r\n        mountedRef.current = false;\r\n      };\r\n    }\r\n\r\n    // âœ… Build connection\r\n    // Append SA business context if selected\r\n    let finalUrl = hubUrl;\r\n    const saBizId = localStorage.getItem(\"sa_selectedBusinessId\");\r\n    if (saBizId) {\r\n      finalUrl += `?bizId=${encodeURIComponent(saBizId)}`;\r\n    }\r\n\r\n    const conn = new signalR.HubConnectionBuilder()\r\n      .withUrl(finalUrl, {\r\n        accessTokenFactory: () => localStorage.getItem(TOKEN_KEY) || \"\",\r\n        transport:\r\n          signalR.HttpTransportType.WebSockets |\r\n          signalR.HttpTransportType.LongPolling,\r\n      })\r\n      .withAutomaticReconnect([0, 2000, 5000, 10000])\r\n      .configureLogging(signalR.LogLevel.Information)\r\n      .build();\r\n\r\n    connRef.current = conn;\r\n    setConnection(conn);\r\n\r\n    // âœ… Subscribe before start\r\n    if (onMessageReceived) conn.on(\"ReceiveInboxMessage\", onMessageReceived);\r\n    if (onUnreadChanged) conn.on(\"UnreadCountChanged\", onUnreadChanged);\r\n\r\n    conn.onreconnecting(() => {\r\n      if (!mountedRef.current) return;\r\n      setIsConnected(false);\r\n    });\r\n\r\n    conn.onreconnected(() => {\r\n      if (!mountedRef.current) return;\r\n      setIsConnected(true);\r\n      toast.dismiss(REALTIME_TOAST_ID);\r\n    });\r\n\r\n    conn.onclose(err => {\r\n      if (!mountedRef.current) return;\r\n      setIsConnected(false);\r\n\r\n      // Ignore dev-mode abort noise\r\n      if (isIgnorableSignalRError(err)) return;\r\n\r\n      // âœ… Only ONE toast ever\r\n      toast.error(\"Real-time connection failed.\", {\r\n        toastId: REALTIME_TOAST_ID,\r\n      });\r\n    });\r\n\r\n    const start = async () => {\r\n      if (startingRef.current) return;\r\n      startingRef.current = true;\r\n\r\n      try {\r\n        await conn.start();\r\n        if (!mountedRef.current) return;\r\n\r\n        setIsConnected(true);\r\n        toast.dismiss(REALTIME_TOAST_ID);\r\n        // console.log(\"âœ… SignalR connected:\", hubUrl);\r\n        console.log(\"âœ… SignalR connected:\", finalUrl);\r\n      } catch (err) {\r\n        if (!mountedRef.current) return;\r\n\r\n        // Ignore dev-mode abort noise\r\n        if (isIgnorableSignalRError(err)) return;\r\n\r\n        setIsConnected(false);\r\n\r\n        const msg = String(err?.message || err || \"\").toLowerCase();\r\n        if (msg.includes(\"401\") || msg.includes(\"unauthorized\")) {\r\n          toast.error(\"SignalR unauthorized. Your session may have expired.\", {\r\n            toastId: REALTIME_TOAST_ID,\r\n          });\r\n        } else {\r\n          toast.error(\"Real-time connection failed.\", {\r\n            toastId: REALTIME_TOAST_ID,\r\n          });\r\n        }\r\n\r\n        console.error(\"âŒ SignalR start failed:\", err);\r\n      } finally {\r\n        startingRef.current = false;\r\n      }\r\n    };\r\n\r\n    start();\r\n\r\n    return () => {\r\n      mountedRef.current = false;\r\n\r\n      try {\r\n        if (onMessageReceived)\r\n          conn.off(\"ReceiveInboxMessage\", onMessageReceived);\r\n        if (onUnreadChanged) conn.off(\"UnreadCountChanged\", onUnreadChanged);\r\n      } catch {\r\n        // ignore\r\n      }\r\n\r\n      if (conn && conn.state !== signalR.HubConnectionState.Disconnected) {\r\n        conn.stop().catch(() => {});\r\n      }\r\n    };\r\n  }, [onMessageReceived, onUnreadChanged]);\r\n\r\n  return { connection, isConnected };\r\n}\r\n","!function(e,o){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=o():\"function\"==typeof define&&define.amd?define(o):(e=\"undefined\"!=typeof globalThis?globalThis:e||self).dayjs_plugin_isToday=o()}(this,(function(){\"use strict\";return function(e,o,t){o.prototype.isToday=function(){var e=\"YYYY-MM-DD\",o=t();return this.format(e)===o.format(e)}}}));","!function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define(t):(e=\"undefined\"!=typeof globalThis?globalThis:e||self).dayjs_plugin_isYesterday=t()}(this,(function(){\"use strict\";return function(e,t,n){t.prototype.isYesterday=function(){var e=\"YYYY-MM-DD\",t=n().subtract(1,\"day\");return this.format(e)===t.format(e)}}}));","import React, { createContext, useContext, useState, useEffect } from \"react\";\r\nimport useSignalR from \"../../hooks/useSignalR\";\r\nimport axiosClient from \"../../api/axiosClient\";\r\nimport { toast } from \"react-toastify\";\r\n\r\nconst InboxContext = createContext();\r\n\r\nexport const useInbox = () => useContext(InboxContext);\r\n\r\nexport const InboxProvider = ({ children }) => {\r\n  // All state is managed here\r\n  const { connection, isConnected } = useSignalR();\r\n  const [messages, setMessages] = useState([]);\r\n  const [selectedContactId, setSelectedContactId] = useState(null);\r\n  const [newMessage, setNewMessage] = useState(\"\");\r\n  const [contact, setContact] = useState(null);\r\n  const [playSound, setPlaySound] = useState(\r\n    localStorage.getItem(\"playSound\") === \"true\"\r\n  );\r\n  const [userHasInteracted, setUserHasInteracted] = useState(false);\r\n\r\n  const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n  // Track user interaction for sound autoplay\r\n  useEffect(() => {\r\n    const handleUserInteraction = () => setUserHasInteracted(true);\r\n    window.addEventListener(\"click\", handleUserInteraction);\r\n    window.addEventListener(\"keydown\", handleUserInteraction);\r\n    return () => {\r\n      window.removeEventListener(\"click\", handleUserInteraction);\r\n      window.removeEventListener(\"keydown\", handleUserInteraction);\r\n    };\r\n  }, []);\r\n\r\n  // Fetch contact details when a contact is selected\r\n  useEffect(() => {\r\n    if (!selectedContactId) {\r\n      setContact(null);\r\n      return;\r\n    }\r\n    axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n      setContact(res.data);\r\n    });\r\n  }, [selectedContactId]);\r\n\r\n  // Load message history with robust clearing logic\r\n  useEffect(() => {\r\n    if (!selectedContactId) {\r\n      setMessages([]);\r\n      return;\r\n    }\r\n    setMessages([]); // Instantly clear old messages for better UX\r\n    axiosClient\r\n      .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n      .then(res => {\r\n        const normalized = (res.data || []).map(m => ({\r\n          ...m,\r\n          messageContent: m.messageContent ?? m.message, // âœ… normalize\r\n        }));\r\n        setMessages(normalized);\r\n      })\r\n      .catch(err => {\r\n        console.error(\"âŒ Failed to load messages:\", err);\r\n        toast.error(\"Failed to load messages.\");\r\n      });\r\n  }, [selectedContactId]);\r\n\r\n  // SignalR listener for incoming messages\r\n  useEffect(() => {\r\n    if (!connection) return;\r\n\r\n    const handler = incoming => {\r\n      const normalized = {\r\n        ...incoming,\r\n        messageContent: incoming.messageContent ?? incoming.message, // âœ… normalize\r\n      };\r\n\r\n      if (\r\n        normalized.contactId !== selectedContactId &&\r\n        playSound &&\r\n        userHasInteracted\r\n      ) {\r\n        new Audio(\"/sounds/inbox_notify.mp3\").play().catch(() => {});\r\n      }\r\n\r\n      if (normalized.contactId === selectedContactId) {\r\n        setMessages(prev => {\r\n          if (!normalized.isIncoming) {\r\n            // This is our own message coming back from the server; replace the temp one\r\n            return prev.map(m => (m.status === \"Sending\" ? normalized : m));\r\n          }\r\n          // This is a new message from the contact; add it to the end\r\n          return [...prev, normalized];\r\n        });\r\n      }\r\n    };\r\n\r\n    connection.on(\"ReceiveInboxMessage\", handler);\r\n    return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n  }, [connection, selectedContactId, playSound, userHasInteracted]);\r\n\r\n  // Function to toggle notification sound\r\n  const toggleSound = async () => {\r\n    const newVal = !playSound;\r\n    if (newVal) {\r\n      try {\r\n        await new Audio(\"/sounds/inbox_notify.mp3\").play();\r\n        setPlaySound(true);\r\n        localStorage.setItem(\"playSound\", \"true\");\r\n      } catch (err) {\r\n        toast.error(\"ðŸ”‡ Browser blocked sound. Please enable autoplay.\");\r\n        setPlaySound(false);\r\n        localStorage.setItem(\"playSound\", \"false\");\r\n      }\r\n    } else {\r\n      setPlaySound(false);\r\n      localStorage.setItem(\"playSound\", \"false\");\r\n    }\r\n  };\r\n\r\n  // Function to send a message with optimistic UI\r\n  const sendMessage = async () => {\r\n    if (!selectedContactId || !newMessage.trim() || !isConnected) return;\r\n\r\n    const tempId = `temp_${Date.now()}`;\r\n    const optimisticMessage = {\r\n      id: tempId,\r\n      contactId: selectedContactId,\r\n      messageContent: newMessage, // âœ… consistent\r\n      isIncoming: false,\r\n      sentAt: new Date().toISOString(),\r\n      status: \"Sending\",\r\n    };\r\n\r\n    setMessages(prev => [...prev, optimisticMessage]);\r\n    setNewMessage(\"\");\r\n\r\n    try {\r\n      await connection.invoke(\"SendMessageToContact\", {\r\n        contactId: selectedContactId,\r\n        message: newMessage, // backend DTO expects \"message\"\r\n      });\r\n    } catch (err) {\r\n      console.error(\"âŒ Send failed:\", err);\r\n      toast.error(\"Failed to send message.\");\r\n      setMessages(prev =>\r\n        prev.map(m => (m.id === tempId ? { ...m, status: \"Failed\" } : m))\r\n      );\r\n    }\r\n  };\r\n\r\n  // The value provided to all consumer components\r\n  const value = {\r\n    connection,\r\n    isConnected,\r\n    messages,\r\n    selectedContactId,\r\n    setSelectedContactId,\r\n    newMessage,\r\n    setNewMessage,\r\n    contact,\r\n    playSound,\r\n    toggleSound,\r\n    sendMessage,\r\n    currentUserId,\r\n  };\r\n\r\n  return (\r\n    <InboxContext.Provider value={value}>{children}</InboxContext.Provider>\r\n  );\r\n};\r\n\r\n// import React, { createContext, useContext, useState, useEffect } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n\r\n// const InboxContext = createContext();\r\n\r\n// export const useInbox = () => useContext(InboxContext);\r\n\r\n// export const InboxProvider = ({ children }) => {\r\n//   // All state is managed here\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [playSound, setPlaySound] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n//   const [userHasInteracted, setUserHasInteracted] = useState(false);\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   // Track user interaction for sound autoplay\r\n//   useEffect(() => {\r\n//     const handleUserInteraction = () => setUserHasInteracted(true);\r\n//     window.addEventListener(\"click\", handleUserInteraction);\r\n//     window.addEventListener(\"keydown\", handleUserInteraction);\r\n//     return () => {\r\n//       window.removeEventListener(\"click\", handleUserInteraction);\r\n//       window.removeEventListener(\"keydown\", handleUserInteraction);\r\n//     };\r\n//   }, []);\r\n\r\n//   // Fetch contact details when a contact is selected\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   // Load message history with robust clearing logic\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setMessages([]);\r\n//       return;\r\n//     }\r\n//     setMessages([]); // Instantly clear old messages for better UX\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   // SignalR listener for incoming messages\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     const handler = incoming => {\r\n//       if (\r\n//         incoming.contactId !== selectedContactId &&\r\n//         playSound &&\r\n//         userHasInteracted\r\n//       ) {\r\n//         new Audio(\"/sounds/inbox_notify.mp3\").play().catch(() => {});\r\n//       }\r\n\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev => {\r\n//           if (!incoming.isIncoming) {\r\n//             // This is our own message coming back from the server; replace the temp one\r\n//             return prev.map(m => (m.status === \"Sending\" ? incoming : m));\r\n//           }\r\n//           // This is a new message from the contact; add it to the end\r\n//           return [...prev, incoming];\r\n//         });\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, playSound, userHasInteracted]);\r\n\r\n//   // Function to toggle notification sound\r\n//   const toggleSound = async () => {\r\n//     const newVal = !playSound;\r\n//     if (newVal) {\r\n//       try {\r\n//         await new Audio(\"/sounds/inbox_notify.mp3\").play();\r\n//         setPlaySound(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Browser blocked sound. Please enable autoplay.\");\r\n//         setPlaySound(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setPlaySound(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   };\r\n\r\n//   // Function to send a message with optimistic UI\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId || !newMessage.trim() || !isConnected) return;\r\n\r\n//     const tempId = `temp_${Date.now()}`;\r\n//     const optimisticMessage = {\r\n//       id: tempId,\r\n//       contactId: selectedContactId,\r\n//       messageContent: newMessage,\r\n//       isIncoming: false,\r\n//       sentAt: new Date().toISOString(),\r\n//       status: \"Sending\",\r\n//     };\r\n\r\n//     setMessages(prev => [...prev, optimisticMessage]);\r\n//     setNewMessage(\"\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//       setMessages(prev =>\r\n//         prev.map(m => (m.id === tempId ? { ...m, status: \"Failed\" } : m))\r\n//       );\r\n//     }\r\n//   };\r\n\r\n//   // The value provided to all consumer components\r\n//   const value = {\r\n//     connection,\r\n//     isConnected,\r\n//     messages,\r\n//     selectedContactId,\r\n//     setSelectedContactId,\r\n//     newMessage,\r\n//     setNewMessage,\r\n//     contact,\r\n//     playSound,\r\n//     toggleSound,\r\n//     sendMessage,\r\n//     currentUserId,\r\n//   };\r\n\r\n//   return (\r\n//     <InboxContext.Provider value={value}>{children}</InboxContext.Provider>\r\n//   );\r\n// };\r\n","// âœ… Final Updated InboxSidebar.jsx (auto-mark-read + refresh + sound on new unread)\r\nimport React, { useEffect, useState, useCallback } from \"react\";\r\nimport axiosClient from \"../../../api/axiosClient\";\r\nimport useSignalR from \"../../../hooks/useSignalR\";\r\nimport useNotificationSound from \"../../../hooks/useNotificationSound\"; // â¬…ï¸ NEW\r\n\r\nexport default function InboxSidebar({ onSelect, currentUserId }) {\r\n  const [contacts, setContacts] = useState([]);\r\n  const [selectedId, setSelectedId] = useState(null);\r\n  const [unreadCounts, setUnreadCounts] = useState({});\r\n  const [search, setSearch] = useState(\"\");\r\n  const { connection } = useSignalR();\r\n\r\n  // ðŸ”” Sound (autoplay-safe + throttled; uses /sounds/inbox_notify.mp3 by default)\r\n  const { play } = useNotificationSound({\r\n    // src: \"/sounds/inbox_notify.mp3\", // optional (default already this)\r\n    volume: 0.6,\r\n    throttleMs: 800,\r\n  });\r\n\r\n  const fetchUnreadCounts = useCallback(async () => {\r\n    try {\r\n      const res = await axiosClient.get(\"/inbox/unread-counts\");\r\n      setUnreadCounts(res.data || {});\r\n      console.log(\"âœ… Unread counts refreshed\");\r\n    } catch (err) {\r\n      console.error(\"âŒ Failed to refresh unread counts:\", err);\r\n    }\r\n  }, []);\r\n\r\n  const loadContactsAndUnread = useCallback(async () => {\r\n    try {\r\n      const [contactRes, countRes] = await Promise.all([\r\n        axiosClient.get(\"/contacts/all\"),\r\n        axiosClient.get(\"/inbox/unread-counts\"),\r\n      ]);\r\n      setContacts(contactRes.data || []);\r\n      setUnreadCounts(countRes.data || {});\r\n      console.log(\"âœ… Contacts and unread counts loaded\");\r\n    } catch (err) {\r\n      console.error(\"âŒ Failed to load inbox data:\", err);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    console.log(\"ðŸ“¥ InboxSidebar mounted | currentUserId:\", currentUserId);\r\n    loadContactsAndUnread();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [currentUserId]);\r\n\r\n  useEffect(() => {\r\n    if (!connection) return;\r\n\r\n    const handleUnread = payload => {\r\n      console.log(\"ðŸ”” [SignalR] UnreadCountChanged:\", payload);\r\n\r\n      // server says \"refresh your snapshot\"\r\n      if (payload && typeof payload === \"object\" && payload.refresh) {\r\n        fetchUnreadCounts();\r\n        return;\r\n      }\r\n\r\n      if (payload && typeof payload === \"object\") {\r\n        setUnreadCounts(payload);\r\n      }\r\n    };\r\n\r\n    connection.on(\"UnreadCountChanged\", handleUnread);\r\n    return () => connection.off(\"UnreadCountChanged\", handleUnread);\r\n  }, [connection, fetchUnreadCounts]);\r\n\r\n  useEffect(() => {\r\n    if (!connection) return;\r\n\r\n    const handleMessage = async msg => {\r\n      const cid = msg?.contactId ?? msg?.ContactId ?? null;\r\n      if (!cid) return;\r\n\r\n      const isIncoming =\r\n        typeof msg?.isIncoming !== \"undefined\"\r\n          ? !!msg.isIncoming\r\n          : msg?.senderId\r\n          ? false\r\n          : true;\r\n\r\n      console.log(\r\n        \"ðŸ“© [SignalR] Message:\",\r\n        msg,\r\n        \"| parsed contactId:\",\r\n        cid,\r\n        \"| isIncoming:\",\r\n        isIncoming\r\n      );\r\n\r\n      // Never badge on ANY outbound message\r\n      if (!isIncoming) return;\r\n\r\n      // If the active chat â†’ mark as read immediately\r\n      if (String(cid) === String(selectedId)) {\r\n        try {\r\n          if (connection?.invoke) {\r\n            await connection.invoke(\"MarkAsRead\", cid);\r\n            console.log(\"âœ… MarkAsRead via SignalR for\", cid);\r\n          } else {\r\n            await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);\r\n            console.log(\"âœ… MarkAsRead fallback HTTP for\", cid);\r\n          }\r\n        } catch (err) {\r\n          console.error(\"âŒ Failed to mark as read in active chat:\", err);\r\n        }\r\n        return; // do not increment badge or play sound\r\n      }\r\n\r\n      // Otherwise, increment unread count for that contact\r\n      setUnreadCounts(prev => ({\r\n        ...(prev || {}),\r\n        [cid]: (prev?.[cid] || 0) + 1,\r\n      }));\r\n\r\n      // ðŸ”” Play sound only when a new unread is created (non-active chat)\r\n      try {\r\n        play();\r\n      } catch {}\r\n    };\r\n\r\n    connection.on(\"ReceiveInboxMessage\", handleMessage);\r\n    return () => connection.off(\"ReceiveInboxMessage\", handleMessage);\r\n  }, [connection, selectedId, currentUserId, play]); // include play in deps\r\n\r\n  useEffect(() => {\r\n    if (!connection) return;\r\n    if (typeof connection.onreconnected === \"function\") {\r\n      connection.onreconnected(() => {\r\n        console.log(\"ðŸ” SignalR reconnected â€” reloading unread counts\");\r\n        loadContactsAndUnread();\r\n      });\r\n    }\r\n  }, [connection, loadContactsAndUnread]);\r\n\r\n  const handleSelect = async id => {\r\n    setSelectedId(id);\r\n    onSelect(id);\r\n\r\n    // Optimistic reset\r\n    setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));\r\n\r\n    try {\r\n      if (connection?.invoke) {\r\n        await connection.invoke(\"MarkAsRead\", id);\r\n        console.log(\"âœ… MarkAsRead via SignalR for\", id);\r\n        return;\r\n      }\r\n    } catch (err) {\r\n      console.warn(\"âš ï¸ SignalR MarkAsRead failed, fallback:\", err);\r\n    }\r\n\r\n    try {\r\n      await axiosClient.post(`/inbox/mark-read?contactId=${id}`);\r\n      console.log(\"âœ… MarkAsRead fallback HTTP for\", id);\r\n    } catch (err) {\r\n      console.error(\"âŒ Failed to mark as read via HTTP:\", err);\r\n    }\r\n  };\r\n\r\n  const getInitials = name =>\r\n    name\r\n      ?.split(\" \")\r\n      .map(n => n[0])\r\n      .join(\"\")\r\n      .substring(0, 2)\r\n      .toUpperCase();\r\n\r\n  const safeContacts = Array.isArray(contacts) ? contacts : [];\r\n  const filtered = safeContacts.filter(c =>\r\n    (c.name || c.phoneNumber || \"\")\r\n      .toString()\r\n      .toLowerCase()\r\n      .includes(search.toLowerCase())\r\n  );\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full\">\r\n      <div className=\"p-3 border-b\">\r\n        <input\r\n          type=\"text\"\r\n          placeholder=\"Search\"\r\n          className=\"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring\"\r\n          value={search}\r\n          onChange={e => setSearch(e.target.value)}\r\n        />\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        <div className=\"text-sm font-semibold text-gray-700 px-4 py-2\">\r\n          Contacts\r\n        </div>\r\n        {filtered.map(contact => {\r\n          const cid = String(contact.id);\r\n          const unread = Number(unreadCounts[cid] || 0);\r\n          return (\r\n            <div\r\n              key={contact.id}\r\n              onClick={() => handleSelect(contact.id)}\r\n              className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${\r\n                selectedId === contact.id ? \"bg-gray-200\" : \"\"\r\n              }`}\r\n            >\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white\">\r\n                  {getInitials(contact.name || contact.phoneNumber)}\r\n                </div>\r\n                <div className=\"flex flex-col\">\r\n                  <div className=\"font-medium text-sm text-gray-800 truncate\">\r\n                    {contact.name || contact.phoneNumber || \"Unknown\"}\r\n                  </div>\r\n                  {contact.name && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      {contact.phoneNumber}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              {unread > 0 && (\r\n                <div className=\"text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center\">\r\n                  {unread}\r\n                </div>\r\n              )}\r\n            </div>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// // âœ… Final Updated InboxSidebar.jsx (active chat auto-mark-read + refresh support)\r\n// import React, { useEffect, useState, useCallback } from \"react\";\r\n// import axiosClient from \"../../../api/axiosClient\";\r\n// import useSignalR from \"../../../hooks/useSignalR\";\r\n\r\n// export default function InboxSidebar({ onSelect, currentUserId }) {\r\n//   const [contacts, setContacts] = useState([]);\r\n//   const [selectedId, setSelectedId] = useState(null);\r\n//   const [unreadCounts, setUnreadCounts] = useState({});\r\n//   const [search, setSearch] = useState(\"\");\r\n//   const { connection } = useSignalR();\r\n\r\n//   const fetchUnreadCounts = useCallback(async () => {\r\n//     try {\r\n//       const res = await axiosClient.get(\"/inbox/unread-counts\");\r\n//       setUnreadCounts(res.data || {});\r\n//       console.log(\"âœ… Unread counts refreshed\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to refresh unread counts:\", err);\r\n//     }\r\n//   }, []);\r\n\r\n//   const loadContactsAndUnread = useCallback(async () => {\r\n//     try {\r\n//       const [contactRes, countRes] = await Promise.all([\r\n//         axiosClient.get(\"/contacts/all\"),\r\n//         axiosClient.get(\"/inbox/unread-counts\"),\r\n//       ]);\r\n//       setContacts(contactRes.data || []);\r\n//       setUnreadCounts(countRes.data || {});\r\n//       console.log(\"âœ… Contacts and unread counts loaded\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to load inbox data:\", err);\r\n//     }\r\n//   }, []);\r\n\r\n//   useEffect(() => {\r\n//     console.log(\"ðŸ“¥ InboxSidebar mounted | currentUserId:\", currentUserId);\r\n//     loadContactsAndUnread();\r\n//     // eslint-disable-next-line react-hooks/exhaustive-deps\r\n//   }, [currentUserId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleUnread = payload => {\r\n//       console.log(\"ðŸ”” [SignalR] UnreadCountChanged:\", payload);\r\n\r\n//       // server says \"refresh your snapshot\"\r\n//       if (payload && typeof payload === \"object\" && payload.refresh) {\r\n//         fetchUnreadCounts();\r\n//         return;\r\n//       }\r\n\r\n//       if (payload && typeof payload === \"object\") {\r\n//         setUnreadCounts(payload);\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"UnreadCountChanged\", handleUnread);\r\n//     return () => connection.off(\"UnreadCountChanged\", handleUnread);\r\n//   }, [connection, fetchUnreadCounts]);\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleMessage = async msg => {\r\n//       const cid = msg?.contactId ?? msg?.ContactId ?? null;\r\n//       if (!cid) return;\r\n\r\n//       const isIncoming =\r\n//         typeof msg?.isIncoming !== \"undefined\"\r\n//           ? !!msg.isIncoming\r\n//           : msg?.senderId\r\n//           ? false\r\n//           : true;\r\n\r\n//       console.log(\r\n//         \"ðŸ“© [SignalR] Message:\",\r\n//         msg,\r\n//         \"| parsed contactId:\",\r\n//         cid,\r\n//         \"| isIncoming:\",\r\n//         isIncoming\r\n//       );\r\n\r\n//       // Never badge on ANY outbound message\r\n//       if (!isIncoming) return;\r\n\r\n//       // If the active chat â†’ mark as read immediately\r\n//       if (String(cid) === String(selectedId)) {\r\n//         try {\r\n//           if (connection?.invoke) {\r\n//             await connection.invoke(\"MarkAsRead\", cid);\r\n//             console.log(\"âœ… MarkAsRead via SignalR for\", cid);\r\n//           } else {\r\n//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);\r\n//             console.log(\"âœ… MarkAsRead fallback HTTP for\", cid);\r\n//           }\r\n//         } catch (err) {\r\n//           console.error(\"âŒ Failed to mark as read in active chat:\", err);\r\n//         }\r\n//         return; // do not increment badge\r\n//       }\r\n\r\n//       // Otherwise, increment unread count for that contact\r\n//       setUnreadCounts(prev => ({\r\n//         ...(prev || {}),\r\n//         [cid]: (prev?.[cid] || 0) + 1,\r\n//       }));\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handleMessage);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handleMessage);\r\n//   }, [connection, selectedId, currentUserId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     if (typeof connection.onreconnected === \"function\") {\r\n//       connection.onreconnected(() => {\r\n//         console.log(\"ðŸ” SignalR reconnected â€” reloading unread counts\");\r\n//         loadContactsAndUnread();\r\n//       });\r\n//     }\r\n//   }, [connection, loadContactsAndUnread]);\r\n\r\n//   const handleSelect = async id => {\r\n//     setSelectedId(id);\r\n//     onSelect(id);\r\n\r\n//     // Optimistic reset\r\n//     setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));\r\n\r\n//     try {\r\n//       if (connection?.invoke) {\r\n//         await connection.invoke(\"MarkAsRead\", id);\r\n//         console.log(\"âœ… MarkAsRead via SignalR for\", id);\r\n//         return;\r\n//       }\r\n//     } catch (err) {\r\n//       console.warn(\"âš ï¸ SignalR MarkAsRead failed, fallback:\", err);\r\n//     }\r\n\r\n//     try {\r\n//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);\r\n//       console.log(\"âœ… MarkAsRead fallback HTTP for\", id);\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to mark as read via HTTP:\", err);\r\n//     }\r\n//   };\r\n\r\n//   const getInitials = name =>\r\n//     name\r\n//       ?.split(\" \")\r\n//       .map(n => n[0])\r\n//       .join(\"\")\r\n//       .substring(0, 2)\r\n//       .toUpperCase();\r\n\r\n//   const safeContacts = Array.isArray(contacts) ? contacts : [];\r\n//   const filtered = safeContacts.filter(c =>\r\n//     (c.name || c.phoneNumber || \"\")\r\n//       .toString()\r\n//       .toLowerCase()\r\n//       .includes(search.toLowerCase())\r\n//   );\r\n\r\n//   return (\r\n//     <div className=\"w-72 h-full flex flex-col border-r bg-white\">\r\n//       <div className=\"p-3 border-b\">\r\n//         <input\r\n//           type=\"text\"\r\n//           placeholder=\"Search\"\r\n//           className=\"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring\"\r\n//           value={search}\r\n//           onChange={e => setSearch(e.target.value)}\r\n//         />\r\n//       </div>\r\n\r\n//       <div className=\"flex-1 overflow-y-auto\">\r\n//         <div className=\"text-sm font-semibold text-gray-700 px-4 py-2\">\r\n//           Contacts\r\n//         </div>\r\n//         {filtered.map(contact => {\r\n//           const cid = String(contact.id);\r\n//           const unread = Number(unreadCounts[cid] || 0);\r\n//           return (\r\n//             <div\r\n//               key={contact.id}\r\n//               onClick={() => handleSelect(contact.id)}\r\n//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${\r\n//                 selectedId === contact.id ? \"bg-gray-200\" : \"\"\r\n//               }`}\r\n//             >\r\n//               <div className=\"flex items-center gap-3\">\r\n//                 <div className=\"w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white\">\r\n//                   {getInitials(contact.name || contact.phoneNumber)}\r\n//                 </div>\r\n//                 <div className=\"flex flex-col\">\r\n//                   <div className=\"font-medium text-sm text-gray-800 truncate\">\r\n//                     {contact.name || contact.phoneNumber || \"Unknown\"}\r\n//                   </div>\r\n//                   {contact.name && (\r\n//                     <div className=\"text-xs text-gray-500\">\r\n//                       {contact.phoneNumber}\r\n//                     </div>\r\n//                   )}\r\n//                 </div>\r\n//               </div>\r\n//               {unread > 0 && (\r\n//                 <div className=\"text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center\">\r\n//                   {unread}\r\n//                 </div>\r\n//               )}\r\n//             </div>\r\n//           );\r\n//         })}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// // âœ… Final Updated InboxSidebar.jsx (active chat auto-mark-read + refresh support)\r\n// import React, { useEffect, useState, useCallback } from \"react\";\r\n// import axiosClient from \"../../../api/axiosClient\";\r\n// import useSignalR from \"../../../hooks/useSignalR\";\r\n\r\n// export default function InboxSidebar({ onSelect, currentUserId }) {\r\n//   const [contacts, setContacts] = useState([]);\r\n//   const [selectedId, setSelectedId] = useState(null);\r\n//   const [unreadCounts, setUnreadCounts] = useState({});\r\n//   const [search, setSearch] = useState(\"\");\r\n//   const { connection } = useSignalR();\r\n\r\n//   // ðŸ”„ Helper to fetch ONLY unread counts (used by refresh signal)\r\n//   const fetchUnreadCounts = useCallback(async () => {\r\n//     try {\r\n//       const res = await axiosClient.get(\"/inbox/unread-counts\");\r\n//       setUnreadCounts(res.data || {});\r\n//       console.log(\"âœ… Unread counts refreshed\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to refresh unread counts:\", err);\r\n//     }\r\n//   }, []);\r\n\r\n//   // ðŸ”„ Helper to fetch contacts & unread counts (initial load / reconnect)\r\n//   const loadContactsAndUnread = useCallback(async () => {\r\n//     try {\r\n//       const [contactRes, countRes] = await Promise.all([\r\n//         axiosClient.get(\"/contacts/all\"),\r\n//         axiosClient.get(\"/inbox/unread-counts\"),\r\n//       ]);\r\n//       setContacts(contactRes.data || []);\r\n//       setUnreadCounts(countRes.data || {});\r\n//       console.log(\"âœ… Contacts and unread counts loaded\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to load inbox data:\", err);\r\n//     }\r\n//   }, []);\r\n\r\n//   useEffect(() => {\r\n//     console.log(\"ðŸ“¥ InboxSidebar mounted | currentUserId:\", currentUserId);\r\n//     loadContactsAndUnread();\r\n//     // eslint-disable-next-line react-hooks/exhaustive-deps\r\n//   }, [currentUserId]);\r\n\r\n//   // ðŸ“¡ Listen for server \"UnreadCountChanged\"\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleUnread = payload => {\r\n//       console.log(\"ðŸ”” [SignalR] UnreadCountChanged:\", payload);\r\n\r\n//       // ðŸš¦ Refresh signal from server: { refresh: true }\r\n//       if (payload && typeof payload === \"object\" && payload.refresh) {\r\n//         fetchUnreadCounts();\r\n//         return;\r\n//       }\r\n\r\n//       // Otherwise, payload is a map { [contactId]: count }\r\n//       if (payload && typeof payload === \"object\") {\r\n//         setUnreadCounts(payload);\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"UnreadCountChanged\", handleUnread);\r\n//     return () => connection.off(\"UnreadCountChanged\", handleUnread);\r\n//   }, [connection, fetchUnreadCounts]);\r\n\r\n//   // ðŸ“¡ Listen for incoming messages\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleMessage = async msg => {\r\n//       const cid = msg?.contactId ?? msg?.ContactId ?? null;\r\n//       if (!cid) return;\r\n\r\n//       const isIncoming =\r\n//         typeof msg?.isIncoming !== \"undefined\"\r\n//           ? !!msg.isIncoming\r\n//           : msg?.senderId\r\n//           ? false\r\n//           : true;\r\n\r\n//       console.log(\r\n//         \"ðŸ“© [SignalR] Message:\",\r\n//         msg,\r\n//         \"| parsed contactId:\",\r\n//         cid,\r\n//         \"| isIncoming:\",\r\n//         isIncoming\r\n//       );\r\n\r\n//       // ðŸ”• Never badge on ANY outbound message (self or other agents)\r\n//       if (!isIncoming) {\r\n//         return;\r\n//       }\r\n\r\n//       // ðŸŸ¢ If message is for the currently open chat â†’ mark as read immediately\r\n//       if (String(cid) === String(selectedId)) {\r\n//         console.log(\r\n//           \"ðŸ‘ï¸ Message received in active chat, marking as read immediately\"\r\n//         );\r\n\r\n//         try {\r\n//           if (connection?.invoke) {\r\n//             await connection.invoke(\"MarkAsRead\", cid);\r\n//             console.log(\"âœ… MarkAsRead invoked via SignalR for\", cid);\r\n//           } else {\r\n//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);\r\n//             console.log(\"âœ… MarkAsRead fallback HTTP for\", cid);\r\n//           }\r\n//         } catch (err) {\r\n//           console.error(\"âŒ Failed to mark as read in active chat:\", err);\r\n//         }\r\n\r\n//         return; // don't increment badge\r\n//       }\r\n\r\n//       // Otherwise, increment unread count for that contact\r\n//       setUnreadCounts(prev => ({\r\n//         ...(prev || {}),\r\n//         [cid]: (prev?.[cid] || 0) + 1,\r\n//       }));\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handleMessage);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handleMessage);\r\n//   }, [connection, selectedId, currentUserId]);\r\n\r\n//   // ðŸ” Handle reconnects â†’ reload contacts + counts (covers missed events)\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     if (typeof connection.onreconnected === \"function\") {\r\n//       connection.onreconnected(() => {\r\n//         console.log(\"ðŸ” SignalR reconnected â€” reloading unread counts\");\r\n//         loadContactsAndUnread();\r\n//       });\r\n//     }\r\n//   }, [connection, loadContactsAndUnread]);\r\n\r\n//   // âœ… Selecting a contact\r\n//   const handleSelect = async id => {\r\n//     setSelectedId(id);\r\n//     onSelect(id);\r\n\r\n//     // Optimistic reset\r\n//     setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));\r\n\r\n//     try {\r\n//       if (connection?.invoke) {\r\n//         await connection.invoke(\"MarkAsRead\", id);\r\n//         console.log(\"âœ… MarkAsRead invoked via SignalR for\", id);\r\n//         return;\r\n//       }\r\n//     } catch (err) {\r\n//       console.warn(\"âš ï¸ SignalR MarkAsRead failed, fallback:\", err);\r\n//     }\r\n\r\n//     try {\r\n//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);\r\n//       console.log(\"âœ… MarkAsRead fallback HTTP for\", id);\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to mark as read via HTTP:\", err);\r\n//     }\r\n//   };\r\n\r\n//   const getInitials = name =>\r\n//     name\r\n//       ?.split(\" \")\r\n//       .map(n => n[0])\r\n//       .join(\"\")\r\n//       .substring(0, 2)\r\n//       .toUpperCase();\r\n\r\n//   const safeContacts = Array.isArray(contacts) ? contacts : [];\r\n//   const filtered = safeContacts.filter(c =>\r\n//     (c.name || c.phoneNumber || \"\")\r\n//       .toString()\r\n//       .toLowerCase()\r\n//       .includes(search.toLowerCase())\r\n//   );\r\n\r\n//   return (\r\n//     <div className=\"w-72 h-full flex flex-col border-r bg-white\">\r\n//       <div className=\"p-3 border-b\">\r\n//         <input\r\n//           type=\"text\"\r\n//           placeholder=\"Search\"\r\n//           className=\"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring\"\r\n//           value={search}\r\n//           onChange={e => setSearch(e.target.value)}\r\n//         />\r\n//       </div>\r\n\r\n//       <div className=\"flex-1 overflow-y-auto\">\r\n//         <div className=\"text-sm font-semibold text-gray-700 px-4 py-2\">\r\n//           Contacts\r\n//         </div>\r\n//         {filtered.map(contact => {\r\n//           const cid = String(contact.id);\r\n//           const unread = Number(unreadCounts[cid] || 0);\r\n//           return (\r\n//             <div\r\n//               key={contact.id}\r\n//               onClick={() => handleSelect(contact.id)}\r\n//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${\r\n//                 selectedId === contact.id ? \"bg-gray-200\" : \"\"\r\n//               }`}\r\n//             >\r\n//               <div className=\"flex items-center gap-3\">\r\n//                 <div className=\"w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white\">\r\n//                   {getInitials(contact.name || contact.phoneNumber)}\r\n//                 </div>\r\n//                 <div className=\"flex flex-col\">\r\n//                   <div className=\"font-medium text-sm text-gray-800 truncate\">\r\n//                     {contact.name || contact.phoneNumber || \"Unknown\"}\r\n//                   </div>\r\n//                   {contact.name && (\r\n//                     <div className=\"text-xs text-gray-500\">\r\n//                       {contact.phoneNumber}\r\n//                     </div>\r\n//                   )}\r\n//                 </div>\r\n//               </div>\r\n//               {unread > 0 && (\r\n//                 <div className=\"text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center\">\r\n//                   {unread}\r\n//                 </div>\r\n//               )}\r\n//             </div>\r\n//           );\r\n//         })}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// // âœ… Final Updated InboxSidebar.jsx (active chat auto-mark-read)\r\n// import React, { useEffect, useState, useCallback } from \"react\";\r\n// import axiosClient from \"../../../api/axiosClient\";\r\n// import useSignalR from \"../../../hooks/useSignalR\";\r\n\r\n// export default function InboxSidebar({ onSelect, currentUserId }) {\r\n//   const [contacts, setContacts] = useState([]);\r\n//   const [selectedId, setSelectedId] = useState(null);\r\n//   const [unreadCounts, setUnreadCounts] = useState({});\r\n//   const [search, setSearch] = useState(\"\");\r\n//   const { connection } = useSignalR();\r\n\r\n//   // ðŸ”„ Helper to fetch contacts & unread counts\r\n//   const loadContactsAndUnread = useCallback(async () => {\r\n//     try {\r\n//       const [contactRes, countRes] = await Promise.all([\r\n//         axiosClient.get(\"/contacts/all\"),\r\n//         axiosClient.get(\"/inbox/unread-counts\"),\r\n//       ]);\r\n//       setContacts(contactRes.data || []);\r\n//       setUnreadCounts(countRes.data || {});\r\n//       console.log(\"âœ… Contacts and unread counts loaded\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to load inbox data:\", err);\r\n//     }\r\n//   }, []);\r\n\r\n//   useEffect(() => {\r\n//     console.log(\"ðŸ“¥ InboxSidebar mounted | currentUserId:\", currentUserId);\r\n//     loadContactsAndUnread();\r\n//     // eslint-disable-next-line react-hooks/exhaustive-deps\r\n//   }, [currentUserId]);\r\n\r\n//   // ðŸ“¡ Listen for server \"UnreadCountChanged\"\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleUnread = payload => {\r\n//       console.log(\"ðŸ”” [SignalR] UnreadCountChanged:\", payload);\r\n//       if (payload && typeof payload === \"object\") {\r\n//         setUnreadCounts(payload);\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"UnreadCountChanged\", handleUnread);\r\n//     return () => connection.off(\"UnreadCountChanged\", handleUnread);\r\n//   }, [connection]);\r\n\r\n//   // ðŸ“¡ Listen for incoming messages\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleMessage = async msg => {\r\n//       const cid = msg?.contactId ?? msg?.ContactId ?? null;\r\n//       if (!cid) return;\r\n\r\n//       const isIncoming =\r\n//         typeof msg?.isIncoming !== \"undefined\"\r\n//           ? !!msg.isIncoming\r\n//           : msg?.senderId\r\n//           ? false\r\n//           : true;\r\n\r\n//       console.log(\r\n//         \"ðŸ“© [SignalR] Message:\",\r\n//         msg,\r\n//         \"| parsed contactId:\",\r\n//         cid,\r\n//         \"| isIncoming:\",\r\n//         isIncoming\r\n//       );\r\n\r\n//       // Skip self/outgoing messages\r\n//       if (\r\n//         !isIncoming &&\r\n//         msg.senderId &&\r\n//         String(msg.senderId) === String(currentUserId)\r\n//       ) {\r\n//         console.log(\"â†©ï¸ Skipping self-sent message\");\r\n//         return;\r\n//       }\r\n\r\n//       // ðŸŸ¢ If message is for the currently open chat â†’ mark as read immediately\r\n//       if (String(cid) === String(selectedId)) {\r\n//         console.log(\r\n//           \"ðŸ‘ï¸ Message received in active chat, marking as read immediately\"\r\n//         );\r\n\r\n//         try {\r\n//           if (connection?.invoke) {\r\n//             await connection.invoke(\"MarkAsRead\", cid);\r\n//             console.log(\"âœ… MarkAsRead invoked via SignalR for\", cid);\r\n//           } else {\r\n//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);\r\n//             console.log(\"âœ… MarkAsRead fallback HTTP for\", cid);\r\n//           }\r\n//         } catch (err) {\r\n//           console.error(\"âŒ Failed to mark as read in active chat:\", err);\r\n//         }\r\n\r\n//         return; // don't increment badge\r\n//       }\r\n\r\n//       // Otherwise, increment unread count for that contact\r\n//       setUnreadCounts(prev => ({\r\n//         ...prev,\r\n//         [cid]: (prev?.[cid] || 0) + 1,\r\n//       }));\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handleMessage);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handleMessage);\r\n//   }, [connection, selectedId, currentUserId]);\r\n\r\n//   // ðŸ” Handle reconnects â†’ reload counts\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     if (typeof connection.onreconnected === \"function\") {\r\n//       connection.onreconnected(() => {\r\n//         console.log(\"ðŸ” SignalR reconnected â€” reloading unread counts\");\r\n//         loadContactsAndUnread();\r\n//       });\r\n//     }\r\n//   }, [connection, loadContactsAndUnread]);\r\n\r\n//   // âœ… Selecting a contact\r\n//   const handleSelect = async id => {\r\n//     setSelectedId(id);\r\n//     onSelect(id);\r\n\r\n//     // Optimistic reset\r\n//     setUnreadCounts(prev => ({ ...prev, [id]: 0 }));\r\n\r\n//     try {\r\n//       if (connection?.invoke) {\r\n//         await connection.invoke(\"MarkAsRead\", id);\r\n//         console.log(\"âœ… MarkAsRead invoked via SignalR for\", id);\r\n//         return;\r\n//       }\r\n//     } catch (err) {\r\n//       console.warn(\"âš ï¸ SignalR MarkAsRead failed, fallback:\", err);\r\n//     }\r\n\r\n//     try {\r\n//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);\r\n//       console.log(\"âœ… MarkAsRead fallback HTTP for\", id);\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to mark as read via HTTP:\", err);\r\n//     }\r\n//   };\r\n\r\n//   const getInitials = name =>\r\n//     name\r\n//       ?.split(\" \")\r\n//       .map(n => n[0])\r\n//       .join(\"\")\r\n//       .substring(0, 2)\r\n//       .toUpperCase();\r\n\r\n//   const safeContacts = Array.isArray(contacts) ? contacts : [];\r\n//   const filtered = safeContacts.filter(c =>\r\n//     (c.name || c.phoneNumber || \"\")\r\n//       .toString()\r\n//       .toLowerCase()\r\n//       .includes(search.toLowerCase())\r\n//   );\r\n\r\n//   return (\r\n//     <div className=\"w-72 h-full flex flex-col border-r bg-white\">\r\n//       <div className=\"p-3 border-b\">\r\n//         <input\r\n//           type=\"text\"\r\n//           placeholder=\"Search\"\r\n//           className=\"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring\"\r\n//           value={search}\r\n//           onChange={e => setSearch(e.target.value)}\r\n//         />\r\n//       </div>\r\n\r\n//       <div className=\"flex-1 overflow-y-auto\">\r\n//         <div className=\"text-sm font-semibold text-gray-700 px-4 py-2\">\r\n//           Contacts\r\n//         </div>\r\n//         {filtered.map(contact => {\r\n//           const cid = String(contact.id);\r\n//           const unread = Number(unreadCounts[cid] || 0);\r\n//           return (\r\n//             <div\r\n//               key={contact.id}\r\n//               onClick={() => handleSelect(contact.id)}\r\n//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${\r\n//                 selectedId === contact.id ? \"bg-gray-200\" : \"\"\r\n//               }`}\r\n//             >\r\n//               <div className=\"flex items-center gap-3\">\r\n//                 <div className=\"w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white\">\r\n//                   {getInitials(contact.name || contact.phoneNumber)}\r\n//                 </div>\r\n//                 <div className=\"flex flex-col\">\r\n//                   <div className=\"font-medium text-sm text-gray-800 truncate\">\r\n//                     {contact.name || contact.phoneNumber || \"Unknown\"}\r\n//                   </div>\r\n//                   {contact.name && (\r\n//                     <div className=\"text-xs text-gray-500\">\r\n//                       {contact.phoneNumber}\r\n//                     </div>\r\n//                   )}\r\n//                 </div>\r\n//               </div>\r\n//               {unread > 0 && (\r\n//                 <div className=\"text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center\">\r\n//                   {unread}\r\n//                 </div>\r\n//               )}\r\n//             </div>\r\n//           );\r\n//         })}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// // âœ… Final Updated InboxSidebar.jsx\r\n// import React, { useEffect, useState, useCallback } from \"react\";\r\n// import axiosClient from \"../../../api/axiosClient\";\r\n// import useSignalR from \"../../../hooks/useSignalR\";\r\n\r\n// export default function InboxSidebar({ onSelect, currentUserId }) {\r\n//   const [contacts, setContacts] = useState([]);\r\n//   const [selectedId, setSelectedId] = useState(null);\r\n//   const [unreadCounts, setUnreadCounts] = useState({});\r\n//   const [search, setSearch] = useState(\"\");\r\n//   const { connection } = useSignalR();\r\n\r\n//   // Helper to load contacts + unread counts (used on mount & reconnect)\r\n//   const loadContactsAndUnread = useCallback(async () => {\r\n//     try {\r\n//       const [contactRes, countRes] = await Promise.all([\r\n//         axiosClient.get(\"/contacts/all\"),\r\n//         axiosClient.get(\"/inbox/unread-counts\"),\r\n//       ]);\r\n//       setContacts(contactRes.data || []);\r\n//       setUnreadCounts(countRes.data || {});\r\n//       console.log(\"âœ… Contacts and unread counts loaded\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Failed to load inbox data:\", err);\r\n//     }\r\n//   }, []);\r\n\r\n//   useEffect(() => {\r\n//     console.log(\"ðŸ“¥ InboxSidebar mounted | currentUserId:\", currentUserId);\r\n//     loadContactsAndUnread();\r\n//     // eslint-disable-next-line react-hooks/exhaustive-deps\r\n//   }, [currentUserId]); // run on mount or when currentUserId changes\r\n\r\n//   // Listen for server-side UnreadCountChanged pushes (authoritative state)\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleUnread = payload => {\r\n//       // payload expected to be a dictionary: { \"<contactId>\": <count>, ... }\r\n//       console.log(\"ðŸ”” [SignalR] UnreadCountChanged:\", payload);\r\n//       if (payload && typeof payload === \"object\") {\r\n//         setUnreadCounts(payload);\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"UnreadCountChanged\", handleUnread);\r\n\r\n//     return () => {\r\n//       connection.off(\"UnreadCountChanged\", handleUnread);\r\n//     };\r\n//   }, [connection]);\r\n\r\n//   // Listen for incoming messages and increment unread for the specific contact (optimistic)\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handleMessage = msg => {\r\n//       // Normalize incoming payload fields safely\r\n//       const contactId = msg?.contactId ?? msg?.ContactId ?? null;\r\n//       const isIncoming = (() => {\r\n//         if (typeof msg?.isIncoming !== \"undefined\") return !!msg.isIncoming;\r\n//         if (typeof msg?.IsIncoming !== \"undefined\") return !!msg.IsIncoming;\r\n//         // fallback: treat presence of senderId or message from contact as incoming\r\n//         return msg?.senderId ? false : true;\r\n//       })();\r\n\r\n//       // choose a stable identifier (string)\r\n//       const cid = contactId ? String(contactId) : null;\r\n//       if (!cid) return;\r\n\r\n//       console.log(\r\n//         \"ðŸ“© [SignalR] Received message:\",\r\n//         msg,\r\n//         \"parsed contactId:\",\r\n//         cid,\r\n//         \"isIncoming:\",\r\n//         isIncoming\r\n//       );\r\n\r\n//       // Don't increment for outgoing / self-sent messages\r\n//       // (some payloads set isIncoming=false for messages sent by this user)\r\n//       if (!isIncoming) {\r\n//         // if the hub sends senderId for outgoing messages, we can check it too:\r\n//         if (msg.senderId && String(msg.senderId) === String(currentUserId)) {\r\n//           console.log(\"â†©ï¸ Skipping self-sent message\");\r\n//           return;\r\n//         }\r\n//         // otherwise skip any non-incoming message\r\n//         return;\r\n//       }\r\n\r\n//       // If the contact is currently open, do not bump unread (they see it)\r\n//       if (cid === selectedId) {\r\n//         console.log(\"ðŸ‘ï¸ Contact already open, skipping increment for\", cid);\r\n//         return;\r\n//       }\r\n\r\n//       // Increment unread for that contact\r\n//       setUnreadCounts(prev => {\r\n//         const prevCount = Number(prev?.[cid] || 0);\r\n//         const next = { ...(prev || {}) };\r\n//         next[cid] = prevCount + 1;\r\n//         console.log(`ðŸ”º Unread for ${cid} => ${next[cid]}`);\r\n//         return next;\r\n//       });\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handleMessage);\r\n\r\n//     return () => {\r\n//       connection.off(\"ReceiveInboxMessage\", handleMessage);\r\n//     };\r\n//   }, [connection, selectedId, currentUserId]);\r\n\r\n//   // On SignalR reconnect, reload authoritative unread counts to avoid missed events\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     // Some HubConnection implementations provide onreconnected\r\n//     if (typeof connection.onreconnected === \"function\") {\r\n//       connection.onreconnected(() => {\r\n//         console.log(\r\n//           \"ðŸ” SignalR reconnected â€” reloading contacts & unread counts\"\r\n//         );\r\n//         loadContactsAndUnread();\r\n//       });\r\n//     }\r\n\r\n//     // Also handle general reconnect detection if available\r\n//     if (typeof connection.onreconnecting === \"function\") {\r\n//       connection.onreconnecting(() => {\r\n//         console.log(\"âš ï¸ SignalR reconnecting...\");\r\n//       });\r\n//     }\r\n\r\n//     return () => {\r\n//       try {\r\n//         if (typeof connection.onreconnected === \"function\") {\r\n//           // no off for onreconnected in some implementations - ignore if unavailable\r\n//         }\r\n//       } catch (e) {}\r\n//     };\r\n//   }, [connection, loadContactsAndUnread]);\r\n\r\n//   // Handler when user selects a contact\r\n//   // const handleSelect = async id => {\r\n//   //   setSelectedId(id);\r\n//   //   onSelect(id);\r\n\r\n//   //   // Optimistically clear unread badge\r\n//   //   setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));\r\n\r\n//   //   // Tell server this user has read messages (preferred: SignalR)\r\n//   //   try {\r\n//   //     if (connection && typeof connection.invoke === \"function\") {\r\n//   //       await connection.invoke(\"MarkAsRead\", id);\r\n//   //       console.log(\"âœ… MarkAsRead invoked via SignalR for\", id);\r\n//   //       return;\r\n//   //     }\r\n//   //   } catch (err) {\r\n//   //     console.warn(\"âš ï¸ SignalR MarkAsRead failed, falling back to HTTP:\", err);\r\n//   //   }\r\n\r\n//   //   // Fallback: HTTP endpoint (keeps backward compatibility)\r\n//   //   try {\r\n//   //     await axiosClient.post(`/inbox/mark-read?contactId=${id}`);\r\n//   //     console.log(\"âœ… Marked messages as read (HTTP) for contact:\", id);\r\n//   //   } catch (err) {\r\n//   //     console.error(\"âŒ Failed to mark as read via HTTP:\", err);\r\n//   //   }\r\n//   // };\r\n//   const handleSelect = async id => {\r\n//     setSelectedId(id);\r\n//     onSelect(id);\r\n\r\n//     setUnreadCounts(prev => ({ ...prev, [id]: 0 }));\r\n\r\n//     try {\r\n//       if (connection?.invoke) {\r\n//         await connection.invoke(\"MarkAsRead\", id);\r\n//       }\r\n//     } catch {\r\n//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);\r\n//     }\r\n//   };\r\n\r\n//   const getInitials = name =>\r\n//     name\r\n//       ?.split(\" \")\r\n//       .map(n => n[0])\r\n//       .join(\"\")\r\n//       .substring(0, 2)\r\n//       .toUpperCase();\r\n\r\n//   const safeContacts = Array.isArray(contacts) ? contacts : [];\r\n//   const filtered = safeContacts.filter(c =>\r\n//     (c.name || c.phoneNumber || \"\")\r\n//       .toString()\r\n//       .toLowerCase()\r\n//       .includes(search.toLowerCase())\r\n//   );\r\n\r\n//   return (\r\n//     <div className=\"w-72 h-full flex flex-col border-r bg-white\">\r\n//       <div className=\"p-3 border-b\">\r\n//         <input\r\n//           type=\"text\"\r\n//           placeholder=\"Search\"\r\n//           className=\"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring\"\r\n//           value={search}\r\n//           onChange={e => setSearch(e.target.value)}\r\n//         />\r\n//       </div>\r\n\r\n//       <div className=\"flex-1 overflow-y-auto\">\r\n//         <div className=\"text-sm font-semibold text-gray-700 px-4 py-2\">\r\n//           Contacts\r\n//         </div>\r\n//         {filtered.map(contact => {\r\n//           const cid = String(contact.id);\r\n//           const unread = Number(unreadCounts[cid] || 0);\r\n//           // debug log (can remove later)\r\n//           // console.log(`ðŸ” Rendering ${contact.id} | unread: ${unread}`);\r\n//           return (\r\n//             <div\r\n//               key={contact.id}\r\n//               onClick={() => handleSelect(contact.id)}\r\n//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${\r\n//                 selectedId === contact.id ? \"bg-gray-200\" : \"\"\r\n//               }`}\r\n//             >\r\n//               <div className=\"flex items-center gap-3\">\r\n//                 <div className=\"w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white\">\r\n//                   {getInitials(contact.name || contact.phoneNumber)}\r\n//                 </div>\r\n//                 <div className=\"flex flex-col\">\r\n//                   <div className=\"font-medium text-sm text-gray-800 truncate\">\r\n//                     {contact.name || contact.phoneNumber || \"Unknown\"}\r\n//                   </div>\r\n//                   {contact.name && (\r\n//                     <div className=\"text-xs text-gray-500\">\r\n//                       {contact.phoneNumber}\r\n//                     </div>\r\n//                   )}\r\n//                 </div>\r\n//               </div>\r\n//               {unread > 0 && (\r\n//                 <div className=\"text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center\">\r\n//                   {unread}\r\n//                 </div>\r\n//               )}\r\n//             </div>\r\n//           );\r\n//         })}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n","import { useEffect, useState, useRef, useCallback } from \"react\";\r\n\r\n/**\r\n * Production-grade notification sound hook\r\n * - Keeps your API: { enabled, toggleSound, play }\r\n * - Adds:\r\n *   â€¢ Autoplay-safe: waits for first user interaction to unlock audio\r\n *   â€¢ Throttle: avoid spammy dings on message bursts (default 800ms)\r\n *   â€¢ Volume with persistence (localStorage: playSoundVolume)\r\n *   â€¢ Resilient playback: retries with a fresh Audio element if needed\r\n *\r\n * Optional options (backward compatible):\r\n *   useNotificationSound({ src, volume, throttleMs })\r\n */\r\nexport default function useNotificationSound(options = {}) {\r\n  const {\r\n    src = \"/sounds/inbox_notify.mp3\",\r\n    volume = 0.6, // 0..1\r\n    throttleMs = 800, // prevent spam\r\n    storageEnabledKey = \"playSound\",\r\n    storageVolumeKey = \"playSoundVolume\",\r\n  } = options;\r\n\r\n  // Enabled flag persists to localStorage (default OFF if key missing, matches your old behavior)\r\n  const [enabled, setEnabled] = useState(() => {\r\n    try {\r\n      return localStorage.getItem(storageEnabledKey) === \"true\";\r\n    } catch {\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // Volume persists as well\r\n  const [vol, setVol] = useState(() => {\r\n    try {\r\n      const raw = localStorage.getItem(storageVolumeKey);\r\n      const v = raw == null ? volume : parseFloat(raw);\r\n      return Number.isFinite(v) ? Math.min(1, Math.max(0, v)) : volume;\r\n    } catch {\r\n      return volume;\r\n    }\r\n  });\r\n\r\n  // Autoplay gating: many browsers block audio until user interacts\r\n  const [userInteracted, setUserInteracted] = useState(false);\r\n\r\n  const audioRef = useRef(null);\r\n  const lastPlayedAtRef = useRef(0);\r\n\r\n  // Create or refresh audio element when src/vol changes\r\n  useEffect(() => {\r\n    let a = audioRef.current;\r\n    if (!a) {\r\n      a = new Audio();\r\n      audioRef.current = a;\r\n    }\r\n    a.src = src;\r\n    a.preload = \"auto\";\r\n    a.volume = vol;\r\n  }, [src, vol]);\r\n\r\n  // Persist enabled + volume\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem(storageEnabledKey, String(enabled));\r\n    } catch {}\r\n  }, [enabled, storageEnabledKey]);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem(storageVolumeKey, String(vol));\r\n    } catch {}\r\n  }, [vol, storageVolumeKey]);\r\n\r\n  // Unlock audio on first interaction (Safari/iOS/Chrome policies)\r\n  useEffect(() => {\r\n    if (userInteracted) return;\r\n\r\n    const unlock = () => {\r\n      setUserInteracted(true);\r\n      // Try a quick play/pause to unlock\r\n      try {\r\n        const a = audioRef.current;\r\n        if (a)\r\n          a.play()\r\n            .then(() => a.pause())\r\n            .catch(() => {});\r\n      } catch {}\r\n      window.removeEventListener(\"pointerdown\", unlock);\r\n      window.removeEventListener(\"keydown\", unlock);\r\n      window.removeEventListener(\"touchstart\", unlock);\r\n    };\r\n\r\n    window.addEventListener(\"pointerdown\", unlock, { passive: true });\r\n    window.addEventListener(\"keydown\", unlock);\r\n    window.addEventListener(\"touchstart\", unlock, { passive: true });\r\n    return () => {\r\n      window.removeEventListener(\"pointerdown\", unlock);\r\n      window.removeEventListener(\"keydown\", unlock);\r\n      window.removeEventListener(\"touchstart\", unlock);\r\n    };\r\n  }, [userInteracted]);\r\n\r\n  // Toggle ON/OFF and store in localStorage\r\n  const toggleSound = useCallback(() => {\r\n    setEnabled(prev => {\r\n      const next = !prev;\r\n      try {\r\n        localStorage.setItem(storageEnabledKey, String(next));\r\n      } catch {}\r\n      return next;\r\n    });\r\n  }, [storageEnabledKey]);\r\n\r\n  // Public: play the sound (throttled + gated)\r\n  const play = useCallback(() => {\r\n    const now = Date.now();\r\n    if (now - lastPlayedAtRef.current < throttleMs) return;\r\n    lastPlayedAtRef.current = now;\r\n\r\n    // Re-check at call time (handles multi-tab changes)\r\n    let isAllowed = false;\r\n    try {\r\n      isAllowed = localStorage.getItem(storageEnabledKey) === \"true\";\r\n    } catch {}\r\n\r\n    if (!isAllowed || !enabled || !userInteracted) return;\r\n\r\n    const a = audioRef.current;\r\n    if (!a) return;\r\n\r\n    try {\r\n      a.currentTime = 0;\r\n      a.play().catch(() => {\r\n        // Fallback: create a fresh element (sometimes helps on mobile)\r\n        try {\r\n          const b = new Audio(a.src);\r\n          b.volume = a.volume;\r\n          b.play().catch(() => {});\r\n        } catch {}\r\n      });\r\n    } catch {}\r\n  }, [enabled, userInteracted, throttleMs, storageEnabledKey]);\r\n\r\n  // Extra helpers if you want to expose them later\r\n  const setVolume = useCallback(v => {\r\n    setVol(Math.min(1, Math.max(0, Number(v))));\r\n  }, []);\r\n\r\n  return {\r\n    // Backward-compatible API\r\n    enabled,\r\n    toggleSound,\r\n    play,\r\n\r\n    // Optional extras (handy for a header toggle UI)\r\n    volume: vol,\r\n    setVolume,\r\n    userInteracted,\r\n  };\r\n}\r\n\r\n// import { useEffect, useState, useRef } from \"react\";\r\n\r\n// export default function useNotificationSound() {\r\n//   const [enabled, setEnabled] = useState(() => {\r\n//     return localStorage.getItem(\"playSound\") === \"true\";\r\n//   });\r\n\r\n//   const audioRef = useRef(null);\r\n\r\n//   // Load audio file once\r\n//   useEffect(() => {\r\n//     audioRef.current = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//     audioRef.current.preload = \"auto\";\r\n//   }, []);\r\n\r\n//   // Toggle ON/OFF and store in localStorage\r\n//   const toggleSound = () => {\r\n//     const newVal = !enabled;\r\n//     setEnabled(newVal);\r\n//     localStorage.setItem(\"playSound\", newVal);\r\n//   };\r\n\r\n//   // âœ… Safe + up-to-date check\r\n//   const play = () => {\r\n//     const isAllowed = localStorage.getItem(\"playSound\") === \"true\";\r\n//     if (!isAllowed || !audioRef.current) return;\r\n\r\n//     audioRef.current.play().catch(err => {\r\n//       console.warn(\"ðŸ”‡ Sound blocked by browser:\", err);\r\n//     });\r\n//   };\r\n\r\n//   return {\r\n//     enabled,\r\n//     toggleSound,\r\n//     play,\r\n//   };\r\n// }\r\n\r\n// import { useCallback, useState } from \"react\";\r\n// import { toast } from \"react-toastify\";\r\n\r\n// /**\r\n//  * Hook to manage notification sound toggle logic.\r\n//  * Stores preference in localStorage and ensures autoplay permission.\r\n//  */\r\n// export default function useNotificationSound() {\r\n//   const [isSoundOn, setIsSoundOn] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n\r\n//   const toggleSound = useCallback(async () => {\r\n//     const newVal = !isSoundOn;\r\n\r\n//     if (newVal) {\r\n//       try {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         await audio.play(); // Attempt to get autoplay permission\r\n//         audio.pause();\r\n\r\n//         setIsSoundOn(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Browser blocked autoplay. Please interact first.\");\r\n//         console.warn(\"âš ï¸ Autoplay blocked:\", err);\r\n\r\n//         setIsSoundOn(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setIsSoundOn(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   }, [isSoundOn]);\r\n\r\n//   return { isSoundOn, toggleSound };\r\n// }\r\n","import React, { useState, useRef, useEffect } from \"react\";\r\nimport dayjs from \"dayjs\";\r\nimport {\r\n  FaCheck,\r\n  FaCheckDouble,\r\n  FaClock,\r\n  FaExclamationCircle,\r\n} from \"react-icons/fa\";\r\n\r\nexport default function ChatBubble({ message, isOwn }) {\r\n  const [expanded, setExpanded] = useState(false);\r\n  const messageRef = useRef(null);\r\n  const [isOverflowing, setIsOverflowing] = useState(false);\r\n\r\n  const time = dayjs(message.sentAt || message.createdAt).format(\"h:mm A\");\r\n  const messageText =\r\n    message.renderedBody ||\r\n    message.message ||\r\n    message.messageContent ||\r\n    \"[no message]\";\r\n\r\n  useEffect(() => {\r\n    const el = messageRef.current;\r\n    if (el && el.scrollHeight > el.clientHeight + 10) {\r\n      setIsOverflowing(true);\r\n    }\r\n  }, []);\r\n\r\n  const baseStyle =\r\n    \"px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap\";\r\n\r\n  const ownStyle = \"bg-green-600 text-white rounded-2xl rounded-br-sm\";\r\n  const incomingStyle = \"bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm\";\r\n\r\n  const tickColor = isOwn ? \"text-white/70\" : \"text-gray-500\";\r\n\r\n  return (\r\n    <div className={`flex ${isOwn ? \"justify-end\" : \"justify-start\"} mb-2`}>\r\n      <div\r\n        ref={messageRef}\r\n        onClick={() => isOverflowing && setExpanded(!expanded)}\r\n        className={`${baseStyle} ${isOwn ? ownStyle : incomingStyle} ${\r\n          expanded ? \"cursor-zoom-out\" : isOverflowing ? \"cursor-zoom-in\" : \"\"\r\n        }`}\r\n        style={{\r\n          overflow: \"hidden\",\r\n          whiteSpace: expanded ? \"normal\" : \"pre-wrap\",\r\n        }}\r\n      >\r\n        <div className=\"flex items-end justify-between gap-2\">\r\n          <span className=\"flex-1\">{messageText}</span>\r\n          <span className={`text-[11px] flex items-center gap-1 ${tickColor}`}>\r\n            {time}\r\n            {isOwn && (\r\n              <>\r\n                {/* {message.status === \"Sent\" && <FaCheck />}\r\n                {message.status === \"Delivered\" && <FaCheckDouble />}\r\n                {message.status === \"Read\" && (\r\n                  <FaCheckDouble className=\"text-blue-400\" />\r\n                )} */}\r\n                {message.status === \"Sending\" && <FaClock />}\r\n                {message.status === \"Failed\" && (\r\n                  <FaExclamationCircle className=\"text-red-400\" />\r\n                )}\r\n                {message.status === \"Sent\" && <FaCheck />}\r\n                {message.status === \"Delivered\" && <FaCheckDouble />}\r\n                {message.status === \"Read\" && (\r\n                  <FaCheckDouble className=\"text-blue-400\" />\r\n                )}\r\n              </>\r\n            )}\r\n          </span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// import React, { useState, useRef, useEffect } from \"react\";\r\n// import dayjs from \"dayjs\";\r\n// import { FaCheck, FaCheckDouble } from \"react-icons/fa\";\r\n\r\n// export default function ChatBubble({ message, isOwn }) {\r\n//   const [expanded, setExpanded] = useState(false);\r\n//   const messageRef = useRef(null);\r\n//   const [isOverflowing, setIsOverflowing] = useState(false);\r\n\r\n//   const time = dayjs(message.sentAt || message.createdAt).format(\"h:mm A\");\r\n//   const messageText =\r\n//     message.renderedBody ||\r\n//     message.message ||\r\n//     message.messageContent ||\r\n//     \"[no message]\";\r\n\r\n//   useEffect(() => {\r\n//     const el = messageRef.current;\r\n//     if (el && el.scrollHeight > el.clientHeight + 10) {\r\n//       setIsOverflowing(true);\r\n//     }\r\n//   }, []);\r\n\r\n//   const baseStyle =\r\n//     \"px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap\";\r\n\r\n//   const ownStyle = \"bg-green-600 text-white rounded-2xl rounded-br-sm\";\r\n//   const incomingStyle = \"bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm\";\r\n\r\n//   const tickColor = isOwn ? \"text-white/70\" : \"text-gray-500\";\r\n\r\n//   return (\r\n//     <div className={`flex ${isOwn ? \"justify-end\" : \"justify-start\"} mb-2`}>\r\n//       <div\r\n//         ref={messageRef}\r\n//         onClick={() => isOverflowing && setExpanded(!expanded)}\r\n//         className={`${baseStyle} ${isOwn ? ownStyle : incomingStyle} ${\r\n//           expanded ? \"cursor-zoom-out\" : isOverflowing ? \"cursor-zoom-in\" : \"\"\r\n//         }`}\r\n//         style={{\r\n//           overflow: \"hidden\",\r\n//           whiteSpace: expanded ? \"normal\" : \"pre-wrap\",\r\n//         }}\r\n//       >\r\n//         <div className=\"flex items-end justify-between gap-2\">\r\n//           <span className=\"flex-1\">\r\n//             {messageText}\r\n//             {message.campaignName && (\r\n//               <div className=\"mt-1 text-[10px] italic text-white/80\">\r\n//                 ðŸ“¢ Sent via campaign: {message.campaignName}\r\n//               </div>\r\n//             )}\r\n//           </span>\r\n\r\n//           <span className={`text-[11px] flex items-center gap-1 ${tickColor}`}>\r\n//             {time}\r\n//             {isOwn && (\r\n//               <>\r\n//                 {message.status === \"Sent\" && <FaCheck />}\r\n//                 {message.status === \"Delivered\" && <FaCheckDouble />}\r\n//                 {message.status === \"Read\" && (\r\n//                   <FaCheckDouble className=\"text-blue-400\" />\r\n//                 )}\r\n//               </>\r\n//             )}\r\n//           </span>\r\n//         </div>\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n","import React, { useRef, useEffect, useCallback } from \"react\";\r\nimport { useInbox } from \"../InboxContext\";\r\nimport ChatBubble from \"./ChatBubble\";\r\nimport dayjs from \"dayjs\";\r\nimport isToday from \"dayjs/plugin/isToday\";\r\nimport isYesterday from \"dayjs/plugin/isYesterday\";\r\n\r\ndayjs.extend(isToday);\r\ndayjs.extend(isYesterday);\r\n\r\nfunction getDateLabel(date) {\r\n  const d = dayjs(date);\r\n  if (d.isToday()) return \"Today\";\r\n  if (d.isYesterday()) return \"Yesterday\";\r\n  return d.format(\"D MMM YYYY\");\r\n}\r\n\r\nexport default function ChatWindow() {\r\n  const { messages = [], connection, selectedContactId } = useInbox();\r\n\r\n  // The ONLY scroll container + a bottom anchor\r\n  const scrollContainerRef = useRef(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  // Track if user is already at/near bottom\r\n  const atBottomRef = useRef(true);\r\n  const NEAR_BOTTOM_PX = 120;\r\n\r\n  const isNearBottom = useCallback(() => {\r\n    const el = scrollContainerRef.current;\r\n    if (!el) return true;\r\n    const distance = el.scrollHeight - (el.scrollTop + el.clientHeight);\r\n    return distance <= NEAR_BOTTOM_PX;\r\n  }, []);\r\n\r\n  const handleScroll = useCallback(() => {\r\n    atBottomRef.current = isNearBottom();\r\n  }, [isNearBottom]);\r\n\r\n  const scrollToBottom = useCallback((smooth = true) => {\r\n    bottomRef.current?.scrollIntoView({\r\n      behavior: smooth ? \"smooth\" : \"auto\",\r\n      block: \"end\",\r\n    });\r\n  }, []);\r\n\r\n  // 1) On first mount -> jump to bottom\r\n  useEffect(() => {\r\n    scrollToBottom(false);\r\n    // initialize bottom state\r\n    atBottomRef.current = true;\r\n  }, [scrollToBottom]);\r\n\r\n  // 2) On contact change -> jump to bottom after DOM paints\r\n  useEffect(() => {\r\n    const t = setTimeout(() => scrollToBottom(false), 0);\r\n    return () => clearTimeout(t);\r\n  }, [selectedContactId, scrollToBottom]);\r\n\r\n  // 3) On new messages -> only scroll if already near bottom\r\n  useEffect(() => {\r\n    if (atBottomRef.current) scrollToBottom(true);\r\n  }, [messages.length, scrollToBottom]);\r\n\r\n  // 4) Allow imperative force scroll (e.g., right after Send)\r\n  useEffect(() => {\r\n    const onForce = () => scrollToBottom(true);\r\n    window.addEventListener(\"xbc:scrollToBottom\", onForce);\r\n    return () => window.removeEventListener(\"xbc:scrollToBottom\", onForce);\r\n  }, [scrollToBottom]);\r\n\r\n  // 5) Gentle auto mark-as-read shortly after switching\r\n  useEffect(() => {\r\n    if (!connection || !selectedContactId) return;\r\n    const timeout = setTimeout(() => {\r\n      connection.invoke(\"MarkAsRead\", selectedContactId).catch(err => {\r\n        console.warn(\"âš ï¸ MarkAsRead SignalR call failed:\", err);\r\n      });\r\n    }, 800);\r\n    return () => clearTimeout(timeout);\r\n  }, [connection, selectedContactId]);\r\n\r\n  if (messages.length === 0) {\r\n    return (\r\n      <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n        Loading messagesâ€¦\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Group by date\r\n  const grouped = messages.reduce((acc, msg) => {\r\n    const dateKey = getDateLabel(msg.sentAt || msg.createdAt);\r\n    (acc[dateKey] ||= []).push(msg);\r\n    return acc;\r\n  }, {});\r\n\r\n  return (\r\n    <div\r\n      ref={scrollContainerRef}\r\n      onScroll={handleScroll}\r\n      className=\"p-4 space-y-6 overflow-y-auto h-full\"\r\n    >\r\n      {Object.entries(grouped).map(([date, msgs]) => (\r\n        <div key={date}>\r\n          <div className=\"text-center text-xs text-gray-500 mb-2\">{date}</div>\r\n          <div className=\"space-y-1\">\r\n            {msgs.map((msg, idx) => (\r\n              <ChatBubble\r\n                key={msg.id || idx}\r\n                message={msg}\r\n                isOwn={!msg.isIncoming}\r\n              />\r\n            ))}\r\n          </div>\r\n        </div>\r\n      ))}\r\n      <div ref={bottomRef} />\r\n    </div>\r\n  );\r\n}\r\n\r\n// import React, { useRef, useEffect } from \"react\";\r\n// import { useInbox } from \"../InboxContext\";\r\n// import ChatBubble from \"./ChatBubble\";\r\n// import dayjs from \"dayjs\";\r\n// import isToday from \"dayjs/plugin/isToday\";\r\n// import isYesterday from \"dayjs/plugin/isYesterday\";\r\n\r\n// dayjs.extend(isToday);\r\n// dayjs.extend(isYesterday);\r\n\r\n// function getDateLabel(date) {\r\n//   const d = dayjs(date);\r\n//   if (d.isToday()) return \"Today\";\r\n//   if (d.isYesterday()) return \"Yesterday\";\r\n//   return d.format(\"D MMM YYYY\");\r\n// }\r\n\r\n// export default function ChatWindow() {\r\n//   const { messages, connection, selectedContactId } = useInbox();\r\n//   const bottomRef = useRef(null);\r\n//   const scrollContainerRef = useRef(null);\r\n\r\n//   // Smart scrolling\r\n//   useEffect(() => {\r\n//     if (!scrollContainerRef.current) return;\r\n//     const { scrollHeight, scrollTop, clientHeight } =\r\n//       scrollContainerRef.current;\r\n//     if (scrollHeight - scrollTop <= clientHeight + 100) {\r\n//       bottomRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n//     }\r\n//   }, [messages]);\r\n\r\n//   // Mark messages as read\r\n//   useEffect(() => {\r\n//     if (!connection || !selectedContactId) return;\r\n//     const timeout = setTimeout(() => {\r\n//       connection.invoke(\"MarkAsRead\", selectedContactId).catch(err => {\r\n//         console.warn(\"âš ï¸ MarkAsRead SignalR call failed:\", err);\r\n//       });\r\n//     }, 800);\r\n//     return () => clearTimeout(timeout);\r\n//   }, [connection, selectedContactId]);\r\n\r\n//   if (messages.length === 0) {\r\n//     return (\r\n//       <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//         Loading messages...\r\n//       </div>\r\n//     );\r\n//   }\r\n\r\n//   const grouped = messages.reduce((acc, msg) => {\r\n//     const dateKey = getDateLabel(msg.sentAt || msg.createdAt);\r\n//     if (!acc[dateKey]) acc[dateKey] = [];\r\n//     acc[dateKey].push(msg);\r\n//     return acc;\r\n//   }, {});\r\n\r\n//   return (\r\n//     <div\r\n//       ref={scrollContainerRef}\r\n//       className=\"p-4 space-y-6 overflow-y-auto h-full\"\r\n//     >\r\n//       {Object.entries(grouped).map(([date, msgs]) => (\r\n//         <div key={date}>\r\n//           <div className=\"text-center text-xs text-gray-500 mb-2\">{date}</div>\r\n//           <div className=\"space-y-1\">\r\n//             {msgs.map((msg, idx) => (\r\n//               <ChatBubble\r\n//                 key={msg.id || idx}\r\n//                 message={msg}\r\n//                 isOwn={!msg.isIncoming}\r\n//               />\r\n//             ))}\r\n//           </div>\r\n//         </div>\r\n//       ))}\r\n//       <div ref={bottomRef} />\r\n//     </div>\r\n//   );\r\n// }\r\n","import React, {\r\n  useCallback,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\nimport axiosClient from \"../../../api/axiosClient\";\r\n\r\n/**\r\n * QuickReplyPicker\r\n * Props:\r\n *  - onInsert(text: string): required\r\n *  - onClose(): optional\r\n *  - scope?: \"Business\" | \"Personal\" | \"All\"  // initial view; default \"All\"\r\n */\r\nexport default function QuickReplyPicker({ onInsert, onClose, scope = \"All\" }) {\r\n  const containerRef = useRef(null);\r\n  const searchRef = useRef(null);\r\n\r\n  const [q, setQ] = useState(\"\");\r\n  const [items, setItems] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [activeIndex, setActiveIndex] = useState(-1);\r\n\r\n  // scope chips\r\n  const [viewScope, setViewScope] = useState(() => scope || \"All\");\r\n  const viewScopeParam = useMemo(() => {\r\n    const s = (viewScope || \"All\").toString().toLowerCase();\r\n    return s === \"business\" || s === \"personal\" ? s : \"all\";\r\n  }, [viewScope]);\r\n\r\n  // NEW: create mode\r\n  const [creating, setCreating] = useState(false);\r\n  const [title, setTitle] = useState(\"\");\r\n  const [body, setBody] = useState(\"\");\r\n  const [tagsCsv, setTagsCsv] = useState(\"\");\r\n  const [createScope, setCreateScope] = useState(\"Personal\"); // default personal\r\n  const [saving, setSaving] = useState(false);\r\n  const [saveMsg, setSaveMsg] = useState(\"\");\r\n\r\n  // Debounced fetch when search or scope changes\r\n  useEffect(() => {\r\n    if (creating) return; // pause list fetch while creating\r\n    let ignore = false;\r\n    setLoading(true);\r\n\r\n    const t = setTimeout(() => {\r\n      const params = {};\r\n      if (q) params.q = q;\r\n      if (viewScopeParam) params.scope = viewScopeParam;\r\n\r\n      axiosClient\r\n        .get(\"/quick-replies\", { params })\r\n        .then(res => {\r\n          if (ignore) return;\r\n          setItems(Array.isArray(res.data) ? res.data : []);\r\n          setActiveIndex(-1);\r\n        })\r\n        .catch(() => {\r\n          if (ignore) return;\r\n          setItems([]);\r\n        })\r\n        .finally(() => !ignore && setLoading(false));\r\n    }, 200);\r\n\r\n    return () => {\r\n      clearTimeout(t);\r\n      ignore = true;\r\n    };\r\n  }, [q, viewScopeParam, creating]);\r\n\r\n  // Autofocus search on open\r\n  useEffect(() => {\r\n    searchRef.current?.focus();\r\n  }, []);\r\n\r\n  // Close on click outside\r\n  useEffect(() => {\r\n    const onDocClick = e => {\r\n      if (!containerRef.current) return;\r\n      if (!containerRef.current.contains(e.target)) onClose?.();\r\n    };\r\n    document.addEventListener(\"mousedown\", onDocClick, { capture: true });\r\n    return () =>\r\n      document.removeEventListener(\"mousedown\", onDocClick, { capture: true });\r\n  }, [onClose]);\r\n\r\n  const handleInsert = useCallback(\r\n    text => {\r\n      if (!text) return;\r\n      onInsert?.(text);\r\n    },\r\n    [onInsert]\r\n  );\r\n\r\n  const handleKeyDown = e => {\r\n    if (e.key === \"Escape\") {\r\n      e.preventDefault();\r\n      if (creating) {\r\n        setCreating(false);\r\n        return;\r\n      }\r\n      onClose?.();\r\n      return;\r\n    }\r\n    if (creating) return; // no list nav while in create form\r\n    if (e.key === \"ArrowDown\") {\r\n      e.preventDefault();\r\n      setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));\r\n      return;\r\n    }\r\n    if (e.key === \"ArrowUp\") {\r\n      e.preventDefault();\r\n      setActiveIndex(i => Math.max(i - 1, -1));\r\n      return;\r\n    }\r\n    if (e.key === \"Enter\") {\r\n      if (activeIndex >= 0 && activeIndex < items.length) {\r\n        e.preventDefault();\r\n        handleInsert(items[activeIndex]?.body);\r\n        onClose?.();\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleCreate = async () => {\r\n    setSaveMsg(\"\");\r\n    if (!title.trim() || !body.trim()) {\r\n      setSaveMsg(\"Title and Body are required.\");\r\n      return;\r\n    }\r\n    setSaving(true);\r\n    try {\r\n      const payload = {\r\n        title: title.trim(),\r\n        body: body,\r\n        tagsCsv: tagsCsv.trim() || null,\r\n        scope: createScope === \"Business\" ? 2 : 0, // enum: Personal=0, Business=2\r\n      };\r\n      const res = await axiosClient.post(\"/quick-replies\", payload);\r\n      const ok = res?.data?.success === true;\r\n      setSaveMsg(ok ? \"âœ… Saved.\" : res?.data?.message || \"âŒ Failed to save.\");\r\n      if (ok) {\r\n        // reset form and refresh list to created scope\r\n        setTitle(\"\");\r\n        setBody(\"\");\r\n        setTagsCsv(\"\");\r\n        setCreating(false);\r\n        setViewScope(createScope);\r\n        setQ(\"\"); // clear search\r\n      }\r\n    } catch (err) {\r\n      setSaveMsg(\"âŒ Failed to save.\");\r\n      // optional: console.error(err);\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      ref={containerRef}\r\n      className=\"w-80 rounded-xl border bg-white shadow-lg p-2\"\r\n      role=\"dialog\"\r\n      aria-label=\"Quick replies\"\r\n    >\r\n      {/* Header row: search + actions */}\r\n      <div className=\"flex items-center gap-2 mb-2\">\r\n        {!creating ? (\r\n          <>\r\n            <input\r\n              ref={searchRef}\r\n              className=\"flex-1 border rounded-md px-2 py-1 text-sm\"\r\n              placeholder=\"Search saved repliesâ€¦\"\r\n              value={q}\r\n              onChange={e => setQ(e.target.value)}\r\n              onKeyDown={handleKeyDown}\r\n            />\r\n            <button\r\n              className=\"text-xs px-2 py-1 border rounded-md bg-white hover:bg-gray-50\"\r\n              onClick={() => setCreating(true)}\r\n              type=\"button\"\r\n              title=\"Create a new quick reply\"\r\n            >\r\n              New\r\n            </button>\r\n            <button\r\n              className=\"text-xs text-gray-500 hover:text-gray-700 px-2 py-1\"\r\n              onClick={() => onClose?.()}\r\n              type=\"button\"\r\n            >\r\n              Close\r\n            </button>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <div className=\"text-sm font-medium\">New quick reply</div>\r\n            <div className=\"flex-1\" />\r\n            <button\r\n              className=\"text-xs text-gray-500 hover:text-gray-700 px-2 py-1\"\r\n              onClick={() => setCreating(false)}\r\n              type=\"button\"\r\n            >\r\n              Cancel\r\n            </button>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* Scope chips (list view) OR Create form */}\r\n      {!creating ? (\r\n        <>\r\n          {/* Scope chips */}\r\n          <div className=\"flex items-center gap-1 mb-2 px-1\">\r\n            {[\"All\", \"Business\", \"Personal\"].map(s => (\r\n              <button\r\n                key={s}\r\n                type=\"button\"\r\n                onClick={() => setViewScope(s)}\r\n                className={`px-2 py-0.5 text-xs rounded-full border ${\r\n                  viewScope === s ? \"bg-gray-200\" : \"bg-white hover:bg-gray-100\"\r\n                }`}\r\n              >\r\n                {s}\r\n              </button>\r\n            ))}\r\n          </div>\r\n\r\n          <div className=\"max-h-64 overflow-y-auto\">\r\n            {loading && (\r\n              <div className=\"text-xs text-gray-500 p-2\">Loadingâ€¦</div>\r\n            )}\r\n            {!loading && items.length === 0 && (\r\n              <div className=\"text-xs text-gray-500 p-2\">No results</div>\r\n            )}\r\n\r\n            {!loading &&\r\n              items.map((x, idx) => {\r\n                const isActive = idx === activeIndex;\r\n                return (\r\n                  <button\r\n                    key={x.id}\r\n                    type=\"button\"\r\n                    className={`w-full text-left p-2 rounded-md ${\r\n                      isActive ? \"bg-gray-200\" : \"hover:bg-gray-100\"\r\n                    }`}\r\n                    onMouseEnter={() => setActiveIndex(idx)}\r\n                    onClick={() => {\r\n                      handleInsert(x.body);\r\n                      onClose?.();\r\n                    }}\r\n                    title={x.tagsCsv || \"\"}\r\n                  >\r\n                    <div className=\"text-sm font-medium text-gray-800\">\r\n                      {x.title}\r\n                    </div>\r\n                    <div className=\"text-xs text-gray-600 line-clamp-2\">\r\n                      {x.body}\r\n                    </div>\r\n                    {x.language && (\r\n                      <div className=\"text-[10px] text-gray-400 mt-1\">\r\n                        Lang: {x.language}\r\n                      </div>\r\n                    )}\r\n                  </button>\r\n                );\r\n              })}\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-between mt-2 px-1\">\r\n            <div className=\"text-[10px] text-gray-400\">\r\n              Scope: <span className=\"uppercase\">{viewScopeParam}</span>\r\n            </div>\r\n            <div className=\"text-[10px] text-gray-400\">\r\n              â†‘/â†“ navigate â€¢ Enter insert â€¢ Esc close\r\n            </div>\r\n          </div>\r\n        </>\r\n      ) : (\r\n        // CREATE FORM\r\n        <div className=\"space-y-2\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <label className=\"text-xs text-gray-600 w-16\">Scope</label>\r\n            <div className=\"flex items-center gap-2\">\r\n              {[\"Personal\", \"Business\"].map(s => (\r\n                <label key={s} className=\"text-xs flex items-center gap-1\">\r\n                  <input\r\n                    type=\"radio\"\r\n                    name=\"qr-scope\"\r\n                    value={s}\r\n                    checked={createScope === s}\r\n                    onChange={() => setCreateScope(s)}\r\n                  />\r\n                  {s}\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <label className=\"text-xs text-gray-600 w-16\">Title</label>\r\n            <input\r\n              className=\"flex-1 border rounded-md px-2 py-1 text-sm\"\r\n              value={title}\r\n              onChange={e => setTitle(e.target.value)}\r\n              placeholder=\"e.g., Greeting (EN)\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"flex items-start gap-2\">\r\n            <label className=\"text-xs text-gray-600 w-16 mt-1\">Body</label>\r\n            <textarea\r\n              className=\"flex-1 border rounded-md px-2 py-1 text-sm h-24\"\r\n              value={body}\r\n              onChange={e => setBody(e.target.value)}\r\n              placeholder=\"Type the messageâ€¦\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <label className=\"text-xs text-gray-600 w-16\">Tags</label>\r\n            <input\r\n              className=\"flex-1 border rounded-md px-2 py-1 text-sm\"\r\n              value={tagsCsv}\r\n              onChange={e => setTagsCsv(e.target.value)}\r\n              placeholder=\"e.g., greeting,eng\"\r\n            />\r\n          </div>\r\n\r\n          {saveMsg && (\r\n            <div className=\"text-xs px-2 py-1 rounded-md bg-gray-50 border\">\r\n              {saveMsg}\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex items-center justify-end gap-2\">\r\n            <button\r\n              className=\"text-xs px-3 py-1 rounded-md border bg-white hover:bg-gray-50\"\r\n              onClick={() => setCreating(false)}\r\n              type=\"button\"\r\n              disabled={saving}\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              className=\"text-xs px-3 py-1 rounded-md text-white bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300\"\r\n              onClick={handleCreate}\r\n              type=\"button\"\r\n              disabled={saving}\r\n            >\r\n              {saving ? \"Savingâ€¦\" : \"Save\"}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// import React, {\r\n//   useCallback,\r\n//   useEffect,\r\n//   useMemo,\r\n//   useRef,\r\n//   useState,\r\n// } from \"react\";\r\n// import axiosClient from \"../../../api/axiosClient\";\r\n\r\n// /**\r\n//  * QuickReplyPicker\r\n//  * Props:\r\n//  *  - onInsert(text: string): required\r\n//  *  - onClose(): optional\r\n//  *  - scope?: \"Business\" | \"Personal\" | \"All\"  // acts as the initial scope; default: \"All\"\r\n//  */\r\n// export default function QuickReplyPicker({ onInsert, onClose, scope = \"All\" }) {\r\n//   const containerRef = useRef(null);\r\n//   const searchRef = useRef(null);\r\n\r\n//   const [q, setQ] = useState(\"\");\r\n//   const [items, setItems] = useState([]);\r\n//   const [loading, setLoading] = useState(false);\r\n//   const [activeIndex, setActiveIndex] = useState(-1);\r\n\r\n//   // NEW: local scope state (chips control this)\r\n//   const [viewScope, setViewScope] = useState(() => scope || \"All\");\r\n\r\n//   const viewScopeParam = useMemo(() => {\r\n//     const s = (viewScope || \"All\").toString().toLowerCase();\r\n//     return s === \"business\" || s === \"personal\" ? s : \"all\";\r\n//   }, [viewScope]);\r\n\r\n//   // Debounced fetch when search or scope changes\r\n//   useEffect(() => {\r\n//     let ignore = false;\r\n//     setLoading(true);\r\n\r\n//     const t = setTimeout(() => {\r\n//       const params = {};\r\n//       if (q) params.q = q;\r\n//       if (viewScopeParam) params.scope = viewScopeParam;\r\n\r\n//       axiosClient\r\n//         .get(\"/quick-replies\", { params })\r\n//         .then(res => {\r\n//           if (ignore) return;\r\n//           setItems(Array.isArray(res.data) ? res.data : []);\r\n//           setActiveIndex(-1);\r\n//         })\r\n//         .catch(() => {\r\n//           if (ignore) return;\r\n//           setItems([]);\r\n//         })\r\n//         .finally(() => !ignore && setLoading(false));\r\n//     }, 200);\r\n\r\n//     return () => {\r\n//       clearTimeout(t);\r\n//       ignore = true;\r\n//     };\r\n//   }, [q, viewScopeParam]);\r\n\r\n//   // Autofocus search on open\r\n//   useEffect(() => {\r\n//     searchRef.current?.focus();\r\n//   }, []);\r\n\r\n//   // Close on click outside\r\n//   useEffect(() => {\r\n//     const onDocClick = e => {\r\n//       if (!containerRef.current) return;\r\n//       if (!containerRef.current.contains(e.target)) onClose?.();\r\n//     };\r\n//     document.addEventListener(\"mousedown\", onDocClick, { capture: true });\r\n//     return () =>\r\n//       document.removeEventListener(\"mousedown\", onDocClick, { capture: true });\r\n//   }, [onClose]);\r\n\r\n//   const handleInsert = useCallback(\r\n//     text => {\r\n//       if (!text) return;\r\n//       onInsert?.(text);\r\n//     },\r\n//     [onInsert]\r\n//   );\r\n\r\n//   const handleKeyDown = e => {\r\n//     if (e.key === \"Escape\") {\r\n//       e.preventDefault();\r\n//       onClose?.();\r\n//       return;\r\n//     }\r\n//     if (e.key === \"ArrowDown\") {\r\n//       e.preventDefault();\r\n//       setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));\r\n//       return;\r\n//     }\r\n//     if (e.key === \"ArrowUp\") {\r\n//       e.preventDefault();\r\n//       setActiveIndex(i => Math.max(i - 1, -1));\r\n//       return;\r\n//     }\r\n//     if (e.key === \"Enter\") {\r\n//       if (activeIndex >= 0 && activeIndex < items.length) {\r\n//         e.preventDefault();\r\n//         handleInsert(items[activeIndex]?.body);\r\n//         onClose?.();\r\n//       }\r\n//     }\r\n//   };\r\n\r\n//   return (\r\n//     <div\r\n//       ref={containerRef}\r\n//       className=\"w-80 rounded-xl border bg-white shadow-lg p-2\"\r\n//       role=\"dialog\"\r\n//       aria-label=\"Quick replies\"\r\n//     >\r\n//       {/* Header row: search + close */}\r\n//       <div className=\"flex items-center gap-2 mb-2\">\r\n//         <input\r\n//           ref={searchRef}\r\n//           className=\"flex-1 border rounded-md px-2 py-1 text-sm\"\r\n//           placeholder=\"Search saved repliesâ€¦\"\r\n//           value={q}\r\n//           onChange={e => setQ(e.target.value)}\r\n//           onKeyDown={handleKeyDown}\r\n//         />\r\n//         <button\r\n//           className=\"text-xs text-gray-500 hover:text-gray-700 px-2 py-1\"\r\n//           onClick={() => onClose?.()}\r\n//           type=\"button\"\r\n//         >\r\n//           Close\r\n//         </button>\r\n//       </div>\r\n\r\n//       {/* NEW: Scope chips inside the picker */}\r\n//       <div className=\"flex items-center gap-1 mb-2 px-1\">\r\n//         {[\"All\", \"Business\", \"Personal\"].map(s => (\r\n//           <button\r\n//             key={s}\r\n//             type=\"button\"\r\n//             onClick={() => setViewScope(s)}\r\n//             className={`px-2 py-0.5 text-xs rounded-full border ${\r\n//               viewScope === s ? \"bg-gray-200\" : \"bg-white hover:bg-gray-100\"\r\n//             }`}\r\n//           >\r\n//             {s}\r\n//           </button>\r\n//         ))}\r\n//       </div>\r\n\r\n//       <div className=\"max-h-64 overflow-y-auto\">\r\n//         {loading && <div className=\"text-xs text-gray-500 p-2\">Loadingâ€¦</div>}\r\n//         {!loading && items.length === 0 && (\r\n//           <div className=\"text-xs text-gray-500 p-2\">No results</div>\r\n//         )}\r\n\r\n//         {!loading &&\r\n//           items.map((x, idx) => {\r\n//             const isActive = idx === activeIndex;\r\n//             return (\r\n//               <button\r\n//                 key={x.id}\r\n//                 type=\"button\"\r\n//                 className={`w-full text-left p-2 rounded-md ${\r\n//                   isActive ? \"bg-gray-200\" : \"hover:bg-gray-100\"\r\n//                 }`}\r\n//                 onMouseEnter={() => setActiveIndex(idx)}\r\n//                 onClick={() => {\r\n//                   handleInsert(x.body);\r\n//                   onClose?.();\r\n//                 }}\r\n//                 title={x.tagsCsv || \"\"}\r\n//               >\r\n//                 <div className=\"text-sm font-medium text-gray-800\">\r\n//                   {x.title}\r\n//                 </div>\r\n//                 <div className=\"text-xs text-gray-600 line-clamp-2\">\r\n//                   {x.body}\r\n//                 </div>\r\n//                 {x.language && (\r\n//                   <div className=\"text-[10px] text-gray-400 mt-1\">\r\n//                     Lang: {x.language}\r\n//                   </div>\r\n//                 )}\r\n//               </button>\r\n//             );\r\n//           })}\r\n//       </div>\r\n\r\n//       <div className=\"flex items-center justify-between mt-2 px-1\">\r\n//         <div className=\"text-[10px] text-gray-400\">\r\n//           Scope: <span className=\"uppercase\">{viewScopeParam}</span>\r\n//         </div>\r\n//         <div className=\"text-[10px] text-gray-400\">\r\n//           â†‘/â†“ navigate â€¢ Enter insert â€¢ Esc close\r\n//         </div>\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n","import React, { useEffect, useMemo, useRef, useState } from \"react\";\r\n\r\n// Lightweight emoji set (common, chat-friendly)\r\nconst RAW = [\r\n  [\"ðŸ˜€\", \"grinning\"],\r\n  [\"ðŸ˜\", \"beaming\"],\r\n  [\"ðŸ˜‚\", \"joy\"],\r\n  [\"ðŸ¤£\", \"rofl\"],\r\n  [\"ðŸ˜Š\", \"smile\"],\r\n  [\"ðŸ™‚\", \"slight_smile\"],\r\n  [\"ðŸ˜‰\", \"wink\"],\r\n  [\"ðŸ˜\", \"heart_eyes\"],\r\n  [\"ðŸ˜˜\", \"kiss\"],\r\n  [\"ðŸ˜‹\", \"yum\"],\r\n  [\"ðŸ˜Ž\", \"cool\"],\r\n  [\"ðŸ¤©\", \"star_struck\"],\r\n  [\"ðŸ¥³\", \"partying\"],\r\n  [\"ðŸ˜‡\", \"innocent\"],\r\n  [\"ðŸ¤—\", \"hug\"],\r\n  [\"ðŸ˜…\", \"sweat_smile\"],\r\n  [\"ðŸ˜Œ\", \"relieved\"],\r\n  [\"ðŸ˜´\", \"sleep\"],\r\n  [\"ðŸ¤”\", \"think\"],\r\n  [\"ðŸ¤¨\", \"doubt\"],\r\n  [\"ðŸ˜\", \"neutral\"],\r\n  [\"ðŸ˜®\", \"open_mouth\"],\r\n  [\"ðŸ˜¢\", \"cry\"],\r\n  [\"ðŸ˜­\", \"sob\"],\r\n  [\"ðŸ˜¡\", \"angry\"],\r\n  [\"ðŸ˜±\", \"scream\"],\r\n  [\"ðŸ¤¯\", \"mind_blown\"],\r\n  [\"ðŸ¤’\", \"sick\"],\r\n  [\"ðŸ¤•\", \"injured\"],\r\n  [\"ðŸ¤§\", \"sneeze\"],\r\n  [\"ðŸ¥¶\", \"cold\"],\r\n  [\"ðŸ¥µ\", \"hot\"],\r\n  [\"ðŸ‘\", \"thumbs_up\"],\r\n  [\"ðŸ‘Ž\", \"thumbs_down\"],\r\n  [\"ðŸ™\", \"pray\"],\r\n  [\"ðŸ‘\", \"clap\"],\r\n  [\"ðŸ™Œ\", \"raised_hands\"],\r\n  [\"ðŸ¤\", \"handshake\"],\r\n  [\"ðŸ’ª\", \"muscle\"],\r\n  [\"ðŸ«¶\", \"heart_hands\"],\r\n  [\"â¤ï¸\", \"red_heart\"],\r\n  [\"ðŸ’›\", \"yellow_heart\"],\r\n  [\"ðŸ’š\", \"green_heart\"],\r\n  [\"ðŸ’™\", \"blue_heart\"],\r\n  [\"ðŸ’œ\", \"purple_heart\"],\r\n  [\"ðŸ–¤\", \"black_heart\"],\r\n  [\"ðŸ’”\", \"broken_heart\"],\r\n  [\"âœ¨\", \"sparkles\"],\r\n  [\"ðŸ”¥\", \"fire\"],\r\n  [\"â­\", \"star\"],\r\n  [\"âœ…\", \"check\"],\r\n  [\"âŒ\", \"cross\"],\r\n  [\"âš ï¸\", \"warning\"],\r\n  [\"â³\", \"hourglass\"],\r\n  [\"ðŸ“Œ\", \"pin\"],\r\n  [\"ðŸ“\", \"round_pushpin\"],\r\n  [\"ðŸ“…\", \"calendar\"],\r\n  [\"ðŸ›ï¸\", \"shopping\"],\r\n  [\"ðŸ’°\", \"money\"],\r\n  [\"ðŸŽ‰\", \"tada\"],\r\n  [\"ðŸŽŠ\", \"confetti\"],\r\n  [\"ðŸ’¬\", \"speech\"],\r\n  [\"âœ‰ï¸\", \"envelope\"],\r\n  [\"ðŸ“±\", \"phone\"],\r\n  [\"ðŸ“ž\", \"telephone\"],\r\n  [\"â°\", \"alarm\"],\r\n  [\"âŒ›\", \"timer\"],\r\n  [\"ðŸ§¾\", \"receipt\"],\r\n  [\"ðŸ§°\", \"tools\"],\r\n  [\"ðŸ§ \", \"brain\"],\r\n];\r\n\r\nconst EMOJIS = RAW.map(([char, name]) => ({ char, name }));\r\n\r\nexport default function EmojiPicker({ onPick, onClose }) {\r\n  const ref = useRef(null);\r\n  const [q, setQ] = useState(\"\");\r\n\r\n  // Close on outside click\r\n  useEffect(() => {\r\n    const onDocClick = e => {\r\n      if (!ref.current) return;\r\n      if (!ref.current.contains(e.target)) onClose?.();\r\n    };\r\n    document.addEventListener(\"mousedown\", onDocClick, { capture: true });\r\n    return () =>\r\n      document.removeEventListener(\"mousedown\", onDocClick, { capture: true });\r\n  }, [onClose]);\r\n\r\n  const filtered = useMemo(() => {\r\n    const s = q.trim().toLowerCase();\r\n    if (!s) return EMOJIS;\r\n    return EMOJIS.filter(e => e.char.includes(s) || e.name.includes(s));\r\n  }, [q]);\r\n\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      className=\"w-80 rounded-xl border bg-white shadow-lg p-2\"\r\n      role=\"dialog\"\r\n      aria-label=\"Emoji picker\"\r\n    >\r\n      <div className=\"flex items-center gap-2 mb-2\">\r\n        <input\r\n          autoFocus\r\n          className=\"flex-1 border rounded-md px-2 py-1 text-sm\"\r\n          placeholder=\"Search emojiâ€¦\"\r\n          value={q}\r\n          onChange={e => setQ(e.target.value)}\r\n          onKeyDown={e => {\r\n            if (e.key === \"Escape\") onClose?.();\r\n          }}\r\n        />\r\n        <button\r\n          className=\"text-xs text-gray-500 hover:text-gray-700 px-2 py-1\"\r\n          onClick={() => onClose?.()}\r\n          type=\"button\"\r\n        >\r\n          Close\r\n        </button>\r\n      </div>\r\n\r\n      {/* No scrollbar: wider + more columns + slightly smaller buttons */}\r\n      <div className=\"grid grid-cols-10 gap-1 overflow-y-hidden\">\r\n        {filtered.map(e => (\r\n          <button\r\n            key={e.char + e.name}\r\n            type=\"button\"\r\n            className=\"h-7 w-7 flex items-center justify-center rounded hover:bg-gray-100\"\r\n            title={e.name.replace(/_/g, \" \")}\r\n            onClick={() => onPick?.(e.char)}\r\n          >\r\n            <span className=\"text-lg\">{e.char}</span>\r\n          </button>\r\n        ))}\r\n      </div>\r\n\r\n      {/* <div className=\"mt-2 text-[10px] text-gray-400 px-1\">\r\n        Tip: you can also use your OS emoji panel (Win + .) / (âŒ˜ Ctrl Space)\r\n      </div> */}\r\n    </div>\r\n  );\r\n}\r\n","import React, { useRef, useState, useCallback, useEffect } from \"react\";\r\nimport { useInbox } from \"../InboxContext\";\r\nimport { Smile, Paperclip, Send, X as CloseIcon } from \"lucide-react\";\r\nimport QuickReplyPicker from \"./QuickReplyPicker\";\r\nimport EmojiPicker from \"./EmojiPicker\";\r\n\r\nexport default function ChatInput() {\r\n  const { newMessage, setNewMessage, sendMessage, isConnected } = useInbox();\r\n  const [pickerOpen, setPickerOpen] = useState(false);\r\n  const [emojiOpen, setEmojiOpen] = useState(false);\r\n  const textareaRef = useRef(null);\r\n\r\n  const clearMessage = () => setNewMessage(\"\");\r\n\r\n  const handleSend = () => {\r\n    if (!isConnected || !newMessage?.trim()) return;\r\n    setPickerOpen(false);\r\n    setEmojiOpen(false);\r\n    sendMessage();\r\n    // âœ… force the message list to scroll to bottom after sending\r\n    window.dispatchEvent(new CustomEvent(\"xbc:scrollToBottom\"));\r\n  };\r\n\r\n  const handleKeyDown = e => {\r\n    if (e.key === \"/\" && !pickerOpen) {\r\n      e.preventDefault();\r\n      setPickerOpen(true);\r\n      return;\r\n    }\r\n    if (e.key === \"Escape\" && (pickerOpen || emojiOpen)) {\r\n      e.preventDefault();\r\n      setPickerOpen(false);\r\n      setEmojiOpen(false);\r\n      return;\r\n    }\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSend();\r\n    }\r\n  };\r\n\r\n  const insertAtCursor = useCallback(\r\n    snippet => {\r\n      const el = textareaRef.current;\r\n      if (!el) {\r\n        setNewMessage(prev => (prev ? `${prev} ${snippet}` : snippet));\r\n        return;\r\n      }\r\n      const start = el.selectionStart ?? newMessage?.length ?? 0;\r\n      const end = el.selectionEnd ?? newMessage?.length ?? 0;\r\n      const base = newMessage ?? \"\";\r\n      const next = base.slice(0, start) + snippet + base.slice(end);\r\n      setNewMessage(next);\r\n      requestAnimationFrame(() => {\r\n        el.focus();\r\n        const pos = start + snippet.length;\r\n        el.setSelectionRange(pos, pos);\r\n      });\r\n    },\r\n    [newMessage, setNewMessage]\r\n  );\r\n\r\n  const autoResize = useCallback(() => {\r\n    const el = textareaRef.current;\r\n    if (!el) return;\r\n    el.style.height = \"auto\";\r\n    const max = 160; // ~4 lines\r\n    el.style.height = Math.min(el.scrollHeight, max) + \"px\";\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    autoResize();\r\n  }, [newMessage, autoResize]);\r\n\r\n  return (\r\n    <div className=\"p-3 border-t bg-white overflow-visible\">\r\n      <div className=\"flex items-center gap-2\">\r\n        {/* Quick Reply */}\r\n        <div className=\"relative\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setPickerOpen(v => !v)}\r\n            className=\"h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50\"\r\n            title=\"Saved replies\"\r\n            disabled={!isConnected}\r\n            aria-expanded={pickerOpen}\r\n          >\r\n            Quick Reply\r\n          </button>\r\n          {pickerOpen && (\r\n            <div className=\"absolute left-0 bottom-full mb-2 z-[100]\">\r\n              <QuickReplyPicker\r\n                onInsert={text => {\r\n                  insertAtCursor(text);\r\n                  setPickerOpen(false);\r\n                }}\r\n                onClose={() => setPickerOpen(false)}\r\n              />\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Emoji */}\r\n        <div className=\"relative\">\r\n          <button\r\n            type=\"button\"\r\n            className=\"h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100\"\r\n            title=\"Emoji\"\r\n            disabled={!isConnected}\r\n            aria-expanded={emojiOpen}\r\n            onClick={() => setEmojiOpen(v => !v)}\r\n          >\r\n            <Smile size={16} />\r\n          </button>\r\n          {emojiOpen && (\r\n            <div className=\"absolute left-0 bottom-full mb-2 z-[100]\">\r\n              <EmojiPicker\r\n                onPick={emoji => {\r\n                  insertAtCursor(emoji);\r\n                  setEmojiOpen(false);\r\n                }}\r\n                onClose={() => setEmojiOpen(false)}\r\n              />\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Attach (placeholder) */}\r\n        <button\r\n          className=\"h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100\"\r\n          title=\"Attach\"\r\n          disabled\r\n        >\r\n          <Paperclip size={16} />\r\n        </button>\r\n\r\n        {/* Textarea + Clear X */}\r\n        <div className=\"relative flex-1\">\r\n          <textarea\r\n            ref={textareaRef}\r\n            rows={1}\r\n            value={newMessage}\r\n            onChange={e => setNewMessage(e.target.value)}\r\n            onKeyDown={handleKeyDown}\r\n            onInput={autoResize}\r\n            disabled={!isConnected}\r\n            placeholder={\r\n              !isConnected\r\n                ? \"Connecting...\"\r\n                : \"Type your messageâ€¦ (Enter to send â€¢ Shift+Enter for new line)\"\r\n            }\r\n            className=\"w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed\"\r\n          />\r\n          {!!(newMessage || \"\").length && (\r\n            <button\r\n              type=\"button\"\r\n              onClick={clearMessage}\r\n              title=\"Clear\"\r\n              aria-label=\"Clear message\"\r\n              className=\"absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500\"\r\n            >\r\n              <CloseIcon size={16} />\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {/* Send */}\r\n        <button\r\n          onClick={handleSend}\r\n          disabled={!isConnected || !newMessage?.trim()}\r\n          className=\"h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed\"\r\n          title=\"Send\"\r\n        >\r\n          <Send size={16} />\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// import React, { useRef, useState, useCallback, useEffect } from \"react\";\r\n// import { useInbox } from \"../InboxContext\";\r\n// import { Smile, Paperclip, Send, X as CloseIcon } from \"lucide-react\";\r\n// import QuickReplyPicker from \"./QuickReplyPicker\";\r\n// import EmojiPicker from \"./EmojiPicker\";\r\n\r\n// export default function ChatInput() {\r\n//   const { newMessage, setNewMessage, sendMessage, isConnected } = useInbox();\r\n//   const [pickerOpen, setPickerOpen] = useState(false);\r\n//   const [emojiOpen, setEmojiOpen] = useState(false);\r\n//   const textareaRef = useRef(null);\r\n\r\n//   const clearMessage = () => setNewMessage(\"\");\r\n\r\n//   const handleSend = () => {\r\n//     if (!isConnected || !newMessage?.trim()) return;\r\n//     setPickerOpen(false);\r\n//     setEmojiOpen(false);\r\n//     sendMessage();\r\n//   };\r\n\r\n//   const handleKeyDown = e => {\r\n//     if (e.key === \"/\" && !pickerOpen) {\r\n//       e.preventDefault();\r\n//       setPickerOpen(true);\r\n//       return;\r\n//     }\r\n//     if (e.key === \"Escape\" && (pickerOpen || emojiOpen)) {\r\n//       e.preventDefault();\r\n//       setPickerOpen(false);\r\n//       setEmojiOpen(false);\r\n//       return;\r\n//     }\r\n//     if (e.key === \"Enter\" && !e.shiftKey) {\r\n//       e.preventDefault();\r\n//       handleSend();\r\n//     }\r\n//   };\r\n\r\n//   const insertAtCursor = useCallback(\r\n//     snippet => {\r\n//       const el = textareaRef.current;\r\n//       if (!el) {\r\n//         setNewMessage(prev => (prev ? `${prev} ${snippet}` : snippet));\r\n//         return;\r\n//       }\r\n//       const start = el.selectionStart ?? newMessage?.length ?? 0;\r\n//       const end = el.selectionEnd ?? newMessage?.length ?? 0;\r\n//       const base = newMessage ?? \"\";\r\n//       const next = base.slice(0, start) + snippet + base.slice(end);\r\n//       setNewMessage(next);\r\n//       requestAnimationFrame(() => {\r\n//         el.focus();\r\n//         const pos = start + snippet.length;\r\n//         el.setSelectionRange(pos, pos);\r\n//       });\r\n//     },\r\n//     [newMessage, setNewMessage]\r\n//   );\r\n\r\n//   const autoResize = useCallback(() => {\r\n//     const el = textareaRef.current;\r\n//     if (!el) return;\r\n//     el.style.height = \"auto\";\r\n//     const max = 160; // ~4 lines\r\n//     el.style.height = Math.min(el.scrollHeight, max) + \"px\";\r\n//   }, []);\r\n\r\n//   useEffect(() => {\r\n//     autoResize();\r\n//   }, [newMessage, autoResize]);\r\n\r\n//   return (\r\n//     <div className=\"p-3 border-t bg-white overflow-visible\">\r\n//       <div className=\"flex items-center gap-2\">\r\n//         {/* Quick Reply */}\r\n//         <div className=\"relative\">\r\n//           <button\r\n//             type=\"button\"\r\n//             onClick={() => setPickerOpen(v => !v)}\r\n//             className=\"h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50\"\r\n//             title=\"Saved replies\"\r\n//             disabled={!isConnected}\r\n//             aria-expanded={pickerOpen}\r\n//           >\r\n//             Quick Reply\r\n//           </button>\r\n//           {pickerOpen && (\r\n//             <div className=\"absolute left-0 bottom-full mb-2 z-[100]\">\r\n//               <QuickReplyPicker\r\n//                 onInsert={text => {\r\n//                   insertAtCursor(text);\r\n//                   setPickerOpen(false);\r\n//                 }}\r\n//                 onClose={() => setPickerOpen(false)}\r\n//               />\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* Emoji */}\r\n//         <div className=\"relative\">\r\n//           <button\r\n//             type=\"button\"\r\n//             className=\"h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100\"\r\n//             title=\"Emoji\"\r\n//             disabled={!isConnected}\r\n//             aria-expanded={emojiOpen}\r\n//             onClick={() => setEmojiOpen(v => !v)}\r\n//           >\r\n//             <Smile size={16} />\r\n//           </button>\r\n//           {emojiOpen && (\r\n//             <div className=\"absolute left-0 bottom-full mb-2 z-[100]\">\r\n//               <EmojiPicker\r\n//                 onPick={emoji => {\r\n//                   insertAtCursor(emoji);\r\n//                   setEmojiOpen(false);\r\n//                 }}\r\n//                 onClose={() => setEmojiOpen(false)}\r\n//               />\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* Attach (placeholder) */}\r\n//         <button\r\n//           className=\"h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100\"\r\n//           title=\"Attach\"\r\n//           disabled\r\n//         >\r\n//           <Paperclip size={16} />\r\n//         </button>\r\n\r\n//         {/* Textarea + Clear X */}\r\n//         <div className=\"relative flex-1\">\r\n//           <textarea\r\n//             ref={textareaRef}\r\n//             rows={1}\r\n//             value={newMessage}\r\n//             onChange={e => setNewMessage(e.target.value)}\r\n//             onKeyDown={handleKeyDown}\r\n//             onInput={autoResize}\r\n//             disabled={!isConnected}\r\n//             placeholder={\r\n//               !isConnected\r\n//                 ? \"Connecting...\"\r\n//                 : \"Type your messageâ€¦ (Enter to send â€¢ Shift+Enter for new line)\"\r\n//             }\r\n//             className=\"w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed\"\r\n//           />\r\n//           {!!(newMessage || \"\").length && (\r\n//             <button\r\n//               type=\"button\"\r\n//               onClick={clearMessage}\r\n//               title=\"Clear\"\r\n//               aria-label=\"Clear message\"\r\n//               className=\"absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500\"\r\n//             >\r\n//               <CloseIcon size={16} />\r\n//             </button>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* Send */}\r\n//         <button\r\n//           onClick={handleSend}\r\n//           disabled={!isConnected || !newMessage?.trim()}\r\n//           className=\"h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed\"\r\n//           title=\"Send\"\r\n//         >\r\n//           <Send size={16} />\r\n//         </button>\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n","import React, { useEffect, useState } from \"react\";\r\nimport axiosClient from \"../../../api/axiosClient\";\r\n// Removed Edit2 as it was unused\r\nimport { Info, StickyNote } from \"lucide-react\";\r\nimport dayjs from \"dayjs\";\r\nimport relativeTime from \"dayjs/plugin/relativeTime\";\r\ndayjs.extend(relativeTime);\r\n\r\nexport default function ContactSidebar({ contactId }) {\r\n  const [contact, setContact] = useState(null);\r\n  const [newNote, setNewNote] = useState(\"\");\r\n  const [activeTab, setActiveTab] = useState(\"details\");\r\n\r\n  // ðŸŸ£ LOG: Incoming contactId\r\n  useEffect(() => {\r\n    console.log(\"[ContactSidebar] Rendered with contactId:\", contactId);\r\n  }, [contactId]);\r\n\r\n  useEffect(() => {\r\n    if (!contactId) {\r\n      console.warn(\"[ContactSidebar] No contactId provided\");\r\n      return;\r\n    }\r\n\r\n    const fetchContact = async () => {\r\n      try {\r\n        console.log(\"[ContactSidebar] Fetching contact:\", contactId);\r\n        const res = await axiosClient.get(`/contacts/${contactId}`);\r\n        console.log(\"[ContactSidebar] API response:\", res);\r\n\r\n        // ðŸŸ£ Some APIs wrap data in a .data.data shape!\r\n        if (res?.data?.data) {\r\n          setContact(res.data.data);\r\n          console.log(\"[ContactSidebar] Set contact with res.data.data\");\r\n        } else if (res?.data) {\r\n          setContact(res.data);\r\n          console.log(\"[ContactSidebar] Set contact with res.data\");\r\n        } else {\r\n          setContact(res);\r\n          console.log(\"[ContactSidebar] Set contact with res\");\r\n        }\r\n      } catch (err) {\r\n        console.error(\"âŒ [ContactSidebar] Failed to load contact:\", err);\r\n      }\r\n    };\r\n\r\n    fetchContact();\r\n  }, [contactId]);\r\n\r\n  const handleAddNote = async () => {\r\n    if (!newNote.trim()) return;\r\n\r\n    try {\r\n      console.log(\r\n        \"[ContactSidebar] Adding note for contactId:\",\r\n        contactId,\r\n        newNote\r\n      );\r\n      await axiosClient.post(`/notes`, {\r\n        contactId,\r\n        content: newNote,\r\n      });\r\n      setNewNote(\"\");\r\n      // Refetch after adding note\r\n      const updated = await axiosClient.get(`/contacts/${contactId}`);\r\n      if (updated?.data?.data) {\r\n        setContact(updated.data.data);\r\n      } else if (updated?.data) {\r\n        setContact(updated.data);\r\n      } else {\r\n        setContact(updated);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"âŒ [ContactSidebar] Failed to add note:\", err);\r\n    }\r\n  };\r\n\r\n  // ðŸŸ£ LOG: Current contact state\r\n  useEffect(() => {\r\n    console.log(\"[ContactSidebar] Current contact state:\", contact);\r\n  }, [contact]);\r\n\r\n  if (!contact) return <div className=\"p-4 text-gray-500\">Loading...</div>;\r\n\r\n  const {\r\n    createdAt,\r\n    tags = [],\r\n    notes = [],\r\n    list = \"Default\",\r\n    chatWindowStatus = \"Open\",\r\n    sessionStatus = \"Active\",\r\n  } = contact;\r\n\r\n  return (\r\n    <div\r\n      className=\"p-4 text-sm overflow-y-auto\"\r\n      style={{ height: \"100%\", maxHeight: \"100%\" }}\r\n    >\r\n      {/* ðŸ§± Tab Switcher */}\r\n      <div className=\"flex mb-4 border rounded-md overflow-hidden text-sm\">\r\n        <button\r\n          onClick={() => setActiveTab(\"details\")}\r\n          className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${\r\n            activeTab === \"details\"\r\n              ? \"bg-gray-200 font-semibold\"\r\n              : \"bg-gray-100 hover:bg-gray-200\"\r\n          }`}\r\n        >\r\n          <Info size={14} /> Details\r\n        </button>\r\n        <button\r\n          onClick={() => setActiveTab(\"notes\")}\r\n          className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${\r\n            activeTab === \"notes\"\r\n              ? \"bg-gray-200 font-semibold\"\r\n              : \"bg-gray-100 hover:bg-gray-200\"\r\n          }`}\r\n        >\r\n          <StickyNote size={14} /> Notes\r\n        </button>\r\n      </div>\r\n\r\n      {/* ðŸ“„ Details Tab */}\r\n      {activeTab === \"details\" && (\r\n        <div className=\"space-y-4\">\r\n          <div className=\"bg-gray-50 border rounded-md p-3\">\r\n            <h4 className=\"text-xs font-semibold text-gray-700 mb-1\">\r\n              Conversation\r\n            </h4>\r\n            <div className=\"flex justify-between text-xs text-gray-600\">\r\n              <span>24-hour window:</span>\r\n              <span className=\"text-green-600 font-medium\">\r\n                {chatWindowStatus}\r\n              </span>\r\n            </div>\r\n            <div className=\"flex justify-between text-xs text-gray-600\">\r\n              <span>Chat session:</span>\r\n              <span className=\"text-green-600 font-medium\">\r\n                {sessionStatus}\r\n              </span>\r\n            </div>\r\n            <div className=\"flex justify-between text-xs text-gray-600\">\r\n              <span>Window ends:</span>\r\n              <span>â€”</span>\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <h4 className=\"text-xs font-semibold text-gray-700 mb-1\">\r\n              Contact data\r\n            </h4>\r\n            <div className=\"text-xs text-gray-600\">\r\n              Created: {createdAt?.slice(0, 10)}\r\n            </div>\r\n            <div className=\"text-xs text-gray-600\">List: {list}</div>\r\n          </div>\r\n\r\n          <div>\r\n            <h4 className=\"text-xs font-semibold text-gray-700 mb-1\">Tags</h4>\r\n            {tags.length === 0 ? (\r\n              <div className=\"text-gray-400 italic text-xs\">No tags</div>\r\n            ) : (\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {tags.map(tag => (\r\n                  <span\r\n                    key={tag.id}\r\n                    className=\"text-xs font-medium px-2 py-1 rounded-full\"\r\n                    style={{\r\n                      backgroundColor: tag.colorHex || \"#999\",\r\n                      color:\r\n                        tag.colorHex && tag.colorHex.toLowerCase() === \"#ffffe0\"\r\n                          ? \"#000\"\r\n                          : \"#fff\",\r\n                    }}\r\n                  >\r\n                    {tag.name}\r\n                  </span>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ðŸ“ Notes Tab */}\r\n      {activeTab === \"notes\" && (\r\n        <div className=\"space-y-3\">\r\n          <div className=\"flex gap-2\">\r\n            <input\r\n              className=\"flex-1 px-2 py-1 text-xs border rounded-md\"\r\n              placeholder=\"Add note...\"\r\n              value={newNote}\r\n              onChange={e => setNewNote(e.target.value)}\r\n            />\r\n            <button\r\n              onClick={handleAddNote}\r\n              className=\"bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700\"\r\n            >\r\n              Add\r\n            </button>\r\n          </div>\r\n\r\n          {Array.isArray(notes) && notes.length > 0 ? (\r\n            <div className=\"space-y-2 max-h-40 overflow-y-auto\">\r\n              {notes.map(n => (\r\n                <div\r\n                  key={n.id}\r\n                  className=\"text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1\"\r\n                >\r\n                  <div>{n.content}</div>\r\n                  <div className=\"text-[10px] text-gray-400 mt-1\">\r\n                    {dayjs(n.createdAt).fromNow()}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <div className=\"text-gray-400 italic text-xs\">No notes yet</div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// import React, { useEffect, useState } from \"react\";\r\n// import axiosClient from \"../../../api/axiosClient\";\r\n// import { Edit2, Info, StickyNote } from \"lucide-react\";\r\n// import dayjs from \"dayjs\";\r\n// import relativeTime from \"dayjs/plugin/relativeTime\";\r\n// dayjs.extend(relativeTime);\r\n\r\n// export default function ContactSidebar({ contactId }) {\r\n//   const [contact, setContact] = useState(null);\r\n//   const [newNote, setNewNote] = useState(\"\");\r\n//   const [activeTab, setActiveTab] = useState(\"details\");\r\n\r\n//   // ðŸŸ£ LOG: Incoming contactId\r\n//   useEffect(() => {\r\n//     console.log(\"[ContactSidebar] Rendered with contactId:\", contactId);\r\n//   }, [contactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!contactId) {\r\n//       console.warn(\"[ContactSidebar] No contactId provided\");\r\n//       return;\r\n//     }\r\n\r\n//     const fetchContact = async () => {\r\n//       try {\r\n//         console.log(\"[ContactSidebar] Fetching contact:\", contactId);\r\n//         const res = await axiosClient.get(`/contacts/${contactId}`);\r\n//         console.log(\"[ContactSidebar] API response:\", res);\r\n\r\n//         // ðŸŸ£ Some APIs wrap data in a .data.data shape!\r\n//         if (res?.data?.data) {\r\n//           setContact(res.data.data);\r\n//           console.log(\"[ContactSidebar] Set contact with res.data.data\");\r\n//         } else if (res?.data) {\r\n//           setContact(res.data);\r\n//           console.log(\"[ContactSidebar] Set contact with res.data\");\r\n//         } else {\r\n//           setContact(res);\r\n//           console.log(\"[ContactSidebar] Set contact with res\");\r\n//         }\r\n//       } catch (err) {\r\n//         console.error(\"âŒ [ContactSidebar] Failed to load contact:\", err);\r\n//       }\r\n//     };\r\n\r\n//     fetchContact();\r\n//   }, [contactId]);\r\n\r\n//   const handleAddNote = async () => {\r\n//     if (!newNote.trim()) return;\r\n\r\n//     try {\r\n//       console.log(\r\n//         \"[ContactSidebar] Adding note for contactId:\",\r\n//         contactId,\r\n//         newNote\r\n//       );\r\n//       await axiosClient.post(`/notes`, {\r\n//         contactId,\r\n//         content: newNote,\r\n//       });\r\n//       setNewNote(\"\");\r\n//       // Refetch after adding note\r\n//       const updated = await axiosClient.get(`/contacts/${contactId}`);\r\n//       if (updated?.data?.data) {\r\n//         setContact(updated.data.data);\r\n//       } else if (updated?.data) {\r\n//         setContact(updated.data);\r\n//       } else {\r\n//         setContact(updated);\r\n//       }\r\n//     } catch (err) {\r\n//       console.error(\"âŒ [ContactSidebar] Failed to add note:\", err);\r\n//     }\r\n//   };\r\n\r\n//   // ðŸŸ£ LOG: Current contact state\r\n//   useEffect(() => {\r\n//     console.log(\"[ContactSidebar] Current contact state:\", contact);\r\n//   }, [contact]);\r\n\r\n//   if (!contact) return <div className=\"p-4 text-gray-500\">Loading...</div>;\r\n\r\n//   const {\r\n//     name,\r\n//     phoneNumber,\r\n//     createdAt,\r\n//     tags = [],\r\n//     notes = [],\r\n//     list = \"Default\",\r\n//     chatWindowStatus = \"Open\",\r\n//     sessionStatus = \"Active\",\r\n//   } = contact;\r\n\r\n//   const initials = name\r\n//     ?.split(\" \")\r\n//     .map(n => n[0])\r\n//     .join(\"\")\r\n//     .substring(0, 2)\r\n//     .toUpperCase();\r\n\r\n//   return (\r\n//     <div className=\"p-4 text-sm overflow-y-auto h-full\">\r\n//       {/* ðŸ”¹ Top Header */}\r\n//       <div className=\"flex items-center gap-4 mb-4\">\r\n//         <div className=\"w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-semibold text-sm\">\r\n//           {initials}\r\n//         </div>\r\n//         <div>\r\n//           <h2 className=\"font-semibold text-gray-800 flex items-center gap-2\">\r\n//             {name}\r\n//             {sessionStatus === \"Active\" && (\r\n//               <span\r\n//                 className=\"ml-1 inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse\"\r\n//                 title=\"Active session\"\r\n//               ></span>\r\n//             )}\r\n//           </h2>\r\n//           <div className=\"text-xs text-gray-500\">{phoneNumber}</div>\r\n//         </div>\r\n//       </div>\r\n\r\n//       {/* ðŸ§± Tab Switcher */}\r\n//       <div className=\"flex mb-4 border rounded-md overflow-hidden text-sm\">\r\n//         <button\r\n//           onClick={() => setActiveTab(\"details\")}\r\n//           className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${\r\n//             activeTab === \"details\"\r\n//               ? \"bg-gray-200 font-semibold\"\r\n//               : \"bg-gray-100 hover:bg-gray-200\"\r\n//           }`}\r\n//         >\r\n//           <Info size={14} /> Details\r\n//         </button>\r\n//         <button\r\n//           onClick={() => setActiveTab(\"notes\")}\r\n//           className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${\r\n//             activeTab === \"notes\"\r\n//               ? \"bg-gray-200 font-semibold\"\r\n//               : \"bg-gray-100 hover:bg-gray-200\"\r\n//           }`}\r\n//         >\r\n//           <StickyNote size={14} /> Notes\r\n//         </button>\r\n//       </div>\r\n\r\n//       {/* ðŸ“„ Details Tab */}\r\n//       {activeTab === \"details\" && (\r\n//         <div className=\"space-y-4\">\r\n//           <div className=\"bg-gray-50 border rounded-md p-3\">\r\n//             <h4 className=\"text-xs font-semibold text-gray-700 mb-1\">\r\n//               Conversation\r\n//             </h4>\r\n//             <div className=\"flex justify-between text-xs text-gray-600\">\r\n//               <span>24-hour window:</span>\r\n//               <span className=\"text-green-600 font-medium\">\r\n//                 {chatWindowStatus}\r\n//               </span>\r\n//             </div>\r\n//             <div className=\"flex justify-between text-xs text-gray-600\">\r\n//               <span>Chat session:</span>\r\n//               <span className=\"text-green-600 font-medium\">\r\n//                 {sessionStatus}\r\n//               </span>\r\n//             </div>\r\n//             <div className=\"flex justify-between text-xs text-gray-600\">\r\n//               <span>Window ends:</span>\r\n//               <span>â€”</span>\r\n//             </div>\r\n//           </div>\r\n\r\n//           <div>\r\n//             <h4 className=\"text-xs font-semibold text-gray-700 mb-1\">\r\n//               Contact data\r\n//             </h4>\r\n//             <div className=\"text-xs text-gray-600\">\r\n//               Created: {createdAt?.slice(0, 10)}\r\n//             </div>\r\n//             <div className=\"text-xs text-gray-600\">List: {list}</div>\r\n//           </div>\r\n\r\n//           <div>\r\n//             <h4 className=\"text-xs font-semibold text-gray-700 mb-1\">Tags</h4>\r\n//             {tags.length === 0 ? (\r\n//               <div className=\"text-gray-400 italic text-xs\">No tags</div>\r\n//             ) : (\r\n//               <div className=\"flex flex-wrap gap-2\">\r\n//                 {tags.map(tag => (\r\n//                   <span\r\n//                     key={tag.id}\r\n//                     className=\"text-xs font-medium px-2 py-1 rounded-full\"\r\n//                     style={{\r\n//                       backgroundColor: tag.colorHex || \"#999\",\r\n//                       color:\r\n//                         tag.colorHex && tag.colorHex.toLowerCase() === \"#ffffe0\"\r\n//                           ? \"#000\"\r\n//                           : \"#fff\",\r\n//                     }}\r\n//                   >\r\n//                     {tag.name}\r\n//                   </span>\r\n//                 ))}\r\n//               </div>\r\n//             )}\r\n//           </div>\r\n//         </div>\r\n//       )}\r\n\r\n//       {/* ðŸ“ Notes Tab */}\r\n//       {activeTab === \"notes\" && (\r\n//         <div className=\"space-y-3\">\r\n//           <div className=\"flex gap-2\">\r\n//             <input\r\n//               className=\"flex-1 px-2 py-1 text-xs border rounded-md\"\r\n//               placeholder=\"Add note...\"\r\n//               value={newNote}\r\n//               onChange={e => setNewNote(e.target.value)}\r\n//             />\r\n//             <button\r\n//               onClick={handleAddNote}\r\n//               className=\"bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700\"\r\n//             >\r\n//               Add\r\n//             </button>\r\n//           </div>\r\n\r\n//           {Array.isArray(notes) && notes.length > 0 ? (\r\n//             <div className=\"space-y-2 max-h-40 overflow-y-auto\">\r\n//               {notes.map(n => (\r\n//                 <div\r\n//                   key={n.id}\r\n//                   className=\"text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1\"\r\n//                 >\r\n//                   <div>{n.content}</div>\r\n//                   <div className=\"text-[10px] text-gray-400 mt-1\">\r\n//                     {dayjs(n.createdAt).fromNow()}\r\n//                   </div>\r\n//                 </div>\r\n//               ))}\r\n//             </div>\r\n//           ) : (\r\n//             <div className=\"text-gray-400 italic text-xs\">No notes yet</div>\r\n//           )}\r\n//         </div>\r\n//       )}\r\n//     </div>\r\n//   );\r\n// }\r\n","import React, { useEffect, useState } from \"react\";\r\nimport axiosClient from \"../../../api/axiosClient\";\r\n\r\n/**\r\n * ChatHeader â€” Professional WhatsApp-style chat header\r\n * Props:\r\n * - contactId: contact ID to fetch data\r\n */\r\nexport default function ChatHeader({ contactId }) {\r\n  const [contact, setContact] = useState(null);\r\n\r\n  // Fetch contact data when contactId changes\r\n  useEffect(() => {\r\n    if (!contactId) {\r\n      setContact(null);\r\n      return;\r\n    }\r\n\r\n    const fetchContact = async () => {\r\n      try {\r\n        const res = await axiosClient.get(`/contacts/${contactId}`);\r\n        // Handle different API response structures\r\n        if (res?.data?.data) {\r\n          setContact(res.data.data);\r\n        } else if (res?.data) {\r\n          setContact(res.data);\r\n        } else {\r\n          setContact(res);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"âŒ [ChatHeader] Failed to load contact:\", err);\r\n      }\r\n    };\r\n\r\n    fetchContact();\r\n  }, [contactId]);\r\n\r\n  if (!contact) return null;\r\n\r\n  const { name, phoneNumber } = contact;\r\n\r\n  // ðŸ§  Extract initials from name or phone number\r\n  const initials =\r\n    name\r\n      ?.split(\" \")\r\n      .map(part => part.charAt(0).toUpperCase())\r\n      .slice(0, 2)\r\n      .join(\"\") ||\r\n    phoneNumber?.slice(-2) ||\r\n    \"??\";\r\n\r\n  // Display name if present, otherwise phone number\r\n  const displayName = name || phoneNumber || \"Unknown Contact\";\r\n\r\n  return (\r\n    <div className=\"bg-white border-b shadow-sm px-4 py-3 flex items-center justify-between\">\r\n      {/* Left Section: Avatar + Info */}\r\n      <div className=\"flex items-center gap-4\">\r\n        {/* Avatar with Initials */}\r\n        <div className=\"w-10 h-10 rounded-full bg-green-600 text-white font-semibold text-sm flex items-center justify-center shadow-sm\">\r\n          {initials}\r\n        </div>\r\n\r\n        {/* Name, Phone */}\r\n        <div className=\"space-y-0.5\">\r\n          <h2 className=\"text-base font-semibold text-gray-800\">\r\n            {displayName}\r\n          </h2>\r\n          {name && phoneNumber && (\r\n            <div className=\"text-xs text-gray-500\">{phoneNumber}</div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import React, { useState, useEffect } from \"react\";\r\nimport { InboxProvider, useInbox } from \"./InboxContext\";\r\nimport InboxSidebar from \"./components/InboxSidebar\";\r\nimport ChatWindow from \"./components/ChatWindow\";\r\nimport ChatInput from \"./components/ChatInput\";\r\nimport ContactSidebar from \"./components/ContactSidebar\";\r\nimport ChatHeader from \"./components/ChatHeader\";\r\nimport { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n\r\n// The layout component gets its data from our new hook\r\nfunction InboxLayout() {\r\n  const {\r\n    selectedContactId,\r\n    setSelectedContactId,\r\n    currentUserId,\r\n    playSound,\r\n    toggleSound,\r\n  } = useInbox();\r\n\r\n  const [showRightPanel, setShowRightPanel] = useState(true);\r\n\r\n  // Control body scrolling when inbox is mounted\r\n  useEffect(() => {\r\n    // Store original styles\r\n    const originalBodyOverflow = document.body.style.overflow;\r\n    const originalHtmlOverflow = document.documentElement.style.overflow;\r\n\r\n    // Add classes to prevent scrolling\r\n    document.body.classList.add(\"inbox-active\");\r\n    document.documentElement.classList.add(\"inbox-active\");\r\n\r\n    // Force prevent scrolling\r\n    document.body.style.overflow = \"hidden\";\r\n    document.documentElement.style.overflow = \"hidden\";\r\n\r\n    // Cleanup function to restore original styles\r\n    return () => {\r\n      document.body.classList.remove(\"inbox-active\");\r\n      document.documentElement.classList.remove(\"inbox-active\");\r\n      document.body.style.overflow = originalBodyOverflow;\r\n      document.documentElement.style.overflow = originalHtmlOverflow;\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"inbox-fullscreen h-screen flex flex-col overflow-hidden\">\r\n      <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n        <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n          <span className=\"text-xl\">ðŸ“¨</span>\r\n          Inbox\r\n        </div>\r\n        <div className=\"flex items-center gap-4\">\r\n          <button\r\n            onClick={toggleSound}\r\n            className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n              playSound\r\n                ? \"bg-green-100 text-green-600 border-green-300\"\r\n                : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n            }`}\r\n          >\r\n            <Bell size={14} /> {playSound ? \"Sound ON\" : \"Sound OFF\"}\r\n          </button>\r\n        </div>\r\n      </header>\r\n\r\n      <div className=\"flex flex-1 overflow-hidden\">\r\n        {/* Left Sidebar - Always visible */}\r\n        <div\r\n          className=\"bg-white border-r overflow-y-auto\"\r\n          style={{\r\n            width: \"288px\",\r\n            minWidth: \"288px\",\r\n            maxWidth: \"288px\",\r\n            height: \"100%\",\r\n          }}\r\n        >\r\n          <InboxSidebar\r\n            onSelect={id => setSelectedContactId(id)}\r\n            currentUserId={currentUserId}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n          <button\r\n            className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n            onClick={() => setShowRightPanel(!showRightPanel)}\r\n            title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n          >\r\n            {showRightPanel ? (\r\n              <ChevronRight size={16} />\r\n            ) : (\r\n              <ChevronLeft size={16} />\r\n            )}\r\n          </button>\r\n\r\n          {selectedContactId ? (\r\n            <>\r\n              {/* Chat Header - Fixed at top */}\r\n              <div className=\"shrink-0\">\r\n                <ChatHeader contactId={selectedContactId} />\r\n              </div>\r\n\r\n              {/* Chat Window - Scrollable area that takes remaining space */}\r\n              <div className=\"flex-1 overflow-hidden\">\r\n                <ChatWindow />\r\n              </div>\r\n\r\n              {/* Chat Input - Fixed at bottom */}\r\n              <div className=\"shrink-0\" style={{ flexShrink: 0 }}>\r\n                <ChatInput />\r\n              </div>\r\n            </>\r\n          ) : (\r\n            <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n              Please select a contact to start chatting.\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {showRightPanel && selectedContactId && (\r\n          <div\r\n            className=\"w-80 border-l bg-white overflow-y-auto\"\r\n            style={{ height: \"100%\", maxHeight: \"100%\" }}\r\n          >\r\n            <ContactSidebar contactId={selectedContactId} />\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// The final export wraps our layout with the provider\r\nexport default function InboxWrapper() {\r\n  return (\r\n    <InboxProvider>\r\n      <InboxLayout />\r\n    </InboxProvider>\r\n  );\r\n}\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n// import { InboxProvider, useInbox } from \"./InboxContext\";\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const [playSound, setPlaySound] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n//   const [userHasInteracted, setUserHasInteracted] = useState(false);\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   // âœ… Track first user interaction to allow audio play\r\n//   useEffect(() => {\r\n//     const handleUserInteraction = () => setUserHasInteracted(true);\r\n//     window.addEventListener(\"click\", handleUserInteraction);\r\n//     window.addEventListener(\"keydown\", handleUserInteraction);\r\n//     return () => {\r\n//       window.removeEventListener(\"click\", handleUserInteraction);\r\n//       window.removeEventListener(\"keydown\", handleUserInteraction);\r\n//     };\r\n//   }, []);\r\n\r\n//   // ðŸ”Š Sound toggle with permission\r\n//   const toggleSound = async () => {\r\n//     const newVal = !playSound;\r\n\r\n//     if (newVal) {\r\n//       try {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         await audio.play();\r\n//         audio.pause();\r\n//         setPlaySound(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Browser blocked sound. Allow autoplay.\");\r\n//         console.warn(\"âš ï¸ Audio play blocked:\", err);\r\n//         setPlaySound(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setPlaySound(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   };\r\n\r\n//   // ðŸ“ž Fetch contact info on select\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   // ðŸ“© Load message history\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   // ðŸš€ Send message\r\n//   // const sendMessage = async () => {\r\n//   //   if (!selectedContactId)\r\n//   //     return toast.error(\"â— Please select a contact first.\");\r\n//   //   if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//   //   if (!connection || !isConnected)\r\n//   //     return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//   //   try {\r\n//   //     await connection.invoke(\"SendMessageToContact\", {\r\n//   //       contactId: selectedContactId,\r\n//   //       message: newMessage,\r\n//   //     });\r\n//   //     setNewMessage(\"\");\r\n//   //   } catch (err) {\r\n//   //     console.error(\"âŒ Send failed:\", err);\r\n//   //     toast.error(\"Failed to send message.\");\r\n//   //   }\r\n//   // };\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId || !newMessage.trim()) return;\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     // 1. Create a temporary message for optimistic UI\r\n//     const tempId = `temp_${Date.now()}`;\r\n//     const optimisticMessage = {\r\n//       id: tempId,\r\n//       contactId: selectedContactId,\r\n//       messageContent: newMessage,\r\n//       isIncoming: false,\r\n//       sentAt: new Date().toISOString(),\r\n//       status: \"Sending\", // Special status for the UI\r\n//     };\r\n\r\n//     // 2. Add to state immediately and clear input\r\n//     setMessages(prevMessages => [...prevMessages, optimisticMessage]);\r\n//     setNewMessage(\"\");\r\n\r\n//     try {\r\n//       // 3. Send to server\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//         // Optional: send tempId to make replacement easier\r\n//         // tempId: tempId\r\n//       });\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//       // Handle error: update the optimistic message to show a \"Failed\" status\r\n//       setMessages(prev =>\r\n//         prev.map(m => (m.id === tempId ? { ...m, status: \"Failed\" } : m))\r\n//       );\r\n//     }\r\n//   };\r\n//   // ðŸ”” Real-time message listener\r\n//   // useEffect(() => {\r\n//   //   if (!connection) return;\r\n\r\n//   //   const handler = incoming => {\r\n//   //     if (\r\n//   //       incoming.contactId !== selectedContactId &&\r\n//   //       playSound &&\r\n//   //       userHasInteracted\r\n//   //     ) {\r\n//   //       try {\r\n//   //         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//   //         audio.play().catch(err => {\r\n//   //           console.warn(\"ðŸ”‡ Browser prevented sound playback:\", err);\r\n//   //         });\r\n//   //       } catch (err) {\r\n//   //         console.warn(\"âŒ Sound error:\", err);\r\n//   //       }\r\n//   //     }\r\n\r\n//   //     if (incoming.contactId === selectedContactId) {\r\n//   //       setMessages(prev =>\r\n//   //         [...prev, incoming].sort(\r\n//   //           (a, b) =>\r\n//   //             new Date(a.sentAt || a.createdAt) -\r\n//   //             new Date(b.sentAt || b.createdAt)\r\n//   //         )\r\n//   //       );\r\n//   //     }\r\n//   //   };\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handler = incoming => {\r\n//       // ... sound playing logic ...\r\n\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev => {\r\n//           // If the message is from the current user, replace the temp message\r\n//           if (!incoming.isIncoming) {\r\n//             return prev.map(m => (m.status === \"Sending\" ? incoming : m));\r\n//           }\r\n//           // Otherwise, just add the new incoming message\r\n//           return [...prev, incoming];\r\n//         });\r\n//       }\r\n//     };\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, playSound, userHasInteracted]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           <span className=\"text-xl\">ðŸ“¨</span> Inbox\r\n//         </div>\r\n//         <div className=\"flex items-center gap-4\">\r\n//           <button\r\n//             onClick={toggleSound}\r\n//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n//               playSound\r\n//                 ? \"bg-green-100 text-green-600 border-green-300\"\r\n//                 : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n//             }`}\r\n//           >\r\n//             <Bell size={14} /> {playSound ? \"Sound ON\" : \"Sound OFF\"}\r\n//           </button>\r\n//         </div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar\r\n//             onSelect={id => setSelectedContactId(id)}\r\n//             currentUserId={currentUserId}\r\n//           />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat Area */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow\r\n//                   messages={messages}\r\n//                   currentUserId={currentUserId}\r\n//                   selectedContactId={selectedContactId}\r\n//                   connection={connection}\r\n//                 />\r\n//               </div>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Panel */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const [playSound, setPlaySound] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   // ðŸ”Š Sound toggle with permission\r\n//   const toggleSound = async () => {\r\n//     const newVal = !playSound;\r\n\r\n//     if (newVal) {\r\n//       try {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         await audio.play();\r\n//         audio.pause();\r\n//         setPlaySound(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Browser blocked sound. Allow autoplay.\");\r\n//         console.warn(\"âš ï¸ Audio play blocked:\", err);\r\n//         setPlaySound(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setPlaySound(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   };\r\n\r\n//   // ðŸ“ž Fetch contact info on select\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   // ðŸ“© Load message history\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   // ðŸš€ Send message\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   // ðŸ”” Real-time message listener\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handler = incoming => {\r\n//       if (incoming.contactId !== selectedContactId && playSound) {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         audio.play();\r\n//       }\r\n\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, playSound]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           <span className=\"text-xl\">ðŸ“¨</span> Inbox\r\n//         </div>\r\n//         <div className=\"flex items-center gap-4\">\r\n//           <button\r\n//             onClick={toggleSound}\r\n//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n//               playSound\r\n//                 ? \"bg-green-100 text-green-600 border-green-300\"\r\n//                 : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n//             }`}\r\n//           >\r\n//             <Bell size={14} /> {playSound ? \"Sound ON\" : \"Sound OFF\"}\r\n//           </button>\r\n//           <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//         </div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar\r\n//             onSelect={id => setSelectedContactId(id)}\r\n//             currentUserId={currentUserId}\r\n//           />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat Area */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow\r\n//                   messages={messages}\r\n//                   currentUserId={currentUserId}\r\n//                   selectedContactId={selectedContactId}\r\n//                   connection={connection}\r\n//                 />\r\n//               </div>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Panel */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const [playSound, setPlaySound] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   const toggleSound = async () => {\r\n//     const newVal = !playSound;\r\n\r\n//     if (newVal) {\r\n//       // Try to play dummy sound to get permission\r\n//       try {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         await audio.play();\r\n//         audio.pause();\r\n//         setPlaySound(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Your browser blocked sound. Please allow autoplay.\");\r\n//         console.warn(\"âš ï¸ Audio play blocked:\", err);\r\n//         setPlaySound(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setPlaySound(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     const handler = incoming => {\r\n//       // âœ… Play sound only if it's from another contact\r\n//       if (incoming.contactId !== selectedContactId && playSound) {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         audio.play();\r\n//       }\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, playSound]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           <span className=\"text-xl\">ðŸ“¨</span> Inbox\r\n//         </div>\r\n//         <div className=\"flex items-center gap-4\">\r\n//           <button\r\n//             onClick={toggleSound}\r\n//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n//               playSound\r\n//                 ? \"bg-green-100 text-green-600 border-green-300\"\r\n//                 : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n//             }`}\r\n//           >\r\n//             <Bell size={14} /> {playSound ? \"Sound ON\" : \"Sound OFF\"}\r\n//           </button>\r\n//           <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//         </div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main 3-column layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat column */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow\r\n//                   messages={messages}\r\n//                   currentUserId={currentUserId}\r\n//                   selectedContactId={selectedContactId}\r\n//                   connection={connection}\r\n//                 />\r\n//               </div>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Contact Info */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const [playSound, setPlaySound] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   const toggleSound = async () => {\r\n//     const newVal = !playSound;\r\n\r\n//     if (newVal) {\r\n//       try {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         await audio.play();\r\n//         audio.pause();\r\n//         setPlaySound(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Your browser blocked sound. Please allow autoplay.\");\r\n//         console.warn(\"âš ï¸ Audio play blocked:\", err);\r\n//         setPlaySound(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setPlaySound(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handler = incoming => {\r\n//       if (incoming.contactId !== selectedContactId && playSound) {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         audio.play();\r\n//       }\r\n\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, playSound]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           ðŸ“¨ Inbox\r\n//         </div>\r\n//         <div className=\"flex items-center gap-4\">\r\n//           <button\r\n//             onClick={toggleSound}\r\n//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n//               playSound\r\n//                 ? \"bg-green-100 text-green-600 border-green-300\"\r\n//                 : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n//             }`}\r\n//           >\r\n//             <Bell size={14} /> {playSound ? \"Sound ON\" : \"Sound OFF\"}\r\n//           </button>\r\n//           <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//         </div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main 3-column layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat column */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow messages={messages} currentUserId={currentUserId} />\r\n//               </div>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Contact Info */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// // âœ… Updated InboxWrapper.jsx with stable notification sound toggle via useNotificationSound\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import useNotificationSound from \"../../hooks/useNotificationSound\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   const { isSoundOn, toggleSound, soundRef } = useNotificationSound();\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n\r\n//     const handler = incoming => {\r\n//       // âœ… Use soundRef for latest value\r\n//       if (incoming.contactId !== selectedContactId && soundRef.current) {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         audio.play();\r\n//       }\r\n\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, soundRef]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           ðŸ“¨ Inbox\r\n//         </div>\r\n//         <div className=\"flex items-center gap-4\">\r\n//           <button\r\n//             onClick={toggleSound}\r\n//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n//               isSoundOn\r\n//                 ? \"bg-green-100 text-green-600 border-green-300\"\r\n//                 : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n//             }`}\r\n//           >\r\n//             <Bell size={14} /> {isSoundOn ? \"Sound ON\" : \"Sound OFF\"}\r\n//           </button>\r\n//           <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//         </div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main 3-column layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat column */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow messages={messages} currentUserId={currentUserId} />\r\n//               </div>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Contact Info */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// âœ… Updated InboxWrapper.jsx with Notification Sound Toggle + Play Logic\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight, Bell } from \"lucide-react\";\r\n\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const [playSound, setPlaySound] = useState(\r\n//     localStorage.getItem(\"playSound\") === \"true\"\r\n//   );\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   // const toggleSound = () => {\r\n//   //   const newVal = !playSound;\r\n//   //   setPlaySound(newVal);\r\n//   //   localStorage.setItem(\"playSound\", newVal);\r\n//   // };\r\n//   const toggleSound = async () => {\r\n//     const newVal = !playSound;\r\n\r\n//     if (newVal) {\r\n//       // Try to play dummy sound to get permission\r\n//       try {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         await audio.play();\r\n//         audio.pause();\r\n//         setPlaySound(true);\r\n//         localStorage.setItem(\"playSound\", \"true\");\r\n//       } catch (err) {\r\n//         toast.error(\"ðŸ”‡ Your browser blocked sound. Please allow autoplay.\");\r\n//         console.warn(\"âš ï¸ Audio play blocked:\", err);\r\n//         setPlaySound(false);\r\n//         localStorage.setItem(\"playSound\", \"false\");\r\n//       }\r\n//     } else {\r\n//       setPlaySound(false);\r\n//       localStorage.setItem(\"playSound\", \"false\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     const handler = incoming => {\r\n//       // âœ… Play sound only if it's from another contact\r\n//       if (incoming.contactId !== selectedContactId && playSound) {\r\n//         const audio = new Audio(\"/sounds/inbox_notify.mp3\");\r\n//         audio.play();\r\n//       }\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId, playSound]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           ðŸ“¨ Inbox\r\n//         </div>\r\n//         <div className=\"flex items-center gap-4\">\r\n//           <button\r\n//             onClick={toggleSound}\r\n//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${\r\n//               playSound\r\n//                 ? \"bg-green-100 text-green-600 border-green-300\"\r\n//                 : \"bg-gray-100 text-gray-500 border-gray-300\"\r\n//             }`}\r\n//           >\r\n//             <Bell size={14} /> {playSound ? \"Sound ON\" : \"Sound OFF\"}\r\n//           </button>\r\n//           <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//         </div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main 3-column layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat column */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow messages={messages} currentUserId={currentUserId} />\r\n//               </div>\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Contact Info */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight } from \"lucide-react\";\r\n\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {\r\n//       setContact(res.data);\r\n//     });\r\n//   }, [selectedContactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     axiosClient\r\n//       .get(`/inbox/messages?contactId=${selectedContactId}`)\r\n//       .then(res => setMessages(res.data))\r\n//       .catch(err => {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       });\r\n//   }, [selectedContactId]);\r\n\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", {\r\n//         contactId: selectedContactId,\r\n//         message: newMessage,\r\n//       });\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     const handler = incoming => {\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId]);\r\n\r\n//   return (\r\n//     <div className=\"h-screen flex flex-col overflow-hidden\">\r\n//       {/* ðŸ”’ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           ðŸ“¨ Inbox\r\n//         </div>\r\n//         <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main 3-column layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* ðŸ“‡ Left Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />\r\n//         </div>\r\n\r\n//         {/* ðŸ’¬ Chat column */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative\">\r\n//           {/* â†”ï¸ Toggle Right Panel */}\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               {/* ðŸ§‘ Contact Header */}\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n\r\n//               {/* ðŸ“œ Message Scroll Area */}\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow messages={messages} currentUserId={currentUserId} />\r\n//               </div>\r\n\r\n//               {/* âœï¸ Chat Input (Fixed at bottom) */}\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatInput\r\n//                   value={newMessage}\r\n//                   onChange={e => setNewMessage(e.target.value)}\r\n//                   onSend={sendMessage}\r\n//                   disabled={!isConnected}\r\n//                 />\r\n//               </div>\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* ðŸ“‡ Right Contact Info */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n\r\n// import React, { useEffect, useState } from \"react\";\r\n// import useSignalR from \"../../hooks/useSignalR\";\r\n// import InboxSidebar from \"./components/InboxSidebar\";\r\n// import ChatWindow from \"./components/ChatWindow\";\r\n// import ChatInput from \"./components/ChatInput\";\r\n// import ContactSidebar from \"./components/ContactSidebar\";\r\n// import ChatHeader from \"./components/ChatHeader\";\r\n// import axiosClient from \"../../api/axiosClient\";\r\n// import { toast } from \"react-toastify\";\r\n// import { ChevronLeft, ChevronRight } from \"lucide-react\";\r\n// import { Inbox } from \"lucide-react\"; // âœ… Add this at top\r\n// export default function InboxWrapper() {\r\n//   const { connection, isConnected } = useSignalR();\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [selectedContactId, setSelectedContactId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n//   const [contact, setContact] = useState(null);\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n\r\n//   const currentUserId = localStorage.getItem(\"userId\");\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContact(null);\r\n//       return;\r\n//     }\r\n//     const loadContact = async () => {\r\n//       try {\r\n//         const res = await axiosClient.get(`/contacts/${selectedContactId}`);\r\n//         setContact(res.data);\r\n//       } catch (err) {\r\n//         console.error(\"âŒ Failed to load contact:\", err);\r\n//       }\r\n//     };\r\n//     loadContact();\r\n//   }, [selectedContactId]);\r\n\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) return;\r\n//     const loadMessages = async () => {\r\n//       try {\r\n//         const res = await axiosClient.get(\r\n//           `/inbox/messages?contactId=${selectedContactId}`\r\n//         );\r\n//         setMessages(res.data);\r\n//       } catch (err) {\r\n//         console.error(\"âŒ Failed to load messages:\", err);\r\n//         toast.error(\"Failed to load messages.\");\r\n//       }\r\n//     };\r\n//     loadMessages();\r\n//   }, [selectedContactId]);\r\n\r\n//   const sendMessage = async () => {\r\n//     if (!selectedContactId)\r\n//       return toast.error(\"â— Please select a contact first.\");\r\n//     if (!newMessage.trim()) return toast.warn(\"âš ï¸ Please type a message.\");\r\n//     if (!connection || !isConnected)\r\n//       return toast.error(\"âŒ SignalR not connected.\");\r\n\r\n//     const payload = {\r\n//       contactId: selectedContactId,\r\n//       message: newMessage,\r\n//     };\r\n\r\n//     try {\r\n//       await connection.invoke(\"SendMessageToContact\", payload);\r\n//       setNewMessage(\"\");\r\n//     } catch (err) {\r\n//       console.error(\"âŒ Send failed:\", err);\r\n//       toast.error(\"Failed to send message.\");\r\n//     }\r\n//   };\r\n\r\n//   useEffect(() => {\r\n//     if (!connection) return;\r\n//     const handler = incoming => {\r\n//       if (incoming.contactId === selectedContactId) {\r\n//         setMessages(prev =>\r\n//           [...prev, incoming].sort(\r\n//             (a, b) =>\r\n//               new Date(a.sentAt || a.createdAt) -\r\n//               new Date(b.sentAt || b.createdAt)\r\n//           )\r\n//         );\r\n//       }\r\n//     };\r\n//     connection.on(\"ReceiveInboxMessage\", handler);\r\n//     return () => connection.off(\"ReceiveInboxMessage\", handler);\r\n//   }, [connection, selectedContactId]);\r\n\r\n//   return (\r\n//     <div className=\"flex flex-col h-screen bg-white\">\r\n//       {/* ðŸŸ£ Top App Bar */}\r\n//       <header className=\"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between\">\r\n//         <div className=\"flex items-center gap-2 text-purple-600 font-semibold text-base\">\r\n//           <Inbox size={18} className=\"text-purple-600\" />\r\n//           Inbox\r\n//         </div>\r\n//         <div className=\"text-sm text-gray-500\">xByteChat</div>\r\n//       </header>\r\n\r\n//       {/* ðŸ’¬ Main Body Layout */}\r\n//       <div className=\"flex flex-1 overflow-hidden\">\r\n//         {/* Sidebar */}\r\n//         <div className=\"w-72 border-r bg-white overflow-y-auto\">\r\n//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />\r\n//         </div>\r\n\r\n//         {/* Chat Column */}\r\n//         <div className=\"flex flex-col flex-1 bg-[#f0f0eb] relative\">\r\n//           {/* Toggle Right Panel Button */}\r\n//           <button\r\n//             className=\"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600\"\r\n//             onClick={() => setShowRightPanel(!showRightPanel)}\r\n//             title={showRightPanel ? \"Hide contact info\" : \"Show contact info\"}\r\n//           >\r\n//             {showRightPanel ? (\r\n//               <ChevronRight size={16} />\r\n//             ) : (\r\n//               <ChevronLeft size={16} />\r\n//             )}\r\n//           </button>\r\n\r\n//           {selectedContactId ? (\r\n//             <>\r\n//               {/* Chat Header (Not Sticky) */}\r\n//               <div className=\"shrink-0\">\r\n//                 <ChatHeader contact={contact} />\r\n//               </div>\r\n\r\n//               {/* Scrollable Chat Window */}\r\n//               <div className=\"flex-1 overflow-y-auto\">\r\n//                 <ChatWindow\r\n//                   messages={messages}\r\n//                   currentUserId={currentUserId}\r\n//                   contact={contact}\r\n//                 />\r\n//               </div>\r\n\r\n//               {/* Input */}\r\n//               <ChatInput\r\n//                 value={newMessage}\r\n//                 onChange={e => setNewMessage(e.target.value)}\r\n//                 onSend={sendMessage}\r\n//                 disabled={!isConnected}\r\n//               />\r\n//             </>\r\n//           ) : (\r\n//             <div className=\"flex-1 flex items-center justify-center text-gray-400\">\r\n//               Please select a contact to start chatting.\r\n//             </div>\r\n//           )}\r\n//         </div>\r\n\r\n//         {/* Right Panel */}\r\n//         {showRightPanel && selectedContactId && (\r\n//           <div className=\"w-80 border-l bg-white overflow-y-auto\">\r\n//             <ContactSidebar contactId={selectedContactId} />\r\n//           </div>\r\n//         )}\r\n//       </div>\r\n//     </div>\r\n//   );\r\n// }\r\n"],"names":["REALTIME_TOAST_ID","isIgnorableSignalRError","err","name","String","msg","message","toLowerCase","includes","useSignalR","onMessageReceived","onUnreadChanged","arguments","length","undefined","connection","setConnection","useState","isConnected","setIsConnected","connRef","useRef","mountedRef","startingRef","useEffect","current","hubUrl","base","process","trim","replace","concat","getHubUrl","localStorage","getItem","TOKEN_KEY","console","warn","finalUrl","saBizId","encodeURIComponent","conn","signalR","withUrl","accessTokenFactory","transport","WebSockets","LongPolling","withAutomaticReconnect","configureLogging","Information","build","on","onreconnecting","onreconnected","toast","dismiss","onclose","error","toastId","async","start","log","off","_unused","state","Disconnected","stop","catch","module","exports","e","o","t","prototype","isToday","this","format","n","isYesterday","subtract","InboxContext","createContext","useInbox","useContext","InboxProvider","_ref","children","messages","setMessages","selectedContactId","setSelectedContactId","newMessage","setNewMessage","contact","setContact","playSound","setPlaySound","userHasInteracted","setUserHasInteracted","currentUserId","handleUserInteraction","window","addEventListener","removeEventListener","axiosClient","get","then","res","data","normalized","map","m","_m$messageContent","_objectSpread","messageContent","handler","incoming","_incoming$messageCont","contactId","Audio","play","prev","isIncoming","status","value","toggleSound","setItem","sendMessage","tempId","Date","now","optimisticMessage","id","sentAt","toISOString","invoke","_jsx","Provider","InboxSidebar","onSelect","contacts","setContacts","selectedId","setSelectedId","unreadCounts","setUnreadCounts","search","setSearch","options","src","volume","throttleMs","storageEnabledKey","storageVolumeKey","enabled","setEnabled","vol","setVol","raw","v","parseFloat","Number","isFinite","Math","min","max","_unused2","userInteracted","setUserInteracted","audioRef","lastPlayedAtRef","a","preload","_unused3","_unused4","unlock","pause","_unused5","passive","useCallback","next","_unused6","isAllowed","_unused7","currentTime","b","_unused8","_unused9","setVolume","useNotificationSound","fetchUnreadCounts","loadContactsAndUnread","contactRes","countRes","Promise","all","handleUnread","payload","refresh","handleMessage","_ref2","_msg$contactId","cid","ContactId","senderId","post","filtered","Array","isArray","filter","c","phoneNumber","toString","_jsxs","className","type","placeholder","onChange","target","unread","onClick","handleSelect","split","join","substring","toUpperCase","ChatBubble","isOwn","expanded","setExpanded","messageRef","isOverflowing","setIsOverflowing","time","dayjs","createdAt","messageText","renderedBody","el","scrollHeight","clientHeight","tickColor","ref","style","overflow","whiteSpace","_Fragment","FaClock","FaExclamationCircle","FaCheck","FaCheckDouble","ChatWindow","scrollContainerRef","bottomRef","atBottomRef","isNearBottom","scrollTop","handleScroll","scrollToBottom","_bottomRef$current","smooth","scrollIntoView","behavior","block","setTimeout","clearTimeout","onForce","timeout","grouped","reduce","acc","dateKey","date","d","getDateLabel","push","onScroll","Object","entries","msgs","idx","QuickReplyPicker","onInsert","onClose","scope","containerRef","searchRef","q","setQ","items","setItems","loading","setLoading","activeIndex","setActiveIndex","viewScope","setViewScope","viewScopeParam","useMemo","s","creating","setCreating","title","setTitle","body","setBody","tagsCsv","setTagsCsv","createScope","setCreateScope","saving","setSaving","saveMsg","setSaveMsg","ignore","params","finally","_searchRef$current","focus","onDocClick","contains","document","capture","handleInsert","text","role","onKeyDown","key","preventDefault","i","_items$activeIndex","checked","disabled","_res$data","_res$data2","ok","success","x","isActive","onMouseEnter","language","EMOJIS","char","EmojiPicker","onPick","autoFocus","ChatInput","pickerOpen","setPickerOpen","emojiOpen","setEmojiOpen","textareaRef","handleSend","dispatchEvent","CustomEvent","insertAtCursor","snippet","_el$selectionStart","_el$selectionEnd","selectionStart","end","selectionEnd","slice","requestAnimationFrame","pos","setSelectionRange","autoResize","height","Smile","size","emoji","Paperclip","rows","shiftKey","onInput","clearMessage","CloseIcon","Send","ContactSidebar","newNote","setNewNote","activeTab","setActiveTab","fetchContact","tags","notes","list","chatWindowStatus","sessionStatus","maxHeight","Info","StickyNote","tag","backgroundColor","colorHex","color","_updated$data","content","updated","fromNow","ChatHeader","initials","part","charAt","displayName","relativeTime","InboxLayout","showRightPanel","setShowRightPanel","originalBodyOverflow","originalHtmlOverflow","documentElement","classList","add","remove","Bell","width","minWidth","maxWidth","ChevronRight","ChevronLeft","flexShrink","InboxWrapper"],"sourceRoot":""}