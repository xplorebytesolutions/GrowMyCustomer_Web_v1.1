(self.webpackChunkxbytechat_ui=self.webpackChunkxbytechat_ui||[]).push([[640],{29792:(e,t,s)=>{"use strict";s.d(t,{A:()=>x});var n=s(65043),a=s(35713),o=s(69008),r=s(60069),l=s(79378),c=s(57488),i=s(35870);const d="signalr-realtime-failed";function u(e){const t=String((null===e||void 0===e?void 0:e.name)||""),s=String((null===e||void 0===e?void 0:e.message)||e||"").toLowerCase();return"AbortError"===t||s.includes("stopped during negotiation")||s.includes("abort")||s.includes("canceled")||s.includes("cancelled")}function x(){let{onMessageReceived:e,onUnreadChanged:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const[s,x]=(0,n.useState)(null),[m,h]=(0,n.useState)(!1),g=(0,n.useRef)(null),f=(0,n.useRef)(!1),v=(0,n.useRef)(!1);return(0,n.useEffect)((()=>{f.current=!0;const s=function(){const e=("https://api.xplorebyte.com/api".trim()||"http://localhost:7113/api").replace(/\/+$/,"");return"".concat(e,"/hubs/inbox")}();if(!localStorage.getItem(i.TOKEN_KEY))return console.warn("SignalR skipped: No auth token found."),h(!1),()=>{f.current=!1};let n=s;const m=localStorage.getItem("sa_selectedBusinessId");m&&(n+="?bizId=".concat(encodeURIComponent(m)));const p=(new a.$).withUrl(n,{accessTokenFactory:()=>localStorage.getItem(i.TOKEN_KEY)||"",transport:o.w.WebSockets|o.w.LongPolling}).withAutomaticReconnect([0,2e3,5e3,1e4]).configureLogging(r.$.Information).build();g.current=p,x(p),e&&p.on("ReceiveInboxMessage",e),t&&p.on("UnreadCountChanged",t),p.onreconnecting((()=>{f.current&&h(!1)})),p.onreconnected((()=>{f.current&&(h(!0),c.oR.dismiss(d))})),p.onclose((e=>{f.current&&(h(!1),u(e)||c.oR.error("Real-time connection failed.",{toastId:d}))}));return(async()=>{if(!v.current){v.current=!0;try{if(await p.start(),!f.current)return;h(!0),c.oR.dismiss(d),console.log("\u2705 SignalR connected:",n)}catch(e){if(!f.current)return;if(u(e))return;h(!1);const t=String((null===e||void 0===e?void 0:e.message)||e||"").toLowerCase();t.includes("401")||t.includes("unauthorized")?c.oR.error("SignalR unauthorized. Your session may have expired.",{toastId:d}):c.oR.error("Real-time connection failed.",{toastId:d}),console.error("\u274c SignalR start failed:",e)}finally{v.current=!1}}})(),()=>{f.current=!1;try{e&&p.off("ReceiveInboxMessage",e),t&&p.off("UnreadCountChanged",t)}catch(s){}p&&p.state!==l.j.Disconnected&&p.stop().catch((()=>{}))}}),[e,t]),{connection:s,isConnected:m}}},30616:function(e){e.exports=function(){"use strict";return function(e,t,s){t.prototype.isToday=function(){var e="YYYY-MM-DD",t=s();return this.format(e)===t.format(e)}}}()},36109:function(e){e.exports=function(){"use strict";return function(e,t,s){t.prototype.isYesterday=function(){var e="YYYY-MM-DD",t=s().subtract(1,"day");return this.format(e)===t.format(e)}}}()},42640:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>H});var n=s(65043),a=s(89379),o=s(29792),r=s(35870),l=s(57488),c=s(70579);const i=(0,n.createContext)(),d=()=>(0,n.useContext)(i),u=e=>{let{children:t}=e;const{connection:s,isConnected:d}=(0,o.A)(),[u,x]=(0,n.useState)([]),[m,h]=(0,n.useState)(null),[g,f]=(0,n.useState)(""),[v,p]=(0,n.useState)(null),[y,b]=(0,n.useState)("true"===localStorage.getItem("playSound")),[w,j]=(0,n.useState)(!1),N=localStorage.getItem("userId");(0,n.useEffect)((()=>{const e=()=>j(!0);return window.addEventListener("click",e),window.addEventListener("keydown",e),()=>{window.removeEventListener("click",e),window.removeEventListener("keydown",e)}}),[]),(0,n.useEffect)((()=>{m?r.default.get("/contacts/".concat(m)).then((e=>{p(e.data)})):p(null)}),[m]),(0,n.useEffect)((()=>{m?(x([]),r.default.get("/inbox/messages?contactId=".concat(m)).then((e=>{const t=(e.data||[]).map((e=>{var t;return(0,a.A)((0,a.A)({},e),{},{messageContent:null!==(t=e.messageContent)&&void 0!==t?t:e.message})}));x(t)})).catch((e=>{console.error("\u274c Failed to load messages:",e),l.oR.error("Failed to load messages.")}))):x([])}),[m]),(0,n.useEffect)((()=>{if(!s)return;const e=e=>{var t;const s=(0,a.A)((0,a.A)({},e),{},{messageContent:null!==(t=e.messageContent)&&void 0!==t?t:e.message});s.contactId!==m&&y&&w&&new Audio("/sounds/inbox_notify.mp3").play().catch((()=>{})),s.contactId===m&&x((e=>s.isIncoming?[...e,s]:e.map((e=>"Sending"===e.status?s:e))))};return s.on("ReceiveInboxMessage",e),()=>s.off("ReceiveInboxMessage",e)}),[s,m,y,w]);const S={connection:s,isConnected:d,messages:u,selectedContactId:m,setSelectedContactId:h,newMessage:g,setNewMessage:f,contact:v,playSound:y,toggleSound:async()=>{if(!y)try{await new Audio("/sounds/inbox_notify.mp3").play(),b(!0),localStorage.setItem("playSound","true")}catch(e){l.oR.error("\ud83d\udd07 Browser blocked sound. Please enable autoplay."),b(!1),localStorage.setItem("playSound","false")}else b(!1),localStorage.setItem("playSound","false")},sendMessage:async()=>{if(!m||!g.trim()||!d)return;const e="temp_".concat(Date.now()),t={id:e,contactId:m,messageContent:g,isIncoming:!1,sentAt:(new Date).toISOString(),status:"Sending"};x((e=>[...e,t])),f("");try{await s.invoke("SendMessageToContact",{contactId:m,message:g})}catch(n){console.error("\u274c Send failed:",n),l.oR.error("Failed to send message."),x((t=>t.map((t=>t.id===e?(0,a.A)((0,a.A)({},t),{},{status:"Failed"}):t))))}},currentUserId:N};return(0,c.jsx)(i.Provider,{value:S,children:t})};function x(e){let{onSelect:t,currentUserId:s}=e;const[l,i]=(0,n.useState)([]),[d,u]=(0,n.useState)(null),[x,m]=(0,n.useState)({}),[h,g]=(0,n.useState)(""),{connection:f}=(0,o.A)(),{play:v}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{src:t="/sounds/inbox_notify.mp3",volume:s=.6,throttleMs:a=800,storageEnabledKey:o="playSound",storageVolumeKey:r="playSoundVolume"}=e,[l,c]=(0,n.useState)((()=>{try{return"true"===localStorage.getItem(o)}catch(e){return!1}})),[i,d]=(0,n.useState)((()=>{try{const e=localStorage.getItem(r),t=null==e?s:parseFloat(e);return Number.isFinite(t)?Math.min(1,Math.max(0,t)):s}catch(e){return s}})),[u,x]=(0,n.useState)(!1),m=(0,n.useRef)(null),h=(0,n.useRef)(0);(0,n.useEffect)((()=>{let e=m.current;e||(e=new Audio,m.current=e),e.src=t,e.preload="auto",e.volume=i}),[t,i]),(0,n.useEffect)((()=>{try{localStorage.setItem(o,String(l))}catch(e){}}),[l,o]),(0,n.useEffect)((()=>{try{localStorage.setItem(r,String(i))}catch(e){}}),[i,r]),(0,n.useEffect)((()=>{if(u)return;const e=()=>{x(!0);try{const e=m.current;e&&e.play().then((()=>e.pause())).catch((()=>{}))}catch(t){}window.removeEventListener("pointerdown",e),window.removeEventListener("keydown",e),window.removeEventListener("touchstart",e)};return window.addEventListener("pointerdown",e,{passive:!0}),window.addEventListener("keydown",e),window.addEventListener("touchstart",e,{passive:!0}),()=>{window.removeEventListener("pointerdown",e),window.removeEventListener("keydown",e),window.removeEventListener("touchstart",e)}}),[u]);const g=(0,n.useCallback)((()=>{c((e=>{const t=!e;try{localStorage.setItem(o,String(t))}catch(s){}return t}))}),[o]),f=(0,n.useCallback)((()=>{const e=Date.now();if(e-h.current<a)return;h.current=e;let t=!1;try{t="true"===localStorage.getItem(o)}catch(n){}if(!t||!l||!u)return;const s=m.current;if(s)try{s.currentTime=0,s.play().catch((()=>{try{const e=new Audio(s.src);e.volume=s.volume,e.play().catch((()=>{}))}catch(e){}}))}catch(r){}}),[l,u,a,o]),v=(0,n.useCallback)((e=>{d(Math.min(1,Math.max(0,Number(e))))}),[]);return{enabled:l,toggleSound:g,play:f,volume:i,setVolume:v,userInteracted:u}}({volume:.6,throttleMs:800}),p=(0,n.useCallback)((async()=>{try{const e=await r.default.get("/inbox/unread-counts");m(e.data||{}),console.log("\u2705 Unread counts refreshed")}catch(e){console.error("\u274c Failed to refresh unread counts:",e)}}),[]),y=(0,n.useCallback)((async()=>{try{const[e,t]=await Promise.all([r.default.get("/contacts/all"),r.default.get("/inbox/unread-counts")]);i(e.data||[]),m(t.data||{}),console.log("\u2705 Contacts and unread counts loaded")}catch(e){console.error("\u274c Failed to load inbox data:",e)}}),[]);(0,n.useEffect)((()=>{console.log("\ud83d\udce5 InboxSidebar mounted | currentUserId:",s),y()}),[s]),(0,n.useEffect)((()=>{if(!f)return;const e=e=>{console.log("\ud83d\udd14 [SignalR] UnreadCountChanged:",e),e&&"object"===typeof e&&e.refresh?p():e&&"object"===typeof e&&m(e)};return f.on("UnreadCountChanged",e),()=>f.off("UnreadCountChanged",e)}),[f,p]),(0,n.useEffect)((()=>{if(!f)return;const e=async e=>{var t,s;const n=null!==(t=null!==(s=null===e||void 0===e?void 0:e.contactId)&&void 0!==s?s:null===e||void 0===e?void 0:e.ContactId)&&void 0!==t?t:null;if(!n)return;const o="undefined"!==typeof(null===e||void 0===e?void 0:e.isIncoming)?!!e.isIncoming:null===e||void 0===e||!e.senderId;if(console.log("\ud83d\udce9 [SignalR] Message:",e,"| parsed contactId:",n,"| isIncoming:",o),o)if(String(n)!==String(d)){m((e=>(0,a.A)((0,a.A)({},e||{}),{},{[n]:((null===e||void 0===e?void 0:e[n])||0)+1})));try{v()}catch(l){}}else try{null!==f&&void 0!==f&&f.invoke?(await f.invoke("MarkAsRead",n),console.log("\u2705 MarkAsRead via SignalR for",n)):(await r.default.post("/inbox/mark-read?contactId=".concat(n)),console.log("\u2705 MarkAsRead fallback HTTP for",n))}catch(c){console.error("\u274c Failed to mark as read in active chat:",c)}};return f.on("ReceiveInboxMessage",e),()=>f.off("ReceiveInboxMessage",e)}),[f,d,s,v]),(0,n.useEffect)((()=>{f&&"function"===typeof f.onreconnected&&f.onreconnected((()=>{console.log("\ud83d\udd01 SignalR reconnected \u2014 reloading unread counts"),y()}))}),[f,y]);const b=(Array.isArray(l)?l:[]).filter((e=>(e.name||e.phoneNumber||"").toString().toLowerCase().includes(h.toLowerCase())));return(0,c.jsxs)("div",{className:"flex flex-col h-full",children:[(0,c.jsx)("div",{className:"p-3 border-b",children:(0,c.jsx)("input",{type:"text",placeholder:"Search",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring",value:h,onChange:e=>g(e.target.value)})}),(0,c.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,c.jsx)("div",{className:"text-sm font-semibold text-gray-700 px-4 py-2",children:"Contacts"}),b.map((e=>{const s=String(e.id),n=Number(x[s]||0);return(0,c.jsxs)("div",{onClick:()=>(async e=>{u(e),t(e),m((t=>(0,a.A)((0,a.A)({},t||{}),{},{[e]:0})));try{if(null!==f&&void 0!==f&&f.invoke)return await f.invoke("MarkAsRead",e),void console.log("\u2705 MarkAsRead via SignalR for",e)}catch(s){console.warn("\u26a0\ufe0f SignalR MarkAsRead failed, fallback:",s)}try{await r.default.post("/inbox/mark-read?contactId=".concat(e)),console.log("\u2705 MarkAsRead fallback HTTP for",e)}catch(s){console.error("\u274c Failed to mark as read via HTTP:",s)}})(e.id),className:"flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ".concat(d===e.id?"bg-gray-200":""),children:[(0,c.jsxs)("div",{className:"flex items-center gap-3",children:[(0,c.jsx)("div",{className:"w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white",children:(o=e.name||e.phoneNumber,null===o||void 0===o?void 0:o.split(" ").map((e=>e[0])).join("").substring(0,2).toUpperCase())}),(0,c.jsxs)("div",{className:"flex flex-col",children:[(0,c.jsx)("div",{className:"font-medium text-sm text-gray-800 truncate",children:e.name||e.phoneNumber||"Unknown"}),e.name&&(0,c.jsx)("div",{className:"text-xs text-gray-500",children:e.phoneNumber})]})]}),n>0&&(0,c.jsx)("div",{className:"text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center",children:n})]},e.id);var o}))]})]})}var m=s(60446),h=s.n(m),g=s(60184);function f(e){let{message:t,isOwn:s}=e;const[a,o]=(0,n.useState)(!1),r=(0,n.useRef)(null),[l,i]=(0,n.useState)(!1),d=h()(t.sentAt||t.createdAt).format("h:mm A"),u=t.renderedBody||t.message||t.messageContent||"[no message]";(0,n.useEffect)((()=>{const e=r.current;e&&e.scrollHeight>e.clientHeight+10&&i(!0)}),[]);const x=s?"text-white/70":"text-gray-500";return(0,c.jsx)("div",{className:"flex ".concat(s?"justify-end":"justify-start"," mb-2"),children:(0,c.jsx)("div",{ref:r,onClick:()=>l&&o(!a),className:"".concat("px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap"," ").concat(s?"bg-green-600 text-white rounded-2xl rounded-br-sm":"bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm"," ").concat(a?"cursor-zoom-out":l?"cursor-zoom-in":""),style:{overflow:"hidden",whiteSpace:a?"normal":"pre-wrap"},children:(0,c.jsxs)("div",{className:"flex items-end justify-between gap-2",children:[(0,c.jsx)("span",{className:"flex-1",children:u}),(0,c.jsxs)("span",{className:"text-[11px] flex items-center gap-1 ".concat(x),children:[d,s&&(0,c.jsxs)(c.Fragment,{children:["Sending"===t.status&&(0,c.jsx)(g.w_X,{}),"Failed"===t.status&&(0,c.jsx)(g.TNq,{className:"text-red-400"}),"Sent"===t.status&&(0,c.jsx)(g.CMH,{}),"Delivered"===t.status&&(0,c.jsx)(g.flP,{}),"Read"===t.status&&(0,c.jsx)(g.flP,{className:"text-blue-400"})]})]})]})})})}var v=s(30616),p=s.n(v),y=s(36109),b=s.n(y);function w(){const{messages:e=[],connection:t,selectedContactId:s}=d(),a=(0,n.useRef)(null),o=(0,n.useRef)(null),r=(0,n.useRef)(!0),l=(0,n.useCallback)((()=>{const e=a.current;if(!e)return!0;return e.scrollHeight-(e.scrollTop+e.clientHeight)<=120}),[]),i=(0,n.useCallback)((()=>{r.current=l()}),[l]),u=(0,n.useCallback)((function(){var e;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];null===(e=o.current)||void 0===e||e.scrollIntoView({behavior:t?"smooth":"auto",block:"end"})}),[]);if((0,n.useEffect)((()=>{u(!1),r.current=!0}),[u]),(0,n.useEffect)((()=>{const e=setTimeout((()=>u(!1)),0);return()=>clearTimeout(e)}),[s,u]),(0,n.useEffect)((()=>{r.current&&u(!0)}),[e.length,u]),(0,n.useEffect)((()=>{const e=()=>u(!0);return window.addEventListener("xbc:scrollToBottom",e),()=>window.removeEventListener("xbc:scrollToBottom",e)}),[u]),(0,n.useEffect)((()=>{if(!t||!s)return;const e=setTimeout((()=>{t.invoke("MarkAsRead",s).catch((e=>{console.warn("\u26a0\ufe0f MarkAsRead SignalR call failed:",e)}))}),800);return()=>clearTimeout(e)}),[t,s]),0===e.length)return(0,c.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:"Loading messages\u2026"});const x=e.reduce(((e,t)=>{const s=function(e){const t=h()(e);return t.isToday()?"Today":t.isYesterday()?"Yesterday":t.format("D MMM YYYY")}(t.sentAt||t.createdAt);return(e[s]||(e[s]=[])).push(t),e}),{});return(0,c.jsxs)("div",{ref:a,onScroll:i,className:"p-4 space-y-6 overflow-y-auto h-full",children:[Object.entries(x).map((e=>{let[t,s]=e;return(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{className:"text-center text-xs text-gray-500 mb-2",children:t}),(0,c.jsx)("div",{className:"space-y-1",children:s.map(((e,t)=>(0,c.jsx)(f,{message:e,isOwn:!e.isIncoming},e.id||t)))})]},t)})),(0,c.jsx)("div",{ref:o})]})}h().extend(p()),h().extend(b());var j=s(57922),N=s(72494),S=s(40614),C=s(35746);function k(e){let{onInsert:t,onClose:s,scope:a="All"}=e;const o=(0,n.useRef)(null),l=(0,n.useRef)(null),[i,d]=(0,n.useState)(""),[u,x]=(0,n.useState)([]),[m,h]=(0,n.useState)(!1),[g,f]=(0,n.useState)(-1),[v,p]=(0,n.useState)((()=>a||"All")),y=(0,n.useMemo)((()=>{const e=(v||"All").toString().toLowerCase();return"business"===e||"personal"===e?e:"all"}),[v]),[b,w]=(0,n.useState)(!1),[j,N]=(0,n.useState)(""),[S,C]=(0,n.useState)(""),[k,E]=(0,n.useState)(""),[I,A]=(0,n.useState)("Personal"),[R,M]=(0,n.useState)(!1),[L,T]=(0,n.useState)("");(0,n.useEffect)((()=>{if(b)return;let e=!1;h(!0);const t=setTimeout((()=>{const t={};i&&(t.q=i),y&&(t.scope=y),r.default.get("/quick-replies",{params:t}).then((t=>{e||(x(Array.isArray(t.data)?t.data:[]),f(-1))})).catch((()=>{e||x([])})).finally((()=>!e&&h(!1)))}),200);return()=>{clearTimeout(t),e=!0}}),[i,y,b]),(0,n.useEffect)((()=>{var e;null===(e=l.current)||void 0===e||e.focus()}),[]),(0,n.useEffect)((()=>{const e=e=>{o.current&&(o.current.contains(e.target)||null===s||void 0===s||s())};return document.addEventListener("mousedown",e,{capture:!0}),()=>document.removeEventListener("mousedown",e,{capture:!0})}),[s]);const _=(0,n.useCallback)((e=>{e&&(null===t||void 0===t||t(e))}),[t]);return(0,c.jsxs)("div",{ref:o,className:"w-80 rounded-xl border bg-white shadow-lg p-2",role:"dialog","aria-label":"Quick replies",children:[(0,c.jsx)("div",{className:"flex items-center gap-2 mb-2",children:b?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"text-sm font-medium",children:"New quick reply"}),(0,c.jsx)("div",{className:"flex-1"}),(0,c.jsx)("button",{className:"text-xs text-gray-500 hover:text-gray-700 px-2 py-1",onClick:()=>w(!1),type:"button",children:"Cancel"})]}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("input",{ref:l,className:"flex-1 border rounded-md px-2 py-1 text-sm",placeholder:"Search saved replies\u2026",value:i,onChange:e=>d(e.target.value),onKeyDown:e=>{if("Escape"===e.key)return e.preventDefault(),b?void w(!1):void(null===s||void 0===s||s());if(!b){if("ArrowDown"===e.key)return e.preventDefault(),void f((e=>Math.min(e+1,Math.max(0,u.length-1))));if("ArrowUp"===e.key)return e.preventDefault(),void f((e=>Math.max(e-1,-1)));var t;if("Enter"===e.key)if(g>=0&&g<u.length)e.preventDefault(),_(null===(t=u[g])||void 0===t?void 0:t.body),null===s||void 0===s||s()}}}),(0,c.jsx)("button",{className:"text-xs px-2 py-1 border rounded-md bg-white hover:bg-gray-50",onClick:()=>w(!0),type:"button",title:"Create a new quick reply",children:"New"}),(0,c.jsx)("button",{className:"text-xs text-gray-500 hover:text-gray-700 px-2 py-1",onClick:()=>null===s||void 0===s?void 0:s(),type:"button",children:"Close"})]})}),b?(0,c.jsxs)("div",{className:"space-y-2",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2",children:[(0,c.jsx)("label",{className:"text-xs text-gray-600 w-16",children:"Scope"}),(0,c.jsx)("div",{className:"flex items-center gap-2",children:["Personal","Business"].map((e=>(0,c.jsxs)("label",{className:"text-xs flex items-center gap-1",children:[(0,c.jsx)("input",{type:"radio",name:"qr-scope",value:e,checked:I===e,onChange:()=>A(e)}),e]},e)))})]}),(0,c.jsxs)("div",{className:"flex items-center gap-2",children:[(0,c.jsx)("label",{className:"text-xs text-gray-600 w-16",children:"Title"}),(0,c.jsx)("input",{className:"flex-1 border rounded-md px-2 py-1 text-sm",value:j,onChange:e=>N(e.target.value),placeholder:"e.g., Greeting (EN)"})]}),(0,c.jsxs)("div",{className:"flex items-start gap-2",children:[(0,c.jsx)("label",{className:"text-xs text-gray-600 w-16 mt-1",children:"Body"}),(0,c.jsx)("textarea",{className:"flex-1 border rounded-md px-2 py-1 text-sm h-24",value:S,onChange:e=>C(e.target.value),placeholder:"Type the message\u2026"})]}),(0,c.jsxs)("div",{className:"flex items-center gap-2",children:[(0,c.jsx)("label",{className:"text-xs text-gray-600 w-16",children:"Tags"}),(0,c.jsx)("input",{className:"flex-1 border rounded-md px-2 py-1 text-sm",value:k,onChange:e=>E(e.target.value),placeholder:"e.g., greeting,eng"})]}),L&&(0,c.jsx)("div",{className:"text-xs px-2 py-1 rounded-md bg-gray-50 border",children:L}),(0,c.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,c.jsx)("button",{className:"text-xs px-3 py-1 rounded-md border bg-white hover:bg-gray-50",onClick:()=>w(!1),type:"button",disabled:R,children:"Cancel"}),(0,c.jsx)("button",{className:"text-xs px-3 py-1 rounded-md text-white bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300",onClick:async()=>{if(T(""),j.trim()&&S.trim()){M(!0);try{var e,t;const s={title:j.trim(),body:S,tagsCsv:k.trim()||null,scope:"Business"===I?2:0},n=await r.default.post("/quick-replies",s),a=!0===(null===n||void 0===n||null===(e=n.data)||void 0===e?void 0:e.success);T(a?"\u2705 Saved.":(null===n||void 0===n||null===(t=n.data)||void 0===t?void 0:t.message)||"\u274c Failed to save."),a&&(N(""),C(""),E(""),w(!1),p(I),d(""))}catch(s){T("\u274c Failed to save.")}finally{M(!1)}}else T("Title and Body are required.")},type:"button",disabled:R,children:R?"Saving\u2026":"Save"})]})]}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"flex items-center gap-1 mb-2 px-1",children:["All","Business","Personal"].map((e=>(0,c.jsx)("button",{type:"button",onClick:()=>p(e),className:"px-2 py-0.5 text-xs rounded-full border ".concat(v===e?"bg-gray-200":"bg-white hover:bg-gray-100"),children:e},e)))}),(0,c.jsxs)("div",{className:"max-h-64 overflow-y-auto",children:[m&&(0,c.jsx)("div",{className:"text-xs text-gray-500 p-2",children:"Loading\u2026"}),!m&&0===u.length&&(0,c.jsx)("div",{className:"text-xs text-gray-500 p-2",children:"No results"}),!m&&u.map(((e,t)=>{const n=t===g;return(0,c.jsxs)("button",{type:"button",className:"w-full text-left p-2 rounded-md ".concat(n?"bg-gray-200":"hover:bg-gray-100"),onMouseEnter:()=>f(t),onClick:()=>{_(e.body),null===s||void 0===s||s()},title:e.tagsCsv||"",children:[(0,c.jsx)("div",{className:"text-sm font-medium text-gray-800",children:e.title}),(0,c.jsx)("div",{className:"text-xs text-gray-600 line-clamp-2",children:e.body}),e.language&&(0,c.jsxs)("div",{className:"text-[10px] text-gray-400 mt-1",children:["Lang: ",e.language]})]},e.id)}))]}),(0,c.jsxs)("div",{className:"flex items-center justify-between mt-2 px-1",children:[(0,c.jsxs)("div",{className:"text-[10px] text-gray-400",children:["Scope: ",(0,c.jsx)("span",{className:"uppercase",children:y})]}),(0,c.jsx)("div",{className:"text-[10px] text-gray-400",children:"\u2191/\u2193 navigate \u2022 Enter insert \u2022 Esc close"})]})]})]})}const E=[["\ud83d\ude00","grinning"],["\ud83d\ude01","beaming"],["\ud83d\ude02","joy"],["\ud83e\udd23","rofl"],["\ud83d\ude0a","smile"],["\ud83d\ude42","slight_smile"],["\ud83d\ude09","wink"],["\ud83d\ude0d","heart_eyes"],["\ud83d\ude18","kiss"],["\ud83d\ude0b","yum"],["\ud83d\ude0e","cool"],["\ud83e\udd29","star_struck"],["\ud83e\udd73","partying"],["\ud83d\ude07","innocent"],["\ud83e\udd17","hug"],["\ud83d\ude05","sweat_smile"],["\ud83d\ude0c","relieved"],["\ud83d\ude34","sleep"],["\ud83e\udd14","think"],["\ud83e\udd28","doubt"],["\ud83d\ude10","neutral"],["\ud83d\ude2e","open_mouth"],["\ud83d\ude22","cry"],["\ud83d\ude2d","sob"],["\ud83d\ude21","angry"],["\ud83d\ude31","scream"],["\ud83e\udd2f","mind_blown"],["\ud83e\udd12","sick"],["\ud83e\udd15","injured"],["\ud83e\udd27","sneeze"],["\ud83e\udd76","cold"],["\ud83e\udd75","hot"],["\ud83d\udc4d","thumbs_up"],["\ud83d\udc4e","thumbs_down"],["\ud83d\ude4f","pray"],["\ud83d\udc4f","clap"],["\ud83d\ude4c","raised_hands"],["\ud83e\udd1d","handshake"],["\ud83d\udcaa","muscle"],["\ud83e\udef6","heart_hands"],["\u2764\ufe0f","red_heart"],["\ud83d\udc9b","yellow_heart"],["\ud83d\udc9a","green_heart"],["\ud83d\udc99","blue_heart"],["\ud83d\udc9c","purple_heart"],["\ud83d\udda4","black_heart"],["\ud83d\udc94","broken_heart"],["\u2728","sparkles"],["\ud83d\udd25","fire"],["\u2b50","star"],["\u2705","check"],["\u274c","cross"],["\u26a0\ufe0f","warning"],["\u23f3","hourglass"],["\ud83d\udccc","pin"],["\ud83d\udccd","round_pushpin"],["\ud83d\udcc5","calendar"],["\ud83d\udecd\ufe0f","shopping"],["\ud83d\udcb0","money"],["\ud83c\udf89","tada"],["\ud83c\udf8a","confetti"],["\ud83d\udcac","speech"],["\u2709\ufe0f","envelope"],["\ud83d\udcf1","phone"],["\ud83d\udcde","telephone"],["\u23f0","alarm"],["\u231b","timer"],["\ud83e\uddfe","receipt"],["\ud83e\uddf0","tools"],["\ud83e\udde0","brain"]].map((e=>{let[t,s]=e;return{char:t,name:s}}));function I(e){let{onPick:t,onClose:s}=e;const a=(0,n.useRef)(null),[o,r]=(0,n.useState)("");(0,n.useEffect)((()=>{const e=e=>{a.current&&(a.current.contains(e.target)||null===s||void 0===s||s())};return document.addEventListener("mousedown",e,{capture:!0}),()=>document.removeEventListener("mousedown",e,{capture:!0})}),[s]);const l=(0,n.useMemo)((()=>{const e=o.trim().toLowerCase();return e?E.filter((t=>t.char.includes(e)||t.name.includes(e))):E}),[o]);return(0,c.jsxs)("div",{ref:a,className:"w-80 rounded-xl border bg-white shadow-lg p-2",role:"dialog","aria-label":"Emoji picker",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,c.jsx)("input",{autoFocus:!0,className:"flex-1 border rounded-md px-2 py-1 text-sm",placeholder:"Search emoji\u2026",value:o,onChange:e=>r(e.target.value),onKeyDown:e=>{"Escape"===e.key&&(null===s||void 0===s||s())}}),(0,c.jsx)("button",{className:"text-xs text-gray-500 hover:text-gray-700 px-2 py-1",onClick:()=>null===s||void 0===s?void 0:s(),type:"button",children:"Close"})]}),(0,c.jsx)("div",{className:"grid grid-cols-10 gap-1 overflow-y-hidden",children:l.map((e=>(0,c.jsx)("button",{type:"button",className:"h-7 w-7 flex items-center justify-center rounded hover:bg-gray-100",title:e.name.replace(/_/g," "),onClick:()=>null===t||void 0===t?void 0:t(e.char),children:(0,c.jsx)("span",{className:"text-lg",children:e.char})},e.char+e.name)))})]})}function A(){const{newMessage:e,setNewMessage:t,sendMessage:s,isConnected:a}=d(),[o,r]=(0,n.useState)(!1),[l,i]=(0,n.useState)(!1),u=(0,n.useRef)(null),x=()=>{a&&null!==e&&void 0!==e&&e.trim()&&(r(!1),i(!1),s(),window.dispatchEvent(new CustomEvent("xbc:scrollToBottom")))},m=(0,n.useCallback)((s=>{var n,a,o,r;const l=u.current;if(!l)return void t((e=>e?"".concat(e," ").concat(s):s));const c=null!==(n=null!==(a=l.selectionStart)&&void 0!==a?a:null===e||void 0===e?void 0:e.length)&&void 0!==n?n:0,i=null!==(o=null!==(r=l.selectionEnd)&&void 0!==r?r:null===e||void 0===e?void 0:e.length)&&void 0!==o?o:0,d=null!==e&&void 0!==e?e:"",x=d.slice(0,c)+s+d.slice(i);t(x),requestAnimationFrame((()=>{l.focus();const e=c+s.length;l.setSelectionRange(e,e)}))}),[e,t]),h=(0,n.useCallback)((()=>{const e=u.current;if(!e)return;e.style.height="auto";e.style.height=Math.min(e.scrollHeight,160)+"px"}),[]);return(0,n.useEffect)((()=>{h()}),[e,h]),(0,c.jsx)("div",{className:"p-3 border-t bg-white overflow-visible",children:(0,c.jsxs)("div",{className:"flex items-center gap-2",children:[(0,c.jsxs)("div",{className:"relative",children:[(0,c.jsx)("button",{type:"button",onClick:()=>r((e=>!e)),className:"h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50",title:"Saved replies",disabled:!a,"aria-expanded":o,children:"Quick Reply"}),o&&(0,c.jsx)("div",{className:"absolute left-0 bottom-full mb-2 z-[100]",children:(0,c.jsx)(k,{onInsert:e=>{m(e),r(!1)},onClose:()=>r(!1)})})]}),(0,c.jsxs)("div",{className:"relative",children:[(0,c.jsx)("button",{type:"button",className:"h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100",title:"Emoji",disabled:!a,"aria-expanded":l,onClick:()=>i((e=>!e)),children:(0,c.jsx)(j.A,{size:16})}),l&&(0,c.jsx)("div",{className:"absolute left-0 bottom-full mb-2 z-[100]",children:(0,c.jsx)(I,{onPick:e=>{m(e),i(!1)},onClose:()=>i(!1)})})]}),(0,c.jsx)("button",{className:"h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100",title:"Attach",disabled:!0,children:(0,c.jsx)(N.A,{size:16})}),(0,c.jsxs)("div",{className:"relative flex-1",children:[(0,c.jsx)("textarea",{ref:u,rows:1,value:e,onChange:e=>t(e.target.value),onKeyDown:e=>"/"!==e.key||o?"Escape"===e.key&&(o||l)?(e.preventDefault(),r(!1),void i(!1)):void("Enter"!==e.key||e.shiftKey||(e.preventDefault(),x())):(e.preventDefault(),void r(!0)),onInput:h,disabled:!a,placeholder:a?"Type your message\u2026 (Enter to send \u2022 Shift+Enter for new line)":"Connecting...",className:"w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed"}),!!(e||"").length&&(0,c.jsx)("button",{type:"button",onClick:()=>t(""),title:"Clear","aria-label":"Clear message",className:"absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500",children:(0,c.jsx)(S.A,{size:16})})]}),(0,c.jsx)("button",{onClick:x,disabled:!a||!(null!==e&&void 0!==e&&e.trim()),className:"h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed",title:"Send",children:(0,c.jsx)(C.A,{size:16})})]})})}var R=s(57856),M=s(76996),L=s(8092),T=s.n(L);function _(e){let{contactId:t}=e;const[s,a]=(0,n.useState)(null),[o,l]=(0,n.useState)(""),[i,d]=(0,n.useState)("details");(0,n.useEffect)((()=>{console.log("[ContactSidebar] Rendered with contactId:",t)}),[t]),(0,n.useEffect)((()=>{if(!t)return void console.warn("[ContactSidebar] No contactId provided");(async()=>{try{var e;console.log("[ContactSidebar] Fetching contact:",t);const s=await r.default.get("/contacts/".concat(t));console.log("[ContactSidebar] API response:",s),null!==s&&void 0!==s&&null!==(e=s.data)&&void 0!==e&&e.data?(a(s.data.data),console.log("[ContactSidebar] Set contact with res.data.data")):null!==s&&void 0!==s&&s.data?(a(s.data),console.log("[ContactSidebar] Set contact with res.data")):(a(s),console.log("[ContactSidebar] Set contact with res"))}catch(s){console.error("\u274c [ContactSidebar] Failed to load contact:",s)}})()}),[t]);if((0,n.useEffect)((()=>{console.log("[ContactSidebar] Current contact state:",s)}),[s]),!s)return(0,c.jsx)("div",{className:"p-4 text-gray-500",children:"Loading..."});const{createdAt:u,tags:x=[],notes:m=[],list:g="Default",chatWindowStatus:f="Open",sessionStatus:v="Active"}=s;return(0,c.jsxs)("div",{className:"p-4 text-sm overflow-y-auto",style:{height:"100%",maxHeight:"100%"},children:[(0,c.jsxs)("div",{className:"flex mb-4 border rounded-md overflow-hidden text-sm",children:[(0,c.jsxs)("button",{onClick:()=>d("details"),className:"flex-1 px-3 py-2 flex items-center justify-center gap-1 ".concat("details"===i?"bg-gray-200 font-semibold":"bg-gray-100 hover:bg-gray-200"),children:[(0,c.jsx)(R.A,{size:14})," Details"]}),(0,c.jsxs)("button",{onClick:()=>d("notes"),className:"flex-1 px-3 py-2 flex items-center justify-center gap-1 ".concat("notes"===i?"bg-gray-200 font-semibold":"bg-gray-100 hover:bg-gray-200"),children:[(0,c.jsx)(M.A,{size:14})," Notes"]})]}),"details"===i&&(0,c.jsxs)("div",{className:"space-y-4",children:[(0,c.jsxs)("div",{className:"bg-gray-50 border rounded-md p-3",children:[(0,c.jsx)("h4",{className:"text-xs font-semibold text-gray-700 mb-1",children:"Conversation"}),(0,c.jsxs)("div",{className:"flex justify-between text-xs text-gray-600",children:[(0,c.jsx)("span",{children:"24-hour window:"}),(0,c.jsx)("span",{className:"text-green-600 font-medium",children:f})]}),(0,c.jsxs)("div",{className:"flex justify-between text-xs text-gray-600",children:[(0,c.jsx)("span",{children:"Chat session:"}),(0,c.jsx)("span",{className:"text-green-600 font-medium",children:v})]}),(0,c.jsxs)("div",{className:"flex justify-between text-xs text-gray-600",children:[(0,c.jsx)("span",{children:"Window ends:"}),(0,c.jsx)("span",{children:"\u2014"})]})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("h4",{className:"text-xs font-semibold text-gray-700 mb-1",children:"Contact data"}),(0,c.jsxs)("div",{className:"text-xs text-gray-600",children:["Created: ",null===u||void 0===u?void 0:u.slice(0,10)]}),(0,c.jsxs)("div",{className:"text-xs text-gray-600",children:["List: ",g]})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("h4",{className:"text-xs font-semibold text-gray-700 mb-1",children:"Tags"}),0===x.length?(0,c.jsx)("div",{className:"text-gray-400 italic text-xs",children:"No tags"}):(0,c.jsx)("div",{className:"flex flex-wrap gap-2",children:x.map((e=>(0,c.jsx)("span",{className:"text-xs font-medium px-2 py-1 rounded-full",style:{backgroundColor:e.colorHex||"#999",color:e.colorHex&&"#ffffe0"===e.colorHex.toLowerCase()?"#000":"#fff"},children:e.name},e.id)))})]})]}),"notes"===i&&(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsxs)("div",{className:"flex gap-2",children:[(0,c.jsx)("input",{className:"flex-1 px-2 py-1 text-xs border rounded-md",placeholder:"Add note...",value:o,onChange:e=>l(e.target.value)}),(0,c.jsx)("button",{onClick:async()=>{if(o.trim())try{var e;console.log("[ContactSidebar] Adding note for contactId:",t,o),await r.default.post("/notes",{contactId:t,content:o}),l("");const s=await r.default.get("/contacts/".concat(t));null!==s&&void 0!==s&&null!==(e=s.data)&&void 0!==e&&e.data?a(s.data.data):null!==s&&void 0!==s&&s.data?a(s.data):a(s)}catch(s){console.error("\u274c [ContactSidebar] Failed to add note:",s)}},className:"bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700",children:"Add"})]}),Array.isArray(m)&&m.length>0?(0,c.jsx)("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:m.map((e=>(0,c.jsxs)("div",{className:"text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1",children:[(0,c.jsx)("div",{children:e.content}),(0,c.jsx)("div",{className:"text-[10px] text-gray-400 mt-1",children:h()(e.createdAt).fromNow()})]},e.id)))}):(0,c.jsx)("div",{className:"text-gray-400 italic text-xs",children:"No notes yet"})]})]})}function F(e){let{contactId:t}=e;const[s,a]=(0,n.useState)(null);if((0,n.useEffect)((()=>{if(!t)return void a(null);(async()=>{try{var e;const s=await r.default.get("/contacts/".concat(t));null!==s&&void 0!==s&&null!==(e=s.data)&&void 0!==e&&e.data?a(s.data.data):null!==s&&void 0!==s&&s.data?a(s.data):a(s)}catch(s){console.error("\u274c [ChatHeader] Failed to load contact:",s)}})()}),[t]),!s)return null;const{name:o,phoneNumber:l}=s,i=(null===o||void 0===o?void 0:o.split(" ").map((e=>e.charAt(0).toUpperCase())).slice(0,2).join(""))||(null===l||void 0===l?void 0:l.slice(-2))||"??",d=o||l||"Unknown Contact";return(0,c.jsx)("div",{className:"bg-white border-b shadow-sm px-4 py-3 flex items-center justify-between",children:(0,c.jsxs)("div",{className:"flex items-center gap-4",children:[(0,c.jsx)("div",{className:"w-10 h-10 rounded-full bg-green-600 text-white font-semibold text-sm flex items-center justify-center shadow-sm",children:i}),(0,c.jsxs)("div",{className:"space-y-0.5",children:[(0,c.jsx)("h2",{className:"text-base font-semibold text-gray-800",children:d}),o&&l&&(0,c.jsx)("div",{className:"text-xs text-gray-500",children:l})]})]})})}h().extend(T());var D=s(19233),z=s(38326),U=s(9463);function Y(){const{selectedContactId:e,setSelectedContactId:t,currentUserId:s,playSound:a,toggleSound:o}=d(),[r,l]=(0,n.useState)(!0);return(0,n.useEffect)((()=>{const e=document.body.style.overflow,t=document.documentElement.style.overflow;return document.body.classList.add("inbox-active"),document.documentElement.classList.add("inbox-active"),document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",()=>{document.body.classList.remove("inbox-active"),document.documentElement.classList.remove("inbox-active"),document.body.style.overflow=e,document.documentElement.style.overflow=t}}),[]),(0,c.jsxs)("div",{className:"inbox-fullscreen h-screen flex flex-col overflow-hidden",children:[(0,c.jsxs)("header",{className:"h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 text-purple-600 font-semibold text-base",children:[(0,c.jsx)("span",{className:"text-xl",children:"\ud83d\udce8"}),"Inbox"]}),(0,c.jsx)("div",{className:"flex items-center gap-4",children:(0,c.jsxs)("button",{onClick:o,className:"text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ".concat(a?"bg-green-100 text-green-600 border-green-300":"bg-gray-100 text-gray-500 border-gray-300"),children:[(0,c.jsx)(D.A,{size:14})," ",a?"Sound ON":"Sound OFF"]})})]}),(0,c.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,c.jsx)("div",{className:"bg-white border-r overflow-y-auto",style:{width:"288px",minWidth:"288px",maxWidth:"288px",height:"100%"},children:(0,c.jsx)(x,{onSelect:e=>t(e),currentUserId:s})}),(0,c.jsxs)("div",{className:"flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative",children:[(0,c.jsx)("button",{className:"absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600",onClick:()=>l(!r),title:r?"Hide contact info":"Show contact info",children:r?(0,c.jsx)(z.A,{size:16}):(0,c.jsx)(U.A,{size:16})}),e?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"shrink-0",children:(0,c.jsx)(F,{contactId:e})}),(0,c.jsx)("div",{className:"flex-1 overflow-hidden",children:(0,c.jsx)(w,{})}),(0,c.jsx)("div",{className:"shrink-0",style:{flexShrink:0},children:(0,c.jsx)(A,{})})]}):(0,c.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:"Please select a contact to start chatting."})]}),r&&e&&(0,c.jsx)("div",{className:"w-80 border-l bg-white overflow-y-auto",style:{height:"100%",maxHeight:"100%"},children:(0,c.jsx)(_,{contactId:e})})]})]})}function H(){return(0,c.jsx)(u,{children:(0,c.jsx)(Y,{})})}}}]);
//# sourceMappingURL=640.44b1a4ac.chunk.js.map