{"version":3,"file":"static/js/797.1e8076d1.chunk.js","mappings":"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","sources":["hooks/useSignalR.js","../node_modules/lucide-react/src/icons/mail.ts","pages/ChatInbox/api/chatInboxApi.js","pages/ChatInbox/utils/messageMapping.js","pages/ChatInbox/utils/dateUtils.js","pages/ChatInbox/utils/formatters.js","pages/ChatInbox/utils/parseConversationStatus.js","pages/ChatInbox/hooks/useChatInboxController.js","pages/ChatInbox/hooks/useInboxSignalR.js","pages/ChatInbox/components/modals/ConfirmDialog.jsx","pages/ChatInbox/components/modals/InboxAddTagModal.jsx","pages/ChatInbox/components/ConversationRow.jsx","pages/ChatInbox/components/LeftPanel.jsx","pages/ChatInbox/components/shared/StatusIcon.jsx","../node_modules/lucide-react/src/icons/circle-help.ts","pages/ChatInbox/components/QuickReplyPicker.jsx","pages/ChatInbox/components/ComposerTabs.jsx","pages/ChatInbox/components/EmojiPicker.jsx","pages/ChatInbox/components/MiddlePanel.jsx","pages/ChatInbox/components/RightPanel.jsx","pages/ChatInbox/components/ChatInboxView.jsx","pages/ChatInbox/ChatInbox.jsx"],"sourcesContent":["//  src/hooks/useSignalR.js\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport * as signalR from \"@microsoft/signalr\";\r\nimport { toast } from \"react-toastify\";\r\nimport { TOKEN_KEY } from \"../api/axiosClient\"; // single source of truth\r\n\r\nconst REALTIME_TOAST_ID = \"signalr-realtime-failed\";\r\n\r\nfunction getHubUrl() {\r\n  const raw =\r\n    (process.env.REACT_APP_API_BASE_URL &&\r\n      process.env.REACT_APP_API_BASE_URL.trim()) ||\r\n    \"http://localhost:7113/api\";\r\n\r\n  const base = raw.replace(/\\/+$/, \"\");\r\n  return `${base}/hubs/inbox`; // => .../api/hubs/inbox\r\n}\r\n\r\nfunction isIgnorableSignalRError(err) {\r\n  const name = String(err?.name || \"\");\r\n  const msg = String(err?.message || err || \"\").toLowerCase();\r\n\r\n  return (\r\n    name === \"AbortError\" ||\r\n    msg.includes(\"stopped during negotiation\") ||\r\n    msg.includes(\"abort\") ||\r\n    msg.includes(\"canceled\") ||\r\n    msg.includes(\"cancelled\")\r\n  );\r\n}\r\n\r\nexport default function useSignalR({\r\n  onMessageReceived,\r\n  onUnreadChanged,\r\n} = {}) {\r\n  const [connection, setConnection] = useState(null);\r\n  const [isConnected, setIsConnected] = useState(false);\r\n\r\n  const connRef = useRef(null);\r\n  const mountedRef = useRef(false);\r\n  const startingRef = useRef(false);\r\n\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n\r\n    const hubUrl = getHubUrl();\r\n    const token = localStorage.getItem(TOKEN_KEY);\r\n\r\n    if (!token) {\r\n      console.warn(\"SignalR skipped: No auth token found.\");\r\n      setIsConnected(false);\r\n      return () => {\r\n        mountedRef.current = false;\r\n      };\r\n    }\r\n\r\n    //  Build connection\r\n    // Append SA business context if selected\r\n    let finalUrl = hubUrl;\r\n    const saBizId = localStorage.getItem(\"sa_selectedBusinessId\");\r\n    if (saBizId) {\r\n      finalUrl += `?bizId=${encodeURIComponent(saBizId)}`;\r\n    }\r\n\r\n    const conn = new signalR.HubConnectionBuilder()\r\n      .withUrl(finalUrl, {\r\n        accessTokenFactory: () => localStorage.getItem(TOKEN_KEY) || \"\",\r\n        transport:\r\n          signalR.HttpTransportType.WebSockets |\r\n          signalR.HttpTransportType.LongPolling,\r\n      })\r\n      .withAutomaticReconnect([0, 2000, 5000, 10000])\r\n      .configureLogging(signalR.LogLevel.Information)\r\n      .build();\r\n\r\n    connRef.current = conn;\r\n    setConnection(conn);\r\n\r\n    //  Subscribe before start\r\n    if (onMessageReceived) conn.on(\"ReceiveInboxMessage\", onMessageReceived);\r\n    if (onUnreadChanged) conn.on(\"UnreadCountChanged\", onUnreadChanged);\r\n\r\n    conn.onreconnecting(() => {\r\n      if (!mountedRef.current) return;\r\n      setIsConnected(false);\r\n    });\r\n\r\n    conn.onreconnected(() => {\r\n      if (!mountedRef.current) return;\r\n      setIsConnected(true);\r\n      toast.dismiss(REALTIME_TOAST_ID);\r\n    });\r\n\r\n    conn.onclose(err => {\r\n      if (!mountedRef.current) return;\r\n      setIsConnected(false);\r\n\r\n      // Ignore dev-mode abort noise\r\n      if (isIgnorableSignalRError(err)) return;\r\n\r\n      //  Only ONE toast ever\r\n      toast.error(\"Real-time connection failed.\", {\r\n        toastId: REALTIME_TOAST_ID,\r\n      });\r\n    });\r\n\r\n    const start = async () => {\r\n      if (startingRef.current) return;\r\n      startingRef.current = true;\r\n\r\n      try {\r\n        await conn.start();\r\n        if (!mountedRef.current) return;\r\n\r\n        setIsConnected(true);\r\n        toast.dismiss(REALTIME_TOAST_ID);\r\n        // console.log(\" SignalR connected:\", hubUrl);\r\n        console.log(\" SignalR connected:\", finalUrl);\r\n      } catch (err) {\r\n        if (!mountedRef.current) return;\r\n\r\n        // Ignore dev-mode abort noise\r\n        if (isIgnorableSignalRError(err)) return;\r\n\r\n        setIsConnected(false);\r\n\r\n        const msg = String(err?.message || err || \"\").toLowerCase();\r\n        if (msg.includes(\"401\") || msg.includes(\"unauthorized\")) {\r\n          toast.error(\"SignalR unauthorized. Your session may have expired.\", {\r\n            toastId: REALTIME_TOAST_ID,\r\n          });\r\n        } else {\r\n          toast.error(\"Real-time connection failed.\", {\r\n            toastId: REALTIME_TOAST_ID,\r\n          });\r\n        }\r\n\r\n        console.error(\" SignalR start failed:\", err);\r\n      } finally {\r\n        startingRef.current = false;\r\n      }\r\n    };\r\n\r\n    start();\r\n\r\n    return () => {\r\n      mountedRef.current = false;\r\n\r\n      try {\r\n        if (onMessageReceived)\r\n          conn.off(\"ReceiveInboxMessage\", onMessageReceived);\r\n        if (onUnreadChanged) conn.off(\"UnreadCountChanged\", onUnreadChanged);\r\n      } catch {\r\n        // ignore\r\n      }\r\n\r\n      if (conn && conn.state !== signalR.HubConnectionState.Disconnected) {\r\n        conn.stop().catch(() => {});\r\n      }\r\n    };\r\n  }, [onMessageReceived, onUnreadChanged]);\r\n\r\n  return { connection, isConnected };\r\n}\r\n","import createLucideIcon from '../createLucideIcon';\nimport { IconNode } from '../types';\n\nexport const __iconNode: IconNode = [\n  ['rect', { width: '20', height: '16', x: '2', y: '4', rx: '2', key: '18n3k1' }],\n  ['path', { d: 'm22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7', key: '1ocrg3' }],\n];\n\n/**\n * @component @name Mail\n * @description Lucide SVG icon component, renders SVG Element with children.\n *\n * @preview ![img](data:image/svg+xml;base64,PHN2ZyAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogIHdpZHRoPSIyNCIKICBoZWlnaHQ9IjI0IgogIHZpZXdCb3g9IjAgMCAyNCAyNCIKICBmaWxsPSJub25lIgogIHN0cm9rZT0iIzAwMCIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDJweCIKICBzdHJva2Utd2lkdGg9IjIiCiAgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIgogIHN0cm9rZS1saW5lam9pbj0icm91bmQiCj4KICA8cmVjdCB3aWR0aD0iMjAiIGhlaWdodD0iMTYiIHg9IjIiIHk9IjQiIHJ4PSIyIiAvPgogIDxwYXRoIGQ9Im0yMiA3LTguOTcgNS43YTEuOTQgMS45NCAwIDAgMS0yLjA2IDBMMiA3IiAvPgo8L3N2Zz4K) - https://lucide.dev/icons/mail\n * @see https://lucide.dev/guide/packages/lucide-react - Documentation\n *\n * @param {Object} props - Lucide icons props and any valid SVG attribute\n * @returns {JSX.Element} JSX Element\n *\n */\nconst Mail = createLucideIcon('mail', __iconNode);\n\nexport default Mail;\n","import axiosClient from \"../../../api/axiosClient\";\n\nexport default axiosClient;\n\n","/**\n *  Fix #1: Tolerant inbound detection\n */\nexport function inferIsInboundFromAny(obj) {\n  if (!obj) return false;\n\n  const rawInbound =\n    obj.isInbound ??\n    obj.IsInbound ??\n    obj.isIncoming ??\n    obj.IsIncoming ??\n    obj.inbound ??\n    obj.Inbound ??\n    null;\n\n  if (typeof rawInbound === \"boolean\") return rawInbound;\n\n  if (typeof rawInbound === \"string\") {\n    const v = rawInbound.toLowerCase().trim();\n    if (v === \"true\") return true;\n    if (v === \"false\") return false;\n  }\n\n  const directionRaw =\n    obj.direction ??\n    obj.Direction ??\n    obj.dir ??\n    obj.messageDirection ??\n    obj.messageDir ??\n    obj.DirectionType ??\n    \"\";\n\n  const statusRaw = obj.status ?? obj.deliveryStatus ?? \"\";\n\n  const dir = String(directionRaw).toLowerCase().trim();\n  const status = String(statusRaw).toLowerCase().trim();\n\n  return (\n    dir === \"in\" ||\n    dir === \"inbound\" ||\n    dir === \"incoming\" ||\n    dir === \"received\" ||\n    dir === \"customer\" ||\n    dir === \"from\" ||\n    dir.startsWith(\"in\") ||\n    status === \"received\" ||\n    status === \"incoming\"\n  );\n}\n\n//  Map hub payload  ChatInbox message shape (SignalR)\n//  Map hub payload  ChatInbox message shape (SignalR)\nexport function mapHubMessageToChat(msg) {\n  if (!msg) return null;\n\n  const providerMessageId =\n    msg.providerMessageId ?? msg.ProviderMessageId ?? null;\n\n  const messageLogId =\n    msg.messageLogId ?? msg.MessageLogId ?? msg.messageLogID ?? null;\n\n  const messageId =\n    msg.messageId ??\n    msg.MessageId ??\n    msg.wamid ??\n    msg.Wamid ??\n    msg.waMessageId ??\n    msg.WaMessageId ??\n    msg.providerMessageId ??\n    msg.ProviderMessageId ??\n    null;\n\n  const clientMessageId =\n    msg.clientMessageId ?? msg.ClientMessageId ?? msg.clientId ?? null;\n\n  const id =\n    msg.id ??\n    msg.Id ??\n    messageLogId ??\n    messageId ??\n    clientMessageId ??\n    `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n\n  const text =\n    msg.text ??\n    msg.message ??\n    msg.body ??\n    msg.content ??\n    msg.messageText ??\n    msg.MessageText ??\n    msg.messageContent ??\n    msg.MessageContent ??\n    msg.renderedBody ??\n    msg.RenderedBody ??\n    \"\";\n\n  let mediaId = msg.mediaId ?? msg.MediaId ?? null;\n  let mediaType = msg.mediaType ?? msg.MediaType ?? null;\n  const fileName = msg.fileName ?? msg.FileName ?? null;\n  const mimeType = msg.mimeType ?? msg.MimeType ?? null;\n  let locationLatitude =\n    msg.locationLatitude ?? msg.LocationLatitude ?? msg.latitude ?? null;\n  let locationLongitude =\n    msg.locationLongitude ?? msg.LocationLongitude ?? msg.longitude ?? null;\n  let locationName = msg.locationName ?? msg.LocationName ?? msg.name ?? null;\n  let locationAddress =\n    msg.locationAddress ?? msg.LocationAddress ?? msg.address ?? null;\n\n  const typeFallback =\n    msg.type ?? msg.Type ?? msg.messageType ?? msg.MessageType ?? null;\n\n  if (!mediaType && typeFallback) mediaType = typeFallback;\n  if (!mediaType) {\n    if (msg.image || msg.Image) mediaType = \"image\";\n    else if (msg.video || msg.Video) mediaType = \"video\";\n    else if (msg.audio || msg.Audio) mediaType = \"audio\";\n    else if (msg.document || msg.Document) mediaType = \"document\";\n    else if (msg.location || msg.Location) mediaType = \"location\";\n  }\n  if (typeof mediaType === \"string\") mediaType = mediaType.toLowerCase().trim();\n\n  const nested =\n    mediaType === \"image\"\n      ? msg.image ?? msg.Image ?? null\n      : mediaType === \"video\"\n        ? msg.video ?? msg.Video ?? null\n        : mediaType === \"audio\"\n          ? msg.audio ?? msg.Audio ?? null\n          : mediaType === \"document\"\n            ? msg.document ?? msg.Document ?? null\n            : mediaType === \"location\"\n              ? msg.location ?? msg.Location ?? null\n              : null;\n\n  if (!mediaId && nested && typeof nested === \"object\") {\n    mediaId = nested.id ?? nested.mediaId ?? null;\n  }\n\n  if (mediaType === \"location\" && nested && typeof nested === \"object\") {\n    locationLatitude =\n      locationLatitude ?? nested.latitude ?? nested.Latitude ?? null;\n    locationLongitude =\n      locationLongitude ?? nested.longitude ?? nested.Longitude ?? null;\n    locationName = locationName ?? nested.name ?? nested.Name ?? null;\n    locationAddress =\n      locationAddress ?? nested.address ?? nested.Address ?? null;\n  }\n\n  const isInbound = inferIsInboundFromAny(msg);\n\n  const directionRaw = msg.direction ?? msg.Direction ?? msg.dir ?? \"\";\n  const status = msg.status ?? msg.deliveryStatus ?? msg.Status ?? \"\";\n\n  const createdAt =\n    msg.createdAt ??\n    msg.sentAt ??\n    msg.sentAtUtc ??\n    msg.timestamp ??\n    new Date().toISOString();\n\n  return {\n    id,\n    providerMessageId,\n    messageLogId: messageLogId ?? null,\n    serverId: messageLogId ?? null,\n    messageId, //  WhatsApp WAMID (best for reconciliation)\n    clientMessageId, //  temp id (best for optimistic reconciliation)\n    direction: directionRaw || (isInbound ? \"in\" : \"out\"),\n    isInbound,\n    text,\n    mediaId,\n    mediaType,\n    fileName,\n    mimeType,\n    locationLatitude,\n    locationLongitude,\n    locationName,\n    locationAddress,\n    sentAt: createdAt,\n    status,\n    errorMessage: msg.errorMessage ?? null,\n  };\n}\n","/** Small helper: datetime-local -> ISO string */\nexport function toIsoFromDatetimeLocal(datetimeLocal) {\n  if (!datetimeLocal) return null;\n  const d = new Date(datetimeLocal);\n  if (Number.isNaN(d.getTime())) return null;\n  return d.toISOString();\n}\n\n","// Local helper: format dates nicely\nexport function formatDateTime(value) {\n  if (!value) return \"-\";\n  const d = new Date(value);\n  if (Number.isNaN(d.getTime())) return String(value);\n  return d.toLocaleString();\n}\n\n// Local helper: first letter avatar\nexport function getInitial(name, phone) {\n  const src = name || phone || \"?\";\n  return src.trim()[0]?.toUpperCase() ?? \"?\";\n}\n\n// Day label for separators (Today / Yesterday / 12 Dec 2025)\nexport function formatDayLabel(date) {\n  if (!date || Number.isNaN(date.getTime())) return \"\";\n  const today = new Date();\n  const todayKey = today.toDateString();\n\n  const yesterday = new Date();\n  yesterday.setDate(today.getDate() - 1);\n  const yesterdayKey = yesterday.toDateString();\n\n  const key = date.toDateString();\n\n  if (key === todayKey) return \"Today\";\n  if (key === yesterdayKey) return \"Yesterday\";\n\n  return date.toLocaleDateString(undefined, {\n    day: \"2-digit\",\n    month: \"short\",\n    year: \"numeric\",\n  });\n}\n\n","export function parseConversationStatus(status) {\n  const raw = String(status ?? \"\")\n    .trim()\n    .toLowerCase();\n  if (raw === \"pending\") return \"Pending\";\n  if (raw === \"closed\") return \"Closed\";\n  return \"Open\"; // safest default\n}\n","//  Suggested path: src/pages/ChatInbox/hooks/useChatInboxController.js\r\nimport { useState, useMemo, useCallback, useEffect, useRef } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { toast } from \"react-toastify\";\r\nimport useInboxSignalR from \"./useInboxSignalR\";\r\nimport axiosClient from \"../api/chatInboxApi\";\r\nimport {\r\n  inferIsInboundFromAny,\r\n  mapHubMessageToChat,\r\n} from \"../utils/messageMapping\";\r\nimport { toIsoFromDatetimeLocal } from \"../utils/dateUtils\";\r\nimport { formatDayLabel } from \"../utils/formatters\";\r\nimport { parseConversationStatus } from \"../utils/parseConversationStatus\";\r\n\r\nconst normalizePagedResult = data => {\r\n  if (Array.isArray(data)) {\r\n    return { items: data, nextCursor: null, hasMore: false };\r\n  }\r\n\r\n  const items = data?.items ?? data?.Items ?? [];\r\n  const nextCursor = data?.nextCursor ?? data?.NextCursor ?? null;\r\n  const hasMore =\r\n    data?.hasMore ??\r\n    data?.HasMore ??\r\n    (nextCursor !== null && nextCursor !== \"\");\r\n\r\n  return {\r\n    items: Array.isArray(items) ? items : [],\r\n    nextCursor: nextCursor || null,\r\n    hasMore: Boolean(hasMore),\r\n  };\r\n};\r\n\r\nconst DEFAULT_CONVERSATIONS_PAGE_SIZE = 50;\r\nconst DEFAULT_MESSAGES_PAGE_SIZE = 50;\r\n\r\nconst CHAT_INBOX_MEDIA_MAX_BYTES = 10 * 1024 * 1024; // 10MB (must match backend limit)\r\nconst CHAT_INBOX_ALLOWED_MIME_TYPES = new Set([\r\n  \"image/jpeg\",\r\n  \"image/png\",\r\n  \"image/webp\",\r\n  \"application/pdf\",\r\n  \"video/mp4\",\r\n  \"video/3gpp\",\r\n  \"audio/mpeg\",\r\n  \"audio/mp4\",\r\n  \"audio/aac\",\r\n  \"audio/ogg\",\r\n]);\r\n\r\nconst inferChatInboxMediaType = mime => {\r\n  const base = String(mime || \"\")\r\n    .split(\";\")[0]\r\n    .toLowerCase()\r\n    .trim();\r\n  if (base === \"application/pdf\") return \"document\";\r\n  if (base.startsWith(\"video/\")) return \"video\";\r\n  if (base.startsWith(\"audio/\")) return \"audio\";\r\n  return \"image\";\r\n};\r\n\r\nconst toFiniteNumberOrNull = value => {\r\n  if (value === null || value === undefined) return null;\r\n  if (typeof value === \"string\" && value.trim() === \"\") return null;\r\n  const n = Number(value);\r\n  return Number.isFinite(n) ? n : null;\r\n};\r\n\r\nconst toLatitudeOrNull = value => {\r\n  const n = toFiniteNumberOrNull(value);\r\n  return n !== null && n >= -90 && n <= 90 ? n : null;\r\n};\r\n\r\nconst toLongitudeOrNull = value => {\r\n  const n = toFiniteNumberOrNull(value);\r\n  return n !== null && n >= -180 && n <= 180 ? n : null;\r\n};\r\n\r\nconst buildChatInboxMediaContentUrl = mediaId =>\r\n  `/chat-inbox/media/${encodeURIComponent(String(mediaId || \"\").trim())}/content`;\r\n\r\nconst CHAT_INBOX_ACTIVE_TAB_KEY = businessId =>\r\n  `chatInbox:activeTab:${businessId || \"global\"}`;\r\n\r\nconst VALID_CHAT_INBOX_TABS = new Set([\r\n  \"live\",\r\n  \"unassigned\",\r\n  \"my\",\r\n  \"closed\",\r\n  \"history\",\r\n]);\r\n\r\nconst readStoredActiveTab = () => {\r\n  try {\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    const raw =\r\n      localStorage.getItem(CHAT_INBOX_ACTIVE_TAB_KEY(businessId)) ||\r\n      localStorage.getItem(CHAT_INBOX_ACTIVE_TAB_KEY(\"global\"));\r\n\r\n    const tab = String(raw || \"\").trim();\r\n    return VALID_CHAT_INBOX_TABS.has(tab) ? tab : null;\r\n  } catch {\r\n    return null;\r\n  }\r\n};\r\n\r\nexport function useChatInboxController() {\r\n  const navigate = useNavigate();\r\n\r\n  //  SignalR connection\r\n  const { connection, isConnected } = useInboxSignalR();\r\n\r\n  //  Filters & selection\r\n  const [activeTab, setActiveTab] = useState(\r\n    () => readStoredActiveTab() || \"live\"\r\n  );\r\n  const [selectedNumberId, setSelectedNumberId] = useState(\"all\");\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const businessId = localStorage.getItem(\"businessId\");\r\n      localStorage.setItem(CHAT_INBOX_ACTIVE_TAB_KEY(\"global\"), activeTab);\r\n      if (businessId) {\r\n        localStorage.setItem(CHAT_INBOX_ACTIVE_TAB_KEY(businessId), activeTab);\r\n      }\r\n    } catch {\r\n      // ignore storage errors\r\n    }\r\n  }, [activeTab]);\r\n\r\n  //  Data from backend\r\n  const [allConversations, setAllConversations] = useState([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [conversationsNextCursor, setConversationsNextCursor] = useState(null);\r\n  const [conversationsHasMore, setConversationsHasMore] = useState(false);\r\n  const [isConversationsLoadingMore, setIsConversationsLoadingMore] =\r\n    useState(false);\r\n\r\n  //  Selected conversation & message input\r\n  const [selectedConversationId, setSelectedConversationId] = useState(null);\r\n  const [newMessage, setNewMessage] = useState(\"\");\r\n\r\n  //  Messages for selected conversation\r\n  const [messages, setMessages] = useState([]);\r\n  const [isMessagesLoading, setIsMessagesLoading] = useState(false);\r\n  const [messagesNextCursor, setMessagesNextCursor] = useState(null);\r\n  const [messagesHasMore, setMessagesHasMore] = useState(false);\r\n  const [isMessagesLoadingOlder, setIsMessagesLoadingOlder] = useState(false);\r\n\r\n  //  Sending & assignment state\r\n  const [isSending, setIsSending] = useState(false);\r\n  const [isUploadingMedia, setIsUploadingMedia] = useState(false);\r\n  const [isAssigning, setIsAssigning] = useState(false);\r\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false);\r\n\r\n  const [agents, setAgents] = useState([]);\r\n  const [isAgentsLoading, setIsAgentsLoading] = useState(false);\r\n\r\n  //  CRM summary for right panel\r\n  const [contactSummary, setContactSummary] = useState(null);\r\n  const [isSummaryLoading, setIsSummaryLoading] = useState(false);\r\n\r\n  //  Quick CRM actions (notes + reminders)\r\n  const [noteDraft, setNoteDraft] = useState(\"\");\r\n  const [isSavingNote, setIsSavingNote] = useState(false);\r\n\r\n  const [reminderTitle, setReminderTitle] = useState(\"\");\r\n  const [reminderDueAt, setReminderDueAt] = useState(\"\");\r\n  const [reminderDescription, setReminderDescription] = useState(\"\");\r\n  const [isSavingReminder, setIsSavingReminder] = useState(false);\r\n\r\n  //  Edit state: Notes\r\n  const [editingNoteId, setEditingNoteId] = useState(null);\r\n  const [editNoteContent, setEditNoteContent] = useState(\"\");\r\n  const [isUpdatingNote, setIsUpdatingNote] = useState(false);\r\n\r\n  //  Edit state: Reminder\r\n  const [editingReminderId, setEditingReminderId] = useState(null);\r\n  const [editReminderTitle, setEditReminderTitle] = useState(\"\");\r\n  const [editReminderDueAt, setEditReminderDueAt] = useState(\"\");\r\n  const [editReminderDescription, setEditReminderDescription] = useState(\"\");\r\n  const [isUpdatingReminder, setIsUpdatingReminder] = useState(false);\r\n\r\n  //  Confirm dialog\r\n  const [confirmState, setConfirmState] = useState({\r\n    open: false,\r\n    type: null, // \"note\" | \"reminder\"\r\n    id: null,\r\n    title: \"\",\r\n  });\r\n  const [confirmBusy, setConfirmBusy] = useState(false);\r\n\r\n  //  Tag modal state\r\n  const [isTagModalOpen, setIsTagModalOpen] = useState(false);\r\n\r\n  //  tag remove state (simple, MVP)\r\n  const [removingTagId, setRemovingTagId] = useState(null);\r\n\r\n  // Right panel toggles\r\n  const [showRightPanel, setShowRightPanel] = useState(true);\r\n  \r\n  //  Persist 'showDetails' (Expand/Collapse right panel)\r\n  const [showDetails, setShowDetails] = useState(() => {\r\n    try {\r\n      const stored = localStorage.getItem(\"chatInbox:showDetails\");\r\n      return stored !== null ? stored === \"true\" : true;\r\n    } catch {\r\n      return true;\r\n    }\r\n  });\r\n\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem(\"chatInbox:showDetails\", String(showDetails));\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }, [showDetails]);\r\n\r\n  const [showCrmPanel, setShowCrmPanel] = useState(true);\r\n  const [showMiniTimeline, setShowMiniTimeline] = useState(true);\r\n\r\n  //  Auto-scroll anchor for chat messages\r\n  const messagesEndRef = useRef(null);\r\n  const lastMessagesMutationRef = useRef(null);\r\n  const clearedUnreadByConversationRef = useRef(new Map());\r\n  const clearedUnreadByContactRef = useRef(new Map());\r\n  const messagesRequestAbortRef = useRef(null);\r\n  const messagesRequestIdRef = useRef(0);\r\n  const messagesLoadTimerRef = useRef(null);\r\n  const markReadTimerRef = useRef(null);\r\n  const mediaObjectUrlByIdRef = useRef(new Map());\r\n  const mediaObjectUrlFetchRef = useRef(new Map());\r\n  const mediaBlobFetchRef = useRef(new Map());\r\n  const localObjectUrlByTempIdRef = useRef(new Map());\r\n  const [mediaObjectUrlById, setMediaObjectUrlById] = useState({});\r\n  const [pdfPreviewById, setPdfPreviewById] = useState({});\r\n  const [mediaViewer, setMediaViewer] = useState({\r\n    open: false,\r\n    type: null,\r\n    mediaId: null,\r\n    url: null,\r\n    fileName: null,\r\n    items: null,\r\n    index: 0,\r\n    loading: false,\r\n  });\r\n  const messagesRef = useRef(messages);\r\n  const mediaViewerRef = useRef(mediaViewer);\r\n  const pdfPreviewFetchRef = useRef(new Map());\r\n  const pdfJsImportRef = useRef(null);\r\n  const pdfJsModuleRef = useRef(null);\r\n\r\n  // Keep frequently-read paging state in refs so effects/callbacks stay stable\r\n  const selectedConversationIdRef = useRef(selectedConversationId);\r\n  const conversationsNextCursorRef = useRef(conversationsNextCursor);\r\n  const conversationsHasMoreRef = useRef(conversationsHasMore);\r\n  const isConversationsLoadingMoreRef = useRef(isConversationsLoadingMore);\r\n  const messagesNextCursorRef = useRef(messagesNextCursor);\r\n  const messagesHasMoreRef = useRef(messagesHasMore);\r\n  const isMessagesLoadingOlderRef = useRef(isMessagesLoadingOlder);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      for (const url of mediaObjectUrlByIdRef.current.values()) {\r\n        try {\r\n          URL.revokeObjectURL(url);\r\n        } catch {}\r\n      }\r\n      for (const url of localObjectUrlByTempIdRef.current.values()) {\r\n        try {\r\n          URL.revokeObjectURL(url);\r\n        } catch {}\r\n      }\r\n      mediaObjectUrlByIdRef.current.clear();\r\n      mediaObjectUrlFetchRef.current.clear();\r\n      mediaBlobFetchRef.current.clear();\r\n      localObjectUrlByTempIdRef.current.clear();\r\n      pdfPreviewFetchRef.current.clear();\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    messagesRef.current = messages;\r\n  }, [messages]);\r\n\r\n  useEffect(() => {\r\n    mediaViewerRef.current = mediaViewer;\r\n  }, [mediaViewer]);\r\n\r\n  const upsertMediaObjectUrl = useCallback((mediaId, objectUrl) => {\r\n    const key = String(mediaId || \"\").trim();\r\n    if (!key || !objectUrl) return;\r\n\r\n    const existing = mediaObjectUrlByIdRef.current.get(key);\r\n    if (existing && existing !== objectUrl) {\r\n      try {\r\n        URL.revokeObjectURL(existing);\r\n      } catch {}\r\n    }\r\n\r\n    mediaObjectUrlByIdRef.current.set(key, objectUrl);\r\n    setMediaObjectUrlById(prev => ({ ...prev, [key]: objectUrl }));\r\n  }, []);\r\n\r\n  const fetchMediaBlob = useCallback(async (mediaId, opts = {}) => {\r\n    const key = String(mediaId || \"\").trim();\r\n    if (!key) return null;\r\n\r\n    const inflight = mediaBlobFetchRef.current.get(key);\r\n    if (inflight) return inflight;\r\n\r\n    const silent = Boolean(opts?.silent);\r\n\r\n    const promise = axiosClient\r\n      .get(buildChatInboxMediaContentUrl(key), {\r\n        responseType: \"blob\",\r\n        __silentToast: true,\r\n      })\r\n      .then(res => res?.data || null)\r\n      .catch(error => {\r\n        console.error(\"Failed to fetch media content:\", error);\r\n        if (!silent) {\r\n          toast.error(\r\n            error.response?.data?.message ||\r\n              \"Failed to load media preview. Please retry.\"\r\n          );\r\n        }\r\n        return null;\r\n      })\r\n      .finally(() => {\r\n        mediaBlobFetchRef.current.delete(key);\r\n      });\r\n\r\n    mediaBlobFetchRef.current.set(key, promise);\r\n    return promise;\r\n  }, []);\r\n\r\n  const fetchMediaObjectUrl = useCallback(\r\n    async (mediaId, opts = {}) => {\r\n      const key = String(mediaId || \"\").trim();\r\n      if (!key) return null;\r\n\r\n      const cached = mediaObjectUrlByIdRef.current.get(key);\r\n      if (cached) return cached;\r\n\r\n      const inflight = mediaObjectUrlFetchRef.current.get(key);\r\n      if (inflight) return inflight;\r\n\r\n      const promise = (async () => {\r\n        const blob = await fetchMediaBlob(key, opts);\r\n        if (!blob) return null;\r\n\r\n        if (\r\n          typeof URL === \"undefined\" ||\r\n          typeof URL.createObjectURL !== \"function\"\r\n        ) {\r\n          return null;\r\n        }\r\n\r\n        const url = URL.createObjectURL(blob);\r\n        upsertMediaObjectUrl(key, url);\r\n        return url;\r\n      })()\r\n        .catch(error => {\r\n          console.error(\"Failed to fetch media content:\", error);\r\n          toast.error(\r\n            error.response?.data?.message ||\r\n              \"Failed to load media preview. Please retry.\"\r\n          );\r\n          return null;\r\n        })\r\n        .finally(() => {\r\n          mediaObjectUrlFetchRef.current.delete(key);\r\n        });\r\n\r\n      mediaObjectUrlFetchRef.current.set(key, promise);\r\n      return promise;\r\n    },\r\n    [fetchMediaBlob, upsertMediaObjectUrl]\r\n  );\r\n\r\n  const buildImageViewerItems = useCallback(() => {\r\n    const list = Array.isArray(messagesRef.current) ? messagesRef.current : [];\r\n    const items = list\r\n      .map(m => {\r\n        const mt = String(m?.mediaType ?? m?.MediaType ?? \"\")\r\n          .trim()\r\n          .toLowerCase();\r\n        if (mt !== \"image\") return null;\r\n\r\n        const mediaId = String(m?.mediaId ?? m?.MediaId ?? \"\").trim();\r\n        if (!mediaId) return null;\r\n\r\n        const fileName = String(m?.fileName ?? m?.FileName ?? \"\").trim() || null;\r\n        const sentAt = m?.sentAt ?? m?.sentAtUtc ?? m?.createdAt ?? null;\r\n\r\n        return { mediaId, fileName, sentAt };\r\n      })\r\n      .filter(Boolean);\r\n\r\n    items.sort((a, b) => {\r\n      const ta = a?.sentAt ? Date.parse(a.sentAt) : 0;\r\n      const tb = b?.sentAt ? Date.parse(b.sentAt) : 0;\r\n      return ta - tb;\r\n    });\r\n\r\n    // De-dupe by mediaId (keep first occurrence)\r\n    const seen = new Set();\r\n    return items.filter(i => {\r\n      if (!i?.mediaId) return false;\r\n      if (seen.has(i.mediaId)) return false;\r\n      seen.add(i.mediaId);\r\n      return true;\r\n    });\r\n  }, []);\r\n\r\n  const handleOpenMedia = useCallback(\r\n    async msg => {\r\n      const mediaId = msg?.mediaId ?? msg?.MediaId ?? null;\r\n      const mt = String(msg?.mediaType ?? msg?.MediaType ?? \"\")\r\n        .trim()\r\n        .toLowerCase();\r\n      if (!mediaId || (mt !== \"image\" && mt !== \"document\" && mt !== \"video\"))\r\n        return;\r\n\r\n      const url =\r\n        msg?.localPreviewUrl ||\r\n        (await fetchMediaObjectUrl(String(mediaId), { silent: false }));\r\n      if (!url) return;\r\n\r\n      const name = String(msg?.fileName ?? msg?.FileName ?? \"\").trim();\r\n\r\n      if (mt === \"image\") {\r\n        const items = buildImageViewerItems();\r\n        const id = String(mediaId).trim();\r\n        let index = items.findIndex(i => i.mediaId === id);\r\n        if (index < 0) {\r\n          items.push({ mediaId: id, fileName: name || null, sentAt: null });\r\n          index = items.length - 1;\r\n        }\r\n\r\n        // Prefetch neighbors quietly (best-effort)\r\n        const prev = items[index - 1]?.mediaId;\r\n        const next = items[index + 1]?.mediaId;\r\n        if (prev) fetchMediaObjectUrl(prev, { silent: true });\r\n        if (next) fetchMediaObjectUrl(next, { silent: true });\r\n\r\n        setMediaViewer({\r\n          open: true,\r\n          type: \"image\",\r\n          mediaId: id,\r\n          url,\r\n          fileName: name || null,\r\n          items,\r\n          index,\r\n          loading: false,\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (mt === \"video\") {\r\n        const id = String(mediaId).trim();\r\n        setMediaViewer({\r\n          open: true,\r\n          type: \"video\",\r\n          mediaId: id,\r\n          url,\r\n          fileName: name || null,\r\n          items: null,\r\n          index: 0,\r\n          loading: false,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Documents: keep a simple new-tab open/download for now.\r\n      const a = document.createElement(\"a\");\r\n      a.href = url;\r\n      a.target = \"_blank\";\r\n      a.rel = \"noreferrer noopener\";\r\n      if (name) a.download = name;\r\n      a.click();\r\n    },\r\n    [buildImageViewerItems, fetchMediaObjectUrl]\r\n  );\r\n\r\n  const handleCloseMediaViewer = useCallback(() => {\r\n    setMediaViewer({\r\n      open: false,\r\n      type: null,\r\n      mediaId: null,\r\n      url: null,\r\n      fileName: null,\r\n      items: null,\r\n      index: 0,\r\n      loading: false,\r\n    });\r\n  }, []);\r\n\r\n  const handleMediaViewerSelectIndex = useCallback(\r\n    async nextIndex => {\r\n      const v = mediaViewerRef.current;\r\n      if (!v?.open || v.type !== \"image\") return;\r\n      const items = Array.isArray(v.items) ? v.items : [];\r\n      if (items.length === 0) return;\r\n\r\n      const idx = Number(nextIndex);\r\n      if (!Number.isFinite(idx) || idx < 0 || idx >= items.length) return;\r\n      if (idx === v.index && v.url) return;\r\n\r\n      const target = items[idx];\r\n      if (!target?.mediaId) return;\r\n\r\n      setMediaViewer(prev => ({ ...prev, loading: true }));\r\n      const url = await fetchMediaObjectUrl(target.mediaId, { silent: false });\r\n      if (!url) {\r\n        setMediaViewer(prev => ({ ...prev, loading: false }));\r\n        return;\r\n      }\r\n\r\n      const prevId = items[idx - 1]?.mediaId;\r\n      const nextId = items[idx + 1]?.mediaId;\r\n      if (prevId) fetchMediaObjectUrl(prevId, { silent: true });\r\n      if (nextId) fetchMediaObjectUrl(nextId, { silent: true });\r\n\r\n      setMediaViewer(prev => ({\r\n        ...prev,\r\n        open: true,\r\n        type: \"image\",\r\n        mediaId: target.mediaId,\r\n        url,\r\n        fileName: target.fileName || null,\r\n        items,\r\n        index: idx,\r\n        loading: false,\r\n      }));\r\n    },\r\n    [fetchMediaObjectUrl]\r\n  );\r\n\r\n  const handleMediaViewerPrev = useCallback(() => {\r\n    const v = mediaViewerRef.current;\r\n    if (!v?.open || v.type !== \"image\") return;\r\n    if (!Array.isArray(v.items) || v.items.length <= 1) return;\r\n    if (v.index <= 0) return;\r\n    handleMediaViewerSelectIndex(v.index - 1);\r\n  }, [handleMediaViewerSelectIndex]);\r\n\r\n  const handleMediaViewerNext = useCallback(() => {\r\n    const v = mediaViewerRef.current;\r\n    if (!v?.open || v.type !== \"image\") return;\r\n    if (!Array.isArray(v.items) || v.items.length <= 1) return;\r\n    if (v.index >= v.items.length - 1) return;\r\n    handleMediaViewerSelectIndex(v.index + 1);\r\n  }, [handleMediaViewerSelectIndex]);\r\n\r\n  const ensureImagePreview = useCallback(\r\n    mediaId => {\r\n      const key = String(mediaId || \"\").trim();\r\n      if (!key) return;\r\n      fetchMediaObjectUrl(key, { silent: true });\r\n    },\r\n    [fetchMediaObjectUrl]\r\n  );\r\n\r\n  const ensurePdfPreview = useCallback(\r\n    async (mediaId, opts = {}) => {\r\n      const key = String(mediaId || \"\").trim();\r\n      if (!key) return;\r\n      if (pdfPreviewById[key]) return;\r\n      if (pdfPreviewFetchRef.current.has(key)) return;\r\n\r\n      const promise = (async () => {\r\n        const localPreviewUrl = String(opts?.localPreviewUrl || \"\").trim();\r\n        const skipRemote = Boolean(opts?.skipRemote);\r\n\r\n        const blob = await (async () => {\r\n          if (localPreviewUrl) {\r\n            try {\r\n              const res = await fetch(localPreviewUrl);\r\n              if (res?.ok) return await res.blob();\r\n            } catch {\r\n              // ignore local preview fetch errors\r\n            }\r\n          }\r\n\r\n          if (skipRemote) return null;\r\n\r\n          return await fetchMediaBlob(key, { silent: true });\r\n        })();\r\n        if (!blob) return;\r\n\r\n        // In test/SSR environments, canvas may not exist; skip thumbnail generation.\r\n        if (\r\n          typeof document === \"undefined\" ||\r\n          typeof URL === \"undefined\" ||\r\n          typeof blob.arrayBuffer !== \"function\"\r\n        ) {\r\n          setPdfPreviewById(prev => ({\r\n            ...prev,\r\n            [key]: {\r\n              pages: null,\r\n              sizeBytes: Number(blob.size) || null,\r\n              thumbDataUrl: null,\r\n            },\r\n          }));\r\n          return;\r\n        }\r\n\r\n        try {\r\n          let pdfjs = pdfJsModuleRef.current;\r\n          if (!pdfjs) {\r\n            if (!pdfJsImportRef.current) {\r\n              pdfJsImportRef.current = import(\"pdfjs-dist/legacy/build/pdf.mjs\");\r\n            }\r\n            pdfjs = await pdfJsImportRef.current;\r\n            pdfJsModuleRef.current = pdfjs;\r\n          }\r\n\r\n          // Fix runtime error: configure pdf.js worker URL for CRA/Webpack builds.\r\n          // (Even with disableWorker=true, some builds still try to initialize a PDFWorker.)\r\n          try {\r\n            const gwo = pdfjs?.GlobalWorkerOptions;\r\n            if (gwo && !gwo.workerSrc) {\r\n              const publicUrl =\r\n                typeof process !== \"undefined\" &&\r\n                process?.env &&\r\n                typeof process.env.PUBLIC_URL === \"string\"\r\n                  ? process.env.PUBLIC_URL\r\n                  : \"\";\r\n\r\n              // This file is copied from node_modules by `node scripts/copy-pdf-worker.js`\r\n              // (hooked up via `postinstall`), so the dev server/build can serve it reliably.\r\n              gwo.workerSrc = `${publicUrl}/pdf.worker.min.mjs`;\r\n            }\r\n          } catch {\r\n            // If import.meta.url isn't supported by the bundler, we still try to proceed with disableWorker below.\r\n          }\r\n\r\n          const buffer = await blob.arrayBuffer();\r\n          const doc = await pdfjs.getDocument({\r\n            data: buffer,\r\n            disableWorker: true,\r\n          }).promise;\r\n\r\n          const pages = Number(doc?.numPages) || null;\r\n\r\n          let thumbDataUrl = null;\r\n          try {\r\n            const page = await doc.getPage(1);\r\n            const viewport = page.getViewport({ scale: 0.35 });\r\n\r\n            const canvas = document.createElement(\"canvas\");\r\n            const ctx = canvas.getContext?.(\"2d\");\r\n            if (ctx) {\r\n              canvas.width = Math.max(1, Math.floor(viewport.width));\r\n              canvas.height = Math.max(1, Math.floor(viewport.height));\r\n\r\n              await page.render({ canvasContext: ctx, viewport }).promise;\r\n              thumbDataUrl = canvas.toDataURL(\"image/png\");\r\n              page.cleanup?.();\r\n            }\r\n          } catch {\r\n            thumbDataUrl = null;\r\n          } finally {\r\n            try {\r\n              await doc.destroy?.();\r\n            } catch {}\r\n          }\r\n\r\n          setPdfPreviewById(prev => ({\r\n            ...prev,\r\n            [key]: {\r\n              pages,\r\n              sizeBytes: Number(blob.size) || null,\r\n              thumbDataUrl,\r\n            },\r\n          }));\r\n        } catch (error) {\r\n          console.error(\"Failed to generate PDF preview:\", error);\r\n          setPdfPreviewById(prev => ({\r\n            ...prev,\r\n            [key]: {\r\n              pages: null,\r\n              sizeBytes: Number(blob.size) || null,\r\n              thumbDataUrl: null,\r\n            },\r\n          }));\r\n        }\r\n      })().finally(() => {\r\n        pdfPreviewFetchRef.current.delete(key);\r\n      });\r\n\r\n      pdfPreviewFetchRef.current.set(key, promise);\r\n      await promise;\r\n    },\r\n    [fetchMediaBlob, pdfPreviewById]\r\n  );\r\n\r\n  useEffect(() => {\r\n    selectedConversationIdRef.current = selectedConversationId;\r\n  }, [selectedConversationId]);\r\n  useEffect(() => {\r\n    conversationsNextCursorRef.current = conversationsNextCursor;\r\n  }, [conversationsNextCursor]);\r\n  useEffect(() => {\r\n    conversationsHasMoreRef.current = conversationsHasMore;\r\n  }, [conversationsHasMore]);\r\n  useEffect(() => {\r\n    isConversationsLoadingMoreRef.current = isConversationsLoadingMore;\r\n  }, [isConversationsLoadingMore]);\r\n  useEffect(() => {\r\n    messagesNextCursorRef.current = messagesNextCursor;\r\n  }, [messagesNextCursor]);\r\n  useEffect(() => {\r\n    messagesHasMoreRef.current = messagesHasMore;\r\n  }, [messagesHasMore]);\r\n  useEffect(() => {\r\n    isMessagesLoadingOlderRef.current = isMessagesLoadingOlder;\r\n  }, [isMessagesLoadingOlder]);\r\n\r\n  const scrollToBottom = useCallback(() => {\r\n    if (messagesEndRef.current) {\r\n      messagesEndRef.current.scrollIntoView({\r\n        behavior: \"auto\",\r\n        block: \"end\",\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  const currentUserId = useMemo(() => localStorage.getItem(\"userId\"), []);\r\n\r\n  //  Selected conversation\r\n  const selectedConversation = useMemo(\r\n    () => allConversations.find(c => c.id === selectedConversationId) || null,\r\n    [allConversations, selectedConversationId]\r\n  );\r\n\r\n  //  Prevent stale selectedConversation inside SignalR handlers\r\n  const selectedConversationRef = useRef(null);\r\n  useEffect(() => {\r\n    selectedConversationRef.current = selectedConversation;\r\n  }, [selectedConversation]);\r\n\r\n  //  Keep latest conversations without making message-loading re-run\r\n  const conversationsRef = useRef([]);\r\n  useEffect(() => {\r\n    conversationsRef.current = allConversations;\r\n  }, [allConversations]);\r\n\r\n  const getClearedUnreadEntry = useCallback(conversation => {\r\n    if (!conversation) return null;\r\n    const byConversationId = conversation.id\r\n      ? clearedUnreadByConversationRef.current.get(conversation.id)\r\n      : null;\r\n    if (byConversationId) return byConversationId;\r\n    if (!conversation.contactId) return null;\r\n    return (\r\n      clearedUnreadByContactRef.current.get(conversation.contactId) || null\r\n    );\r\n  }, []);\r\n\r\n  const getClearedUnreadEntryByContactId = useCallback(contactId => {\r\n    if (!contactId) return null;\r\n    return clearedUnreadByContactRef.current.get(contactId) || null;\r\n  }, []);\r\n\r\n  const setLocalUnreadOverride = useCallback((conversation, nextUnread) => {\r\n    if (!conversation) return;\r\n    const entry = {\r\n      localUnread: Math.max(0, Number(nextUnread) || 0),\r\n      updatedAt: Date.now(),\r\n    };\r\n    if (conversation.id) {\r\n      clearedUnreadByConversationRef.current.set(conversation.id, entry);\r\n    }\r\n    if (conversation.contactId) {\r\n      clearedUnreadByContactRef.current.set(conversation.contactId, entry);\r\n    }\r\n  }, []);\r\n\r\n  const getLocalUnreadOverride = useCallback(\r\n    conversation => {\r\n      const entry = getClearedUnreadEntry(conversation);\r\n      if (!entry) return null;\r\n      if (typeof entry.localUnread !== \"number\") return null;\r\n      return entry.localUnread;\r\n    },\r\n    [getClearedUnreadEntry]\r\n  );\r\n\r\n  const markConversationUnreadCleared = useCallback(\r\n    conversation => {\r\n      if (!conversation) return;\r\n      setLocalUnreadOverride(conversation, 0);\r\n    },\r\n    [setLocalUnreadOverride]\r\n  );\r\n\r\n  const selectedContactId = useMemo(\r\n    () => selectedConversation?.contactId || null,\r\n    [selectedConversation]\r\n  );\r\n\r\n  //  24h window + status flags\r\n  const isWithin24h = selectedConversation?.within24h ?? false;\r\n  const selectedConversationStatus =\r\n    parseConversationStatus(selectedConversation?.status) ?? \"Open\";\r\n  const isConversationClosed = selectedConversationStatus === \"Closed\";\r\n\r\n  //  Assignment flags for header\r\n  const headerIsAssigned = !!selectedConversation?.assignedToUserId;\r\n  const headerIsAssignedToMe =\r\n    !!selectedConversation?.isAssignedToMe ||\r\n    (!!selectedConversation?.assignedToUserId &&\r\n      currentUserId &&\r\n      selectedConversation.assignedToUserId === currentUserId);\r\n\r\n  const headerAssignedName = headerIsAssignedToMe\r\n    ? \"You\"\r\n    : selectedConversation?.assignedToUserName || \"Agent\";\r\n\r\n  //  Reset edit state when switching contact\r\n  useEffect(() => {\r\n    setEditingNoteId(null);\r\n    setEditNoteContent(\"\");\r\n    setEditingReminderId(null);\r\n    setEditReminderTitle(\"\");\r\n    setEditReminderDueAt(\"\");\r\n    setEditReminderDescription(\"\");\r\n  }, [selectedContactId]);\r\n\r\n  //  Filter + sort conversations\r\n  const filteredConversations = useMemo(() => {\r\n    let list = [...allConversations];\r\n    const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n\r\n    if (selectedNumberId !== \"all\") {\r\n      list = list.filter(c => c.numberId === selectedNumberId);\r\n    }\r\n\r\n    if (searchTerm.trim()) {\r\n      const q = searchTerm.trim().toLowerCase();\r\n      list = list.filter(\r\n        c =>\r\n          c.contactName?.toLowerCase().includes(q) ||\r\n          c.contactPhone?.toLowerCase().includes(q) ||\r\n          c.lastMessagePreview?.toLowerCase().includes(q)\r\n      );\r\n    }\r\n\r\n    if (tabKey === \"closed\") {\r\n      list = list.filter(c => parseConversationStatus(c.status) === \"Closed\");\r\n    } else {\r\n      list = list.filter(c => parseConversationStatus(c.status) !== \"Closed\");\r\n    }\r\n\r\n    if (tabKey === \"live\") {\r\n      list = list.filter(c => c.within24h);\r\n    } else if (tabKey === \"older\") {\r\n      list = list.filter(c => !c.within24h);\r\n    } else if (tabKey === \"unassigned\") {\r\n      list = list.filter(c => !c.assignedToUserId);\r\n    } else if (tabKey === \"my\") {\r\n      if (currentUserId) {\r\n        list = list.filter(c => c.assignedToUserId === currentUserId);\r\n      }\r\n    }\r\n\r\n    //  Sort: unread first, then most recent lastMessageAt\r\n    list.sort((a, b) => {\r\n      const aUnread = a.unreadCount > 0;\r\n      const bUnread = b.unreadCount > 0;\r\n\r\n      if (aUnread && !bUnread) return -1;\r\n      if (!aUnread && bUnread) return 1;\r\n\r\n      const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;\r\n      const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;\r\n\r\n      return bTime - aTime;\r\n    });\r\n\r\n    return list;\r\n  }, [\r\n    allConversations,\r\n    activeTab,\r\n    selectedNumberId,\r\n    searchTerm,\r\n    currentUserId,\r\n  ]);\r\n\r\n  //  Load conversations (supports \"silent\" refresh)\r\n  const fetchConversationsPage = useCallback(\r\n    async (options = {}) => {\r\n      const {\r\n        reset = false,\r\n        append = false,\r\n        limit = DEFAULT_CONVERSATIONS_PAGE_SIZE,\r\n      } = options;\r\n\r\n      if (append) {\r\n        if (!conversationsHasMoreRef.current) return;\r\n        if (!conversationsNextCursorRef.current) return;\r\n        if (isConversationsLoadingMoreRef.current) return;\r\n      }\r\n\r\n      try {\r\n        if (reset) {\r\n          setIsLoading(true);\r\n          setConversationsNextCursor(null);\r\n          setConversationsHasMore(false);\r\n        }\r\n        if (append) setIsConversationsLoadingMore(true);\r\n\r\n        const businessId = localStorage.getItem(\"businessId\");\r\n        if (!businessId) {\r\n          toast.error(\r\n            \"Missing business context. Please login again to load inbox.\"\r\n          );\r\n          return;\r\n        }\r\n\r\n        const params = {\r\n          businessId,\r\n          tab: activeTab === \"history\" ? \"older\" : activeTab,\r\n          numberId:\r\n            selectedNumberId && selectedNumberId !== \"all\"\r\n              ? selectedNumberId\r\n              : undefined,\r\n          search: searchTerm || undefined,\r\n          limit,\r\n          paged: true,\r\n          cursor: append ? conversationsNextCursorRef.current : undefined,\r\n        };\r\n\r\n        const res = await axiosClient.get(\"/chat-inbox/conversations\", {\r\n          params,\r\n        });\r\n\r\n        const { items, nextCursor, hasMore } = normalizePagedResult(res.data);\r\n\r\n        const selectedId = selectedConversationIdRef.current;\r\n        const mapped = items.map(item => {\r\n          const isSelected = selectedId && item.id === selectedId;\r\n          const localUnread = getLocalUnreadOverride(item);\r\n          return {\r\n            id: item.id,\r\n            contactId: item.contactId,\r\n            contactName: item.contactName,\r\n            contactPhone: item.contactPhone,\r\n            lastMessagePreview: item.lastMessagePreview,\r\n            lastMessageAt: item.lastMessageAt,\r\n\r\n            unreadCount: isSelected\r\n              ? 0\r\n              : (localUnread ?? item.unreadCount ?? item.UnreadCount) || 0,\r\n            status: parseConversationStatus(item.status) ?? \"Open\",\r\n            numberId: item.numberId,\r\n            numberLabel: item.numberLabel,\r\n            within24h: !!item.within24h,\r\n            assignedToUserId: item.assignedToUserId || null,\r\n            assignedToUserName: item.assignedToUserName || null,\r\n            isAssignedToMe: !!item.isAssignedToMe,\r\n            sourceType: item.sourceType || \"WhatsApp\",\r\n            sourceName: item.sourceName || \"WhatsApp\",\r\n            mode: item.mode || \"Live\",\r\n            firstSeenAt: item.firstSeenAt,\r\n            lastInboundAt: item.lastInboundAt,\r\n            lastOutboundAt: item.lastOutboundAt,\r\n          };\r\n        });\r\n\r\n        const keyOf = c => String(c?.id ?? c?.contactId ?? c?.contactPhone);\r\n\r\n        setAllConversations(prev => {\r\n          if (reset) return mapped;\r\n          if (!append) return prev;\r\n\r\n          const byKey = new Map(prev.map(c => [keyOf(c), c]));\r\n          const orderedKeys = prev.map(keyOf);\r\n\r\n          mapped.forEach(nc => {\r\n            const k = keyOf(nc);\r\n            if (!k) return;\r\n            if (!byKey.has(k)) orderedKeys.push(k);\r\n            const existing = byKey.get(k);\r\n            byKey.set(k, existing ? { ...existing, ...nc } : nc);\r\n          });\r\n\r\n          return orderedKeys.map(k => byKey.get(k)).filter(Boolean);\r\n        });\r\n\r\n        setConversationsNextCursor(nextCursor);\r\n        setConversationsHasMore(hasMore);\r\n\r\n        if (!selectedConversationIdRef.current && mapped.length > 0) {\r\n          setSelectedConversationId(mapped[0].id);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to load inbox conversations:\", error);\r\n        toast.error(\r\n          error.response?.data?.message || \"Failed to load inbox conversations.\"\r\n        );\r\n      } finally {\r\n        if (reset) setIsLoading(false);\r\n        if (append) setIsConversationsLoadingMore(false);\r\n      }\r\n    },\r\n    [activeTab, selectedNumberId, searchTerm, getLocalUnreadOverride]\r\n  );\r\n\r\n  const fetchConversations = useCallback(\r\n    async (options = {}) => {\r\n      const { limit, silent } = options;\r\n\r\n      if (!silent) {\r\n        return fetchConversationsPage({\r\n          reset: true,\r\n          limit: limit ?? DEFAULT_CONVERSATIONS_PAGE_SIZE,\r\n        });\r\n      }\r\n\r\n      try {\r\n        const businessId = localStorage.getItem(\"businessId\");\r\n        if (!businessId) {\r\n          toast.error(\r\n            \" Missing business context. Please login again to load inbox.\"\r\n          );\r\n          return;\r\n        }\r\n\r\n        const params = {\r\n          businessId,\r\n          tab: activeTab === \"history\" ? \"older\" : activeTab,\r\n          numberId:\r\n            selectedNumberId && selectedNumberId !== \"all\"\r\n              ? selectedNumberId\r\n              : undefined,\r\n          search: searchTerm || undefined,\r\n          limit: limit ?? DEFAULT_CONVERSATIONS_PAGE_SIZE,\r\n          paged: true,\r\n        };\r\n\r\n        const res = await axiosClient.get(\"/chat-inbox/conversations\", {\r\n          params,\r\n        });\r\n        const { items: apiItems } = normalizePagedResult(res.data);\r\n\r\n        const selectedId = selectedConversationIdRef.current;\r\n        const mapped = apiItems.map(item => {\r\n          const isSelected = selectedId && item.id === selectedId;\r\n          const localUnread = getLocalUnreadOverride(item);\r\n          return {\r\n            id: item.id,\r\n            contactId: item.contactId,\r\n            contactName: item.contactName,\r\n            contactPhone: item.contactPhone,\r\n            lastMessagePreview: item.lastMessagePreview,\r\n            lastMessageAt: item.lastMessageAt,\r\n            unreadCount: isSelected\r\n              ? 0\r\n              : (localUnread ?? item.unreadCount ?? item.UnreadCount) || 0,\r\n            status: parseConversationStatus(item.status) ?? \"Open\",\r\n            numberId: item.numberId,\r\n            numberLabel: item.numberLabel,\r\n            within24h: !!item.within24h,\r\n            assignedToUserId: item.assignedToUserId || null,\r\n            assignedToUserName: item.assignedToUserName || null,\r\n            isAssignedToMe: !!item.isAssignedToMe,\r\n            sourceType: item.sourceType || \"WhatsApp\",\r\n            sourceName: item.sourceName || \"WhatsApp\",\r\n            mode: item.mode || \"Live\",\r\n            firstSeenAt: item.firstSeenAt,\r\n            lastInboundAt: item.lastInboundAt,\r\n            lastOutboundAt: item.lastOutboundAt,\r\n          };\r\n        });\r\n\r\n        //  Silent refresh should not \"erase\" unread counts you already have in UI\r\n        setAllConversations(prev => {\r\n          const prevMap = new Map(prev.map(c => [c.id, c]));\r\n          const selectedId = selectedConversationIdRef.current;\r\n\r\n          const mergedTop = mapped.map(nc => {\r\n            const old = prevMap.get(nc.id);\r\n            if (!old) return nc;\r\n            const localUnread = getLocalUnreadOverride(nc);\r\n\r\n            // Never preserve unread for the currently open chat\r\n            if (selectedId && nc.id === selectedId) {\r\n              return { ...old, ...nc, unreadCount: 0 };\r\n            }\r\n\r\n            // Preserve unread if server temporarily returns 0\r\n            if (\r\n              (nc.unreadCount ?? 0) === 0 &&\r\n              (old.unreadCount ?? 0) > 0 &&\r\n              typeof localUnread !== \"number\"\r\n            ) {\r\n              return { ...old, ...nc, unreadCount: old.unreadCount };\r\n            }\r\n\r\n            return { ...old, ...nc };\r\n          });\r\n\r\n          const mergedIds = new Set(mergedTop.map(c => c.id));\r\n          const tail = prev.filter(c => !mergedIds.has(c.id));\r\n\r\n          return [...mergedTop, ...tail];\r\n        });\r\n\r\n        if (!selectedConversationIdRef.current && mapped.length > 0) {\r\n          setSelectedConversationId(mapped[0].id);\r\n        }\r\n      } catch (error) {\r\n        console.error(\" Failed to load inbox conversations:\", error);\r\n        toast.error(\r\n          error.response?.data?.message || \"Failed to load inbox conversations.\"\r\n        );\r\n      } finally {\r\n        if (!options.silent) setIsLoading(false);\r\n      }\r\n    },\r\n    [\r\n      activeTab,\r\n      selectedNumberId,\r\n      searchTerm,\r\n      fetchConversationsPage,\r\n      getLocalUnreadOverride,\r\n    ]\r\n  );\r\n\r\n  useEffect(() => {\r\n    fetchConversationsPage({\r\n      reset: true,\r\n      limit: DEFAULT_CONVERSATIONS_PAGE_SIZE,\r\n    });\r\n  }, [activeTab, selectedNumberId, searchTerm, fetchConversationsPage]);\r\n\r\n  const fetchAgents = useCallback(async () => {\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) return;\r\n\r\n    setIsAgentsLoading(true);\r\n    try {\r\n      const res = await axiosClient.get(\"/chat-inbox/agents\", {\r\n        params: { businessId },\r\n      });\r\n\r\n      const items = Array.isArray(res.data) ? res.data : [];\r\n      const mapped = items\r\n        .map(a => ({\r\n          userId: a.userId ?? a.id ?? null,\r\n          name: a.name ?? a.fullName ?? a.displayName ?? a.email ?? \"Agent\",\r\n          email: a.email ?? null,\r\n          roleName: a.roleName ?? a.role ?? null,\r\n        }))\r\n        .filter(a => a.userId);\r\n\r\n      setAgents(mapped);\r\n    } catch (error) {\r\n      setAgents([]);\r\n    } finally {\r\n      setIsAgentsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchAgents();\r\n  }, [fetchAgents]);\r\n\r\n  //  Auto-refresh conversations every 25 seconds (silent, no flicker)\r\n  const fetchMessagesPage = useCallback(async (options = {}) => {\r\n    const {\r\n      reset = false,\r\n      prepend = false,\r\n      limit = DEFAULT_MESSAGES_PAGE_SIZE,\r\n    } = options;\r\n\r\n    const selectedId = selectedConversationIdRef.current;\r\n\r\n    if (!selectedId) {\r\n      if (reset) {\r\n        setMessages([]);\r\n        setMessagesNextCursor(null);\r\n        setMessagesHasMore(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (prepend) {\r\n      if (!messagesHasMoreRef.current) return;\r\n      if (!messagesNextCursorRef.current) return;\r\n      if (isMessagesLoadingOlderRef.current) return;\r\n    }\r\n\r\n    const conv = conversationsRef.current.find(c => c.id === selectedId);\r\n    if (!conv) {\r\n      if (reset) {\r\n        setMessages([]);\r\n        setMessagesNextCursor(null);\r\n        setMessagesHasMore(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) {\r\n      toast.error(\r\n        \"Missing business context. Please login again to load messages.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    const requestId = messagesRequestIdRef.current + 1;\r\n    messagesRequestIdRef.current = requestId;\r\n    if (messagesRequestAbortRef.current) {\r\n      messagesRequestAbortRef.current.abort();\r\n    }\r\n    const controller = new AbortController();\r\n    messagesRequestAbortRef.current = controller;\r\n\r\n    try {\r\n      if (reset) {\r\n        setIsMessagesLoading(true);\r\n        setMessages([]);\r\n        setMessagesNextCursor(null);\r\n        setMessagesHasMore(false);\r\n        lastMessagesMutationRef.current = \"reset\";\r\n      }\r\n\r\n      if (prepend) {\r\n        setIsMessagesLoadingOlder(true);\r\n        lastMessagesMutationRef.current = \"prepend\";\r\n      }\r\n\r\n      const params = {\r\n        businessId,\r\n        limit,\r\n        paged: true,\r\n        cursor: prepend ? messagesNextCursorRef.current : undefined,\r\n        contactId: conv.contactId || undefined,\r\n        contactPhone: conv.contactPhone || undefined,\r\n      };\r\n\r\n      const res = await axiosClient.get(\"/chat-inbox/messages\", {\r\n        params,\r\n        signal: controller.signal,\r\n      });\r\n      const { items, nextCursor, hasMore } = normalizePagedResult(res.data);\r\n\r\n      if (messagesRequestIdRef.current !== requestId) return;\r\n\r\n      const mappedPage = items\r\n        .map(m => {\r\n          const isInbound = inferIsInboundFromAny(m);\r\n\r\n          const directionRaw =\r\n            m.direction ?? m.Direction ?? m.dir ?? m.messageDirection ?? \"\";\r\n          const statusRaw = m.status ?? \"\";\r\n\r\n          const providerMessageId =\r\n            m.providerMessageId ?? m.ProviderMessageId ?? null;\r\n          const messageLogId =\r\n            m.messageLogId ?? m.MessageLogId ?? m.messageLogID ?? null;\r\n\r\n          const messageId =\r\n            m.messageId ??\r\n            m.MessageId ??\r\n            m.wamid ??\r\n            m.Wamid ??\r\n            m.waMessageId ??\r\n            m.WaMessageId ??\r\n            providerMessageId ??\r\n            null;\r\n\r\n          const clientMessageId =\r\n            m.clientMessageId ?? m.ClientMessageId ?? null;\r\n\r\n          return {\r\n            id: m.id ?? messageLogId ?? messageId,\r\n            serverId: messageLogId ?? m.id ?? null,\r\n            messageLogId: messageLogId ?? m.id ?? null,\r\n            messageId,\r\n            providerMessageId,\r\n            clientMessageId,\r\n            direction: directionRaw || (isInbound ? \"in\" : \"out\"),\r\n            isInbound,\r\n            text:\r\n              m.text ||\r\n              m.message ||\r\n              m.body ||\r\n              m.content ||\r\n              m.messageText ||\r\n              m.MessageText ||\r\n              m.messageContent ||\r\n              m.MessageContent ||\r\n              m.renderedBody ||\r\n              m.RenderedBody ||\r\n              \"\",\r\n            mediaId: m.mediaId ?? m.MediaId ?? null,\r\n            mediaType: m.mediaType ?? m.MediaType ?? null,\r\n            fileName: m.fileName ?? m.FileName ?? null,\r\n            mimeType: m.mimeType ?? m.MimeType ?? null,\r\n            locationLatitude:\r\n              m.locationLatitude ?? m.LocationLatitude ?? m.latitude ?? null,\r\n            locationLongitude:\r\n              m.locationLongitude ?? m.LocationLongitude ?? m.longitude ?? null,\r\n            locationName: m.locationName ?? m.LocationName ?? m.name ?? null,\r\n            locationAddress:\r\n              m.locationAddress ?? m.LocationAddress ?? m.address ?? null,\r\n            sentAt: m.sentAtUtc || m.sentAt || m.createdAt || m.timestamp,\r\n            status: statusRaw,\r\n            errorMessage: m.errorMessage,\r\n          };\r\n        })\r\n        .reverse();\r\n\r\n      const keyOf = msg =>\r\n        String(\r\n          msg.messageLogId ??\r\n            msg.serverId ??\r\n            msg.messageId ??\r\n            msg.providerMessageId ??\r\n            msg.clientMessageId ??\r\n            msg.id\r\n        );\r\n\r\n      if (reset) {\r\n        setMessages(mappedPage);\r\n      } else if (prepend) {\r\n        setMessages(prev => {\r\n          const existing = new Set(prev.map(keyOf));\r\n          const older = mappedPage.filter(m => !existing.has(keyOf(m)));\r\n          return [...older, ...prev];\r\n        });\r\n      }\r\n\r\n      setMessagesNextCursor(nextCursor);\r\n      setMessagesHasMore(hasMore);\r\n    } catch (error) {\r\n      if (error?.name === \"CanceledError\" || error?.code === \"ERR_CANCELED\") {\r\n        return;\r\n      }\r\n      if (messagesRequestIdRef.current !== requestId) return;\r\n      console.error(\"Failed to load messages:\", error);\r\n      toast.error(error.response?.data?.message || \"Failed to load messages.\");\r\n      if (reset) setMessages([]);\r\n    } finally {\r\n      if (messagesRequestIdRef.current !== requestId) return;\r\n      if (reset) setIsMessagesLoading(false);\r\n      if (prepend) setIsMessagesLoadingOlder(false);\r\n      if (messagesRequestAbortRef.current === controller) {\r\n        messagesRequestAbortRef.current = null;\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const intervalId = setInterval(() => {\r\n      fetchConversations({ silent: true, limit: 100 });\r\n    }, 25000);\r\n\r\n    return () => clearInterval(intervalId);\r\n  }, [fetchConversations]);\r\n\r\n  //  Load messages for selected conversation\r\n  useEffect(() => {\r\n    if (messagesRequestAbortRef.current) {\r\n      messagesRequestAbortRef.current.abort();\r\n    }\r\n\r\n    if (messagesLoadTimerRef.current) {\r\n      clearTimeout(messagesLoadTimerRef.current);\r\n    }\r\n\r\n    if (!selectedConversationId) {\r\n      setMessages([]);\r\n      setMessagesNextCursor(null);\r\n      setMessagesHasMore(false);\r\n      setIsMessagesLoading(false);\r\n      return;\r\n    }\r\n\r\n    setMessages([]);\r\n    setMessagesNextCursor(null);\r\n    setMessagesHasMore(false);\r\n    setIsMessagesLoading(true);\r\n    lastMessagesMutationRef.current = \"reset\";\r\n\r\n    const loadMessages = async () => {\r\n      await fetchMessagesPage({\r\n        reset: true,\r\n        limit: DEFAULT_MESSAGES_PAGE_SIZE,\r\n      });\r\n      return;\r\n\r\n      /*\r\n      if (!selectedConversationId) {\r\n        setMessages([]);\r\n        return;\r\n      }\r\n\r\n      const conv = conversationsRef.current.find(\r\n        c => c.id === selectedConversationId\r\n      );\r\n      if (!conv) {\r\n        setMessages([]);\r\n        return;\r\n      }\r\n\r\n      const businessId = localStorage.getItem(\"businessId\");\r\n      if (!businessId) {\r\n        toast.error(\r\n          \" Missing business context. Please login again to load messages.\"\r\n        );\r\n        return;\r\n      }\r\n\r\n      try {\r\n        setIsMessagesLoading(true);\r\n\r\n        const res = await axiosClient.get(\"/chat-inbox/messages\", {\r\n          params: {\r\n            businessId,\r\n            contactPhone: conv.contactPhone,\r\n            limit: 100,\r\n          },\r\n        });\r\n\r\n        const apiItems = Array.isArray(res.data) ? res.data : [];\r\n\r\n        const mapped = apiItems\r\n          .map(m => {\r\n            const isInbound = inferIsInboundFromAny(m);\r\n\r\n            const directionRaw =\r\n              m.direction ?? m.Direction ?? m.dir ?? m.messageDirection ?? \"\";\r\n            const statusRaw = m.status ?? \"\";\r\n\r\n            const providerMessageId =\r\n              m.providerMessageId ?? m.ProviderMessageId ?? null;\r\n            const messageLogId =\r\n              m.messageLogId ?? m.MessageLogId ?? m.messageLogID ?? null;\r\n\r\n            const messageId =\r\n              m.messageId ??\r\n              m.MessageId ??\r\n              m.wamid ??\r\n              m.Wamid ??\r\n              m.waMessageId ??\r\n              m.WaMessageId ??\r\n              providerMessageId ??\r\n              null;\r\n\r\n            const clientMessageId =\r\n              m.clientMessageId ?? m.ClientMessageId ?? null;\r\n\r\n            return {\r\n              id: m.id ?? messageLogId ?? messageId,\r\n              serverId: messageLogId ?? m.id ?? null,\r\n              messageLogId: messageLogId ?? m.id ?? null,\r\n              messageId,\r\n              providerMessageId,\r\n              clientMessageId,\r\n              direction: directionRaw || (isInbound ? \"in\" : \"out\"),\r\n              isInbound,\r\n              text: m.text || m.message || m.body || m.content || \"\",\r\n              sentAt: m.sentAtUtc || m.sentAt || m.createdAt || m.timestamp,\r\n              status: statusRaw,\r\n              errorMessage: m.errorMessage,\r\n            };\r\n          })\r\n          .reverse();\r\n\r\n        setMessages(mapped);\r\n      } catch (error) {\r\n        console.error(\" Failed to load messages:\", error);\r\n        toast.error(\r\n          error.response?.data?.message || \"Failed to load messages.\"\r\n        );\r\n        setMessages([]);\r\n      } finally {\r\n        setIsMessagesLoading(false);\r\n      }\r\n      */\r\n    };\r\n\r\n    messagesLoadTimerRef.current = setTimeout(() => {\r\n      loadMessages();\r\n    }, 200);\r\n\r\n    return () => {\r\n      if (messagesLoadTimerRef.current) {\r\n        clearTimeout(messagesLoadTimerRef.current);\r\n      }\r\n    };\r\n  }, [selectedConversationId, fetchMessagesPage]);\r\n\r\n  //  Mark as read when opening a conversation (HTTP + SignalR)\r\n  //  Mark as read when opening a conversation (HTTP + SignalR)\r\n  useEffect(() => {\r\n    if (!selectedConversationId) return;\r\n\r\n    // 1 Immediate UI clear (optimistic)\r\n    setAllConversations(prev =>\r\n      prev.map(c =>\r\n        c.id === selectedConversationId ? { ...c, unreadCount: 0 } : c\r\n      )\r\n    );\r\n\r\n    if (selectedConversation) {\r\n      markConversationUnreadCleared(selectedConversation);\r\n    }\r\n\r\n    if (markReadTimerRef.current) {\r\n      clearTimeout(markReadTimerRef.current);\r\n    }\r\n\r\n    markReadTimerRef.current = setTimeout(() => {\r\n      const businessId = localStorage.getItem(\"businessId\");\r\n      const contactId = selectedConversation?.contactId;\r\n\r\n      //  userId REMOVED  backend uses JWT claims\r\n      if (!businessId || !contactId) return;\r\n\r\n      const payload = {\r\n        businessId,\r\n        contactId,\r\n        lastReadAtUtc: new Date().toISOString(),\r\n      };\r\n\r\n      axiosClient.post(\"/chat-inbox/mark-read\", payload).catch(err => {\r\n        console.error(\"Failed to mark conversation as read:\", err);\r\n      });\r\n\r\n      // SignalR sync (best-effort)\r\n      if (connection && isConnected) {\r\n        connection.invoke(\"MarkAsRead\", contactId).catch(err => {\r\n          console.warn(\"SignalR MarkAsRead failed:\", err);\r\n        });\r\n      }\r\n    }, 200);\r\n\r\n    return () => {\r\n      if (markReadTimerRef.current) {\r\n        clearTimeout(markReadTimerRef.current);\r\n      }\r\n    };\r\n  }, [\r\n    selectedConversationId,\r\n    selectedConversation?.contactId,\r\n    connection,\r\n    isConnected,\r\n    markConversationUnreadCleared,\r\n  ]);\r\n\r\n  //  Helper to (re)load CRM contact summary\r\n  const refreshContactSummary = useCallback(async () => {\r\n    if (!selectedContactId) {\r\n      setContactSummary(null);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsSummaryLoading(true);\r\n      const res = await axiosClient.get(\r\n        `/crm/contact-summary/${selectedContactId}`\r\n      );\r\n      const payload = res.data?.data ?? res.data;\r\n      setContactSummary(payload || null);\r\n    } catch (error) {\r\n      console.error(\" Failed to load contact summary:\", error);\r\n      setContactSummary(null);\r\n    } finally {\r\n      setIsSummaryLoading(false);\r\n    }\r\n  }, [selectedContactId]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedContactId) {\r\n      setContactSummary(null);\r\n      return;\r\n    }\r\n    refreshContactSummary();\r\n  }, [selectedContactId, refreshContactSummary]);\r\n\r\n  //  Remove/unassign tag from contact (MVP)\r\n  const handleRemoveTag = useCallback(\r\n    async tag => {\r\n      if (!selectedContactId) {\r\n        toast.warn(\"No contact selected.\");\r\n        return;\r\n      }\r\n\r\n      const tagId = tag?.id || tag?.tagId;\r\n      const tagName = tag?.tagName || tag?.name || \"tag\";\r\n\r\n      if (!tagId) {\r\n        toast.error(\"Cannot remove this tag (missing tagId).\");\r\n        return;\r\n      }\r\n\r\n      if (removingTagId) return;\r\n\r\n      // Optimistic UI: remove it from contactSummary immediately\r\n      setContactSummary(prev => {\r\n        if (!prev) return prev;\r\n        const removeFrom = arr =>\r\n          Array.isArray(arr)\r\n            ? arr.filter(t => (t?.id || t?.tagId) !== tagId)\r\n            : arr;\r\n\r\n        return {\r\n          ...prev,\r\n          tags: removeFrom(prev.tags),\r\n          contactTags: removeFrom(prev.contactTags),\r\n          contactTagsDto: removeFrom(prev.contactTagsDto),\r\n        };\r\n      });\r\n\r\n      setRemovingTagId(tagId);\r\n\r\n      try {\r\n        const body = {\r\n          contactIds: [selectedContactId],\r\n          tagId,\r\n        };\r\n\r\n        // Try DELETE first, fallback to POST (some APIs enforce POST-only)\r\n        try {\r\n          await axiosClient.request({\r\n            url: \"/contacts/bulk-unassign-tag\",\r\n            method: \"DELETE\",\r\n            data: body,\r\n          });\r\n        } catch (err) {\r\n          const status = err?.response?.status;\r\n          if (status === 404 || status === 405) {\r\n            await axiosClient.post(\"/contacts/bulk-unassign-tag\", body);\r\n          } else {\r\n            throw err;\r\n          }\r\n        }\r\n\r\n        toast.success(`Removed \"${tagName}\"`);\r\n        await refreshContactSummary();\r\n      } catch (error) {\r\n        console.error(\"Failed to remove tag:\", error);\r\n        toast.error(\r\n          error?.response?.data?.message || `Failed to remove \"${tagName}\".`\r\n        );\r\n        await refreshContactSummary();\r\n      } finally {\r\n        setRemovingTagId(null);\r\n      }\r\n    },\r\n    [selectedContactId, removingTagId, refreshContactSummary]\r\n  );\r\n\r\n  // Auto-scroll when messages change\r\n  useEffect(() => {\r\n    if (!selectedConversationId) return;\r\n    if (isMessagesLoading) return;\r\n    if (messages.length === 0) return;\r\n\r\n    const lastMutation = lastMessagesMutationRef.current;\r\n    if (lastMutation === \"prepend\") {\r\n      lastMessagesMutationRef.current = null;\r\n      return;\r\n    }\r\n    lastMessagesMutationRef.current = null;\r\n\r\n    scrollToBottom();\r\n  }, [messages, isMessagesLoading, selectedConversationId, scrollToBottom]);\r\n\r\n  //  Messages + date separators\r\n  const messagesWithSeparators = useMemo(() => {\r\n    const result = [];\r\n    let lastDateKey = null;\r\n\r\n    messages.forEach(m => {\r\n      const dateObj = m.sentAt ? new Date(m.sentAt) : null;\r\n      const key = dateObj ? dateObj.toDateString() : \"unknown\";\r\n\r\n      if (key !== lastDateKey) {\r\n        if (dateObj) {\r\n          result.push({\r\n            type: \"separator\",\r\n            id: `sep-${key}`,\r\n            label: formatDayLabel(dateObj),\r\n          });\r\n        }\r\n        lastDateKey = key;\r\n      }\r\n\r\n      result.push({ type: \"message\", ...m });\r\n    });\r\n\r\n    return result;\r\n  }, [messages]);\r\n\r\n  //  SignalR: ReceiveInboxMessage handler\r\n  const handleReceiveInboxMessage = useCallback(\r\n    payload => {\r\n      if (!payload) return;\r\n\r\n      const contactId = payload.contactId ?? payload.ContactId ?? null;\r\n      const conversationId =\r\n        payload.conversationId ?? payload.ConversationId ?? null;\r\n\r\n      const mappedMsg = mapHubMessageToChat(payload);\r\n      if (!mappedMsg) return;\r\n      const mappedMediaType = String(mappedMsg.mediaType || \"\")\r\n        .trim()\r\n        .toLowerCase();\r\n      const mappedHasMedia =\r\n        Boolean(mappedMsg.mediaId) &&\r\n        (mappedMediaType === \"image\" ||\r\n          mappedMediaType === \"document\" ||\r\n          mappedMediaType === \"video\" ||\r\n          mappedMediaType === \"audio\");\r\n      const mappedLat = toLatitudeOrNull(mappedMsg.locationLatitude);\r\n      const mappedLon = toLongitudeOrNull(mappedMsg.locationLongitude);\r\n      const mappedHasLocation =\r\n        mappedMediaType === \"location\" &&\r\n        mappedLat !== null &&\r\n        mappedLon !== null;\r\n\r\n      // 1) Update messages if this conversation is open\r\n      setMessages(prev => {\r\n        const openConv = selectedConversationRef.current;\r\n        if (!openConv) return prev;\r\n\r\n        const matchesOpenConversation =\r\n          (conversationId && openConv.id && openConv.id === conversationId) ||\r\n          (contactId &&\r\n            openConv.contactId &&\r\n            openConv.contactId === contactId) ||\r\n          (payload.contactPhone &&\r\n            openConv.contactPhone &&\r\n            openConv.contactPhone === payload.contactPhone);\r\n\r\n        if (!matchesOpenConversation) return prev;\r\n\r\n        //  Merge-by-identity: update existing bubble when a status update arrives\r\n        const sameMessage = (existing, incoming, raw) => {\r\n          const incMessageId =\r\n            incoming?.messageId ||\r\n            raw?.messageId ||\r\n            raw?.MessageId ||\r\n            raw?.wamid ||\r\n            raw?.Wamid ||\r\n            null;\r\n\r\n          const incClientId =\r\n            incoming?.clientMessageId ||\r\n            raw?.clientMessageId ||\r\n            raw?.ClientMessageId ||\r\n            raw?.clientId ||\r\n            null;\r\n\r\n          if (\r\n            existing?.messageId &&\r\n            incMessageId &&\r\n            existing.messageId === incMessageId\r\n          )\r\n            return true;\r\n\r\n          if (\r\n            existing?.clientMessageId &&\r\n            incClientId &&\r\n            existing.clientMessageId === incClientId\r\n          )\r\n            return true;\r\n\r\n          if (existing?.id && incoming?.id && existing.id === incoming.id)\r\n            return true;\r\n\r\n          if (existing?.id && incMessageId && existing.id === incMessageId)\r\n            return true;\r\n\r\n          if (\r\n            existing?.serverId &&\r\n            incoming?.id &&\r\n            existing.serverId === incoming.id\r\n          )\r\n            return true;\r\n\r\n          return false;\r\n        };\r\n\r\n        const idx = prev.findIndex(m => sameMessage(m, mappedMsg, payload));\r\n\r\n        //  If already exists, update status/time/error instead of adding duplicate\r\n        if (idx >= 0) {\r\n          const existing = prev[idx];\r\n\r\n          const merged = {\r\n            ...existing,\r\n            ...mappedMsg,\r\n            text: mappedMsg.text || existing.text,\r\n            sentAt: mappedMsg.sentAt || existing.sentAt,\r\n            status: mappedMsg.status || existing.status,\r\n            messageId: mappedMsg.messageId || existing.messageId || null,\r\n            clientMessageId:\r\n              mappedMsg.clientMessageId || existing.clientMessageId || null,\r\n            serverId: existing.serverId ?? null,\r\n            errorMessage:\r\n              mappedMsg.errorMessage ?? existing.errorMessage ?? null,\r\n          };\r\n\r\n          const next = [...prev];\r\n          next[idx] = merged;\r\n          return next;\r\n        }\r\n\r\n        // If this hub payload has no real message text, it's very likely a status-only event.\r\n        // Don't create a new bubble for it.\r\n        const isEmptyText =\r\n          !mappedMsg.text || String(mappedMsg.text).trim().length === 0;\r\n\r\n        // Media-only inbound messages can have empty text (no caption). We still want to show the bubble.\r\n        if (isEmptyText && !mappedHasMedia && !mappedHasLocation) {\r\n          return prev; // <-- prevents \"-\" ghost bubbles\r\n        }\r\n        return [...prev, mappedMsg];\r\n      });\r\n\r\n      // 2) Update conversations list\r\n      let matched = false;\r\n\r\n      setAllConversations(prev => {\r\n        const openConv = selectedConversationRef.current;\r\n\r\n        const next = prev.map(c => {\r\n          const isMatch =\r\n            (conversationId && c.id === conversationId) ||\r\n            (contactId && c.contactId === contactId) ||\r\n            (payload.contactPhone && c.contactPhone === payload.contactPhone);\r\n\r\n          if (!isMatch) return c;\r\n\r\n          matched = true;\r\n\r\n          const isOpen =\r\n            !!openConv &&\r\n            ((openConv.id && c.id === openConv.id) ||\r\n              (openConv.contactId && c.contactId === openConv.contactId));\r\n\r\n          const localUnread = getLocalUnreadOverride(c);\r\n          const baseUnread =\r\n            typeof localUnread === \"number\" ? localUnread : c.unreadCount ?? 0;\r\n          const nextUnread =\r\n            mappedMsg.isInbound && !isOpen ? baseUnread + 1 : baseUnread;\r\n\r\n          if (\r\n            typeof localUnread === \"number\" &&\r\n            mappedMsg.isInbound &&\r\n            !isOpen\r\n          ) {\r\n            setLocalUnreadOverride(c, nextUnread);\r\n          }\r\n\r\n          const trimmedText = String(mappedMsg.text || \"\").trim();\r\n          const fallbackPreview = mappedHasMedia\r\n            ? mappedMediaType === \"image\"\r\n              ? \"Photo\"\r\n              : mappedMediaType === \"document\"\r\n              ? String(mappedMsg.fileName || \"\").trim() || \"PDF\"\r\n              : mappedMediaType === \"video\"\r\n              ? String(mappedMsg.fileName || \"\").trim() || \"Video\"\r\n              : String(mappedMsg.fileName || \"\").trim() || \"Audio\"\r\n            : mappedHasLocation\r\n            ? String(mappedMsg.locationName || \"\").trim() || \"Location\"\r\n            : null;\r\n\r\n          return {\r\n            ...c,\r\n            lastMessagePreview:\r\n              trimmedText || fallbackPreview || c.lastMessagePreview,\r\n            lastMessageAt: mappedMsg.sentAt || c.lastMessageAt,\r\n            lastInboundAt: mappedMsg.isInbound\r\n              ? mappedMsg.sentAt || c.lastInboundAt\r\n              : c.lastInboundAt,\r\n            lastOutboundAt: !mappedMsg.isInbound\r\n              ? mappedMsg.sentAt || c.lastOutboundAt\r\n              : c.lastOutboundAt,\r\n            within24h: mappedMsg.isInbound ? true : c.within24h,\r\n            status:\r\n              mappedMsg.isInbound &&\r\n              parseConversationStatus(c.status) === \"Closed\"\r\n                ? \"Open\"\r\n                : c.status,\r\n            unreadCount: isOpen ? 0 : nextUnread,\r\n          };\r\n        });\r\n\r\n        return next;\r\n      });\r\n\r\n      if (!matched) {\r\n        fetchConversations({ silent: true, limit: 100 });\r\n      }\r\n    },\r\n    [fetchConversations, getLocalUnreadOverride, setLocalUnreadOverride]\r\n  );\r\n\r\n  //  SignalR: UnreadCountChanged handler\r\n  const handleUnreadCountChanged = useCallback(\r\n    payload => {\r\n      if (!payload) return;\r\n\r\n      if (payload.refresh) {\r\n        fetchConversations({ silent: true, limit: 100 });\r\n        return;\r\n      }\r\n\r\n      // if (payload.contactId) {\r\n      //   const hasUnread =\r\n      //     typeof payload.unreadCount === \"number\" &&\r\n      //     !Number.isNaN(payload.unreadCount);\r\n\r\n      //   if (!hasUnread) return;\r\n\r\n      //   setAllConversations(prev =>\r\n      //     prev.map(c =>\r\n      //       c.contactId === payload.contactId\r\n      //         ? { ...c, unreadCount: payload.unreadCount }\r\n      //         : c\r\n      //     )\r\n      //   );\r\n      //   return;\r\n      // }\r\n      if (payload.contactId) {\r\n        const hasUnread =\r\n          typeof payload.unreadCount === \"number\" &&\r\n          !Number.isNaN(payload.unreadCount);\r\n\r\n        if (!hasUnread) return;\r\n\r\n        const open = selectedConversationRef.current;\r\n        const localEntry = getClearedUnreadEntryByContactId(payload.contactId);\r\n        const localUnread =\r\n          typeof localEntry?.localUnread === \"number\"\r\n            ? localEntry.localUnread\r\n            : null;\r\n\r\n        setAllConversations(prev =>\r\n          prev.map(c => {\r\n            if (c.contactId !== payload.contactId) return c;\r\n\r\n            const isOpen =\r\n              !!open &&\r\n              ((open.id && c.id === open.id) ||\r\n                (open.contactId && c.contactId === open.contactId) ||\r\n                (open.contactPhone && c.contactPhone === open.contactPhone));\r\n\r\n            if (typeof localUnread === \"number\") {\r\n              const nextUnread =\r\n                payload.unreadCount > 0 ? Math.max(localUnread, 1) : 0;\r\n              if (!isOpen && nextUnread !== localUnread) {\r\n                setLocalUnreadOverride(c, nextUnread);\r\n              }\r\n              return { ...c, unreadCount: isOpen ? 0 : nextUnread };\r\n            }\r\n\r\n            return { ...c, unreadCount: isOpen ? 0 : payload.unreadCount };\r\n          })\r\n        );\r\n        return;\r\n      }\r\n\r\n      // if (Array.isArray(payload.items)) {\r\n      //   const map = new Map();\r\n      //   payload.items.forEach(item => {\r\n      //     if (!item?.contactId) return;\r\n      //     if (typeof item.unreadCount !== \"number\") return;\r\n      //     map.set(item.contactId, item.unreadCount);\r\n      //   });\r\n\r\n      //   if (map.size === 0) return;\r\n\r\n      //   setAllConversations(prev =>\r\n      //     prev.map(c =>\r\n      //       map.has(c.contactId)\r\n      //         ? { ...c, unreadCount: map.get(c.contactId) }\r\n      //         : c\r\n      //     )\r\n      //   );\r\n      // }\r\n      if (Array.isArray(payload.items)) {\r\n        const map = new Map();\r\n        payload.items.forEach(item => {\r\n          if (!item?.contactId) return;\r\n          if (typeof item.unreadCount !== \"number\") return;\r\n          map.set(item.contactId, item.unreadCount);\r\n        });\r\n\r\n        if (map.size === 0) return;\r\n\r\n        const open = selectedConversationRef.current;\r\n\r\n        setAllConversations(prev =>\r\n          prev.map(c => {\r\n            if (!map.has(c.contactId)) return c;\r\n\r\n            const nextUnread = map.get(c.contactId);\r\n            const localUnread = getLocalUnreadOverride(c);\r\n\r\n            const isOpen =\r\n              !!open &&\r\n              ((open.id && c.id === open.id) ||\r\n                (open.contactId && c.contactId === open.contactId) ||\r\n                (open.contactPhone && c.contactPhone === open.contactPhone));\r\n\r\n            if (typeof localUnread === \"number\") {\r\n              const mergedUnread =\r\n                nextUnread > 0 ? Math.max(localUnread, 1) : 0;\r\n              if (!isOpen && mergedUnread !== localUnread) {\r\n                setLocalUnreadOverride(c, mergedUnread);\r\n              }\r\n              return { ...c, unreadCount: isOpen ? 0 : mergedUnread };\r\n            }\r\n\r\n            return { ...c, unreadCount: isOpen ? 0 : nextUnread };\r\n          })\r\n        );\r\n      }\r\n    },\r\n    [\r\n      fetchConversations,\r\n      getClearedUnreadEntryByContactId,\r\n      getLocalUnreadOverride,\r\n      setLocalUnreadOverride,\r\n    ]\r\n  );\r\n\r\n  //  SignalR: MessageStatusChanged handler (outbound delivery/read ticks)\r\n  const handleMessageStatusChanged = useCallback(payload => {\r\n    if (!payload) return;\r\n\r\n    const openConv = selectedConversationRef.current;\r\n    if (!openConv) return;\r\n\r\n    const contactId = payload.contactId ?? payload.ContactId ?? null;\r\n    if (contactId && openConv.contactId && openConv.contactId !== contactId)\r\n      return;\r\n\r\n    const messageLogId = payload.messageLogId ?? payload.MessageLogId ?? null;\r\n    const providerMessageId =\r\n      payload.providerMessageId ?? payload.ProviderMessageId ?? null;\r\n    const messageId = payload.messageId ?? payload.MessageId ?? null;\r\n    const nextStatus = payload.status ?? payload.Status ?? null;\r\n    if (!nextStatus) return;\r\n\r\n    const rank = s => {\r\n      const v = String(s || \"\")\r\n        .trim()\r\n        .toLowerCase();\r\n      if (!v) return 0;\r\n      if (v === \"failed\" || v === \"error\" || v.includes(\"fail\")) return 99;\r\n      if (v === \"read\" || v === \"seen\" || v === \"viewed\" || v.includes(\"read\"))\r\n        return 4;\r\n      if (v === \"delivered\" || v.includes(\"deliver\")) return 3;\r\n      if (v === \"sent\") return 2;\r\n      if (\r\n        v === \"queued\" ||\r\n        v === \"sending\" ||\r\n        v === \"pending\" ||\r\n        v.includes(\"queue\") ||\r\n        v.includes(\"send\") ||\r\n        v.includes(\"progress\")\r\n      )\r\n        return 1;\r\n      return 0;\r\n    };\r\n\r\n    setMessages(prev =>\r\n      prev.map(m => {\r\n        const matchesByLogId =\r\n          !!messageLogId &&\r\n          (m.id === messageLogId || m.serverId === messageLogId);\r\n\r\n        const matchesByProviderId =\r\n          !!providerMessageId &&\r\n          (m.providerMessageId === providerMessageId ||\r\n            m.messageId === providerMessageId ||\r\n            m.id === providerMessageId);\r\n\r\n        const matchesByMessageId =\r\n          !!messageId && (m.messageId === messageId || m.id === messageId);\r\n\r\n        const matches =\r\n          matchesByLogId || matchesByProviderId || matchesByMessageId;\r\n        if (!matches) return m;\r\n\r\n        const currentRank = rank(m.status);\r\n        const nextRank = rank(nextStatus);\r\n        if (nextRank < currentRank) return m;\r\n\r\n        return { ...m, status: nextStatus };\r\n      })\r\n    );\r\n  }, []);\r\n\r\n  //  Subscribe to SignalR events\r\n  useEffect(() => {\r\n    if (!connection || !isConnected) return;\r\n\r\n    connection.on(\"ReceiveInboxMessage\", handleReceiveInboxMessage);\r\n    connection.on(\"UnreadCountChanged\", handleUnreadCountChanged);\r\n    connection.on(\"MessageStatusChanged\", handleMessageStatusChanged);\r\n\r\n    return () => {\r\n      connection.off(\"ReceiveInboxMessage\", handleReceiveInboxMessage);\r\n      connection.off(\"UnreadCountChanged\", handleUnreadCountChanged);\r\n      connection.off(\"MessageStatusChanged\", handleMessageStatusChanged);\r\n    };\r\n  }, [\r\n    connection,\r\n    isConnected,\r\n    handleReceiveInboxMessage,\r\n    handleUnreadCountChanged,\r\n    handleMessageStatusChanged,\r\n  ]);\r\n\r\n  //  Send message (HTTP is source of truth)\r\n  const handleSendMessage = async outbound => {\r\n    if (!selectedConversation) {\r\n      toast.warn(\"Please select a conversation first.\");\r\n      return;\r\n    }\r\n\r\n    if (isConversationClosed) {\r\n      toast.warn(\"This conversation is closed. Reopen it to reply.\");\r\n      return;\r\n    }\r\n\r\n    if (!isWithin24h) {\r\n      toast.warn(\r\n        \"This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    const mediaId = outbound?.mediaId ?? outbound?.MediaId ?? null;\r\n    const mediaTypeRaw = outbound?.mediaType ?? outbound?.MediaType ?? null;\r\n    const fileName = outbound?.fileName ?? outbound?.FileName ?? null;\r\n    const mimeType = outbound?.mimeType ?? outbound?.MimeType ?? null;\r\n    const localPreviewUrl = outbound?.localPreviewUrl ?? null;\r\n    const locationLatitude =\r\n      outbound?.locationLatitude ?? outbound?.LocationLatitude ?? null;\r\n    const locationLongitude =\r\n      outbound?.locationLongitude ?? outbound?.LocationLongitude ?? null;\r\n    const locationName = outbound?.locationName ?? outbound?.LocationName ?? null;\r\n    const locationAddress =\r\n      outbound?.locationAddress ?? outbound?.LocationAddress ?? null;\r\n\r\n    const caption =\r\n      typeof outbound?.text === \"string\"\r\n        ? outbound.text\r\n        : typeof outbound?.Text === \"string\"\r\n        ? outbound.Text\r\n        : newMessage;\r\n\r\n    const trimmedCaption = String(caption || \"\").trim();\r\n    const hasMedia = Boolean(String(mediaId || \"\").trim());\r\n    const latNum = toLatitudeOrNull(locationLatitude);\r\n    const lonNum = toLongitudeOrNull(locationLongitude);\r\n    const hasLocation =\r\n      latNum !== null && lonNum !== null;\r\n\r\n    if (hasLocation && (hasMedia || trimmedCaption)) {\r\n      toast.error(\"Location message cannot include text or an attachment.\");\r\n      return;\r\n    }\r\n\r\n    if (!hasMedia && !trimmedCaption && !hasLocation) {\r\n      toast.warn(\"Type a message before sending.\");\r\n      return;\r\n    }\r\n\r\n    const mediaType = hasLocation\r\n      ? \"location\"\r\n      : String(mediaTypeRaw || \"\")\r\n          .trim()\r\n          .toLowerCase() ||\r\n        (hasMedia ? inferChatInboxMediaType(mimeType) : \"\");\r\n\r\n    if (hasMedia && mediaType === \"audio\" && trimmedCaption) {\r\n      toast.error(\"Audio messages do not support captions.\");\r\n      return;\r\n    }\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) {\r\n      toast.error(\"Missing business context. Please login again.\");\r\n      return;\r\n    }\r\n\r\n    if (isSending) return;\r\n\r\n    const normalizeStatus = raw => {\r\n      const s = String(raw || \"\")\r\n        .trim()\r\n        .toLowerCase();\r\n      if (!s) return null;\r\n\r\n      if (s.includes(\"fail\") || s.includes(\"error\") || s.includes(\"reject\"))\r\n        return \"Failed\";\r\n      if (s.includes(\"read\") || s === \"seen\" || s === \"viewed\") return \"Read\";\r\n      if (s.includes(\"deliver\")) return \"Delivered\";\r\n      if (s === \"sent\") return \"Sent\";\r\n\r\n      if (\r\n        s.includes(\"queue\") ||\r\n        s === \"queued\" ||\r\n        s.includes(\"send\") ||\r\n        s === \"sending\" ||\r\n        s === \"pending\" ||\r\n        s.includes(\"accept\") ||\r\n        s.includes(\"submit\") ||\r\n        s.includes(\"process\") ||\r\n        s.includes(\"progress\")\r\n      ) {\r\n        return \"Queued\";\r\n      }\r\n\r\n      return \"Queued\";\r\n    };\r\n\r\n    const tempId = `temp-${Date.now()}`;\r\n    const nowIso = new Date().toISOString();\r\n\r\n    if (localPreviewUrl) {\r\n      localObjectUrlByTempIdRef.current.set(tempId, localPreviewUrl);\r\n    }\r\n\r\n    const optimisticMsg = {\r\n      id: tempId,\r\n      clientMessageId: tempId,\r\n      direction: \"out\",\r\n      isInbound: false,\r\n      text: trimmedCaption,\r\n      mediaId: hasMedia ? String(mediaId).trim() : null,\r\n      mediaType: hasLocation ? \"location\" : hasMedia ? mediaType : null,\r\n      fileName: hasMedia ? fileName : null,\r\n      mimeType: hasMedia ? mimeType : null,\r\n      localPreviewUrl: hasMedia ? localPreviewUrl : null,\r\n      locationLatitude: hasLocation ? latNum : null,\r\n      locationLongitude: hasLocation ? lonNum : null,\r\n      locationName: hasLocation ? locationName : null,\r\n      locationAddress: hasLocation ? locationAddress : null,\r\n      sentAt: nowIso,\r\n      status: \"Queued\",\r\n      errorMessage: null,\r\n    };\r\n\r\n    setMessages(prev => [...prev, optimisticMsg]);\r\n    setNewMessage(\"\");\r\n    setIsSending(true);\r\n\r\n    try {\r\n      const payload = {\r\n        businessId,\r\n        conversationId: selectedConversation.id,\r\n        contactId: selectedConversation.contactId,\r\n        to: selectedConversation.contactPhone,\r\n        text: hasLocation ? null : trimmedCaption || null,\r\n        mediaId: hasMedia ? String(mediaId).trim() : null,\r\n        mediaType: hasLocation ? \"location\" : hasMedia ? mediaType : null,\r\n        fileName: hasMedia ? fileName : null,\r\n        mimeType: hasMedia ? mimeType : null,\r\n        locationLatitude: hasLocation ? latNum : null,\r\n        locationLongitude: hasLocation ? lonNum : null,\r\n        locationName: hasLocation ? locationName : null,\r\n        locationAddress: hasLocation ? locationAddress : null,\r\n        numberId: selectedConversation.numberId,\r\n        clientMessageId: tempId,\r\n      };\r\n\r\n      const res = await axiosClient.post(\"/chat-inbox/send-message\", payload);\r\n      const saved = res.data || {};\r\n\r\n      const finalSentAt =\r\n        saved.sentAtUtc || saved.sentAt || optimisticMsg.sentAt;\r\n      const finalSentAtIso =\r\n        finalSentAt instanceof Date ? finalSentAt.toISOString() : finalSentAt;\r\n\r\n      const serverStatus = normalizeStatus(saved.status) || \"Queued\";\r\n\r\n      const savedMediaId = saved.mediaId ?? saved.MediaId ?? null;\r\n      const savedMediaType = saved.mediaType ?? saved.MediaType ?? null;\r\n      const savedFileName = saved.fileName ?? saved.FileName ?? null;\r\n      const savedMimeType = saved.mimeType ?? saved.MimeType ?? null;\r\n      const savedLocationLatitude =\r\n        saved.locationLatitude ?? saved.LocationLatitude ?? null;\r\n      const savedLocationLongitude =\r\n        saved.locationLongitude ?? saved.LocationLongitude ?? null;\r\n      const savedLocationName = saved.locationName ?? saved.LocationName ?? null;\r\n      const savedLocationAddress =\r\n        saved.locationAddress ?? saved.LocationAddress ?? null;\r\n\r\n      setMessages(prev =>\r\n        prev.map(m =>\r\n          m.id === tempId\r\n            ? {\r\n                ...m,\r\n                id: m.id,\r\n                serverId: saved.id ?? null,\r\n                messageId:\r\n                  saved.messageId ??\r\n                  saved.wamid ??\r\n                  saved.waMessageId ??\r\n                  saved.providerMessageId ??\r\n                  null,\r\n                sentAt: finalSentAtIso,\r\n                status: serverStatus,\r\n                errorMessage: saved.errorMessage || null,\r\n                mediaId: savedMediaId ?? m.mediaId ?? null,\r\n                mediaType: savedMediaType ?? m.mediaType ?? null,\r\n                fileName: savedFileName ?? m.fileName ?? null,\r\n                mimeType: savedMimeType ?? m.mimeType ?? null,\r\n                locationLatitude:\r\n                  savedLocationLatitude ?? m.locationLatitude ?? null,\r\n                locationLongitude:\r\n                  savedLocationLongitude ?? m.locationLongitude ?? null,\r\n                locationName: savedLocationName ?? m.locationName ?? null,\r\n                locationAddress:\r\n                  savedLocationAddress ?? m.locationAddress ?? null,\r\n              }\r\n            : m\r\n        )\r\n      );\r\n\r\n      const preview =\r\n        trimmedCaption ||\r\n        (hasLocation\r\n          ? String(locationName || \"\").trim() || \"Location\"\r\n          : hasMedia\r\n          ? mediaType === \"document\"\r\n            ? `PDF sent${fileName ? `: ${fileName}` : \"\"}`\r\n            : mediaType === \"video\"\r\n            ? `Video sent${fileName ? `: ${fileName}` : \"\"}`\r\n            : mediaType === \"audio\"\r\n            ? `Audio sent${fileName ? `: ${fileName}` : \"\"}`\r\n            : `Image sent${fileName ? `: ${fileName}` : \"\"}`\r\n          : \"\");\r\n\r\n      setAllConversations(prev =>\r\n        prev.map(c =>\r\n          c.id === selectedConversation.id\r\n            ? {\r\n                ...c,\r\n                lastMessagePreview: preview,\r\n                lastMessageAt: finalSentAtIso,\r\n                lastOutboundAt: finalSentAtIso,\r\n              }\r\n            : c\r\n        )\r\n      );\r\n    } catch (error) {\r\n      console.error(\" Failed to send message:\", error);\r\n      toast.error(\r\n        error.response?.data?.message || \"Failed to send message. Please retry.\"\r\n      );\r\n\r\n      setMessages(prev =>\r\n        prev.map(m =>\r\n          m.id === tempId\r\n            ? { ...m, status: \"Failed\", errorMessage: \"Not delivered\" }\r\n            : m\r\n        )\r\n      );\r\n    } finally {\r\n      setIsSending(false);\r\n      scrollToBottom();\r\n    }\r\n  };\r\n\r\n  const handleUploadAndSendMedia = async file => {\r\n    if (!file) return;\r\n\r\n    if (!selectedConversation) {\r\n      toast.warn(\"Please select a conversation first.\");\r\n      return;\r\n    }\r\n\r\n    if (isConversationClosed) {\r\n      toast.warn(\"This conversation is closed. Reopen it to reply.\");\r\n      return;\r\n    }\r\n\r\n    if (!isWithin24h) {\r\n      toast.warn(\r\n        \"This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (isUploadingMedia || isSending) return;\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) {\r\n      toast.error(\"Missing business context. Please login again.\");\r\n      return;\r\n    }\r\n\r\n    const sizeBytes = Number(file.size) || 0;\r\n    if (!sizeBytes) {\r\n      toast.error(\"Selected file is empty.\");\r\n      return;\r\n    }\r\n\r\n    if (sizeBytes > CHAT_INBOX_MEDIA_MAX_BYTES) {\r\n      toast.error(\"File is too large. Max allowed is 10MB.\");\r\n      return;\r\n    }\r\n\r\n    const inferredMime = (() => {\r\n      const raw = String(file.type || \"\").split(\";\")[0].trim();\r\n      if (raw) return raw;\r\n\r\n      const name = String(file.name || \"\").toLowerCase().trim();\r\n      if (name.endsWith(\".pdf\")) return \"application/pdf\";\r\n      if (name.endsWith(\".mp4\")) return \"video/mp4\";\r\n      if (name.endsWith(\".3gp\") || name.endsWith(\".3gpp\")) return \"video/3gpp\";\r\n      if (name.endsWith(\".mp3\")) return \"audio/mpeg\";\r\n      if (name.endsWith(\".m4a\")) return \"audio/mp4\";\r\n      if (name.endsWith(\".aac\")) return \"audio/aac\";\r\n      if (name.endsWith(\".ogg\")) return \"audio/ogg\";\r\n      return \"\";\r\n    })();\r\n\r\n    if (!CHAT_INBOX_ALLOWED_MIME_TYPES.has(inferredMime)) {\r\n      toast.error(\r\n        \"Unsupported file type. Allowed: images (jpg/png/webp), PDF, MP4 video, and audio (mp3/m4a/aac/ogg).\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    setIsUploadingMedia(true);\r\n\r\n    let localPreviewUrl = null;\r\n    let keepLocalPreviewUrl = false;\r\n\r\n    try {\r\n      try {\r\n        if (\r\n          typeof URL !== \"undefined\" &&\r\n          typeof URL.createObjectURL === \"function\"\r\n        ) {\r\n          localPreviewUrl = URL.createObjectURL(file);\r\n        }\r\n      } catch {\r\n        localPreviewUrl = null;\r\n      }\r\n\r\n      const form = new FormData();\r\n      form.append(\"file\", file);\r\n\r\n      const res = await axiosClient.post(\"/chat-inbox/media/upload\", form, {\r\n        headers: { \"Content-Type\": \"multipart/form-data\" },\r\n      });\r\n\r\n      const data = res?.data || {};\r\n      const uploadedMediaId = data.mediaId ?? data.MediaId ?? null;\r\n      const uploadedMediaType = data.mediaType ?? data.MediaType ?? null;\r\n\r\n      if (!uploadedMediaId) {\r\n        toast.error(\"Upload succeeded but mediaId was missing.\");\r\n        return;\r\n      }\r\n\r\n      const mt =\r\n        String(uploadedMediaType || \"\").trim().toLowerCase() ||\r\n        inferChatInboxMediaType(inferredMime);\r\n\r\n      keepLocalPreviewUrl = true;\r\n      await handleSendMessage({\r\n        text: newMessage,\r\n        mediaId: uploadedMediaId,\r\n        mediaType: mt,\r\n        fileName: data.fileName ?? data.FileName ?? file.name ?? null,\r\n        mimeType: data.mimeType ?? data.MimeType ?? inferredMime,\r\n        localPreviewUrl,\r\n      });\r\n    } catch (error) {\r\n      console.error(\" Failed to upload media:\", error);\r\n      toast.error(\r\n        error.response?.data?.message || \"Failed to upload file. Please retry.\"\r\n      );\r\n    } finally {\r\n      if (localPreviewUrl && !keepLocalPreviewUrl) {\r\n        try {\r\n          URL.revokeObjectURL(localPreviewUrl);\r\n        } catch {}\r\n      }\r\n      setIsUploadingMedia(false);\r\n    }\r\n  };\r\n\r\n  const handleSendLocation = async () => {\r\n    if (!selectedConversation) {\r\n      toast.warn(\"Please select a conversation first.\");\r\n      return;\r\n    }\r\n\r\n    if (isConversationClosed) {\r\n      toast.warn(\"This conversation is closed. Reopen it to reply.\");\r\n      return;\r\n    }\r\n\r\n    if (!isWithin24h) {\r\n      toast.warn(\r\n        \"This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (isUploadingMedia || isSending) return;\r\n\r\n    if (typeof navigator === \"undefined\" || !navigator.geolocation) {\r\n      toast.error(\"Geolocation is not available in this browser.\");\r\n      return;\r\n    }\r\n\r\n    toast.info(\"Fetching your current location\");\r\n\r\n    try {\r\n      const pos = await new Promise((resolve, reject) => {\r\n        navigator.geolocation.getCurrentPosition(resolve, reject, {\r\n          enableHighAccuracy: true,\r\n          timeout: 12000,\r\n          maximumAge: 0,\r\n        });\r\n      });\r\n\r\n      const lat = pos?.coords?.latitude;\r\n      const lon = pos?.coords?.longitude;\r\n\r\n      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {\r\n        toast.error(\"Failed to read your coordinates.\");\r\n        return;\r\n      }\r\n\r\n      await handleSendMessage({\r\n        locationLatitude: lat,\r\n        locationLongitude: lon,\r\n        locationName: null,\r\n        locationAddress: null,\r\n      });\r\n    } catch (error) {\r\n      const code = error?.code;\r\n      if (code === 1) {\r\n        toast.error(\"Location permission denied.\");\r\n      } else if (code === 2) {\r\n        toast.error(\"Location unavailable.\");\r\n      } else if (code === 3) {\r\n        toast.error(\"Location request timed out.\");\r\n      } else {\r\n        toast.error(\"Failed to fetch location.\");\r\n      }\r\n    }\r\n  };\r\n\r\n  // Prefetch last few outbound image previews so the sender sees what was sent.\r\n  useEffect(() => {\r\n    const slice = Array.isArray(messages) ? messages.slice(-8) : [];\r\n    for (const m of slice) {\r\n      const mediaId = String(m?.mediaId || \"\").trim();\r\n      if (!mediaId) continue;\r\n      const mt = String(m?.mediaType || \"\")\r\n        .trim()\r\n        .toLowerCase();\r\n      if (mt !== \"image\" && mt !== \"video\" && mt !== \"audio\") continue;\r\n      if (m?.localPreviewUrl) continue;\r\n      if (mediaObjectUrlByIdRef.current.has(mediaId)) continue;\r\n      fetchMediaObjectUrl(mediaId, { silent: true });\r\n    }\r\n  }, [messages, fetchMediaObjectUrl]);\r\n\r\n  useEffect(() => {\r\n    const slice = Array.isArray(messages) ? messages.slice(-4) : [];\r\n    for (const m of slice) {\r\n      const mediaId = String(m?.mediaId || \"\").trim();\r\n      if (!mediaId) continue;\r\n      const mt = String(m?.mediaType || \"\")\r\n        .trim()\r\n        .toLowerCase();\r\n      if (mt !== \"document\") continue;\r\n      const localPreviewUrl = m?.localPreviewUrl || null;\r\n      const isTemp =\r\n        typeof m?.id === \"string\" && String(m.id).startsWith(\"temp-\");\r\n\r\n      ensurePdfPreview(mediaId, {\r\n        localPreviewUrl,\r\n        skipRemote: isTemp && !localPreviewUrl,\r\n      });\r\n    }\r\n  }, [messages, ensurePdfPreview]);\r\n\r\n  const handleComposerKeyDown = event => {\r\n    if (event.key === \"Enter\" && !event.shiftKey) {\r\n      event.preventDefault();\r\n      if (!isSending && newMessage.trim()) handleSendMessage();\r\n    }\r\n  };\r\n\r\n  //  Assign conversation to me\r\n  const handleAssignToMe = async () => {\r\n    if (!selectedConversation || !selectedConversation.contactId) {\r\n      toast.warn(\"Select a conversation before assigning.\");\r\n      return;\r\n    }\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    const userId = localStorage.getItem(\"userId\");\r\n\r\n    if (!businessId || !userId) {\r\n      toast.error(\"Missing business or user context. Please login again.\");\r\n      return;\r\n    }\r\n\r\n    if (isAssigning) return;\r\n\r\n    setIsAssigning(true);\r\n    try {\r\n      const payload = {\r\n        businessId,\r\n        contactId: selectedConversation.contactId,\r\n        userId,\r\n      };\r\n      await axiosClient.post(\"/chat-inbox/assign\", payload);\r\n\r\n      setAllConversations(prev =>\r\n        prev.map(c =>\r\n          c.id === selectedConversation.id\r\n            ? {\r\n                ...c,\r\n                assignedToUserId: userId,\r\n                assignedToUserName: \"You\",\r\n                isAssignedToMe: true,\r\n              }\r\n            : c\r\n        )\r\n      );\r\n\r\n      await fetchConversations({ silent: true, limit: 100 });\r\n      toast.success(\"Conversation assigned to you.\");\r\n    } catch (error) {\r\n      console.error(\"Failed to assign conversation:\", error);\r\n      toast.error(\r\n        error.response?.data?.message || \"Failed to assign conversation.\"\r\n      );\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  };\r\n\r\n  //  Assign conversation to specific agent\r\n  const handleAssignToAgent = async assigneeUserId => {\r\n    if (!selectedConversation || !selectedConversation.contactId) {\r\n      toast.warn(\"Select a conversation before assigning.\");\r\n      return;\r\n    }\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) {\r\n      toast.error(\"Missing business context. Please login again.\");\r\n      return;\r\n    }\r\n\r\n    const userId = String(assigneeUserId ?? \"\").trim();\r\n    if (!userId) {\r\n      toast.error(\"Select a valid agent to assign.\");\r\n      return;\r\n    }\r\n\r\n    if (isAssigning) return;\r\n\r\n    setIsAssigning(true);\r\n    try {\r\n      const payload = {\r\n        businessId,\r\n        contactId: selectedConversation.contactId,\r\n        userId,\r\n      };\r\n      await axiosClient.post(\"/chat-inbox/assign\", payload);\r\n\r\n      const myUserId = localStorage.getItem(\"userId\");\r\n      const agentName =\r\n        agents.find(a => String(a.userId) === String(userId))?.name ?? \"Agent\";\r\n\r\n      setAllConversations(prev =>\r\n        prev.map(c =>\r\n          c.id === selectedConversation.id\r\n            ? {\r\n                ...c,\r\n                assignedToUserId: userId,\r\n                assignedToUserName:\r\n                  myUserId && String(myUserId) === String(userId)\r\n                    ? \"You\"\r\n                    : agentName,\r\n                isAssignedToMe: myUserId && String(myUserId) === String(userId),\r\n              }\r\n            : c\r\n        )\r\n      );\r\n\r\n      await fetchConversations({ silent: true, limit: 100 });\r\n\r\n      const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n      if (tabKey === \"unassigned\" || tabKey === \"my\") {\r\n        setSelectedConversationId(null);\r\n      }\r\n\r\n      toast.success(\"Conversation assigned.\");\r\n    } catch (error) {\r\n      console.error(\"Failed to assign conversation:\", error);\r\n      toast.error(\r\n        error.response?.data?.message || \"Failed to assign conversation.\"\r\n      );\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  };\r\n\r\n  const handleUnassign = async () => {\r\n    if (!selectedConversation || !selectedConversation.contactId) {\r\n      toast.warn(\"Select a conversation before unassigning.\");\r\n      return;\r\n    }\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) {\r\n      toast.error(\"Missing business context. Please login again.\");\r\n      return;\r\n    }\r\n\r\n    if (isAssigning) return;\r\n\r\n    setIsAssigning(true);\r\n    try {\r\n      const payload = { businessId, contactId: selectedConversation.contactId };\r\n      await axiosClient.post(\"/chat-inbox/unassign\", payload);\r\n\r\n      setAllConversations(prev =>\r\n        prev.map(c =>\r\n          c.id === selectedConversation.id\r\n            ? {\r\n                ...c,\r\n                assignedToUserId: null,\r\n                assignedToUserName: null,\r\n                isAssignedToMe: false,\r\n              }\r\n            : c\r\n        )\r\n      );\r\n\r\n      await fetchConversations({ silent: true, limit: 100 });\r\n\r\n      const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n      if (tabKey === \"my\") setSelectedConversationId(null);\r\n\r\n      toast.info(\"Conversation unassigned.\");\r\n    } catch (error) {\r\n      console.error(\"Failed to unassign conversation:\", error);\r\n      toast.error(\r\n        error.response?.data?.message || \"Failed to unassign conversation.\"\r\n      );\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  };\r\n\r\n  const handleUpdateConversationStatus = async newStatus => {\r\n    if (!selectedConversation || !selectedConversation.contactId) {\r\n      toast.warn(\"Select a conversation before updating status.\");\r\n      return;\r\n    }\r\n\r\n    if (!headerIsAssignedToMe) {\r\n      toast.error(\"Not allowed to update this conversation.\");\r\n      return;\r\n    }\r\n\r\n    const businessId = localStorage.getItem(\"businessId\");\r\n    if (!businessId) {\r\n      toast.error(\"Missing business context. Please login again.\");\r\n      return;\r\n    }\r\n\r\n    const normalized = parseConversationStatus(newStatus);\r\n    if (!normalized) {\r\n      toast.error(\"Invalid status. Use Open, Pending, or Closed.\");\r\n      return;\r\n    }\r\n\r\n    if (isUpdatingStatus) return;\r\n\r\n    const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n\r\n    setIsUpdatingStatus(true);\r\n    try {\r\n      const payload = {\r\n        businessId,\r\n        contactId: selectedConversation.contactId,\r\n        status: normalized,\r\n      };\r\n\r\n      try {\r\n        await axiosClient.post(\"/chat-inbox/set-status\", payload);\r\n      } catch (e) {\r\n        const statusCode = e?.response?.status;\r\n        if (statusCode === 404) {\r\n          await axiosClient.post(\"/chat-inbox/status\", payload);\r\n        } else {\r\n          throw e;\r\n        }\r\n      }\r\n\r\n      setAllConversations(prev =>\r\n        prev.map(c =>\r\n          c.id === selectedConversation.id ? { ...c, status: normalized } : c\r\n        )\r\n      );\r\n\r\n      if (\r\n        (tabKey === \"closed\" && normalized !== \"Closed\") ||\r\n        (tabKey !== \"closed\" && normalized === \"Closed\")\r\n      ) {\r\n        setSelectedConversationId(null);\r\n      }\r\n\r\n      await fetchConversations({ silent: true, limit: 100 });\r\n      toast.success(\"Status updated.\");\r\n    } catch (error) {\r\n      console.error(\"Failed to update status:\", error);\r\n      toast.error(error.response?.data?.message || \"Failed to update status.\");\r\n    } finally {\r\n      setIsUpdatingStatus(false);\r\n    }\r\n  };\r\n\r\n  const handleOpenFullCrm = () => {\r\n    if (!selectedConversation) {\r\n      toast.info(\"Select a conversation first to open full CRM.\");\r\n      return;\r\n    }\r\n    if (!selectedContactId) {\r\n      toast.info(\"No contact is linked to this conversation yet.\");\r\n      return;\r\n    }\r\n    navigate(`/app/crm/contacts/${selectedContactId}`);\r\n  };\r\n\r\n  const handleAddNote = async () => {\r\n    if (!selectedConversation || !selectedContactId) {\r\n      toast.warn(\"Select a conversation with a linked contact to add notes.\");\r\n      return;\r\n    }\r\n\r\n    const content = noteDraft.trim();\r\n    if (!content) {\r\n      toast.warn(\"Type something for the note before saving.\");\r\n      return;\r\n    }\r\n\r\n    if (isSavingNote) return;\r\n\r\n    const title =\r\n      content.length > 50 ? `${content.substring(0, 50)}` : content;\r\n\r\n    const dto = {\r\n      contactId: selectedContactId,\r\n      title,\r\n      content,\r\n      source: \"Inbox\",\r\n      createdBy:\r\n        localStorage.getItem(\"userName\") ||\r\n        localStorage.getItem(\"email\") ||\r\n        \"Agent\",\r\n      isPinned: false,\r\n      isInternal: true,\r\n    };\r\n\r\n    setIsSavingNote(true);\r\n    try {\r\n      await axiosClient.post(\"/notes\", dto);\r\n      toast.success(\"Note added.\");\r\n      setNoteDraft(\"\");\r\n      await refreshContactSummary();\r\n    } catch (error) {\r\n      console.error(\"Failed to add note:\", error);\r\n      toast.error(\r\n        error.response?.data?.message ||\r\n          error.response?.data?.title ||\r\n          \"Failed to add note from inbox.\"\r\n      );\r\n    } finally {\r\n      setIsSavingNote(false);\r\n    }\r\n  };\r\n\r\n  const handleAddReminder = async () => {\r\n    if (!selectedConversation || !selectedContactId) {\r\n      toast.warn(\r\n        \"Select a conversation with a linked contact to add reminders.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    const title = reminderTitle.trim();\r\n    if (!title) {\r\n      toast.warn(\"Enter a reminder title.\");\r\n      return;\r\n    }\r\n    if (!reminderDueAt) {\r\n      toast.warn(\"Choose a due date/time for the reminder.\");\r\n      return;\r\n    }\r\n\r\n    const dueIso = toIsoFromDatetimeLocal(reminderDueAt);\r\n    if (!dueIso) {\r\n      toast.error(\"Invalid reminder date/time.\");\r\n      return;\r\n    }\r\n\r\n    if (isSavingReminder) return;\r\n\r\n    const dto = {\r\n      contactId: selectedContactId,\r\n      title,\r\n      description: reminderDescription || \"\",\r\n      dueAt: dueIso,\r\n      reminderType: \"FollowUp\",\r\n      priority: 2,\r\n      isRecurring: false,\r\n      recurrencePattern: \"\",\r\n      sendWhatsappNotification: false,\r\n      linkedCampaign: \"\",\r\n      status: \"Pending\",\r\n      createdBy:\r\n        localStorage.getItem(\"userName\") ||\r\n        localStorage.getItem(\"email\") ||\r\n        \"Agent\",\r\n    };\r\n\r\n    setIsSavingReminder(true);\r\n    try {\r\n      await axiosClient.post(\"/reminders\", dto);\r\n      toast.success(\"Reminder added.\");\r\n      setReminderTitle(\"\");\r\n      setReminderDueAt(\"\");\r\n      setReminderDescription(\"\");\r\n      await refreshContactSummary();\r\n    } catch (error) {\r\n      console.error(\"Failed to add reminder:\", error);\r\n      toast.error(\r\n        error.response?.data?.message ||\r\n          error.response?.data?.title ||\r\n          \"Failed to add reminder from inbox.\"\r\n      );\r\n    } finally {\r\n      setIsSavingReminder(false);\r\n    }\r\n  };\r\n\r\n  const handleUpdateNote = async note => {\r\n    if (!note?.id) return;\r\n    const content = editNoteContent.trim();\r\n    if (!content) {\r\n      toast.warn(\"Note content cannot be empty.\");\r\n      return;\r\n    }\r\n    if (!selectedContactId) return;\r\n    if (isUpdatingNote) return;\r\n\r\n    const title =\r\n      content.length > 50 ? `${content.substring(0, 50)}` : content;\r\n\r\n    const dto = {\r\n      contactId: selectedContactId,\r\n      title,\r\n      content,\r\n      source: note.source || \"Inbox\",\r\n      createdBy:\r\n        localStorage.getItem(\"userName\") ||\r\n        localStorage.getItem(\"email\") ||\r\n        \"Agent\",\r\n      isPinned: !!note.isPinned,\r\n      isInternal: note.isInternal ?? true,\r\n    };\r\n\r\n    setIsUpdatingNote(true);\r\n    try {\r\n      await axiosClient.put(`/notes/${note.id}`, dto);\r\n      toast.success(\"Note updated.\");\r\n      setEditingNoteId(null);\r\n      setEditNoteContent(\"\");\r\n      await refreshContactSummary();\r\n    } catch (error) {\r\n      console.error(\"Failed to update note:\", error);\r\n      toast.error(error.response?.data?.message || \"Failed to update note.\");\r\n    } finally {\r\n      setIsUpdatingNote(false);\r\n    }\r\n  };\r\n\r\n  const handleUpdateReminder = async reminder => {\r\n    if (!reminder?.id) return;\r\n    if (!selectedContactId) return;\r\n\r\n    const title = editReminderTitle.trim();\r\n    if (!title) {\r\n      toast.warn(\"Reminder title cannot be empty.\");\r\n      return;\r\n    }\r\n\r\n    const dueIso = toIsoFromDatetimeLocal(editReminderDueAt);\r\n    if (!dueIso) {\r\n      toast.warn(\"Pick a valid due date/time.\");\r\n      return;\r\n    }\r\n\r\n    if (isUpdatingReminder) return;\r\n\r\n    const dto = {\r\n      contactId: selectedContactId,\r\n      title,\r\n      description: editReminderDescription || \"\",\r\n      dueAt: dueIso,\r\n      status: reminder.status || \"Pending\",\r\n      reminderType: reminder.reminderType || \"FollowUp\",\r\n      priority: reminder.priority ?? 2,\r\n      isRecurring: !!reminder.isRecurring,\r\n      recurrencePattern: reminder.recurrencePattern || \"\",\r\n      sendWhatsappNotification: !!reminder.sendWhatsappNotification,\r\n      linkedCampaign: reminder.linkedCampaign || \"\",\r\n      createdBy:\r\n        localStorage.getItem(\"userName\") ||\r\n        localStorage.getItem(\"email\") ||\r\n        \"Agent\",\r\n    };\r\n\r\n    setIsUpdatingReminder(true);\r\n    try {\r\n      await axiosClient.put(`/reminders/${reminder.id}`, dto);\r\n      toast.success(\"Reminder updated.\");\r\n      setEditingReminderId(null);\r\n      setEditReminderTitle(\"\");\r\n      setEditReminderDueAt(\"\");\r\n      setEditReminderDescription(\"\");\r\n      await refreshContactSummary();\r\n    } catch (error) {\r\n      console.error(\"Failed to update reminder:\", error);\r\n      toast.error(\r\n        error.response?.data?.message || \"Failed to update reminder.\"\r\n      );\r\n    } finally {\r\n      setIsUpdatingReminder(false);\r\n    }\r\n  };\r\n\r\n  const openDeleteConfirm = (type, item) => {\r\n    setConfirmState({\r\n      open: true,\r\n      type,\r\n      id: item?.id || null,\r\n      title: type === \"note\" ? \"Delete note?\" : \"Delete reminder?\",\r\n    });\r\n  };\r\n\r\n  const closeConfirm = () => {\r\n    if (confirmBusy) return;\r\n    setConfirmState({ open: false, type: null, id: null, title: \"\" });\r\n  };\r\n\r\n  const executeDelete = async () => {\r\n    if (!confirmState?.id || !confirmState?.type) return;\r\n    setConfirmBusy(true);\r\n\r\n    try {\r\n      if (confirmState.type === \"note\") {\r\n        await axiosClient.delete(`/notes/${confirmState.id}`);\r\n        toast.info(\"Note deleted.\");\r\n      } else if (confirmState.type === \"reminder\") {\r\n        await axiosClient.delete(`/reminders/${confirmState.id}`);\r\n        toast.info(\"Reminder deleted.\");\r\n      }\r\n      await refreshContactSummary();\r\n    } catch (error) {\r\n      console.error(\"Delete failed:\", error);\r\n      toast.error(error.response?.data?.message || \"Delete failed.\");\r\n    } finally {\r\n      setConfirmBusy(false);\r\n      closeConfirm();\r\n    }\r\n  };\r\n\r\n  const tagsList =\r\n    (contactSummary?.tags ??\r\n      contactSummary?.contactTags ??\r\n      contactSummary?.contactTagsDto ??\r\n      []) ||\r\n    [];\r\n\r\n  const recentNotes = contactSummary?.recentNotes ?? [];\r\n  const nextReminder = contactSummary?.nextReminder ?? null;\r\n  const recentTimeline = contactSummary?.recentTimeline ?? [];\r\n\r\n  return {\r\n    activeTab,\r\n    allConversations,\r\n    closeConfirm,\r\n    confirmBusy,\r\n    confirmState,\r\n    connection,\r\n    contactSummary,\r\n    conversationsHasMore,\r\n    conversationsNextCursor,\r\n    conversationsRef,\r\n    currentUserId,\r\n    editNoteContent,\r\n    editReminderDescription,\r\n    editReminderDueAt,\r\n    editReminderTitle,\r\n    editingNoteId,\r\n    editingReminderId,\r\n    executeDelete,\r\n    fetchConversations,\r\n    fetchConversationsPage,\r\n    filteredConversations,\r\n    agents,\r\n    isAgentsLoading,\r\n    handleAddNote,\r\n    handleAddReminder,\r\n    handleAssignToMe,\r\n    handleAssignToAgent,\r\n    handleComposerKeyDown,\r\n    handleOpenFullCrm,\r\n    handleReceiveInboxMessage,\r\n    handleRemoveTag,\r\n    handleSendMessage,\r\n    handleUploadAndSendMedia,\r\n    handleSendLocation,\r\n    handleOpenMedia,\r\n    handleCloseMediaViewer,\r\n    ensureImagePreview,\r\n    ensurePdfPreview,\r\n    handleUnassign,\r\n    handleUnreadCountChanged,\r\n    handleUpdateConversationStatus,\r\n    handleUpdateNote,\r\n    handleUpdateReminder,\r\n    headerAssignedName,\r\n    headerIsAssigned,\r\n    headerIsAssignedToMe,\r\n    isAssigning,\r\n    isConnected,\r\n    isLoading,\r\n    isConversationsLoadingMore,\r\n    isMessagesLoading,\r\n    isMessagesLoadingOlder,\r\n    isSavingNote,\r\n    isSavingReminder,\r\n    isSending,\r\n    isUploadingMedia,\r\n    isSummaryLoading,\r\n    isTagModalOpen,\r\n    isUpdatingStatus,\r\n    isUpdatingNote,\r\n    isUpdatingReminder,\r\n    isWithin24h,\r\n    isConversationClosed,\r\n    messages,\r\n    messagesEndRef,\r\n    messagesHasMore,\r\n    messagesNextCursor,\r\n    fetchMessagesPage,\r\n    messagesWithSeparators,\r\n    navigate,\r\n    newMessage,\r\n    nextReminder,\r\n    noteDraft,\r\n    openDeleteConfirm,\r\n    recentNotes,\r\n    recentTimeline,\r\n    refreshContactSummary,\r\n    reminderDescription,\r\n    reminderDueAt,\r\n    reminderTitle,\r\n    removingTagId,\r\n    scrollToBottom,\r\n    searchTerm,\r\n    selectedContactId,\r\n    selectedConversation,\r\n    selectedConversationId,\r\n    selectedConversationRef,\r\n    selectedNumberId,\r\n    setActiveTab,\r\n    setAllConversations,\r\n    setConfirmBusy,\r\n    setConfirmState,\r\n    setContactSummary,\r\n    setEditNoteContent,\r\n    setEditReminderDescription,\r\n    setEditReminderDueAt,\r\n    setEditReminderTitle,\r\n    setEditingNoteId,\r\n    setEditingReminderId,\r\n    setIsAssigning,\r\n    setIsLoading,\r\n    setIsMessagesLoading,\r\n    setIsSavingNote,\r\n    setIsSavingReminder,\r\n    setIsSending,\r\n    setIsUploadingMedia,\r\n    setIsSummaryLoading,\r\n    setIsTagModalOpen,\r\n    setIsUpdatingNote,\r\n    setIsUpdatingReminder,\r\n    setMessages,\r\n    setNewMessage,\r\n    setNoteDraft,\r\n    setReminderDescription,\r\n    setReminderDueAt,\r\n    setReminderTitle,\r\n    setRemovingTagId,\r\n    setSearchTerm,\r\n    setSelectedConversationId,\r\n    setSelectedNumberId,\r\n    setShowCrmPanel,\r\n    setShowDetails,\r\n    setShowMiniTimeline,\r\n    setShowRightPanel,\r\n    showCrmPanel,\r\n    showDetails,\r\n    showMiniTimeline,\r\n    showRightPanel,\r\n    tagsList,\r\n    mediaObjectUrlById,\r\n    pdfPreviewById,\r\n    mediaViewer,\r\n    handleMediaViewerPrev,\r\n    handleMediaViewerNext,\r\n    handleMediaViewerSelectIndex,\r\n  };\r\n}\r\n\r\n// import { useState, useMemo, useCallback, useEffect, useRef } from \"react\";\r\n// import { useNavigate } from \"react-router-dom\";\r\n// import { toast } from \"react-toastify\";\r\n// import useInboxSignalR from \"./useInboxSignalR\";\r\n// import axiosClient from \"../api/chatInboxApi\";\r\n// import {\r\n//   inferIsInboundFromAny,\r\n//   mapHubMessageToChat,\r\n// } from \"../utils/messageMapping\";\r\n// import { toIsoFromDatetimeLocal } from \"../utils/dateUtils\";\r\n// import { formatDayLabel } from \"../utils/formatters\";\r\n\r\n// const parseConversationStatus = status => {\r\n//   const raw = String(status ?? \"\").trim().toLowerCase();\r\n//   if (raw === \"open\") return \"Open\";\r\n//   if (raw === \"pending\") return \"Pending\";\r\n//   if (raw === \"closed\") return \"Closed\";\r\n//   return null;\r\n// };\r\n\r\n// export function useChatInboxController() {\r\n//   const navigate = useNavigate();\r\n\r\n//   //  SignalR connection\r\n//   const { connection, isConnected } = useInboxSignalR();\r\n\r\n//   //  Filters & selection\r\n//   const [activeTab, setActiveTab] = useState(\"live\");\r\n//   const [selectedNumberId, setSelectedNumberId] = useState(\"all\");\r\n//   const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n//   //  Data from backend\r\n//   const [allConversations, setAllConversations] = useState([]);\r\n//   const [isLoading, setIsLoading] = useState(false);\r\n\r\n//   //  Selected conversation & message input\r\n//   const [selectedConversationId, setSelectedConversationId] = useState(null);\r\n//   const [newMessage, setNewMessage] = useState(\"\");\r\n\r\n//   //  Messages for selected conversation\r\n//   const [messages, setMessages] = useState([]);\r\n//   const [isMessagesLoading, setIsMessagesLoading] = useState(false);\r\n\r\n//   //  Sending & assignment state\r\n//   const [isSending, setIsSending] = useState(false);\r\n//   const [isAssigning, setIsAssigning] = useState(false);\r\n//   const [isUpdatingStatus, setIsUpdatingStatus] = useState(false);\r\n\r\n//   const [agents, setAgents] = useState([]);\r\n//   const [isAgentsLoading, setIsAgentsLoading] = useState(false);\r\n\r\n//   //  CRM summary for right panel\r\n//   const [contactSummary, setContactSummary] = useState(null);\r\n//   const [isSummaryLoading, setIsSummaryLoading] = useState(false);\r\n\r\n//   //  Quick CRM actions (notes + reminders)\r\n//   const [noteDraft, setNoteDraft] = useState(\"\");\r\n//   const [isSavingNote, setIsSavingNote] = useState(false);\r\n\r\n//   const [reminderTitle, setReminderTitle] = useState(\"\");\r\n//   const [reminderDueAt, setReminderDueAt] = useState(\"\");\r\n//   const [reminderDescription, setReminderDescription] = useState(\"\");\r\n//   const [isSavingReminder, setIsSavingReminder] = useState(false);\r\n\r\n//   //  Edit state: Notes\r\n//   const [editingNoteId, setEditingNoteId] = useState(null);\r\n//   const [editNoteContent, setEditNoteContent] = useState(\"\");\r\n//   const [isUpdatingNote, setIsUpdatingNote] = useState(false);\r\n\r\n//   //  Edit state: Reminder\r\n//   const [editingReminderId, setEditingReminderId] = useState(null);\r\n//   const [editReminderTitle, setEditReminderTitle] = useState(\"\");\r\n//   const [editReminderDueAt, setEditReminderDueAt] = useState(\"\");\r\n//   const [editReminderDescription, setEditReminderDescription] = useState(\"\");\r\n//   const [isUpdatingReminder, setIsUpdatingReminder] = useState(false);\r\n\r\n//   //  Confirm dialog\r\n//   const [confirmState, setConfirmState] = useState({\r\n//     open: false,\r\n//     type: null, // \"note\" | \"reminder\"\r\n//     id: null,\r\n//     title: \"\",\r\n//   });\r\n//   const [confirmBusy, setConfirmBusy] = useState(false);\r\n\r\n//   //  Tag modal state\r\n//   const [isTagModalOpen, setIsTagModalOpen] = useState(false);\r\n\r\n//   //  NEW: tag remove state (simple, MVP)\r\n//   const [removingTagId, setRemovingTagId] = useState(null);\r\n\r\n//   // Right panel toggles\r\n//   const [showRightPanel, setShowRightPanel] = useState(true);\r\n//   const [showDetails, setShowDetails] = useState(true);\r\n//   const [showCrmPanel, setShowCrmPanel] = useState(true);\r\n//   const [showMiniTimeline, setShowMiniTimeline] = useState(true); // (kept as-is)\r\n\r\n//   //  Auto-scroll anchor for chat messages\r\n//   const messagesEndRef = useRef(null);\r\n\r\n//   //  Patch: stop the \"refresh scroll\" feeling\r\n//   const scrollToBottom = useCallback(() => {\r\n//     if (messagesEndRef.current) {\r\n//       messagesEndRef.current.scrollIntoView({\r\n//         behavior: \"auto\",\r\n//         block: \"end\",\r\n//       });\r\n//     }\r\n//   }, []);\r\n\r\n//   const currentUserId = useMemo(() => localStorage.getItem(\"userId\"), []);\r\n\r\n//   //  Selected conversation\r\n//   const selectedConversation = useMemo(\r\n//     () => allConversations.find(c => c.id === selectedConversationId) || null,\r\n//     [allConversations, selectedConversationId]\r\n//   );\r\n\r\n//   //  Fix #3: prevent stale selectedConversation inside SignalR handlers\r\n//   const selectedConversationRef = useRef(null);\r\n//   useEffect(() => {\r\n//     selectedConversationRef.current = selectedConversation;\r\n//   }, [selectedConversation]);\r\n\r\n//   //  Patch: keep latest conversations without making message-loading re-run\r\n//   const conversationsRef = useRef([]);\r\n//   useEffect(() => {\r\n//     conversationsRef.current = allConversations;\r\n//   }, [allConversations]);\r\n\r\n//   // Stable contactId for effects\r\n//   const selectedContactId = useMemo(\r\n//     () => selectedConversation?.contactId || null,\r\n//     [selectedConversation]\r\n//   );\r\n\r\n//   //  24h window flag\r\n//   const isWithin24h = selectedConversation?.within24h ?? false;\r\n//   const selectedConversationStatus =\r\n//     parseConversationStatus(selectedConversation?.status) ?? \"Open\";\r\n//   const isConversationClosed = selectedConversationStatus === \"Closed\";\r\n\r\n//   //  Assignment flags for header\r\n//   const headerIsAssigned = !!selectedConversation?.assignedToUserId;\r\n//   const headerIsAssignedToMe =\r\n//     !!selectedConversation?.isAssignedToMe ||\r\n//     (!!selectedConversation?.assignedToUserId &&\r\n//       currentUserId &&\r\n//       selectedConversation.assignedToUserId === currentUserId);\r\n//   const headerAssignedName = headerIsAssignedToMe\r\n//     ? \"You\"\r\n//     : selectedConversation?.assignedToUserName || \"Agent\";\r\n\r\n//   //  Reset edit state when switching contact\r\n//   useEffect(() => {\r\n//     setEditingNoteId(null);\r\n//     setEditNoteContent(\"\");\r\n//     setEditingReminderId(null);\r\n//     setEditReminderTitle(\"\");\r\n//     setEditReminderDueAt(\"\");\r\n//     setEditReminderDescription(\"\");\r\n//   }, [selectedContactId]);\r\n\r\n//   //  Filter + sort conversations\r\n//   const filteredConversations = useMemo(() => {\r\n//     let list = [...allConversations];\r\n//     const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n\r\n//     if (selectedNumberId !== \"all\") {\r\n//       list = list.filter(c => c.numberId === selectedNumberId);\r\n//     }\r\n\r\n//     if (searchTerm.trim()) {\r\n//       const q = searchTerm.trim().toLowerCase();\r\n//       list = list.filter(\r\n//         c =>\r\n//           c.contactName?.toLowerCase().includes(q) ||\r\n//           c.contactPhone?.toLowerCase().includes(q) ||\r\n//           c.lastMessagePreview?.toLowerCase().includes(q)\r\n//       );\r\n//     }\r\n\r\n//     if (tabKey === \"closed\") {\r\n//       list = list.filter(c => parseConversationStatus(c.status) === \"Closed\");\r\n//     } else {\r\n//       list = list.filter(c => parseConversationStatus(c.status) !== \"Closed\");\r\n//     }\r\n\r\n//     if (tabKey === \"live\") {\r\n//       list = list.filter(c => c.within24h);\r\n//     } else if (tabKey === \"older\") {\r\n//       list = list.filter(c => !c.within24h);\r\n//     } else if (tabKey === \"unassigned\") {\r\n//       list = list.filter(c => !c.assignedToUserId);\r\n//     } else if (tabKey === \"my\") {\r\n//       if (currentUserId) {\r\n//         list = list.filter(c => c.assignedToUserId === currentUserId);\r\n//       }\r\n//     }\r\n\r\n//     //  Sort: unread first, then most recent lastMessageAt\r\n//     list.sort((a, b) => {\r\n//       const aUnread = a.unreadCount > 0;\r\n//       const bUnread = b.unreadCount > 0;\r\n\r\n//       if (aUnread && !bUnread) return -1;\r\n//       if (!aUnread && bUnread) return 1;\r\n\r\n//       const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;\r\n//       const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;\r\n\r\n//       return bTime - aTime; // newest first\r\n//     });\r\n\r\n//     return list;\r\n//   }, [\r\n//     allConversations,\r\n//     activeTab,\r\n//     selectedNumberId,\r\n//     searchTerm,\r\n//     currentUserId,\r\n//   ]);\r\n\r\n//   //  Load conversations (supports \"silent\" refresh)\r\n//   const fetchConversations = useCallback(\r\n//     async (options = {}) => {\r\n//       const { limit, silent } = options;\r\n\r\n//       try {\r\n//         if (!silent) setIsLoading(true);\r\n\r\n//         const businessId = localStorage.getItem(\"businessId\");\r\n\r\n//         if (!businessId) {\r\n//           toast.error(\r\n//             \" Missing business context. Please login again to load inbox.\"\r\n//           );\r\n//           if (!silent) setIsLoading(false);\r\n//           return;\r\n//         }\r\n\r\n//         const params = {\r\n//           businessId,\r\n//           currentUserId,\r\n//           tab: activeTab === \"history\" ? \"older\" : activeTab,\r\n//           numberId:\r\n//             selectedNumberId && selectedNumberId !== \"all\"\r\n//               ? selectedNumberId\r\n//               : undefined,\r\n//           search: searchTerm || undefined,\r\n//           limit: limit ?? 100,\r\n//         };\r\n\r\n//         const res = await axiosClient.get(\"/chat-inbox/conversations\", {\r\n//           params,\r\n//         });\r\n\r\n//         const apiItems = Array.isArray(res.data) ? res.data : [];\r\n\r\n//         const mapped = apiItems.map(item => ({\r\n//           id: item.id,\r\n//           contactId: item.contactId,\r\n//           contactName: item.contactName,\r\n//           contactPhone: item.contactPhone,\r\n//           lastMessagePreview: item.lastMessagePreview,\r\n//           lastMessageAt: item.lastMessageAt,\r\n//           unreadCount: item.unreadCount || 0,\r\n//           status: parseConversationStatus(item.status) ?? \"Open\",\r\n//           numberId: item.numberId,\r\n//           numberLabel: item.numberLabel,\r\n//           within24h: !!item.within24h,\r\n//           assignedToUserId: item.assignedToUserId || null,\r\n//           assignedToUserName: item.assignedToUserName || null,\r\n//           isAssignedToMe: !!item.isAssignedToMe,\r\n//           sourceType: item.sourceType || \"WhatsApp\",\r\n//           sourceName: item.sourceName || \"WhatsApp\",\r\n//           mode: item.mode || \"Live\",\r\n//           firstSeenAt: item.firstSeenAt,\r\n//           lastInboundAt: item.lastInboundAt,\r\n//           lastOutboundAt: item.lastOutboundAt,\r\n//         }));\r\n\r\n//         //  Fix: silent refresh should not \"erase\" unread counts you already have in UI\r\n//         setAllConversations(prev => {\r\n//           if (!silent) return mapped;\r\n\r\n//           const prevMap = new Map(prev.map(c => [c.id, c]));\r\n\r\n//           return mapped.map(nc => {\r\n//             const old = prevMap.get(nc.id);\r\n//             if (!old) return nc;\r\n\r\n//             // Never preserve unread for the currently open chat\r\n//             if (selectedConversationId && nc.id === selectedConversationId)\r\n//               return nc;\r\n\r\n//             // Preserve unread if server temporarily returns 0\r\n//             if ((nc.unreadCount ?? 0) === 0 && (old.unreadCount ?? 0) > 0) {\r\n//               return { ...nc, unreadCount: old.unreadCount };\r\n//             }\r\n\r\n//             return nc;\r\n//           });\r\n//         });\r\n\r\n//         if (!selectedConversationId && mapped.length > 0) {\r\n//           setSelectedConversationId(mapped[0].id);\r\n//         }\r\n//       } catch (error) {\r\n//         console.error(\" Failed to load inbox conversations:\", error);\r\n//         const message =\r\n//           error.response?.data?.message ||\r\n//           \"Failed to load inbox conversations.\";\r\n//         toast.error(message);\r\n//       } finally {\r\n//         if (!options.silent) setIsLoading(false);\r\n//       }\r\n//     },\r\n//     [\r\n//       activeTab,\r\n//       selectedNumberId,\r\n//       searchTerm,\r\n//       selectedConversationId,\r\n//       currentUserId,\r\n//     ]\r\n//   );\r\n\r\n//   // Initial + filter-based load\r\n//   useEffect(() => {\r\n//     fetchConversations();\r\n//   }, [activeTab, selectedNumberId, searchTerm, fetchConversations]);\r\n\r\n//   const fetchAgents = useCallback(async () => {\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n//     if (!businessId) return;\r\n\r\n//     setIsAgentsLoading(true);\r\n//     try {\r\n//       const res = await axiosClient.get(\"/chat-inbox/agents\", {\r\n//         params: { businessId },\r\n//       });\r\n\r\n//       const items = Array.isArray(res.data) ? res.data : [];\r\n//       const mapped = items\r\n//         .map(a => ({\r\n//           userId: a.userId ?? a.id ?? null,\r\n//           name: a.name ?? a.fullName ?? a.displayName ?? a.email ?? \"Agent\",\r\n//           email: a.email ?? null,\r\n//           roleName: a.roleName ?? a.role ?? null,\r\n//         }))\r\n//         .filter(a => a.userId);\r\n\r\n//       setAgents(mapped);\r\n//     } catch (error) {\r\n//       setAgents([]);\r\n//     } finally {\r\n//       setIsAgentsLoading(false);\r\n//     }\r\n//   }, []);\r\n\r\n//   useEffect(() => {\r\n//     fetchAgents();\r\n//   }, [fetchAgents]);\r\n\r\n//   //  Auto-refresh conversations every 25 seconds (silent, no flicker)\r\n//   useEffect(() => {\r\n//     const intervalId = setInterval(() => {\r\n//       fetchConversations({ silent: true, limit: 100 });\r\n//     }, 25000);\r\n\r\n//     return () => clearInterval(intervalId);\r\n//   }, [fetchConversations]);\r\n\r\n//   //  Load messages for selected conversation\r\n//   useEffect(() => {\r\n//     const loadMessages = async () => {\r\n//       if (!selectedConversationId) {\r\n//         setMessages([]);\r\n//         return;\r\n//       }\r\n\r\n//       const conv = conversationsRef.current.find(\r\n//         c => c.id === selectedConversationId\r\n//       );\r\n\r\n//       if (!conv) {\r\n//         setMessages([]);\r\n//         return;\r\n//       }\r\n\r\n//       const businessId = localStorage.getItem(\"businessId\");\r\n//       if (!businessId) {\r\n//         toast.error(\r\n//           \" Missing business context. Please login again to load messages.\"\r\n//         );\r\n//         return;\r\n//       }\r\n\r\n//       try {\r\n//         setIsMessagesLoading(true);\r\n\r\n//         const res = await axiosClient.get(\"/chat-inbox/messages\", {\r\n//           params: {\r\n//             businessId,\r\n//             contactPhone: conv.contactPhone,\r\n//             limit: 100,\r\n//           },\r\n//         });\r\n\r\n//         const apiItems = Array.isArray(res.data) ? res.data : [];\r\n\r\n//         const mapped = apiItems\r\n//           .map(m => {\r\n//             const isInbound = inferIsInboundFromAny(m);\r\n\r\n//             const directionRaw =\r\n//               m.direction ?? m.Direction ?? m.dir ?? m.messageDirection ?? \"\";\r\n//             const statusRaw = m.status ?? \"\";\r\n\r\n//             const providerMessageId =\r\n//               m.providerMessageId ?? m.ProviderMessageId ?? null;\r\n//             const messageLogId =\r\n//               m.messageLogId ?? m.MessageLogId ?? m.messageLogID ?? null;\r\n//             const messageId =\r\n//               m.messageId ??\r\n//               m.MessageId ??\r\n//               m.wamid ??\r\n//               m.Wamid ??\r\n//               m.waMessageId ??\r\n//               m.WaMessageId ??\r\n//               providerMessageId ??\r\n//               null;\r\n//             const clientMessageId =\r\n//               m.clientMessageId ?? m.ClientMessageId ?? null;\r\n\r\n//             return {\r\n//               id: m.id ?? messageLogId ?? messageId,\r\n//               serverId: messageLogId ?? m.id ?? null,\r\n//               messageLogId: messageLogId ?? m.id ?? null,\r\n//               messageId,\r\n//               providerMessageId,\r\n//               clientMessageId,\r\n//               direction: directionRaw || (isInbound ? \"in\" : \"out\"),\r\n//               isInbound,\r\n//               text: m.text || m.message || m.body || m.content || \"\",\r\n//               sentAt: m.sentAtUtc || m.sentAt || m.createdAt || m.timestamp,\r\n//               status: statusRaw,\r\n//               errorMessage: m.errorMessage,\r\n//             };\r\n//           })\r\n//           .reverse();\r\n\r\n//         setMessages(mapped);\r\n//       } catch (error) {\r\n//         console.error(\" Failed to load messages:\", error);\r\n//         const message =\r\n//           error.response?.data?.message || \"Failed to load messages.\";\r\n//         toast.error(message);\r\n//         setMessages([]);\r\n//       } finally {\r\n//         setIsMessagesLoading(false);\r\n//       }\r\n//     };\r\n\r\n//     loadMessages();\r\n//   }, [selectedConversationId]);\r\n\r\n//   //  Mark as read when opening a conversation (HTTP + SignalR)\r\n//   useEffect(() => {\r\n//     if (!selectedConversationId) return;\r\n//     if (!selectedConversation?.contactId) return;\r\n\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n//     const userId = localStorage.getItem(\"userId\");\r\n\r\n//     if (!businessId || !userId) return;\r\n\r\n//     const payload = {\r\n//       businessId,\r\n//       contactId: selectedConversation.contactId,\r\n//       userId,\r\n//     };\r\n\r\n//     axiosClient.post(\"/chat-inbox/mark-read\", payload).catch(err => {\r\n//       console.error(\"Failed to mark conversation as read:\", err);\r\n//     });\r\n\r\n//     if (connection && isConnected) {\r\n//       connection\r\n//         .invoke(\"MarkAsRead\", selectedConversation.contactId)\r\n//         .catch(err => {\r\n//           console.warn(\"SignalR MarkAsRead failed (non-fatal):\", err);\r\n//         });\r\n//     }\r\n\r\n//     setAllConversations(prev =>\r\n//       prev.map(c =>\r\n//         c.id === selectedConversationId ? { ...c, unreadCount: 0 } : c\r\n//       )\r\n//     );\r\n//   }, [\r\n//     selectedConversationId,\r\n//     selectedConversation?.contactId,\r\n//     connection,\r\n//     isConnected,\r\n//   ]);\r\n\r\n//   //  Helper to (re)load CRM contact summary\r\n//   const refreshContactSummary = useCallback(async () => {\r\n//     if (!selectedContactId) {\r\n//       setContactSummary(null);\r\n//       return;\r\n//     }\r\n\r\n//     try {\r\n//       setIsSummaryLoading(true);\r\n//       const res = await axiosClient.get(\r\n//         `/crm/contact-summary/${selectedContactId}`\r\n//       );\r\n//       const payload = res.data?.data ?? res.data;\r\n//       setContactSummary(payload || null);\r\n//     } catch (error) {\r\n//       console.error(\" Failed to load contact summary:\", error);\r\n//       setContactSummary(null);\r\n//     } finally {\r\n//       setIsSummaryLoading(false);\r\n//     }\r\n//   }, [selectedContactId]);\r\n\r\n//   //  Load CRM contact summary for right panel\r\n//   useEffect(() => {\r\n//     if (!selectedContactId) {\r\n//       setContactSummary(null);\r\n//       return;\r\n//     }\r\n//     refreshContactSummary();\r\n//   }, [selectedContactId, refreshContactSummary]);\r\n\r\n//   //  NEW: remove/unassign tag from contact (MVP)\r\n//   const handleRemoveTag = useCallback(\r\n//     async tag => {\r\n//       if (!selectedContactId) {\r\n//         toast.warn(\"No contact selected.\");\r\n//         return;\r\n//       }\r\n\r\n//       const tagId = tag?.id || tag?.tagId;\r\n//       const tagName = tag?.tagName || tag?.name || \"tag\";\r\n\r\n//       if (!tagId) {\r\n//         toast.error(\"Cannot remove this tag (missing tagId).\");\r\n//         return;\r\n//       }\r\n\r\n//       if (removingTagId) return;\r\n\r\n//       // Optimistic UI: remove it from contactSummary immediately\r\n//       setContactSummary(prev => {\r\n//         if (!prev) return prev;\r\n//         const removeFrom = arr =>\r\n//           Array.isArray(arr)\r\n//             ? arr.filter(t => (t?.id || t?.tagId) !== tagId)\r\n//             : arr;\r\n\r\n//         return {\r\n//           ...prev,\r\n//           tags: removeFrom(prev.tags),\r\n//           contactTags: removeFrom(prev.contactTags),\r\n//           contactTagsDto: removeFrom(prev.contactTagsDto),\r\n//         };\r\n//       });\r\n\r\n//       setRemovingTagId(tagId);\r\n\r\n//       try {\r\n//         const body = {\r\n//           contactIds: [selectedContactId],\r\n//           tagId,\r\n//         };\r\n\r\n//         //  Your console showed POST got 405.\r\n//         // So we try DELETE first, then fallback to POST if needed.\r\n//         try {\r\n//           await axiosClient.request({\r\n//             url: \"/contacts/bulk-unassign-tag\",\r\n//             method: \"DELETE\",\r\n//             data: body, // axios supports sending body with DELETE via request()\r\n//           });\r\n//         } catch (err) {\r\n//           const status = err?.response?.status;\r\n\r\n//           // fallback to POST if backend expects POST\r\n//           if (status === 404 || status === 405) {\r\n//             await axiosClient.post(\"/contacts/bulk-unassign-tag\", body);\r\n//           } else {\r\n//             throw err;\r\n//           }\r\n//         }\r\n\r\n//         toast.success(`Removed \"${tagName}\"`);\r\n//         await refreshContactSummary();\r\n//       } catch (error) {\r\n//         console.error(\"Failed to remove tag:\", error);\r\n//         toast.error(\r\n//           error?.response?.data?.message || `Failed to remove \"${tagName}\".`\r\n//         );\r\n//         // revert by reloading from server\r\n//         await refreshContactSummary();\r\n//       } finally {\r\n//         setRemovingTagId(null);\r\n//       }\r\n//     },\r\n//     [selectedContactId, removingTagId, refreshContactSummary]\r\n//   );\r\n\r\n//   // Auto-scroll when messages change\r\n//   useEffect(() => {\r\n//     if (!selectedConversationId) return;\r\n//     if (isMessagesLoading) return;\r\n//     if (messages.length === 0) return;\r\n\r\n//     scrollToBottom();\r\n//   }, [messages, isMessagesLoading, selectedConversationId, scrollToBottom]);\r\n\r\n//   //  Messages + date separators\r\n//   const messagesWithSeparators = useMemo(() => {\r\n//     const result = [];\r\n//     let lastDateKey = null;\r\n\r\n//     messages.forEach(m => {\r\n//       const dateObj = m.sentAt ? new Date(m.sentAt) : null;\r\n//       const key = dateObj ? dateObj.toDateString() : \"unknown\";\r\n\r\n//       if (key !== lastDateKey) {\r\n//         if (dateObj) {\r\n//           result.push({\r\n//             type: \"separator\",\r\n//             id: `sep-${key}`,\r\n//             label: formatDayLabel(dateObj),\r\n//           });\r\n//         }\r\n//         lastDateKey = key;\r\n//       }\r\n\r\n//       result.push({ type: \"message\", ...m });\r\n//     });\r\n\r\n//     return result;\r\n//   }, [messages]);\r\n\r\n//   //  SignalR: ReceiveInboxMessage handler\r\n//   const handleReceiveInboxMessage = useCallback(\r\n//     payload => {\r\n//       if (!payload) return;\r\n\r\n//       const contactId = payload.contactId ?? payload.ContactId ?? null;\r\n//       const conversationId =\r\n//         payload.conversationId ?? payload.ConversationId ?? null;\r\n\r\n//       const mappedMsg = mapHubMessageToChat(payload);\r\n//       if (!mappedMsg) return;\r\n\r\n//       // 1) Update messages if this conversation is open\r\n//       // 1) Update messages if this conversation is open\r\n//       setMessages(prev => {\r\n//         const openConv = selectedConversationRef.current;\r\n//         if (!openConv) return prev;\r\n\r\n//         const matchesOpenConversation =\r\n//           (conversationId && openConv.id && openConv.id === conversationId) ||\r\n//           (contactId &&\r\n//             openConv.contactId &&\r\n//             openConv.contactId === contactId) ||\r\n//           (payload.contactPhone &&\r\n//             openConv.contactPhone &&\r\n//             openConv.contactPhone === payload.contactPhone);\r\n\r\n//         if (!matchesOpenConversation) return prev;\r\n\r\n//         //  Merge-by-identity: update existing bubble when a status update arrives\r\n//         const sameMessage = (existing, incoming, raw) => {\r\n//           const incMessageId =\r\n//             incoming?.messageId ||\r\n//             raw?.messageId ||\r\n//             raw?.MessageId ||\r\n//             raw?.wamid ||\r\n//             raw?.Wamid ||\r\n//             null;\r\n\r\n//           const incClientId =\r\n//             incoming?.clientMessageId ||\r\n//             raw?.clientMessageId ||\r\n//             raw?.ClientMessageId ||\r\n//             raw?.clientId ||\r\n//             null;\r\n\r\n//           // Priority: WAMID  clientMessageId  id/serverId\r\n//           if (\r\n//             existing?.messageId &&\r\n//             incMessageId &&\r\n//             existing.messageId === incMessageId\r\n//           )\r\n//             return true;\r\n\r\n//           if (\r\n//             existing?.clientMessageId &&\r\n//             incClientId &&\r\n//             existing.clientMessageId === incClientId\r\n//           )\r\n//             return true;\r\n\r\n//           if (existing?.id && incoming?.id && existing.id === incoming.id)\r\n//             return true;\r\n\r\n//           // Sometimes the hub uses wamid as id\r\n//           if (existing?.id && incMessageId && existing.id === incMessageId)\r\n//             return true;\r\n\r\n//           // If you store serverId on messages (you do), match against it\r\n//           if (\r\n//             existing?.serverId &&\r\n//             incoming?.id &&\r\n//             existing.serverId === incoming.id\r\n//           )\r\n//             return true;\r\n\r\n//           return false;\r\n//         };\r\n\r\n//         const idx = prev.findIndex(m => sameMessage(m, mappedMsg, payload));\r\n\r\n//         //  If we already have it, UPDATE status/time/error instead of adding duplicate\r\n//         if (idx >= 0) {\r\n//           const existing = prev[idx];\r\n\r\n//           const merged = {\r\n//             ...existing,\r\n//             ...mappedMsg,\r\n\r\n//             // keep old text if hub sends status-only event\r\n//             text: mappedMsg.text || existing.text,\r\n\r\n//             // keep old time if hub sends weird/empty\r\n//             sentAt: mappedMsg.sentAt || existing.sentAt,\r\n\r\n//             // status should move forward (prefer incoming)\r\n//             status: mappedMsg.status || existing.status,\r\n\r\n//             // preserve ids if incoming is missing them\r\n//             messageId: mappedMsg.messageId || existing.messageId || null,\r\n//             clientMessageId:\r\n//               mappedMsg.clientMessageId || existing.clientMessageId || null,\r\n//             serverId: existing.serverId ?? null,\r\n\r\n//             errorMessage:\r\n//               mappedMsg.errorMessage ?? existing.errorMessage ?? null,\r\n//           };\r\n\r\n//           const next = [...prev];\r\n//           next[idx] = merged;\r\n//           return next;\r\n//         }\r\n\r\n//         //  Otherwise append as new bubble\r\n//         return [...prev, mappedMsg];\r\n//       });\r\n\r\n//       // 2) Update conversations list\r\n//       let matched = false;\r\n\r\n//       setAllConversations(prev => {\r\n//         const openConv = selectedConversationRef.current;\r\n\r\n//         const next = prev.map(c => {\r\n//           const isMatch =\r\n//             (conversationId && c.id === conversationId) ||\r\n//             (contactId && c.contactId === contactId) ||\r\n//             (payload.contactPhone && c.contactPhone === payload.contactPhone);\r\n\r\n//           if (!isMatch) return c;\r\n\r\n//           matched = true;\r\n\r\n//           const isOpen =\r\n//             !!openConv &&\r\n//             ((openConv.id && c.id === openConv.id) ||\r\n//               (openConv.contactId && c.contactId === openConv.contactId));\r\n\r\n//           const nextUnread =\r\n//             mappedMsg.isInbound && !isOpen\r\n//               ? (c.unreadCount ?? 0) + 1\r\n//               : c.unreadCount ?? 0;\r\n\r\n//           return {\r\n//             ...c,\r\n//             lastMessagePreview: mappedMsg.text || c.lastMessagePreview,\r\n//             lastMessageAt: mappedMsg.sentAt || c.lastMessageAt,\r\n//             lastInboundAt: mappedMsg.isInbound\r\n//               ? mappedMsg.sentAt || c.lastInboundAt\r\n//               : c.lastInboundAt,\r\n//             lastOutboundAt: !mappedMsg.isInbound\r\n//               ? mappedMsg.sentAt || c.lastOutboundAt\r\n//               : c.lastOutboundAt,\r\n//             within24h: mappedMsg.isInbound ? true : c.within24h,\r\n//             status:\r\n//               mappedMsg.isInbound &&\r\n//               parseConversationStatus(c.status) === \"Closed\"\r\n//                 ? \"Open\"\r\n//                 : c.status,\r\n//             unreadCount: isOpen ? 0 : nextUnread,\r\n//           };\r\n//         });\r\n\r\n//         return next;\r\n//       });\r\n\r\n//       if (!matched) {\r\n//         fetchConversations({ silent: true, limit: 100 });\r\n//       }\r\n//     },\r\n//     [fetchConversations]\r\n//   );\r\n\r\n//   //  SignalR: UnreadCountChanged handler\r\n//   const handleUnreadCountChanged = useCallback(\r\n//     payload => {\r\n//       if (!payload) return;\r\n\r\n//       if (payload.refresh) {\r\n//         fetchConversations({ silent: true, limit: 100 });\r\n//         return;\r\n//       }\r\n\r\n//       if (payload.contactId) {\r\n//         const hasUnread =\r\n//           typeof payload.unreadCount === \"number\" &&\r\n//           !Number.isNaN(payload.unreadCount);\r\n\r\n//         if (!hasUnread) return;\r\n\r\n//         setAllConversations(prev =>\r\n//           prev.map(c =>\r\n//             c.contactId === payload.contactId\r\n//               ? { ...c, unreadCount: payload.unreadCount }\r\n//               : c\r\n//           )\r\n//         );\r\n//         return;\r\n//       }\r\n\r\n//       if (Array.isArray(payload.items)) {\r\n//         const map = new Map();\r\n//         payload.items.forEach(item => {\r\n//           if (!item?.contactId) return;\r\n//           if (typeof item.unreadCount !== \"number\") return;\r\n//           map.set(item.contactId, item.unreadCount);\r\n//         });\r\n\r\n//         if (map.size === 0) return;\r\n\r\n//         setAllConversations(prev =>\r\n//           prev.map(c =>\r\n//             map.has(c.contactId)\r\n//               ? { ...c, unreadCount: map.get(c.contactId) }\r\n//               : c\r\n//           )\r\n//         );\r\n//       }\r\n//     },\r\n//     [fetchConversations]\r\n//   );\r\n\r\n//   //  SignalR: MessageStatusChanged handler (outbound delivery/read ticks)\r\n//   const handleMessageStatusChanged = useCallback(payload => {\r\n//     if (!payload) return;\r\n\r\n//     const openConv = selectedConversationRef.current;\r\n//     if (!openConv) return;\r\n\r\n//     const contactId = payload.contactId ?? payload.ContactId ?? null;\r\n//     if (contactId && openConv.contactId && openConv.contactId !== contactId) {\r\n//       return;\r\n//     }\r\n\r\n//     const messageLogId = payload.messageLogId ?? payload.MessageLogId ?? null;\r\n//     const providerMessageId =\r\n//       payload.providerMessageId ?? payload.ProviderMessageId ?? null;\r\n//     const messageId = payload.messageId ?? payload.MessageId ?? null;\r\n//     const nextStatus = payload.status ?? payload.Status ?? null;\r\n//     if (!nextStatus) return;\r\n\r\n//     const rank = s => {\r\n//       const v = String(s || \"\")\r\n//         .trim()\r\n//         .toLowerCase();\r\n\r\n//       if (!v) return 0;\r\n//       if (v === \"failed\" || v === \"error\" || v.includes(\"fail\")) return 99;\r\n//       if (v === \"read\" || v === \"seen\" || v === \"viewed\" || v.includes(\"read\"))\r\n//         return 4;\r\n//       if (v === \"delivered\" || v.includes(\"deliver\")) return 3;\r\n//       if (v === \"sent\") return 2;\r\n//       if (\r\n//         v === \"queued\" ||\r\n//         v === \"sending\" ||\r\n//         v === \"pending\" ||\r\n//         v.includes(\"queue\") ||\r\n//         v.includes(\"send\") ||\r\n//         v.includes(\"progress\")\r\n//       )\r\n//         return 1;\r\n\r\n//       return 0;\r\n//     };\r\n\r\n//     setMessages(prev =>\r\n//       prev.map(m => {\r\n//         const matchesByLogId =\r\n//           !!messageLogId && (m.id === messageLogId || m.serverId === messageLogId);\r\n\r\n//         const matchesByProviderId =\r\n//           !!providerMessageId &&\r\n//           (m.providerMessageId === providerMessageId ||\r\n//             m.messageId === providerMessageId ||\r\n//             m.id === providerMessageId);\r\n\r\n//         const matchesByMessageId =\r\n//           !!messageId && (m.messageId === messageId || m.id === messageId);\r\n\r\n//         const matches = matchesByLogId || matchesByProviderId || matchesByMessageId;\r\n//         if (!matches) return m;\r\n\r\n//         const currentRank = rank(m.status);\r\n//         const nextRank = rank(nextStatus);\r\n//         if (nextRank < currentRank) return m;\r\n\r\n//         return { ...m, status: nextStatus };\r\n//       })\r\n//     );\r\n//   }, []);\r\n\r\n//   //  Subscribe to SignalR events\r\n//   useEffect(() => {\r\n//     if (!connection || !isConnected) return;\r\n\r\n//     connection.on(\"ReceiveInboxMessage\", handleReceiveInboxMessage);\r\n//     connection.on(\"UnreadCountChanged\", handleUnreadCountChanged);\r\n//     connection.on(\"MessageStatusChanged\", handleMessageStatusChanged);\r\n\r\n//     return () => {\r\n//       connection.off(\"ReceiveInboxMessage\", handleReceiveInboxMessage);\r\n//       connection.off(\"UnreadCountChanged\", handleUnreadCountChanged);\r\n//       connection.off(\"MessageStatusChanged\", handleMessageStatusChanged);\r\n//     };\r\n//   }, [\r\n//     connection,\r\n//     isConnected,\r\n//     handleReceiveInboxMessage,\r\n//     handleUnreadCountChanged,\r\n//     handleMessageStatusChanged,\r\n//   ]);\r\n\r\n//   //  Send message (HTTP is source of truth)\r\n//   //  Send message (HTTP is source of truth)\r\n//   const handleSendMessage = async () => {\r\n//     if (!selectedConversation) {\r\n//       toast.warn(\"Please select a conversation first.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isConversationClosed) {\r\n//       toast.warn(\"This conversation is closed. Reopen it to reply.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (!isWithin24h) {\r\n//       toast.warn(\r\n//         \"This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage.\"\r\n//       );\r\n//       return;\r\n//     }\r\n\r\n//     const trimmed = newMessage.trim();\r\n//     if (!trimmed) {\r\n//       toast.warn(\"Type a message before sending.\");\r\n//       return;\r\n//     }\r\n\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n//     if (!businessId) {\r\n//       toast.error(\" Missing business context. Please login again.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isSending) return;\r\n\r\n//     // Normalize statuses so StatusIcon mapping stays consistent\r\n//     const normalizeStatus = raw => {\r\n//       const s = String(raw || \"\")\r\n//         .trim()\r\n//         .toLowerCase();\r\n\r\n//       if (!s) return null;\r\n\r\n//       if (s.includes(\"fail\") || s.includes(\"error\") || s.includes(\"reject\"))\r\n//         return \"Failed\";\r\n\r\n//       if (s.includes(\"read\") || s === \"seen\" || s === \"viewed\") return \"Read\";\r\n//       if (s.includes(\"deliver\")) return \"Delivered\";\r\n\r\n//       if (s === \"sent\") return \"Sent\";\r\n\r\n//       // Anything \"in-flight\" should be Clock (not )\r\n//       if (\r\n//         s.includes(\"queue\") ||\r\n//         s === \"queued\" ||\r\n//         s.includes(\"send\") ||\r\n//         s === \"sending\" ||\r\n//         s === \"pending\" ||\r\n//         s.includes(\"accept\") ||\r\n//         s.includes(\"submit\") ||\r\n//         s.includes(\"process\") ||\r\n//         s.includes(\"progress\")\r\n//       ) {\r\n//         return \"Queued\";\r\n//       }\r\n\r\n//       // safest default: still in-flight\r\n//       return \"Queued\";\r\n//     };\r\n\r\n//     const tempId = `temp-${Date.now()}`;\r\n//     const nowIso = new Date().toISOString();\r\n\r\n//     const optimisticMsg = {\r\n//       id: tempId,\r\n//       clientMessageId: tempId, //  lets SignalR/webhook reconcile later\r\n//       direction: \"out\",\r\n//       isInbound: false,\r\n//       text: trimmed,\r\n//       sentAt: nowIso,\r\n//       status: \"Queued\", //  IMPORTANT: never show  optimistically\r\n//       errorMessage: null,\r\n//     };\r\n\r\n//     setMessages(prev => [...prev, optimisticMsg]);\r\n\r\n//     setNewMessage(\"\");\r\n//     setIsSending(true);\r\n\r\n//     try {\r\n//       const payload = {\r\n//         businessId,\r\n//         conversationId: selectedConversation.id,\r\n//         contactId: selectedConversation.contactId,\r\n//         to: selectedConversation.contactPhone,\r\n//         text: trimmed,\r\n//         numberId: selectedConversation.numberId,\r\n\r\n//         //  harmless if backend ignores it, super useful if backend stores/echoes it\r\n//         clientMessageId: tempId,\r\n//       };\r\n\r\n//       const res = await axiosClient.post(\"/chat-inbox/send-message\", payload);\r\n//       const saved = res.data || {};\r\n\r\n//       const finalSentAt =\r\n//         saved.sentAtUtc || saved.sentAt || optimisticMsg.sentAt;\r\n\r\n//       const finalSentAtIso =\r\n//         finalSentAt instanceof Date ? finalSentAt.toISOString() : finalSentAt;\r\n\r\n//       //  Use backend status if present; otherwise stay \"Queued\"\r\n//       const serverStatus = normalizeStatus(saved.status) || \"Queued\";\r\n\r\n//       setMessages(prev =>\r\n//         prev.map(m =>\r\n//           m.id === tempId\r\n//             ? {\r\n//                 ...m,\r\n//                 // Keep client id stable so we dont create duplicates\r\n//                 id: m.id,\r\n//                 serverId: saved.id ?? null,\r\n//                 messageId:\r\n//                   saved.messageId ??\r\n//                   saved.wamid ??\r\n//                   saved.waMessageId ??\r\n//                   saved.providerMessageId ??\r\n//                   null,\r\n//                 sentAt: finalSentAtIso,\r\n//                 status: serverStatus,\r\n//                 errorMessage: saved.errorMessage || null,\r\n//               }\r\n//             : m\r\n//         )\r\n//       );\r\n\r\n//       // Update conversation preview/timestamps (dont force within24h true on outbound)\r\n//       setAllConversations(prev =>\r\n//         prev.map(c =>\r\n//           c.id === selectedConversation.id\r\n//             ? {\r\n//                 ...c,\r\n//                 lastMessagePreview: trimmed,\r\n//                 lastMessageAt: finalSentAtIso,\r\n//                 lastOutboundAt: finalSentAtIso,\r\n//               }\r\n//             : c\r\n//         )\r\n//       );\r\n//     } catch (error) {\r\n//       console.error(\" Failed to send message:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message || \"Failed to send message. Please retry.\"\r\n//       );\r\n\r\n//       setMessages(prev =>\r\n//         prev.map(m =>\r\n//           m.id === tempId\r\n//             ? { ...m, status: \"Failed\", errorMessage: \"Not delivered\" }\r\n//             : m\r\n//         )\r\n//       );\r\n//     } finally {\r\n//       setIsSending(false);\r\n//       scrollToBottom();\r\n//     }\r\n//   };\r\n\r\n//   const handleComposerKeyDown = event => {\r\n//     if (event.key === \"Enter\" && !event.shiftKey) {\r\n//       event.preventDefault();\r\n//       if (!isSending && newMessage.trim()) {\r\n//         handleSendMessage();\r\n//       }\r\n//     }\r\n//   };\r\n\r\n//   //  Assign conversation to me\r\n//   const handleAssignToMe = async () => {\r\n//     if (!selectedConversation || !selectedConversation.contactId) {\r\n//       toast.warn(\"Select a conversation before assigning.\");\r\n//       return;\r\n//     }\r\n\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n//     const userId = localStorage.getItem(\"userId\");\r\n\r\n//     if (!businessId || !userId) {\r\n//       toast.error(\"Missing business or user context. Please login again.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isAssigning) return;\r\n\r\n//     setIsAssigning(true);\r\n//     try {\r\n//       const payload = {\r\n//         businessId,\r\n//         contactId: selectedConversation.contactId,\r\n//         userId,\r\n//       };\r\n\r\n//       await axiosClient.post(\"/chat-inbox/assign\", payload);\r\n\r\n//       setAllConversations(prev =>\r\n//         prev.map(c =>\r\n//           c.id === selectedConversation.id\r\n//             ? {\r\n//                 ...c,\r\n//                 assignedToUserId: userId,\r\n//                 assignedToUserName: \"You\",\r\n//                 isAssignedToMe: true,\r\n//               }\r\n//             : c\r\n//         )\r\n//       );\r\n\r\n//       await fetchConversations({ silent: true, limit: 100 });\r\n//       toast.success(\"Conversation assigned to you.\");\r\n//     } catch (error) {\r\n//       console.error(\"Failed to assign conversation:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message || \"Failed to assign conversation.\"\r\n//       );\r\n//     } finally {\r\n//       setIsAssigning(false);\r\n//     }\r\n//   };\r\n\r\n//   //  Unassign conversation\r\n//   const handleAssignToAgent = async assigneeUserId => {\r\n//     if (!selectedConversation || !selectedConversation.contactId) {\r\n//       toast.warn(\"Select a conversation before assigning.\");\r\n//       return;\r\n//     }\r\n\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n//     if (!businessId) {\r\n//       toast.error(\"Missing business context. Please login again.\");\r\n//       return;\r\n//     }\r\n\r\n//     const userId = String(assigneeUserId ?? \"\").trim();\r\n//     if (!userId) {\r\n//       toast.error(\"Select a valid agent to assign.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isAssigning) return;\r\n\r\n//     setIsAssigning(true);\r\n//     try {\r\n//       const payload = {\r\n//         businessId,\r\n//         contactId: selectedConversation.contactId,\r\n//         userId,\r\n//       };\r\n\r\n//       await axiosClient.post(\"/chat-inbox/assign\", payload);\r\n\r\n//       const myUserId = localStorage.getItem(\"userId\");\r\n//       const agentName =\r\n//         agents.find(a => String(a.userId) === String(userId))?.name ?? \"Agent\";\r\n\r\n//       setAllConversations(prev =>\r\n//         prev.map(c =>\r\n//           c.id === selectedConversation.id\r\n//             ? {\r\n//                 ...c,\r\n//                 assignedToUserId: userId,\r\n//                 assignedToUserName:\r\n//                   myUserId && String(myUserId) === String(userId)\r\n//                     ? \"You\"\r\n//                     : agentName,\r\n//                 isAssignedToMe:\r\n//                   myUserId && String(myUserId) === String(userId),\r\n//               }\r\n//             : c\r\n//         )\r\n//       );\r\n\r\n//       await fetchConversations({ silent: true, limit: 100 });\r\n\r\n//       const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n//       if (tabKey === \"unassigned\" || tabKey === \"my\") {\r\n//         setSelectedConversationId(null);\r\n//       }\r\n\r\n//       toast.success(\"Conversation assigned.\");\r\n//     } catch (error) {\r\n//       console.error(\"Failed to assign conversation:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message || \"Failed to assign conversation.\"\r\n//       );\r\n//     } finally {\r\n//       setIsAssigning(false);\r\n//     }\r\n//   };\r\n\r\n//   const handleUnassign = async () => {\r\n//     if (!selectedConversation || !selectedConversation.contactId) {\r\n//       toast.warn(\"Select a conversation before unassigning.\");\r\n//       return;\r\n//     }\r\n\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n\r\n//     if (!businessId) {\r\n//       toast.error(\"Missing business context. Please login again.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isAssigning) return;\r\n\r\n//     setIsAssigning(true);\r\n//     try {\r\n//       const payload = {\r\n//         businessId,\r\n//         contactId: selectedConversation.contactId,\r\n//       };\r\n\r\n//       await axiosClient.post(\"/chat-inbox/unassign\", payload);\r\n\r\n//       setAllConversations(prev =>\r\n//         prev.map(c =>\r\n//           c.id === selectedConversation.id\r\n//             ? {\r\n//                 ...c,\r\n//                 assignedToUserId: null,\r\n//                 assignedToUserName: null,\r\n//                 isAssignedToMe: false,\r\n//               }\r\n//             : c\r\n//         )\r\n//       );\r\n\r\n//       await fetchConversations({ silent: true, limit: 100 });\r\n\r\n//       const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n//       if (tabKey === \"my\") {\r\n//         setSelectedConversationId(null);\r\n//       }\r\n\r\n//       toast.info(\"Conversation unassigned.\");\r\n//     } catch (error) {\r\n//       console.error(\"Failed to unassign conversation:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message || \"Failed to unassign conversation.\"\r\n//       );\r\n//     } finally {\r\n//       setIsAssigning(false);\r\n//     }\r\n//   };\r\n\r\n//   //  Open full CRM (Contact 360 workspace)\r\n//   const handleUpdateConversationStatus = async newStatus => {\r\n//     if (!selectedConversation || !selectedConversation.contactId) {\r\n//       toast.warn(\"Select a conversation before updating status.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (!headerIsAssignedToMe) {\r\n//       toast.error(\"Not allowed to update this conversation.\");\r\n//       return;\r\n//     }\r\n\r\n//     const businessId = localStorage.getItem(\"businessId\");\r\n//     if (!businessId) {\r\n//       toast.error(\"Missing business context. Please login again.\");\r\n//       return;\r\n//     }\r\n\r\n//     const normalized = parseConversationStatus(newStatus);\r\n//     if (!normalized) {\r\n//       toast.error(\"Invalid status. Use Open, Pending, or Closed.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isUpdatingStatus) return;\r\n\r\n//     const tabKey = activeTab === \"history\" ? \"older\" : activeTab;\r\n\r\n//     setIsUpdatingStatus(true);\r\n//     try {\r\n//       const payload = {\r\n//         businessId,\r\n//         contactId: selectedConversation.contactId,\r\n//         status: normalized,\r\n//       };\r\n\r\n//       try {\r\n//         await axiosClient.post(\"/chat-inbox/set-status\", payload);\r\n//       } catch (e) {\r\n//         const statusCode = e?.response?.status;\r\n//         if (statusCode === 404) {\r\n//           await axiosClient.post(\"/chat-inbox/status\", payload);\r\n//         } else {\r\n//           throw e;\r\n//         }\r\n//       }\r\n\r\n//       setAllConversations(prev =>\r\n//         prev.map(c =>\r\n//           c.id === selectedConversation.id ? { ...c, status: normalized } : c\r\n//         )\r\n//       );\r\n\r\n//       if (\r\n//         (tabKey === \"closed\" && normalized !== \"Closed\") ||\r\n//         (tabKey !== \"closed\" && normalized === \"Closed\")\r\n//       ) {\r\n//         setSelectedConversationId(null);\r\n//       }\r\n\r\n//       await fetchConversations({ silent: true, limit: 100 });\r\n//       toast.success(\"Status updated.\");\r\n//     } catch (error) {\r\n//       console.error(\"Failed to update status:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message || \"Failed to update status.\"\r\n//       );\r\n//     } finally {\r\n//       setIsUpdatingStatus(false);\r\n//     }\r\n//   };\r\n\r\n//   const handleOpenFullCrm = () => {\r\n//     if (!selectedConversation) {\r\n//       toast.info(\"Select a conversation first to open full CRM.\");\r\n//       return;\r\n//     }\r\n//     if (!selectedContactId) {\r\n//       toast.info(\"No contact is linked to this conversation yet.\");\r\n//       return;\r\n//     }\r\n//     navigate(`/app/crm/contacts/${selectedContactId}`);\r\n//   };\r\n\r\n//   //  Quick add note from Inbox\r\n//   const handleAddNote = async () => {\r\n//     if (!selectedConversation || !selectedContactId) {\r\n//       toast.warn(\"Select a conversation with a linked contact to add notes.\");\r\n//       return;\r\n//     }\r\n\r\n//     const content = noteDraft.trim();\r\n//     if (!content) {\r\n//       toast.warn(\"Type something for the note before saving.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isSavingNote) return;\r\n\r\n//     const title =\r\n//       content.length > 50 ? `${content.substring(0, 50)}` : content;\r\n\r\n//     const dto = {\r\n//       contactId: selectedContactId,\r\n//       title,\r\n//       content,\r\n//       source: \"Inbox\",\r\n//       createdBy:\r\n//         localStorage.getItem(\"userName\") ||\r\n//         localStorage.getItem(\"email\") ||\r\n//         \"Agent\",\r\n//       isPinned: false,\r\n//       isInternal: true,\r\n//     };\r\n\r\n//     setIsSavingNote(true);\r\n//     try {\r\n//       await axiosClient.post(\"/notes\", dto);\r\n\r\n//       toast.success(\"Note added.\");\r\n//       setNoteDraft(\"\");\r\n\r\n//       await refreshContactSummary();\r\n//     } catch (error) {\r\n//       console.error(\"Failed to add note:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message ||\r\n//           error.response?.data?.title ||\r\n//           \"Failed to add note from inbox.\"\r\n//       );\r\n//     } finally {\r\n//       setIsSavingNote(false);\r\n//     }\r\n//   };\r\n\r\n//   //  Quick add reminder from Inbox\r\n//   const handleAddReminder = async () => {\r\n//     if (!selectedConversation || !selectedContactId) {\r\n//       toast.warn(\r\n//         \"Select a conversation with a linked contact to add reminders.\"\r\n//       );\r\n//       return;\r\n//     }\r\n\r\n//     const title = reminderTitle.trim();\r\n//     if (!title) {\r\n//       toast.warn(\"Enter a reminder title.\");\r\n//       return;\r\n//     }\r\n//     if (!reminderDueAt) {\r\n//       toast.warn(\"Choose a due date/time for the reminder.\");\r\n//       return;\r\n//     }\r\n\r\n//     const dueIso = toIsoFromDatetimeLocal(reminderDueAt);\r\n//     if (!dueIso) {\r\n//       toast.error(\"Invalid reminder date/time.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isSavingReminder) return;\r\n\r\n//     const dto = {\r\n//       contactId: selectedContactId,\r\n//       title,\r\n//       description: reminderDescription || \"\",\r\n//       dueAt: dueIso,\r\n\r\n//       reminderType: \"FollowUp\",\r\n//       priority: 2,\r\n//       isRecurring: false,\r\n//       recurrencePattern: \"\",\r\n//       sendWhatsappNotification: false,\r\n//       linkedCampaign: \"\",\r\n//       status: \"Pending\",\r\n\r\n//       //  add CreatedBy so your backend timeline logging never breaks\r\n//       createdBy:\r\n//         localStorage.getItem(\"userName\") ||\r\n//         localStorage.getItem(\"email\") ||\r\n//         \"Agent\",\r\n//     };\r\n\r\n//     setIsSavingReminder(true);\r\n//     try {\r\n//       await axiosClient.post(\"/reminders\", dto);\r\n\r\n//       toast.success(\"Reminder added.\");\r\n//       setReminderTitle(\"\");\r\n//       setReminderDueAt(\"\");\r\n//       setReminderDescription(\"\");\r\n\r\n//       await refreshContactSummary();\r\n//     } catch (error) {\r\n//       console.error(\"Failed to add reminder:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message ||\r\n//           error.response?.data?.title ||\r\n//           \"Failed to add reminder from inbox.\"\r\n//       );\r\n//     } finally {\r\n//       setIsSavingReminder(false);\r\n//     }\r\n//   };\r\n\r\n//   //  Update note (inline edit)\r\n//   const handleUpdateNote = async note => {\r\n//     if (!note?.id) return;\r\n//     const content = editNoteContent.trim();\r\n//     if (!content) {\r\n//       toast.warn(\"Note content cannot be empty.\");\r\n//       return;\r\n//     }\r\n//     if (!selectedContactId) return;\r\n\r\n//     if (isUpdatingNote) return;\r\n\r\n//     const title =\r\n//       content.length > 50 ? `${content.substring(0, 50)}` : content;\r\n\r\n//     const dto = {\r\n//       contactId: selectedContactId,\r\n//       title,\r\n//       content,\r\n//       source: note.source || \"Inbox\",\r\n//       createdBy:\r\n//         localStorage.getItem(\"userName\") ||\r\n//         localStorage.getItem(\"email\") ||\r\n//         \"Agent\",\r\n//       isPinned: !!note.isPinned,\r\n//       isInternal: note.isInternal ?? true,\r\n//     };\r\n\r\n//     setIsUpdatingNote(true);\r\n//     try {\r\n//       await axiosClient.put(`/notes/${note.id}`, dto);\r\n//       toast.success(\"Note updated.\");\r\n//       setEditingNoteId(null);\r\n//       setEditNoteContent(\"\");\r\n//       await refreshContactSummary();\r\n//     } catch (error) {\r\n//       console.error(\"Failed to update note:\", error);\r\n//       toast.error(error.response?.data?.message || \"Failed to update note.\");\r\n//     } finally {\r\n//       setIsUpdatingNote(false);\r\n//     }\r\n//   };\r\n\r\n//   //  Update reminder (inline edit)\r\n//   const handleUpdateReminder = async reminder => {\r\n//     if (!reminder?.id) return;\r\n//     if (!selectedContactId) return;\r\n\r\n//     const title = editReminderTitle.trim();\r\n//     if (!title) {\r\n//       toast.warn(\"Reminder title cannot be empty.\");\r\n//       return;\r\n//     }\r\n\r\n//     const dueIso = toIsoFromDatetimeLocal(editReminderDueAt);\r\n//     if (!dueIso) {\r\n//       toast.warn(\"Pick a valid due date/time.\");\r\n//       return;\r\n//     }\r\n\r\n//     if (isUpdatingReminder) return;\r\n\r\n//     const dto = {\r\n//       contactId: selectedContactId,\r\n//       title,\r\n//       description: editReminderDescription || \"\",\r\n//       dueAt: dueIso,\r\n//       status: reminder.status || \"Pending\",\r\n//       reminderType: reminder.reminderType || \"FollowUp\",\r\n//       priority: reminder.priority ?? 2,\r\n//       isRecurring: !!reminder.isRecurring,\r\n//       recurrencePattern: reminder.recurrencePattern || \"\",\r\n//       sendWhatsappNotification: !!reminder.sendWhatsappNotification,\r\n//       linkedCampaign: reminder.linkedCampaign || \"\",\r\n//       createdBy:\r\n//         localStorage.getItem(\"userName\") ||\r\n//         localStorage.getItem(\"email\") ||\r\n//         \"Agent\",\r\n//     };\r\n\r\n//     setIsUpdatingReminder(true);\r\n//     try {\r\n//       await axiosClient.put(`/reminders/${reminder.id}`, dto);\r\n//       toast.success(\"Reminder updated.\");\r\n//       setEditingReminderId(null);\r\n//       setEditReminderTitle(\"\");\r\n//       setEditReminderDueAt(\"\");\r\n//       setEditReminderDescription(\"\");\r\n//       await refreshContactSummary();\r\n//     } catch (error) {\r\n//       console.error(\"Failed to update reminder:\", error);\r\n//       toast.error(\r\n//         error.response?.data?.message || \"Failed to update reminder.\"\r\n//       );\r\n//     } finally {\r\n//       setIsUpdatingReminder(false);\r\n//     }\r\n//   };\r\n\r\n//   //  Confirm delete flow\r\n//   const openDeleteConfirm = (type, item) => {\r\n//     setConfirmState({\r\n//       open: true,\r\n//       type,\r\n//       id: item?.id || null,\r\n//       title: type === \"note\" ? \"Delete note?\" : \"Delete reminder?\",\r\n//     });\r\n//   };\r\n\r\n//   const closeConfirm = () => {\r\n//     if (confirmBusy) return;\r\n//     setConfirmState({ open: false, type: null, id: null, title: \"\" });\r\n//   };\r\n\r\n//   const executeDelete = async () => {\r\n//     if (!confirmState?.id || !confirmState?.type) return;\r\n//     setConfirmBusy(true);\r\n\r\n//     try {\r\n//       if (confirmState.type === \"note\") {\r\n//         await axiosClient.delete(`/notes/${confirmState.id}`);\r\n//         toast.info(\"Note deleted.\");\r\n//       } else if (confirmState.type === \"reminder\") {\r\n//         await axiosClient.delete(`/reminders/${confirmState.id}`);\r\n//         toast.info(\"Reminder deleted.\");\r\n//       }\r\n//       await refreshContactSummary();\r\n//     } catch (error) {\r\n//       console.error(\"Delete failed:\", error);\r\n//       toast.error(error.response?.data?.message || \"Delete failed.\");\r\n//     } finally {\r\n//       setConfirmBusy(false);\r\n//       closeConfirm();\r\n//     }\r\n//   };\r\n\r\n//   // Small helpers for CRM panel\r\n//   const tagsList =\r\n//     (contactSummary?.tags ??\r\n//       contactSummary?.contactTags ??\r\n//       contactSummary?.contactTagsDto ??\r\n//       []) ||\r\n//     [];\r\n\r\n//   const recentNotes = contactSummary?.recentNotes ?? [];\r\n//   const nextReminder = contactSummary?.nextReminder ?? null;\r\n//   const recentTimeline = contactSummary?.recentTimeline ?? [];\r\n\r\n//   return {\r\n//     activeTab,\r\n//     allConversations,\r\n//     closeConfirm,\r\n//     confirmBusy,\r\n//     confirmState,\r\n//     connection,\r\n//     contactSummary,\r\n//     conversationsRef,\r\n//     currentUserId,\r\n//     editNoteContent,\r\n//     editReminderDescription,\r\n//     editReminderDueAt,\r\n//     editReminderTitle,\r\n//     editingNoteId,\r\n//     editingReminderId,\r\n//     executeDelete,\r\n//     fetchConversations,\r\n//     filteredConversations,\r\n//     agents,\r\n//     isAgentsLoading,\r\n//     handleAddNote,\r\n//     handleAddReminder,\r\n//     handleAssignToMe,\r\n//     handleAssignToAgent,\r\n//     handleComposerKeyDown,\r\n//     handleOpenFullCrm,\r\n//     handleReceiveInboxMessage,\r\n//     handleRemoveTag,\r\n//     handleSendMessage,\r\n//     handleUnassign,\r\n//     handleUnreadCountChanged,\r\n//     handleUpdateConversationStatus,\r\n//     handleUpdateNote,\r\n//     handleUpdateReminder,\r\n//     headerAssignedName,\r\n//     headerIsAssigned,\r\n//     headerIsAssignedToMe,\r\n//     isAssigning,\r\n//     isConnected,\r\n//     isLoading,\r\n//     isMessagesLoading,\r\n//     isSavingNote,\r\n//     isSavingReminder,\r\n//     isSending,\r\n//     isSummaryLoading,\r\n//     isTagModalOpen,\r\n//     isUpdatingStatus,\r\n//     isUpdatingNote,\r\n//     isUpdatingReminder,\r\n//     isWithin24h,\r\n//     isConversationClosed,\r\n//     messages,\r\n//     messagesEndRef,\r\n//     messagesWithSeparators,\r\n//     navigate,\r\n//     newMessage,\r\n//     nextReminder,\r\n//     noteDraft,\r\n//     openDeleteConfirm,\r\n//     recentNotes,\r\n//     recentTimeline,\r\n//     refreshContactSummary,\r\n//     reminderDescription,\r\n//     reminderDueAt,\r\n//     reminderTitle,\r\n//     removingTagId,\r\n//     scrollToBottom,\r\n//     searchTerm,\r\n//     selectedContactId,\r\n//     selectedConversation,\r\n//     selectedConversationId,\r\n//     selectedConversationRef,\r\n//     selectedNumberId,\r\n//     setActiveTab,\r\n//     setAllConversations,\r\n//     setConfirmBusy,\r\n//     setConfirmState,\r\n//     setContactSummary,\r\n//     setEditNoteContent,\r\n//     setEditReminderDescription,\r\n//     setEditReminderDueAt,\r\n//     setEditReminderTitle,\r\n//     setEditingNoteId,\r\n//     setEditingReminderId,\r\n//     setIsAssigning,\r\n//     setIsLoading,\r\n//     setIsMessagesLoading,\r\n//     setIsSavingNote,\r\n//     setIsSavingReminder,\r\n//     setIsSending,\r\n//     setIsSummaryLoading,\r\n//     setIsTagModalOpen,\r\n//     setIsUpdatingNote,\r\n//     setIsUpdatingReminder,\r\n//     setMessages,\r\n//     setNewMessage,\r\n//     setNoteDraft,\r\n//     setReminderDescription,\r\n//     setReminderDueAt,\r\n//     setReminderTitle,\r\n//     setRemovingTagId,\r\n//     setSearchTerm,\r\n//     setSelectedConversationId,\r\n//     setSelectedNumberId,\r\n//     setShowCrmPanel,\r\n//     setShowDetails,\r\n//     setShowMiniTimeline,\r\n//     setShowRightPanel,\r\n//     showCrmPanel,\r\n//     showDetails,\r\n//     showMiniTimeline,\r\n//     showRightPanel,\r\n//     tagsList,\r\n//   };\r\n// }\r\n","import useSignalR from \"../../../hooks/useSignalR\";\n\nexport default function useInboxSignalR() {\n  return useSignalR();\n}\n\n","import React from \"react\";\nimport { X } from \"lucide-react\";\n\n/**  Modern confirm dialog (no window.confirm) */\nexport function ConfirmDialog({\n  open,\n  title,\n  message,\n  confirmText = \"Confirm\",\n  cancelText = \"Cancel\",\n  danger = false,\n  loading = false,\n  onConfirm,\n  onCancel,\n}) {\n  if (!open) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4\">\n      <div className=\"w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div>\n            <h3 className=\"text-sm font-semibold text-slate-900\">{title}</h3>\n            <p className=\"mt-1 text-xs text-slate-600\">{message}</p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={onCancel}\n            className=\"rounded-lg p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600\"\n          >\n            <X className=\"h-4 w-4\" />\n          </button>\n        </div>\n\n        <div className=\"mt-4 flex justify-end gap-2\">\n          <button\n            type=\"button\"\n            onClick={onCancel}\n            disabled={loading}\n            className=\"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\n          >\n            {cancelText}\n          </button>\n          <button\n            type=\"button\"\n            onClick={onConfirm}\n            disabled={loading}\n            className={`rounded-lg px-3 py-1.5 text-xs font-semibold text-white disabled:opacity-60 ${\n              danger\n                ? \"bg-rose-600 hover:bg-rose-700\"\n                : \"bg-emerald-600 hover:bg-emerald-700\"\n            }`}\n          >\n            {loading ? \"Working\" : confirmText}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","import React from \"react\";\nimport axiosClient from \"../../api/chatInboxApi\";\nimport { toast } from \"react-toastify\";\n\n//  Quick Tag modal for Inbox  adds ONE new tag to the current contact\nexport function InboxAddTagModal({\n  isOpen,\n  onClose,\n  contactId,\n  currentTags,\n  onTagAdded,\n}) {\n  const [availableTags, setAvailableTags] = React.useState([]);\n  const [selectedTagId, setSelectedTagId] = React.useState(\"\");\n  const [loadingTags, setLoadingTags] = React.useState(false);\n  const [saving, setSaving] = React.useState(false);\n\n  // Load all tags when modal opens\n  React.useEffect(() => {\n    if (!isOpen) return;\n\n    const fetchTags = async () => {\n      try {\n        setLoadingTags(true);\n\n        //  use correct backend route: /tags/get-tags\n        const response = await axiosClient.get(\"/tags/get-tags\");\n        const allTags = response.data?.data || response.data || [];\n\n        // Remove tags that this contact already has\n        const existingIds = new Set(\n          (currentTags || []).map(t => t.id || t.tagId)\n        );\n        const filtered = allTags.filter(t => !existingIds.has(t.id));\n\n        setAvailableTags(filtered);\n        setSelectedTagId(filtered.length > 0 ? filtered[0].id : \"\");\n      } catch (error) {\n        console.error(\"Failed to load tags for Inbox:\", error);\n        toast.error(\"Failed to load tags\");\n        setAvailableTags([]);\n      } finally {\n        setLoadingTags(false);\n      }\n    };\n\n    fetchTags();\n  }, [isOpen, currentTags]);\n\n  const handleSubmit = async e => {\n    e.preventDefault();\n\n    if (!selectedTagId) {\n      toast.warn(\"Select a tag to add.\");\n      return;\n    }\n    if (!contactId) {\n      toast.error(\"No contact selected.\");\n      return;\n    }\n\n    try {\n      setSaving(true);\n\n      // Reuse existing bulk assign endpoint from CRM\n      await axiosClient.post(\"/contacts/bulk-assign-tag\", {\n        contactIds: [contactId],\n        tagId: selectedTagId,\n      });\n\n      toast.success(\"Tag added to this contact\");\n      onTagAdded && onTagAdded();\n      onClose();\n    } catch (error) {\n      console.error(\"Failed to assign tag from Inbox:\", error);\n      const message = error.response?.data?.message || \"Failed to assign tag\";\n      toast.error(message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-40 flex items-center justify-center bg-black/40\">\n      <div className=\"w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl\">\n        <h2 className=\"mb-3 text-sm font-semibold text-slate-900\">\n          Add tag to this contact\n        </h2>\n\n        {loadingTags ? (\n          <p className=\"text-xs text-slate-500\">Loading tags</p>\n        ) : availableTags.length === 0 ? (\n          <div className=\"space-y-3\">\n            <p className=\"text-xs text-slate-500\">\n              No new tags available. Create tags in the CRM workspace first, or\n              this contact already has all tags.\n            </p>\n            <div className=\"flex justify-end pt-1\">\n              <button\n                type=\"button\"\n                onClick={onClose}\n                className=\"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50\"\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        ) : (\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <label className=\"mb-1 block text-xs font-medium text-slate-600\">\n                Select tag\n              </label>\n              <select\n                className=\"w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500\"\n                value={selectedTagId}\n                onChange={e => setSelectedTagId(e.target.value)}\n                disabled={saving}\n              >\n                {availableTags.map(tag => (\n                  <option key={tag.id} value={tag.id}>\n                    {tag.name || tag.tagName || \"Tag\"}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            <div className=\"flex justify-end gap-2 pt-1\">\n              <button\n                type=\"button\"\n                onClick={onClose}\n                disabled={saving}\n                className=\"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                disabled={saving || availableTags.length === 0}\n                className=\"rounded-lg bg-emerald-600 px-4 py-1.5 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60\"\n              >\n                {saving ? \"Adding\" : \"Add tag\"}\n              </button>\n            </div>\n          </form>\n        )}\n      </div>\n    </div>\n  );\n}\n","import React from \"react\";\nimport { getInitial } from \"../utils/formatters\";\n\nfunction getComplianceBadges(conv) {\n  const optStatus = Number(conv?.optStatus ?? conv?.contact?.optStatus);\n  const channelStatus = Number(\n    conv?.channelStatus ?? conv?.contact?.channelStatus\n  );\n  const badges = [];\n\n  if (optStatus === 2) {\n    badges.push({\n      key: \"opted-out\",\n      label: \"Opted out\",\n      className: \"border-amber-200 bg-amber-50 text-amber-700\",\n    });\n  }\n\n  if (channelStatus === 2) {\n    badges.push({\n      key: \"invalid\",\n      label: \"Invalid\",\n      className: \"border-rose-200 bg-rose-50 text-rose-700\",\n    });\n  } else if (channelStatus === 1) {\n    badges.push({\n      key: \"blocked\",\n      label: \"Blocked\",\n      className: \"border-orange-200 bg-orange-50 text-orange-700\",\n    });\n  }\n\n  return badges;\n}\n\nexport function ConversationRow({ conv, isSelected, onClick }) {\n  return (\n    <button\n      type=\"button\"\n      onClick={onClick}\n      className={`w-full flex items-start gap-3 px-3 py-2.5 text-left border-b border-slate-100 hover:bg-white transition ${\n        isSelected ? \"bg-white\" : \"bg-slate-50\"\n      }`}\n    >\n      <div className=\"relative\">\n        <div className=\"w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700\">\n          {getInitial(conv.contactName, conv.contactPhone)}\n        </div>\n        {conv.unreadCount > 0 && (\n          <span className=\"absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-semibold rounded-full px-1.5 py-[1px]\">\n            {conv.unreadCount}\n          </span>\n        )}\n      </div>\n\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center justify-between mb-0.5\">\n          <div className=\"flex flex-col\">\n            <div className=\"flex items-center gap-1.5 min-w-0\">\n              <span className=\"text-xs font-semibold text-slate-800 truncate\">\n                {conv.contactName || conv.contactPhone || \"Unknown\"}\n              </span>\n              {getComplianceBadges(conv).map(badge => (\n                <span\n                  key={badge.key}\n                  className={`inline-flex items-center rounded-full border px-1.5 py-[1px] text-[9px] font-medium ${badge.className}`}\n                >\n                  {badge.label}\n                </span>\n              ))}\n            </div>\n            <span className=\"text-[10px] text-slate-400\">{conv.contactPhone}</span>\n          </div>\n          <span className=\"text-[10px] text-slate-400 ml-2\">\n            {conv.lastMessageAt\n              ? new Date(conv.lastMessageAt).toLocaleTimeString([], {\n                  hour: \"2-digit\",\n                  minute: \"2-digit\",\n                })\n              : \"-\"}\n          </span>\n        </div>\n\n        <div className=\"flex items-center justify-between gap-2\">\n          <p className=\"text-[11px] text-slate-600 truncate pr-4\">\n            {conv.lastMessagePreview || \"No recent message\"}\n          </p>\n\n          <div className=\"flex flex-col items-end gap-0.5\">\n            <span\n              className={`text-[9px] px-1.5 py-[1px] rounded-full border ${\n                conv.within24h\n                  ? \"bg-emerald-50 text-emerald-700 border-emerald-100\"\n                  : \"bg-slate-50 text-slate-500 border-slate-200\"\n              }`}\n            >\n              {conv.within24h ? \"24h window\" : \"Outside 24h\"}\n            </span>\n            {conv.assignedToUserName && (\n              <span className=\"text-[9px] text-slate-400\">\n                {conv.assignedToUserName}\n              </span>\n            )}\n          </div>\n        </div>\n      </div>\n    </button>\n  );\n}\n","import React from \"react\";\r\nimport { Phone, Filter, Search, ChevronDown, Activity } from \"lucide-react\";\r\nimport { ConversationRow } from \"./ConversationRow\";\r\n\r\nconst MOCK_NUMBERS = [\r\n  { id: \"all\", label: \"All numbers\" },\r\n  { id: \"wa-1\", label: \"+91 98765 43210\" },\r\n  { id: \"wa-2\", label: \"+91 99887 77665\" },\r\n];\r\n\r\nconst TABS = [\r\n  { id: \"live\", label: \"Live\" },\r\n  { id: \"unassigned\", label: \"Unassigned\" },\r\n  { id: \"my\", label: \"My\" },\r\n  { id: \"closed\", label: \"Closed\" },\r\n  { id: \"history\", label: \"History\" },\r\n];\r\n\r\nexport function LeftPanel({\r\n  activeTab,\r\n  setActiveTab,\r\n  selectedNumberId,\r\n  setSelectedNumberId,\r\n  searchTerm,\r\n  setSearchTerm,\r\n  filteredConversations,\r\n  isLoading,\r\n  conversationsHasMore,\r\n  isConversationsLoadingMore,\r\n  onLoadMoreConversations,\r\n  selectedConversationId,\r\n  setSelectedConversationId,\r\n  isConnected,\r\n}) {\r\n  return (\r\n    <div className=\"w-[360px] border-r border-slate-200 flex flex-col\">\r\n      <div className=\"px-4 py-3 border-b border-slate-200 bg-white flex flex-col gap-3\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Phone className=\"w-4 h-4 text-emerald-600\" />\r\n          <span className=\"text-sm font-semibold text-slate-800\">\r\n            Chat Inbox\r\n          </span>\r\n          <span className=\"ml-auto inline-flex items-center gap-1 text-[10px] text-slate-500\">\r\n            <Activity\r\n              className={`w-3 h-3 ${\r\n                isConnected ? \"text-emerald-500\" : \"text-slate-400\"\r\n              }`}\r\n            />\r\n            {isConnected ? \"Live\" : \"Offline\"}\r\n          </span>\r\n        </div>\r\n\r\n        <div className=\"flex gap-2 items-center\">\r\n          <div className=\"relative\">\r\n            <select\r\n              value={selectedNumberId}\r\n              onChange={e => setSelectedNumberId(e.target.value)}\r\n              className=\"appearance-none bg-slate-50 border border-slate-200 text-xs rounded-full pl-3 pr-7 py-1.5 text-slate-700 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500\"\r\n            >\r\n              {MOCK_NUMBERS.map(n => (\r\n                <option key={n.id} value={n.id}>\r\n                  {n.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <ChevronDown className=\"w-3 h-3 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none\" />\r\n          </div>\r\n\r\n          <div className=\"flex-1 flex items-center bg-slate-50 border border-slate-200 rounded-full px-2\">\r\n            <Search className=\"w-3.5 h-3.5 text-slate-400 mr-1\" />\r\n            <input\r\n              type=\"text\"\r\n              placeholder=\"Search name, number, message...\"\r\n              value={searchTerm}\r\n              onChange={e => setSearchTerm(e.target.value)}\r\n              className=\"w-full bg-transparent border-none text-xs text-slate-700 focus:outline-none\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-3 text-[11px] font-medium\">\r\n          {TABS.map(tab => (\r\n            <button\r\n              key={tab.id}\r\n              type=\"button\"\r\n              onClick={() => setActiveTab(tab.id)}\r\n              className={`pb-1 border-b-2 transition-colors ${\r\n                activeTab === tab.id\r\n                  ? \"border-emerald-600 text-emerald-700\"\r\n                  : \"border-transparent text-slate-500 hover:text-emerald-600\"\r\n              }`}\r\n            >\r\n              {tab.label}\r\n            </button>\r\n          ))}\r\n\r\n          <button\r\n            type=\"button\"\r\n            className=\"ml-auto inline-flex items-center gap-1 text-[11px] text-slate-500 hover:text-slate-700\"\r\n          >\r\n            <Filter className=\"w-3 h-3\" />\r\n            More\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"relative flex-1 overflow-y-auto bg-slate-50\">\r\n        {isLoading && (\r\n          <div className=\"absolute inset-0 z-10 bg-slate-50/70 backdrop-blur-[1px] flex justify-center pt-6\">\r\n            <div className=\"text-xs text-slate-500\">Loading chats...</div>\r\n          </div>\r\n        )}\r\n\r\n        {!isLoading && filteredConversations.length === 0 && (\r\n          <div className=\"p-4 text-xs text-slate-400 italic\">\r\n            No conversations found for this filter.\r\n          </div>\r\n        )}\r\n\r\n        {filteredConversations.map(conv => (\r\n          <ConversationRow\r\n            key={conv.id}\r\n            conv={conv}\r\n            isSelected={selectedConversationId === conv.id}\r\n            onClick={() => setSelectedConversationId(conv.id)}\r\n          />\r\n        ))}\r\n\r\n        {conversationsHasMore && (\r\n          <div className=\"p-3 flex justify-center\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onLoadMoreConversations}\r\n              disabled={isConversationsLoadingMore}\r\n              className={`w-full rounded-lg border px-3 py-2 text-xs font-medium ${\r\n                isConversationsLoadingMore\r\n                  ? \"bg-slate-100 text-slate-400 border-slate-200 cursor-wait\"\r\n                  : \"bg-white text-slate-700 border-slate-200 hover:bg-slate-50\"\r\n              }`}\r\n            >\r\n              {isConversationsLoadingMore ? \"Loading...\" : \"Load more\"}\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import React from \"react\";\nimport { AlertCircle, CheckCheck, Clock } from \"lucide-react\";\n\n/**\n * StatusIcon  WhatsApp-ish delivery semantics\n * - Clock: queued / sending / pending / unknown in-flight\n * - : sent/delivered\n * -  (green): read/seen\n * - Alert: failed/error\n */\nexport function StatusIcon({ status, variant = \"onLight\" }) {\n  const s = String(status || \"\")\n    .trim()\n    .toLowerCase();\n  if (!s) return null;\n\n  const palette =\n    variant === \"onDark\"\n      ? {\n          failed: \"text-rose-300\",\n          read: \"text-emerald-300\",\n          delivered: \"text-white/70\",\n          sent: \"text-white/70\",\n          inFlight: \"text-white/70\",\n        }\n      : {\n          failed: \"text-rose-600\",\n          read: \"text-emerald-600\",\n          delivered: \"text-slate-500\",\n          sent: \"text-slate-500\",\n          inFlight: \"text-slate-500\",\n        };\n\n  const isFailed =\n    s === \"failed\" ||\n    s === \"error\" ||\n    s.includes(\"fail\") ||\n    s.includes(\"reject\");\n\n  if (isFailed) {\n    return (\n      <span\n        title={status}\n        className={`inline-flex items-center text-[10px] ${palette.failed}`}\n      >\n        <AlertCircle className=\"w-3 h-3\" />\n      </span>\n    );\n  }\n\n  const isRead =\n    s === \"read\" || s === \"seen\" || s === \"viewed\" || s.includes(\"read\");\n  if (isRead) {\n    return (\n      <span\n        title={status}\n        className={`inline-flex items-center text-[10px] ${palette.read}`}\n      >\n        <CheckCheck className=\"w-3 h-3\" />\n      </span>\n    );\n  }\n\n  const isDelivered = s === \"delivered\" || s.includes(\"deliver\");\n  if (isDelivered) {\n    return (\n      <span\n        title={status}\n        className={`inline-flex items-center text-[10px] ${palette.delivered}`}\n      >\n        <CheckCheck className=\"w-3 h-3\" />\n      </span>\n    );\n  }\n\n  const isSent = s === \"sent\";\n  if (isSent) {\n    return (\n      <span\n        title={status}\n        className={`inline-flex items-center text-[10px] ${palette.sent}`}\n      >\n        <CheckCheck className=\"w-3 h-3\" />\n      </span>\n    );\n  }\n\n  // In-flight + safest default: Clock (never lie with )\n  const isInFlight =\n    s === \"sending\" ||\n    s === \"queued\" ||\n    s === \"pending\" ||\n    s.includes(\"queue\") ||\n    s.includes(\"send\") ||\n    s.includes(\"accept\") ||\n    s.includes(\"submit\") ||\n    s.includes(\"process\") ||\n    s.includes(\"progress\");\n\n  if (isInFlight) {\n    return (\n      <span\n        title={status}\n        className={`inline-flex items-center text-[10px] ${palette.inFlight}`}\n      >\n        <Clock className=\"w-3 h-3\" />\n      </span>\n    );\n  }\n\n  return (\n    <span\n      title={status}\n      className={`inline-flex items-center text-[10px] ${palette.inFlight}`}\n    >\n      <Clock className=\"w-3 h-3\" />\n    </span>\n  );\n}\n","import createLucideIcon from '../createLucideIcon';\nimport { IconNode } from '../types';\n\nexport const __iconNode: IconNode = [\n  ['circle', { cx: '12', cy: '12', r: '10', key: '1mglay' }],\n  ['path', { d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3', key: '1u773s' }],\n  ['path', { d: 'M12 17h.01', key: 'p32p05' }],\n];\n\n/**\n * @component @name CircleHelp\n * @description Lucide SVG icon component, renders SVG Element with children.\n *\n * @preview ![img](data:image/svg+xml;base64,PHN2ZyAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogIHdpZHRoPSIyNCIKICBoZWlnaHQ9IjI0IgogIHZpZXdCb3g9IjAgMCAyNCAyNCIKICBmaWxsPSJub25lIgogIHN0cm9rZT0iIzAwMCIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDJweCIKICBzdHJva2Utd2lkdGg9IjIiCiAgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIgogIHN0cm9rZS1saW5lam9pbj0icm91bmQiCj4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgLz4KICA8cGF0aCBkPSJNOS4wOSA5YTMgMyAwIDAgMSA1LjgzIDFjMCAyLTMgMy0zIDMiIC8+CiAgPHBhdGggZD0iTTEyIDE3aC4wMSIgLz4KPC9zdmc+Cg==) - https://lucide.dev/icons/circle-help\n * @see https://lucide.dev/guide/packages/lucide-react - Documentation\n *\n * @param {Object} props - Lucide icons props and any valid SVG attribute\n * @returns {JSX.Element} JSX Element\n *\n */\nconst CircleHelp = createLucideIcon('circle-help', __iconNode);\n\nexport default CircleHelp;\n","import React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { CircleHelp, Plus, Search, Trash2 } from \"lucide-react\";\nimport axiosClient from \"../api/chatInboxApi\";\n\n/**\n * QuickReplyPicker (ported from old Inbox module)\n * Props:\n *  - onInsert(text: string): required\n *  - onClose(): optional\n *  - scope?: \"Business\" | \"Personal\" | \"All\"  // initial view; default \"All\"\n */\nexport default function QuickReplyPicker({ onInsert, onClose, scope = \"All\" }) {\n  const searchRef = useRef(null);\n  const listRef = useRef(null);\n  const rowRefs = useRef([]);\n\n  const [q, setQ] = useState(\"\");\n  const [items, setItems] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [activeIndex, setActiveIndex] = useState(-1);\n\n  const [viewScope, setViewScope] = useState(() => scope || \"All\");\n  const viewScopeParam = useMemo(() => {\n    const s = String(viewScope || \"All\").toLowerCase();\n    return s === \"business\" || s === \"personal\" ? s : \"all\";\n  }, [viewScope]);\n\n  const [creating, setCreating] = useState(false);\n  const [title, setTitle] = useState(\"\");\n  const [body, setBody] = useState(\"\");\n  const [tagsCsv, setTagsCsv] = useState(\"\");\n  const [createScope, setCreateScope] = useState(\"Personal\");\n  const [saving, setSaving] = useState(false);\n  const [saveMsg, setSaveMsg] = useState(\"\");\n\n  const [deletingId, setDeletingId] = useState(null);\n  const [searchOpen, setSearchOpen] = useState(false);\n\n  const fetchList = useCallback(async () => {\n    const params = {};\n    if (q) params.q = q;\n    if (viewScopeParam) params.scope = viewScopeParam;\n    const res = await axiosClient.get(\"/quick-replies\", { params });\n    return Array.isArray(res.data) ? res.data : [];\n  }, [q, viewScopeParam]);\n\n  useEffect(() => {\n    if (creating) return;\n    let ignore = false;\n    setLoading(true);\n\n    const t = setTimeout(() => {\n      fetchList()\n        .then(list => {\n          if (ignore) return;\n          setItems(list);\n          setActiveIndex(list.length > 0 ? 0 : -1);\n        })\n        .catch(() => {\n          if (ignore) return;\n          setItems([]);\n          setActiveIndex(-1);\n        })\n        .finally(() => {\n          if (ignore) return;\n          setLoading(false);\n        });\n    }, 200);\n\n    return () => {\n      clearTimeout(t);\n      ignore = true;\n    };\n  }, [q, viewScopeParam, creating, fetchList]);\n\n  useEffect(() => {\n    if (!searchOpen) return;\n    searchRef.current?.focus();\n  }, [searchOpen]);\n\n  useEffect(() => {\n    if (creating) return;\n    if (searchOpen) return;\n    if (loading) return;\n    if (!listRef.current) return;\n    requestAnimationFrame(() => listRef.current?.focus());\n  }, [creating, searchOpen, loading]);\n\n  useEffect(() => {\n    const el = rowRefs.current[activeIndex];\n    if (!el) return;\n    if (typeof el.scrollIntoView !== \"function\") return;\n    el.scrollIntoView({ block: \"nearest\" });\n  }, [activeIndex]);\n\n  const handleInsert = useCallback(\n    text => {\n      if (!text) return;\n      if (typeof onInsert === \"function\") onInsert(text);\n    },\n    [onInsert]\n  );\n\n  const handleKeyDown = e => {\n    if (e.key === \"Escape\") {\n      e.preventDefault();\n      e.stopPropagation();\n      setCreating(false);\n      onClose?.();\n      return;\n    }\n    if (creating) return;\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));\n      return;\n    }\n    if (e.key === \"ArrowUp\") {\n      e.preventDefault();\n      setActiveIndex(i => Math.max(i - 1, -1));\n      return;\n    }\n    if (e.key === \"Enter\") {\n      if (activeIndex >= 0 && activeIndex < items.length) {\n        e.preventDefault();\n        handleInsert(items[activeIndex]?.body);\n        onClose?.();\n      }\n    }\n  };\n\n  const handleListKeyDown = e => {\n    if (e.key === \"Escape\") {\n      e.preventDefault();\n      onClose?.();\n      return;\n    }\n    if (creating) return;\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));\n      return;\n    }\n    if (e.key === \"ArrowUp\") {\n      e.preventDefault();\n      setActiveIndex(i => Math.max(i - 1, 0));\n      return;\n    }\n    if (e.key === \"Enter\") {\n      if (activeIndex >= 0 && activeIndex < items.length) {\n        e.preventDefault();\n        handleInsert(items[activeIndex]?.body);\n        onClose?.();\n      }\n    }\n  };\n\n  const handleCreate = async () => {\n    setSaveMsg(\"\");\n    if (!title.trim() || !body.trim()) {\n      setSaveMsg(\"Title and message are required.\");\n      return;\n    }\n\n    setSaving(true);\n    try {\n      const payload = {\n        title: title.trim(),\n        body,\n        tagsCsv: tagsCsv.trim() || null,\n        scope: createScope === \"Business\" ? 2 : 0,\n      };\n\n      const res = await axiosClient.post(\"/quick-replies\", payload);\n      const ok = res?.data?.success === true;\n      setSaveMsg(ok ? \"Saved.\" : res?.data?.message || \"Failed to save.\");\n      if (ok) {\n        setTitle(\"\");\n        setBody(\"\");\n        setTagsCsv(\"\");\n        setCreating(false);\n        setViewScope(createScope);\n        setQ(\"\");\n      }\n    } catch {\n      setSaveMsg(\"Failed to save.\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleDelete = async item => {\n    if (!item?.id || deletingId) return;\n    const ok = window.confirm(\"Delete this quick reply?\");\n    if (!ok) return;\n\n    setDeletingId(item.id);\n    try {\n      const res = await axiosClient.delete(`/quick-replies/${item.id}`);\n      const success = res?.data?.success === true;\n      if (!success) {\n        setSaveMsg(res?.data?.message || \"Failed to delete.\");\n        return;\n      }\n      setItems(prev => prev.filter(x => x.id !== item.id));\n    } catch {\n      setSaveMsg(\"Failed to delete.\");\n    } finally {\n      setDeletingId(null);\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col flex-1 min-h-0 overflow-hidden\">\n      {!creating ? (\n        <>\n          {/* Controls */}\n          <div className=\"shrink-0\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-1 py-0.5\">\n                {[\"All\", \"Business\", \"Personal\"].map(s => {\n                  const isActive = viewScope === s;\n                  return (\n                    <button\n                      key={s}\n                      type=\"button\"\n                      onClick={() => setViewScope(s)}\n                      className={`px-2.5 py-1 text-[11px] rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-400/30 ${\n                        isActive\n                          ? \"bg-emerald-600 text-white\"\n                          : \"text-slate-700 hover:text-slate-900 hover:bg-slate-50\"\n                      }`}\n                    >\n                      {s}\n                    </button>\n                  );\n                })}\n              </div>\n\n              <button\n                className=\"h-7 w-7 inline-flex items-center justify-center rounded-md border border-slate-200 bg-white text-slate-500 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200 focus:outline-none focus:ring-2 focus:ring-emerald-400/40\"\n                onClick={() => setCreating(true)}\n                type=\"button\"\n                title=\"New quick reply\"\n                aria-label=\"New quick reply\"\n              >\n                <Plus className=\"w-4 h-4\" />\n              </button>\n\n              <div className=\"ml-auto flex items-center gap-1\">\n                <button\n                  type=\"button\"\n                  className={`h-7 w-7 inline-flex items-center justify-center rounded-md border ${\n                    searchOpen\n                      ? \"bg-emerald-50 text-emerald-700 border-emerald-200\"\n                      : \"bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:text-slate-700\"\n                  }`}\n                  onClick={() => setSearchOpen(v => !v)}\n                  title=\"Search\"\n                  aria-label=\"Search quick replies\"\n                >\n                  <Search className=\"w-4 h-4\" />\n                </button>\n              </div>\n            </div>\n\n                {searchOpen ? (\n                  <div className=\"mt-2\">\n                    <input\n                      ref={searchRef}\n                      className=\"w-full border border-slate-200 rounded-lg px-2.5 py-1.5 text-[12px] text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400 bg-white\"\n                      placeholder=\"Search saved replies...\"\n                      value={q}\n                      onChange={e => setQ(e.target.value)}\n                      onKeyDown={handleKeyDown}\n                    />\n                  </div>\n                ) : null}\n\n            <div className=\"mt-2 h-px bg-slate-200/70\" />\n\n            {saveMsg ? (\n              <div className=\"mt-2 text-[11px] px-2.5 py-2 rounded-lg bg-slate-50 border border-slate-200 text-slate-700\">\n                {saveMsg}\n              </div>\n            ) : null}\n          </div>\n\n          {/* List + footer */}\n          <div className=\"flex-1 min-h-0 flex flex-col mt-2 overflow-hidden\">\n            <div\n              ref={listRef}\n              tabIndex={0}\n              onKeyDown={handleListKeyDown}\n              className=\"flex-1 min-h-0 overflow-y-auto overscroll-contain pr-1 focus:outline-none\"\n            >\n              {loading ? (\n                <div className=\"text-[11px] text-slate-500 p-2\">\n                  Loading...\n                </div>\n              ) : items.length === 0 ? (\n                <div className=\"py-6 text-center\">\n                  <div className=\"text-[13px] font-semibold text-slate-800\">\n                    Create your first quick reply\n                  </div>\n                  <div className=\"mt-1 text-[12px] text-slate-600\">\n                    Click + to add one.\n                  </div>\n                </div>\n              ) : (\n                <div className=\"bg-white\">\n                  <div className=\"divide-y divide-slate-100\">\n                    {items.map((x, idx) => {\n                      const isActive = idx === activeIndex;\n                      const isDeleting = deletingId === x.id;\n                      return (\n                        <div\n                          key={x.id}\n                          ref={el => {\n                            rowRefs.current[idx] = el;\n                          }}\n                          className={`group flex items-start gap-2 px-2 py-2 transition-colors cursor-pointer ${\n                            isActive\n                              ? \"bg-emerald-50 active:bg-emerald-100\"\n                              : \"bg-white hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                          onMouseEnter={() => setActiveIndex(idx)}\n                        >\n                          <button\n                            type=\"button\"\n                            className=\"flex-1 text-left min-w-0 focus:outline-none\"\n                            onClick={() => {\n                              handleInsert(x.body);\n                              onClose?.();\n                            }}\n                            title={x.tagsCsv || \"\"}\n                          >\n                            <div className=\"text-[13px] font-semibold text-slate-900 truncate leading-snug\">\n                              {x.title}\n                            </div>\n                            <div className=\"mt-0.5 text-[12px] text-slate-600 truncate leading-snug\">\n                              {x.body}\n                            </div>\n                          </button>\n\n                          <div className=\"flex items-center gap-1 mt-0.5\">\n                            <span className=\"text-[11px] text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity\">\n                              Enter \n                            </span>\n                            <button\n                              type=\"button\"\n                              className={`inline-flex items-center justify-center h-7 w-7 rounded-md border transition-all ${\n                                isDeleting\n                                  ? \"opacity-100 bg-slate-50 text-slate-400 border-slate-200 cursor-wait\"\n                                  : \"opacity-0 group-hover:opacity-100 bg-white text-slate-400 border-slate-200 hover:bg-rose-50 hover:text-rose-700 hover:border-rose-200\"\n                              }`}\n                              title=\"Delete\"\n                              disabled={isDeleting}\n                              onClick={() => handleDelete(x)}\n                            >\n                              <Trash2 className=\"w-3.5 h-3.5\" />\n                            </button>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"shrink-0 pt-1.5 flex items-center justify-between text-[11px] text-slate-500\">\n              <div>\n                Scope: <span className=\"uppercase\">{viewScopeParam}</span>\n              </div>\n              <button\n                type=\"button\"\n                className=\"inline-flex items-center justify-center h-7 w-7 rounded-md text-slate-500 hover:text-slate-700 hover:bg-slate-100\"\n                title=\" navigate  Enter insert  Esc close\"\n                aria-label=\"Keyboard shortcuts\"\n                onClick={() => {}}\n              >\n                <CircleHelp className=\"w-4 h-4\" />\n              </button>\n            </div>\n          </div>\n        </>\n      ) : (\n        <div className=\"flex flex-col h-full min-h-0\">\n          <div className=\"shrink-0 flex items-center gap-2\">\n            <div className=\"text-[12px] font-semibold text-slate-800\">\n              New quick reply\n            </div>\n            <div className=\"flex-1\" />\n            <button\n              className=\"text-[11px] px-3 py-1.5 rounded-md text-white bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300\"\n              onClick={handleCreate}\n              type=\"button\"\n              disabled={saving}\n            >\n              {saving ? \"Saving...\" : \"Save\"}\n            </button>\n            <button\n              className=\"text-[11px] text-slate-500 hover:text-slate-700 px-2 py-1.5\"\n              onClick={() => setCreating(false)}\n              type=\"button\"\n              disabled={saving}\n            >\n              Cancel\n            </button>\n          </div>\n\n          <div className=\"mt-2 flex-1 min-h-0 overflow-y-auto space-y-2 pr-1\">\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-[11px] text-slate-600 w-16\">Scope</label>\n              <div className=\"flex items-center gap-3\">\n                {[\"Personal\", \"Business\"].map(s => (\n                  <label key={s} className=\"text-[11px] flex items-center gap-1\">\n                    <input\n                      type=\"radio\"\n                      name=\"qr-scope\"\n                      value={s}\n                      checked={createScope === s}\n                      onChange={() => setCreateScope(s)}\n                    />\n                    {s}\n                  </label>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-[11px] text-slate-600 w-16\">Title</label>\n              <input\n                className=\"flex-1 border border-slate-200 rounded-xl px-2.5 py-2 text-[12px] text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400\"\n                value={title}\n                onChange={e => setTitle(e.target.value)}\n                placeholder=\"e.g., Greeting (EN)\"\n              />\n            </div>\n\n            <div className=\"flex items-start gap-2\">\n              <label className=\"text-[11px] text-slate-600 w-16 mt-2\">\n                Body\n              </label>\n              <textarea\n                className=\"flex-1 border border-slate-200 rounded-xl px-2.5 py-2 text-[12px] text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400 h-24 resize-none\"\n                value={body}\n                onChange={e => setBody(e.target.value)}\n                placeholder=\"Type the message...\"\n              />\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-[11px] text-slate-600 w-16\">Tags</label>\n              <input\n                className=\"flex-1 border border-slate-200 rounded-xl px-2.5 py-2 text-[12px] text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400\"\n                value={tagsCsv}\n                onChange={e => setTagsCsv(e.target.value)}\n                placeholder=\"e.g., greeting,eng\"\n              />\n            </div>\n\n            {saveMsg && (\n              <div className=\"text-[11px] px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-700\">\n                {saveMsg}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React from \"react\";\nimport { X, Zap, StickyNote, LayoutTemplate } from \"lucide-react\";\nimport QuickReplyPicker from \"./QuickReplyPicker\";\n\nconst TABS = [\n  { id: \"quickReply\", label: \"Quick replies\", Icon: Zap },\n  { id: \"notes\", label: \"Notes\", Icon: StickyNote },\n  { id: \"template\", label: \"Templates\", Icon: LayoutTemplate },\n];\n\nconst PLACEHOLDERS = {\n  quickReply: \"Quick replies UI goes here\",\n  notes: \"Notes UI goes here\",\n  tag: \"Tag UI goes here\",\n  template: \"Template UI goes here\",\n};\n\nexport function ComposerTabs({\n  openTab,\n  setOpenTab,\n  composerRef,\n  onQuickReplyInsert,\n}) {\n  const isOpen = openTab !== null;\n  const active = TABS.find(t => t.id === openTab) || null;\n  const notesTab = TABS.find(t => t.id === \"notes\") || null;\n  const leftTabs = TABS.filter(t => t.id !== \"notes\");\n  const close = React.useCallback(() => {\n    if (typeof setOpenTab === \"function\") setOpenTab(null);\n  }, [setOpenTab]);\n\n  React.useEffect(() => {\n    if (!isOpen) return;\n\n    const onMouseDown = e => {\n      const target = e.target;\n      if (!(target instanceof Node)) return;\n\n      const root = composerRef?.current;\n      if (!root) return;\n      if (root.contains(target)) return;\n      close();\n    };\n\n    const onKeyDown = e => {\n      if (e.key === \"Escape\") close();\n    };\n\n    document.addEventListener(\"mousedown\", onMouseDown);\n    document.addEventListener(\"keydown\", onKeyDown, { capture: true });\n    return () => {\n      document.removeEventListener(\"mousedown\", onMouseDown);\n      document.removeEventListener(\"keydown\", onKeyDown, { capture: true });\n    };\n  }, [isOpen, close, composerRef]);\n\n  const panelId = \"chatinbox-composer-panel\";\n\n  return (\n    <div className=\"relative w-full\">\n      {/* Sliding panel (anchored to composer, expands upward) */}\n      <div\n        id={panelId}\n        aria-hidden={!isOpen}\n        className={`absolute left-0 right-0 bottom-full mb-1 overflow-hidden rounded-lg border border-slate-200/80 bg-white shadow-sm transform-gpu transition-[transform,opacity] duration-150 ease-out flex flex-col max-h-[240px] ${\n          isOpen\n            ? \"opacity-100 translate-y-0 pointer-events-auto\"\n            : \"opacity-0 translate-y-2 pointer-events-none\"\n        }`}\n      >\n        {/* Compact inline header row: tabs + close */}\n        <div className=\"shrink-0 flex items-center gap-2 px-2 pt-2 pb-1.5 border-b border-slate-200/70\">\n          <div\n            className=\"flex items-center gap-3 min-w-0 flex-1\"\n            role=\"tablist\"\n            aria-label=\"Composer tools\"\n          >\n            {leftTabs.map(t => {\n              const isActive = openTab === t.id;\n              const Icon = t.Icon;\n              return (\n                <button\n                  key={t.id}\n                  type=\"button\"\n                  role=\"tab\"\n                  aria-selected={isActive}\n                  className={`inline-flex items-center gap-1.5 text-[13px] leading-none px-0.5 pb-1 border-b-2 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300/70 rounded-sm ${\n                    isActive\n                      ? \"border-emerald-600 text-slate-900 font-semibold\"\n                      : \"border-transparent text-slate-600 hover:text-slate-800\"\n                  }`}\n                  onClick={() => setOpenTab?.(t.id)}\n                >\n                  {Icon ? (\n                    <Icon\n                      className={`w-3.5 h-3.5 ${\n                        isActive ? \"text-emerald-600\" : \"text-slate-400\"\n                      }`}\n                    />\n                  ) : null}\n                  {t.label}\n                </button>\n              );\n            })}\n\n            {notesTab ? (() => {\n              const isActive = openTab === notesTab.id;\n              const Icon = notesTab.Icon;\n              return (\n                <button\n                  key={notesTab.id}\n                  type=\"button\"\n                  role=\"tab\"\n                  aria-selected={isActive}\n                  className={`ml-auto inline-flex items-center gap-1.5 text-[13px] leading-none px-0.5 pb-1 border-b-2 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300/70 rounded-sm ${\n                    isActive\n                      ? \"border-emerald-600 text-slate-900 font-semibold\"\n                      : \"border-transparent text-slate-600 hover:text-slate-800\"\n                  }`}\n                  onClick={() => setOpenTab?.(notesTab.id)}\n                >\n                  {Icon ? (\n                    <Icon\n                      className={`w-3.5 h-3.5 ${\n                        isActive ? \"text-emerald-600\" : \"text-slate-400\"\n                      }`}\n                    />\n                  ) : null}\n                  {notesTab.label}\n                </button>\n              );\n            })() : null}\n          </div>\n\n          <button\n            type=\"button\"\n            className=\"inline-flex items-center justify-center w-7 h-7 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100\"\n            onClick={close}\n            aria-label=\"Close\"\n          >\n            <X className=\"w-4 h-4\" />\n          </button>\n        </div>\n\n        <div className=\"flex-1 min-h-0 p-2.5 overflow-hidden flex flex-col\">\n          {openTab === \"quickReply\" ? (\n            <div className=\"flex-1 min-h-0 overflow-hidden\">\n              <QuickReplyPicker\n                onInsert={text => onQuickReplyInsert?.(text)}\n                onClose={close}\n                scope=\"All\"\n              />\n            </div>\n          ) : (\n            <div className=\"h-full overflow-y-auto\">\n              <div className=\"rounded-md border border-slate-200 bg-white p-3 text-[12px] text-slate-700\">\n                <div className=\"font-medium text-slate-800\">\n                  {active?.label || \"Tools\"}\n                </div>\n                <div className=\"mt-1 text-[11px] text-slate-500\">\n                  {active ? PLACEHOLDERS[active.id] : \"Coming soon\"}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","import React, { useEffect, useMemo, useRef, useState } from \"react\";\n\nconst EMOJIS = [\n  { char: \"\", name: \"grinning\" },\n  { char: \"\", name: \"beaming\" },\n  { char: \"\", name: \"joy\" },\n  { char: \"\", name: \"rofl\" },\n  { char: \"\", name: \"smile\" },\n  { char: \"\", name: \"slight_smile\" },\n  { char: \"\", name: \"wink\" },\n  { char: \"\", name: \"heart_eyes\" },\n  { char: \"\", name: \"kiss\" },\n  { char: \"\", name: \"yum\" },\n  { char: \"\", name: \"cool\" },\n  { char: \"\", name: \"star_struck\" },\n  { char: \"\", name: \"partying\" },\n  { char: \"\", name: \"innocent\" },\n  { char: \"\", name: \"hug\" },\n  { char: \"\", name: \"sweat_smile\" },\n  { char: \"\", name: \"relieved\" },\n  { char: \"\", name: \"sleep\" },\n  { char: \"\", name: \"think\" },\n  { char: \"\", name: \"doubt\" },\n  { char: \"\", name: \"neutral\" },\n  { char: \"\", name: \"open_mouth\" },\n  { char: \"\", name: \"cry\" },\n  { char: \"\", name: \"sob\" },\n  { char: \"\", name: \"angry\" },\n  { char: \"\", name: \"scream\" },\n  { char: \"\", name: \"mind_blown\" },\n  { char: \"\", name: \"sick\" },\n  { char: \"\", name: \"injured\" },\n  { char: \"\", name: \"sneeze\" },\n  { char: \"\", name: \"cold\" },\n  { char: \"\", name: \"hot\" },\n  { char: \"\", name: \"thumbs_up\" },\n  { char: \"\", name: \"thumbs_down\" },\n  { char: \"\", name: \"pray\" },\n  { char: \"\", name: \"clap\" },\n  { char: \"\", name: \"raised_hands\" },\n  { char: \"\", name: \"handshake\" },\n  { char: \"\", name: \"muscle\" },\n  { char: \"\", name: \"heart_hands\" },\n  { char: \"\", name: \"red_heart\" },\n  { char: \"\", name: \"yellow_heart\" },\n  { char: \"\", name: \"green_heart\" },\n  { char: \"\", name: \"blue_heart\" },\n  { char: \"\", name: \"purple_heart\" },\n  { char: \"\", name: \"black_heart\" },\n  { char: \"\", name: \"broken_heart\" },\n  { char: \"\", name: \"sparkles\" },\n  { char: \"\", name: \"fire\" },\n  { char: \"\", name: \"star\" },\n  { char: \"\", name: \"check\" },\n  { char: \"\", name: \"cross\" },\n  { char: \"\", name: \"warning\" },\n  { char: \"\", name: \"hourglass\" },\n  { char: \"\", name: \"pin\" },\n  { char: \"\", name: \"round_pushpin\" },\n  { char: \"\", name: \"calendar\" },\n  { char: \"\", name: \"shopping\" },\n  { char: \"\", name: \"money\" },\n  { char: \"\", name: \"tada\" },\n  { char: \"\", name: \"confetti\" },\n  { char: \"\", name: \"speech\" },\n  { char: \"\", name: \"envelope\" },\n  { char: \"\", name: \"telephone\" },\n  { char: \"\", name: \"alarm\" },\n  { char: \"\", name: \"timer\" },\n  { char: \"\", name: \"receipt\" },\n  { char: \"\", name: \"tools\" },\n  { char: \"\", name: \"brain\" },\n];\n\nexport default function EmojiPicker({ onPick, onClose }) {\n  const ref = useRef(null);\n  const [q, setQ] = useState(\"\");\n\n  useEffect(() => {\n    const onDocClick = e => {\n      if (!ref.current) return;\n      if (!ref.current.contains(e.target)) onClose?.();\n    };\n    document.addEventListener(\"mousedown\", onDocClick, { capture: true });\n    return () =>\n      document.removeEventListener(\"mousedown\", onDocClick, { capture: true });\n  }, [onClose]);\n\n  const filtered = useMemo(() => {\n    const s = q.trim().toLowerCase();\n    if (!s) return EMOJIS;\n    return EMOJIS.filter(e => e.name.includes(s));\n  }, [q]);\n\n  return (\n    <div\n      ref={ref}\n      className=\"w-80 rounded-xl border border-slate-200 bg-white shadow-lg p-2\"\n      role=\"dialog\"\n      aria-label=\"Emoji picker\"\n    >\n      <div className=\"flex items-center gap-2 mb-2\">\n        <input\n          autoFocus\n          className=\"flex-1 border border-slate-200 rounded-lg px-2.5 py-1.5 text-[12px] text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/30 focus:border-emerald-400\"\n          placeholder=\"Search emoji...\"\n          value={q}\n          onChange={e => setQ(e.target.value)}\n          onKeyDown={e => {\n            if (e.key === \"Escape\") {\n              e.preventDefault();\n              e.stopPropagation();\n              onClose?.();\n            }\n          }}\n        />\n        <button\n          className=\"text-[11px] text-slate-500 hover:text-slate-700 px-2 py-1.5\"\n          onClick={() => onClose?.()}\n          type=\"button\"\n        >\n          Close\n        </button>\n      </div>\n\n      <div className=\"grid grid-cols-10 gap-1 overflow-y-hidden\">\n        {filtered.map(e => (\n          <button\n            key={e.char + e.name}\n            type=\"button\"\n            className=\"h-7 w-7 flex items-center justify-center rounded-lg hover:bg-slate-100\"\n            title={e.name.replace(/_/g, \" \")}\n            onClick={() => onPick?.(e.char)}\n          >\n            <span className=\"text-lg\">{e.char}</span>\n          </button>\n        ))}\n      </div>\n    </div>\n  );\n}\n\n","import React from \"react\";\nimport {\n  Clock,\n  CheckCircle2,\n  MessageCircle,\n  Mail,\n  User,\n  Smile,\n  Paperclip,\n  Download,\n  X,\n  Zap,\n  ChevronLeft,\n  ChevronRight,\n  ChevronDown,\n  MapPin,\n  Play,\n} from \"lucide-react\";\n// import { useAuth } from \"../../../app/providers/AuthProvider\";\r\n// import { FK } from \"../../../capabilities/featureKeys\";\r\n\r\nimport { useAuth } from \"../../../app/providers/AuthProvider\";\nimport { FK } from \"../../../capabilities/featureKeys\";\nimport { StatusIcon } from \"./shared/StatusIcon\";\nimport { ComposerTabs } from \"./ComposerTabs\";\nimport EmojiPicker from \"./EmojiPicker\";\nimport { formatDateTime, getInitial } from \"../utils/formatters\";\n\nconst formatBytes = bytes => {\n  const n = Number(bytes);\n  if (!Number.isFinite(n) || n <= 0) return null;\n  const units = [\"B\", \"KB\", \"MB\", \"GB\"];\n  let value = n;\n  let i = 0;\n  while (value >= 1024 && i < units.length - 1) {\n    value /= 1024;\n    i += 1;\n  }\n  const fixed = value >= 100 ? 0 : value >= 10 ? 1 : 2;\n  return `${value.toFixed(fixed)} ${units[i]}`;\n};\n\nconst resolveChatMediaType = msg => {\n  const explicit = String(msg?.mediaType ?? msg?.MediaType ?? \"\")\n    .trim()\n    .toLowerCase();\n\n  const mime = String(msg?.mimeType ?? msg?.MimeType ?? \"\")\n    .split(\";\")[0]\n    .trim()\n    .toLowerCase();\n\n  const fileName = String(msg?.fileName ?? msg?.FileName ?? \"\")\n    .trim()\n    .toLowerCase();\n\n  if (explicit === \"location\") return \"location\";\n\n  if (mime) {\n    if (mime === \"application/pdf\") return \"document\";\n    if (mime.startsWith(\"image/\")) return \"image\";\n    if (mime.startsWith(\"video/\")) return \"video\";\n    if (mime.startsWith(\"audio/\")) return \"audio\";\n  }\n\n  if (fileName) {\n    if (fileName.endsWith(\".pdf\")) return \"document\";\n    if (\n      fileName.endsWith(\".mp4\") ||\n      fileName.endsWith(\".3gp\") ||\n      fileName.endsWith(\".3gpp\") ||\n      fileName.endsWith(\".webm\") ||\n      fileName.endsWith(\".mov\")\n    ) {\n      return \"video\";\n    }\n    if (\n      fileName.endsWith(\".mp3\") ||\n      fileName.endsWith(\".m4a\") ||\n      fileName.endsWith(\".aac\") ||\n      fileName.endsWith(\".ogg\") ||\n      fileName.endsWith(\".wav\")\n    ) {\n      return \"audio\";\n    }\n  }\n\n  return explicit;\n};\n\nconst formatTimeShort = sentAt => {\n  if (!sentAt) return null;\n  try {\n    return new Date(sentAt).toLocaleTimeString([], {\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  } catch {\n    return null;\n  }\n};\n\nconst looksLikeAutoGeneratedMediaText = ({ text, mediaType, fileName }) => {\n  const raw = String(text || \"\").trim();\n  if (!raw) return false;\n\n  const mt = String(mediaType || \"\")\n    .trim()\n    .toLowerCase();\n  const name = String(fileName || \"\")\n    .trim()\n    .toLowerCase();\n\n  const norm = raw\n    .toLowerCase()\n    .replace(/\\s+/g, \" \")\n    .trim();\n\n  if (name && norm === name) return true;\n\n  if (mt === \"image\") {\n    if (norm === \"photo\" || norm === \"image\") return true;\n    if (norm.startsWith(\"image sent\")) return true;\n    if (norm.startsWith(\"photo sent\")) return true;\n    return false;\n  }\n\n  if (mt === \"document\") {\n    if (norm === \"pdf\" || norm === \"document\") return true;\n    if (norm.startsWith(\"pdf sent\")) return true;\n    if (norm.startsWith(\"document sent\")) return true;\n    return false;\n  }\n\n  if (mt === \"video\") {\n    if (norm === \"video\") return true;\n    if (norm.startsWith(\"video sent\")) return true;\n    return false;\n  }\n\n  if (mt === \"audio\") {\n    if (norm === \"audio\") return true;\n    if (norm.startsWith(\"audio sent\")) return true;\n    return false;\n  }\n\n  if (mt === \"location\") {\n    if (norm === \"location\") return true;\n    if (norm.startsWith(\"location sent\")) return true;\n    return false;\n  }\n\n  return false;\n};\n\nfunction TimeStatusOverlay({ timeText, showStatus, status, className }) {\n  if (!timeText) return null;\n\n  return (\n    <div className={className}>\n      <span>{timeText}</span>\n      {showStatus && <StatusIcon status={status} variant=\"onDark\" />}\n    </div>\n  );\n}\n\nfunction PdfMediaCard({\n  msg,\n  isInbound,\n  pdfMeta,\n  onOpen,\n  ensurePdfPreview,\n}) {\n  const mediaId = String(msg?.mediaId || \"\").trim();\n\n  React.useEffect(() => {\n    if (!mediaId) return;\n    ensurePdfPreview?.(mediaId);\n  }, [mediaId, ensurePdfPreview]);\n\n  const fileName = String(msg?.fileName || \"\").trim() || \"Document.pdf\";\n  const pages =\n    typeof pdfMeta?.pages === \"number\" && pdfMeta.pages > 0 ? pdfMeta.pages : null;\n  const sizeLabel = formatBytes(pdfMeta?.sizeBytes);\n\n  const metaLine = [\n    \"PDF\",\n    pages ? `${pages} pages` : null,\n    sizeLabel || null,\n  ]\n    .filter(Boolean)\n    .join(\"  \");\n\n  return (\n    <button\n      type=\"button\"\n      onClick={() => onOpen?.(msg)}\n      className={`relative w-[320px] max-w-full text-left rounded-lg overflow-hidden border ${\n        isInbound\n          ? \"bg-slate-50 border-slate-200\"\n          : \"bg-black/15 border-black/10\"\n      }`}\n      title=\"Open PDF\"\n    >\n      <div className=\"flex items-stretch\">\n        <div className=\"w-[88px] h-[64px] bg-black/10 flex items-center justify-center overflow-hidden\">\n          {pdfMeta?.thumbDataUrl ? (\n            <img\n              src={pdfMeta.thumbDataUrl}\n              alt=\"PDF preview\"\n              className=\"w-full h-full object-cover\"\n              loading=\"lazy\"\n            />\n          ) : (\n            <div className=\"flex items-center gap-2 text-[12px] font-semibold\">\n              <span className=\"inline-flex items-center justify-center w-8 h-8 rounded bg-rose-600 text-white text-[11px]\">\n                PDF\n              </span>\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex-1 px-3 py-2 min-w-0\">\n          <div className=\"text-[13px] font-semibold truncate\">{fileName}</div>\n          <div className={`text-[11px] mt-0.5 ${isInbound ? \"text-slate-500\" : \"text-white/80\"}`}>\n            {metaLine}\n          </div>\n        </div>\n\n        <div className=\"px-3 py-2 flex items-center\">\n          <div\n            className={`w-8 h-8 rounded-full flex items-center justify-center ${\n              isInbound ? \"bg-slate-200 text-slate-700\" : \"bg-black/20 text-white\"\n            }`}\n          >\n            <Download className=\"w-4 h-4\" />\n          </div>\n        </div>\n      </div>\n    </button>\n  );\n}\n\nfunction ImageMediaTile({\n  msg,\n  isInbound,\n  previewUrl,\n  onOpen,\n  ensureImagePreview,\n  timeText,\n  status,\n  showStatus,\n}) {\n  const mediaId = String(msg?.mediaId || \"\").trim();\n\n  React.useEffect(() => {\n    if (!mediaId) return;\n    if (previewUrl) return;\n    ensureImagePreview?.(mediaId);\n  }, [mediaId, previewUrl, ensureImagePreview]);\n\n  return (\n    <button\n      type=\"button\"\n      onClick={() => onOpen?.(msg)}\n      className=\"relative block w-[240px] max-w-full aspect-[4/3] rounded-lg overflow-hidden border border-black/10\"\n      title=\"Open image\"\n    >\n      {previewUrl ? (\n        <img\n          src={previewUrl}\n          alt={msg?.fileName || \"Image\"}\n          className=\"absolute inset-0 w-full h-full object-cover\"\n          loading=\"lazy\"\n        />\n      ) : (\n        <div\n          className={`absolute inset-0 ${\n            isInbound ? \"bg-slate-200/70\" : \"bg-black/15\"\n          }`}\n        />\n      )}\n\n      {!previewUrl && (\n        <div className=\"absolute inset-0 flex items-center justify-center\">\n          <div\n            className={`w-10 h-10 rounded-full flex items-center justify-center ${\n              isInbound ? \"bg-white/80 text-slate-700\" : \"bg-black/30 text-white\"\n            }`}\n          >\n            <Download className=\"w-5 h-5\" />\n          </div>\n        </div>\n      )}\n\n      <TimeStatusOverlay\n        timeText={timeText}\n        showStatus={showStatus}\n        status={status}\n        className=\"absolute bottom-1 right-1 px-1.5 py-[1px] rounded bg-black/45 text-white text-[10px] leading-none flex items-center gap-0.5\"\n      />\n    </button>\n  );\n}\n\nfunction VideoMediaTile({\n  msg,\n  isInbound,\n  previewUrl,\n  onOpen,\n  ensureMediaPreview,\n  timeText,\n  status,\n  showStatus,\n}) {\n  const mediaId = String(msg?.mediaId || \"\").trim();\n\n  React.useEffect(() => {\n    if (!mediaId) return;\n    if (previewUrl) return;\n    ensureMediaPreview?.(mediaId);\n  }, [mediaId, previewUrl, ensureMediaPreview]);\n\n  return (\n    <button\n      type=\"button\"\n      onClick={() => onOpen?.(msg)}\n      className=\"relative block w-[240px] max-w-full aspect-[4/3] rounded-lg overflow-hidden border border-black/10\"\n      title=\"Open video\"\n    >\n      {previewUrl ? (\n        <video\n          src={previewUrl}\n          className=\"absolute inset-0 w-full h-full object-cover\"\n          muted\n          playsInline\n          preload=\"metadata\"\n        />\n      ) : (\n        <div\n          className={`absolute inset-0 ${\n            isInbound ? \"bg-slate-200/70\" : \"bg-black/15\"\n          }`}\n        />\n      )}\n\n      <div className=\"absolute inset-0 flex items-center justify-center\">\n        <div\n          className={`w-12 h-12 rounded-full flex items-center justify-center ${\n            isInbound ? \"bg-white/80 text-slate-700\" : \"bg-black/30 text-white\"\n          }`}\n        >\n          <Play className=\"w-6 h-6\" />\n        </div>\n      </div>\n\n      {!previewUrl && (\n        <div className=\"absolute left-3 bottom-3 w-8 h-8 rounded-full bg-black/30 text-white flex items-center justify-center\">\n          <Download className=\"w-4 h-4\" />\n        </div>\n      )}\n\n      <TimeStatusOverlay\n        timeText={timeText}\n        showStatus={showStatus}\n        status={status}\n        className=\"absolute bottom-1 right-1 px-1.5 py-[1px] rounded bg-black/45 text-white text-[10px] leading-none flex items-center gap-0.5\"\n      />\n    </button>\n  );\n}\n\nfunction AudioMediaCard({ msg, isInbound, previewUrl, ensureMediaPreview }) {\n  const mediaId = String(msg?.mediaId || \"\").trim();\n\n  React.useEffect(() => {\n    if (!mediaId) return;\n    if (previewUrl) return;\n    ensureMediaPreview?.(mediaId);\n  }, [mediaId, previewUrl, ensureMediaPreview]);\n\n  const fileName = String(msg?.fileName || \"\").trim() || \"Audio\";\n\n  return (\n    <div\n      className={`w-[320px] max-w-full rounded-lg border overflow-hidden ${\n        isInbound ? \"bg-slate-50 border-slate-200\" : \"bg-black/15 border-black/10\"\n      }`}\n    >\n      <div className=\"px-3 py-2\">\n        <div className=\"text-[13px] font-semibold truncate\">{fileName}</div>\n        <div className=\"mt-2\">\n          {previewUrl ? (\n            <audio\n              controls\n              src={previewUrl}\n              className=\"w-full\"\n              preload=\"metadata\"\n            />\n          ) : (\n            <div className=\"h-10 flex items-center justify-between px-3 rounded bg-black/10\">\n              <span className={`text-[12px] ${isInbound ? \"text-slate-500\" : \"text-white/80\"}`}>\n                Loading audio...\n              </span>\n              <Download className={`w-4 h-4 ${isInbound ? \"text-slate-600\" : \"text-white\"}`} />\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction LocationCard({ msg, isInbound }) {\n  const lat =\n    msg?.locationLatitude ??\n    msg?.LocationLatitude ??\n    msg?.latitude ??\n    null;\n  const lon =\n    msg?.locationLongitude ??\n    msg?.LocationLongitude ??\n    msg?.longitude ??\n    null;\n  const name = String(\n    msg?.locationName ?? msg?.LocationName ?? msg?.name ?? \"\"\n  ).trim();\n  const address = String(\n    msg?.locationAddress ?? msg?.LocationAddress ?? msg?.address ?? \"\"\n  ).trim();\n\n  const hasCoords = Number.isFinite(Number(lat)) && Number.isFinite(Number(lon));\n  const mapsUrl = hasCoords\n    ? `https://www.google.com/maps?q=${encodeURIComponent(\n        `${Number(lat)},${Number(lon)}`\n      )}`\n    : null;\n\n  return (\n    <a\n      href={mapsUrl || \"#\"}\n      target={mapsUrl ? \"_blank\" : undefined}\n      rel={mapsUrl ? \"noreferrer noopener\" : undefined}\n      onClick={e => {\n        if (!mapsUrl) e.preventDefault();\n      }}\n      className={`block w-[320px] max-w-full rounded-lg border overflow-hidden ${\n        isInbound ? \"bg-slate-50 border-slate-200\" : \"bg-black/15 border-black/10\"\n      }`}\n      title={mapsUrl ? \"Open in Google Maps\" : \"Location\"}\n    >\n      <div className=\"flex items-center gap-3 px-3 py-3\">\n        <div\n          className={`w-10 h-10 rounded-full flex items-center justify-center ${\n            isInbound ? \"bg-slate-200 text-slate-700\" : \"bg-black/25 text-white\"\n          }`}\n        >\n          <MapPin className=\"w-5 h-5\" />\n        </div>\n        <div className=\"min-w-0\">\n          <div className=\"text-[13px] font-semibold truncate\">\n            {name || \"Location\"}\n          </div>\n          {address ? (\n            <div className={`text-[11px] mt-0.5 truncate ${isInbound ? \"text-slate-500\" : \"text-white/80\"}`}>\n              {address}\n            </div>\n          ) : hasCoords ? (\n            <div className={`text-[11px] mt-0.5 ${isInbound ? \"text-slate-500\" : \"text-white/80\"}`}>\n              {Number(lat).toFixed(5)}, {Number(lon).toFixed(5)}\n            </div>\n          ) : null}\n        </div>\n      </div>\n    </a>\n  );\n}\n\nfunction MediaViewerModal({\n  viewer,\n  onClose,\n  onPrev,\n  onNext,\n  onSelectIndex,\n  mediaObjectUrlById,\n  ensureImagePreview,\n}) {\n  const open = Boolean(viewer?.open);\n  const url = viewer?.url;\n  const type = viewer?.type;\n  const loading = Boolean(viewer?.loading);\n  const items = Array.isArray(viewer?.items) ? viewer.items : [];\n  const index =\n    Number.isFinite(Number(viewer?.index)) && Number(viewer?.index) >= 0\n      ? Number(viewer.index)\n      : 0;\n  const canPrev = type === \"image\" && items.length > 1 && index > 0;\n  const canNext =\n    type === \"image\" && items.length > 1 && index < items.length - 1;\n\n  React.useEffect(() => {\n    if (!open) return;\n    const onKeyDown = e => {\n      if (e.key === \"Escape\") onClose?.();\n      if (e.key === \"ArrowLeft\" && canPrev) onPrev?.();\n      if (e.key === \"ArrowRight\" && canNext) onNext?.();\n    };\n    window.addEventListener(\"keydown\", onKeyDown);\n    return () => window.removeEventListener(\"keydown\", onKeyDown);\n  }, [open, onClose, onPrev, onNext, canPrev, canNext]);\n\n  React.useEffect(() => {\n    if (!open) return;\n    const prev = document?.body?.style?.overflow;\n    if (document?.body?.style) document.body.style.overflow = \"hidden\";\n    return () => {\n      if (document?.body?.style) document.body.style.overflow = prev || \"\";\n    };\n  }, [open]);\n\n  if (!open || !url) return null;\n\n  return (\n    <div\n      className=\"fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center p-4\"\n      role=\"dialog\"\n      aria-modal=\"true\"\n      onClick={() => onClose?.()}\n    >\n      {type === \"image\" && (\n        <>\n          <button\n            type=\"button\"\n            onClick={e => {\n              e.stopPropagation();\n              if (canPrev) onPrev?.();\n            }}\n            className={`absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 ${\n              canPrev ? \"\" : \"opacity-40 cursor-not-allowed\"\n            }`}\n            aria-label=\"Previous image\"\n            disabled={!canPrev}\n          >\n            <ChevronLeft className=\"w-6 h-6\" />\n          </button>\n\n          <button\n            type=\"button\"\n            onClick={e => {\n              e.stopPropagation();\n              if (canNext) onNext?.();\n            }}\n            className={`absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 ${\n              canNext ? \"\" : \"opacity-40 cursor-not-allowed\"\n            }`}\n            aria-label=\"Next image\"\n            disabled={!canNext}\n          >\n            <ChevronRight className=\"w-6 h-6\" />\n          </button>\n        </>\n      )}\n\n      <button\n        type=\"button\"\n        onClick={() => onClose?.()}\n        className=\"absolute top-4 right-4 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70\"\n        aria-label=\"Close\"\n      >\n        <X className=\"w-5 h-5\" />\n      </button>\n\n      <div\n        className=\"max-w-[92vw] max-h-[92vh]\"\n        onClick={e => e.stopPropagation()}\n      >\n        {type === \"image\" ? (\n          <div className=\"relative\">\n            <img\n              src={url}\n              alt={viewer?.fileName || \"Image\"}\n              className=\"max-w-[92vw] max-h-[92vh] object-contain rounded-lg\"\n            />\n\n            {loading && (\n              <div className=\"absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg\">\n                <div className=\"w-12 h-12 rounded-full bg-black/40 flex items-center justify-center\">\n                  <Download className=\"w-6 h-6 text-white\" />\n                </div>\n              </div>\n            )}\n          </div>\n        ) : type === \"video\" ? (\n          <video\n            src={url}\n            controls\n            autoPlay\n            playsInline\n            className=\"max-w-[92vw] max-h-[92vh] object-contain rounded-lg bg-black\"\n          />\n        ) : null}\n      </div>\n\n      {type === \"image\" && items.length > 1 && (\n        <div\n          className=\"absolute left-1/2 -translate-x-1/2 bottom-4 w-[min(900px,92vw)]\"\n          onClick={e => e.stopPropagation()}\n        >\n          <div className=\"px-2 py-2 rounded-xl bg-black/45\">\n            <div className=\"flex gap-2 overflow-x-auto\">\n              {items.map((it, i) => {\n                const id = String(it?.mediaId || \"\").trim();\n                if (!id) return null;\n                const thumb =\n                  mediaObjectUrlById?.[id] || (i === index ? url : null);\n                const active = i === index;\n\n                return (\n                  <button\n                    key={id}\n                    type=\"button\"\n                    className={`relative shrink-0 w-[64px] h-[44px] rounded-md overflow-hidden border ${\n                      active\n                        ? \"border-white\"\n                        : \"border-white/20 hover:border-white/40\"\n                    }`}\n                    onMouseEnter={() => ensureImagePreview?.(id)}\n                    onClick={() => onSelectIndex?.(i)}\n                    title={it?.fileName || \"Image\"}\n                  >\n                    {thumb ? (\n                      <img\n                        src={thumb}\n                        alt=\"thumbnail\"\n                        className=\"w-full h-full object-cover\"\n                        loading=\"lazy\"\n                      />\n                    ) : (\n                      <div className=\"w-full h-full bg-white/10 flex items-center justify-center\">\n                        <Download className=\"w-4 h-4 text-white/70\" />\n                      </div>\n                    )}\n                  </button>\n                );\n              })}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport function MiddlePanel({\n  selectedConversation,\n  messages,\n  mediaObjectUrlById,\n  pdfPreviewById,\n  mediaViewer,\n  handleMediaViewerPrev,\n  handleMediaViewerNext,\n  handleMediaViewerSelectIndex,\n  messagesEndRef,\n  messagesWithSeparators,\n  messagesHasMore,\n  newMessage,\n  setNewMessage,\n  isSending,\n  isUploadingMedia,\n  handleSendMessage,\n  handleUploadAndSendMedia,\n  handleSendLocation,\n  handleOpenMedia,\n  handleCloseMediaViewer,\n  ensureImagePreview,\n  ensurePdfPreview,\n  handleComposerKeyDown,\n  headerIsAssigned,\n  headerIsAssignedToMe,\n  headerAssignedName,\n  isWithin24h,\n  normalizedStatus,\r\n  statusPillClass,\r\n  agents,\r\n  isAgentsLoading,\r\n  currentUserId,\r\n  isAssigning,\r\n  handleAssignToMe,\r\n  handleAssignToAgent,\r\n  handleUnassign,\r\n  isUpdatingStatus,\r\n  handleUpdateConversationStatus,\r\n  isMessagesLoading,\r\n  isMessagesLoadingOlder,\r\n  onLoadOlderMessages,\r\n  isConversationClosed,\r\n  showRightPanel,\r\n  setShowRightPanel,\r\n  assigneeMenuOpen,\r\n  setAssigneeMenuOpen,\r\n  statusMenuOpen,\r\n  setStatusMenuOpen,\n}) {\n  const messagesScrollRef = React.useRef(null);\n  const composerRef = React.useRef(null);\n  const [openTab, setOpenTab] = React.useState(null);\n  const [emojiOpen, setEmojiOpen] = React.useState(false);\n  const textareaRef = React.useRef(null);\n  const fileInputRef = React.useRef(null);\n\r\n  const { hasAllAccess, role, can } = useAuth() || {};\r\n  const roleLower = String(role || \"\").toLowerCase();\r\n  const isPrivilegedRole =\r\n    [\"admin\", \"superadmin\", \"business\", \"partner\"].includes(roleLower) ||\r\n    Boolean(hasAllAccess);\r\n  const canAssignOthers = Boolean(\r\n    isPrivilegedRole || (typeof can === \"function\" && can(FK.INBOX_CHAT_ASSIGN))\r\n  );\r\n\r\n  // const otherAgents = React.useMemo(() => {\r\n  //   return (agents ?? []).filter(a =>\r\n  //     currentUserId ? String(a.userId) !== String(currentUserId) : true\r\n  //   );\r\n  // }, [agents, currentUserId]);\r\n  const otherAgents = React.useMemo(() => {\r\n    const list = agents ?? [];\r\n\r\n    const isBusinessOwner = a => {\r\n      // Prefer an explicit flag if your API provides it\r\n      const flag =\r\n        a?.isBusinessOwner ??\r\n        a?.IsBusinessOwner ??\r\n        a?.isOwner ??\r\n        a?.IsOwner ??\r\n        false;\r\n\r\n      if (flag) return true;\r\n\r\n      // Fallback to roleName/roleCode (your agents mapper includes roleName)\r\n      const role = String(a?.roleName ?? a?.roleCode ?? a?.role ?? \"\")\r\n        .toLowerCase()\r\n        .trim();\r\n      return (\r\n        role === \"business\" ||\r\n        role === \"businessowner\" ||\r\n        role === \"business owner\" ||\r\n        role === \"owner\"\r\n      );\r\n    };\r\n\r\n    return list\r\n      .filter(a =>\r\n        currentUserId ? String(a.userId) !== String(currentUserId) : true\r\n      )\r\n      .filter(a => !isBusinessOwner(a));\r\n  }, [agents, currentUserId]);\r\n\r\n  const handleLoadOlderMessages = React.useCallback(async () => {\n    const el = messagesScrollRef.current;\r\n    if (!el || typeof onLoadOlderMessages !== \"function\") {\r\n      await onLoadOlderMessages?.();\r\n      return;\r\n    }\r\n\r\n    const prevScrollHeight = el.scrollHeight;\r\n    const prevScrollTop = el.scrollTop;\r\n\r\n    await onLoadOlderMessages();\r\n\r\n    requestAnimationFrame(() => {\r\n      requestAnimationFrame(() => {\r\n        const current = messagesScrollRef.current;\r\n        if (!current) return;\r\n        const newScrollHeight = current.scrollHeight;\r\n        current.scrollTop =\r\n          prevScrollTop + (newScrollHeight - prevScrollHeight);\r\n      });\r\n    });\r\n  }, [onLoadOlderMessages]);\n\n  const isComposerDisabled =\n    !selectedConversation ||\n    isConversationClosed ||\n    !isWithin24h ||\n    isSending ||\n    isUploadingMedia;\n\n  const insertAtCursor = React.useCallback(\n    snippet => {\n      const el = textareaRef.current;\n      if (!el) {\n        setNewMessage(prev => (prev ? `${prev}${snippet}` : snippet));\n        return;\n      }\n      const start = el.selectionStart ?? (newMessage?.length ?? 0);\n      const end = el.selectionEnd ?? (newMessage?.length ?? 0);\n      const base = newMessage ?? \"\";\n      const next = base.slice(0, start) + snippet + base.slice(end);\n      setNewMessage(next);\n      requestAnimationFrame(() => {\n        el.focus();\n        const pos = start + snippet.length;\n        el.setSelectionRange(pos, pos);\n      });\n    },\n    [newMessage, setNewMessage]\n  );\n\n  const handleTextareaKeyDown = e => {\n    if (e.key === \"Escape\" && emojiOpen) {\n      e.preventDefault();\n      e.stopPropagation();\n      setEmojiOpen(false);\n      return;\n    }\n\n    if (\n      !isComposerDisabled &&\n      e.key === \"/\" &&\n      !e.shiftKey &&\n      !e.altKey &&\n      !e.ctrlKey &&\n      !e.metaKey\n    ) {\n      const msg = newMessage ?? \"\";\n      const start = e.currentTarget?.selectionStart ?? msg.length;\n      const end = e.currentTarget?.selectionEnd ?? msg.length;\n      const cursorAtStart = start === 0 && end === 0;\n      const messageEmpty = msg.length === 0;\n\n      if (messageEmpty || cursorAtStart) {\n        e.preventDefault();\n        setEmojiOpen(false);\n        setOpenTab(\"quickReply\");\n        return;\n      }\n    }\n\n    handleComposerKeyDown?.(e);\n  };\n\r\n  return (\n    <div className=\"flex-1 flex flex-col\">\n      <MediaViewerModal\n        viewer={mediaViewer}\n        onClose={handleCloseMediaViewer}\n        onPrev={handleMediaViewerPrev}\n        onNext={handleMediaViewerNext}\n        onSelectIndex={handleMediaViewerSelectIndex}\n        mediaObjectUrlById={mediaObjectUrlById}\n        ensureImagePreview={ensureImagePreview}\n      />\n      <div className=\"h-[64px] border-b border-slate-200 bg-white flex items-center justify-between px-4\">\n        {selectedConversation ? (\n          <>\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700\">\r\n                {getInitial(\r\n                  selectedConversation.contactName,\r\n                  selectedConversation.contactPhone\r\n                )}\r\n              </div>\r\n              <div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"text-sm font-semibold text-slate-800\">\r\n                    {selectedConversation.contactName ||\r\n                      selectedConversation.contactPhone}\r\n                  </span>\r\n                  <span className=\"text-[11px] text-slate-400\">\r\n                    {selectedConversation.contactPhone}\r\n                  </span>\r\n                </div>\r\n                <div className=\"flex items-center gap-3 text-[11px] text-slate-400 mt-0.5\">\r\n                  <span className=\"flex items-center gap-1\">\r\n                    <Clock className=\"w-3 h-3\" />\r\n                    {selectedConversation.lastInboundAt\r\n                      ? formatDateTime(selectedConversation.lastInboundAt)\r\n                      : \"Last inbound: -\"}\r\n                  </span>\r\n                  <span\r\n                    className={`inline-flex items-center gap-1 px-2 py-[1px] rounded-full text-[10px] border ${\r\n                      isWithin24h\r\n                        ? \"bg-emerald-50 text-emerald-700 border-emerald-200\"\r\n                        : \"bg-rose-50 text-rose-700 border-rose-200\"\r\n                    }`}\r\n                  >\r\n                    <Clock className=\"w-3 h-3\" />\r\n                    {isWithin24h ? \"Within 24h\" : \"Outside 24h\"}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2 text-[11px] text-slate-500\">\r\n              <span className=\"flex items-center gap-1\">\r\n                <MessageCircle className=\"w-3 h-3\" />\r\n                {selectedConversation.sourceName || \"WhatsApp\"}\r\n              </span>\r\n              <span className=\"flex items-center gap-1\">\r\n                <Mail className=\"w-3 h-3\" />\r\n                {selectedConversation.mode || \"Live\"}\r\n              </span>\r\n\r\n              <div className=\"relative ml-2\">\r\n                <button\r\n                  type=\"button\"\r\n                  aria-label=\"Assignee\"\r\n                  onClick={() => {\r\n                    setStatusMenuOpen(false);\r\n                    setAssigneeMenuOpen(v => !v);\r\n                  }}\r\n                  disabled={isAssigning}\r\n                  className={`inline-flex items-center gap-1 rounded-full border bg-white px-3 py-[3px] text-[11px] ${\r\n                    isAssigning\r\n                      ? \"border-slate-200 text-slate-400 cursor-wait\"\r\n                      : \"border-slate-200 text-slate-700 hover:bg-slate-50\"\r\n                  }`}\r\n                >\r\n                  <User className=\"w-3 h-3\" />\r\n                  {headerIsAssigned\r\n                    ? headerIsAssignedToMe\r\n                      ? \"You\"\r\n                      : headerAssignedName || \"Agent\"\r\n                    : \"Unassigned\"}\r\n                  <ChevronDown className=\"w-3 h-3\" />\r\n                </button>\r\n\r\n                {assigneeMenuOpen && (\r\n                  <>\r\n                    <button\r\n                      type=\"button\"\r\n                      aria-label=\"Close assignee menu\"\r\n                      className=\"fixed inset-0 z-10 cursor-default\"\r\n                      onClick={() => setAssigneeMenuOpen(false)}\r\n                    />\r\n                    <div className=\"absolute right-0 mt-2 w-64 rounded-xl border border-slate-200 bg-white shadow-lg overflow-hidden z-20\">\r\n                      <div className=\"px-3 py-2 text-[10px] text-slate-500 border-b border-slate-100\">\r\n                        Agent List\r\n                      </div>\r\n\r\n                      <button\r\n                        type=\"button\"\r\n                        className=\"w-full text-left px-3 py-2 text-[11px] text-slate-700 hover:bg-slate-50 disabled:opacity-50\"\r\n                        onClick={() => {\r\n                          setAssigneeMenuOpen(false);\r\n                          handleAssignToMe();\r\n                        }}\r\n                        disabled={!currentUserId || headerIsAssignedToMe}\r\n                      >\r\n                        Assign to me\r\n                      </button>\r\n\r\n                      <div className=\"max-h-56 overflow-y-auto\">\r\n                        {canAssignOthers ? (\r\n                          <>\r\n                            {isAgentsLoading && (\r\n                              <div className=\"px-3 py-2 text-[11px] text-slate-400\">\r\n                                Loading agents...\r\n                              </div>\r\n                            )}\r\n\r\n                            {!isAgentsLoading &&\r\n                              otherAgents.map(a => (\r\n                                <button\r\n                                  key={a.userId}\r\n                                  type=\"button\"\r\n                                  className=\"w-full text-left px-3 py-2 text-[11px] text-slate-700 hover:bg-slate-50\"\r\n                                  onClick={() => {\r\n                                    setAssigneeMenuOpen(false);\r\n                                    handleAssignToAgent(a.userId);\r\n                                  }}\r\n                                >\r\n                                  Assign to {a.name}\r\n                                  {a.roleName ? (\r\n                                    <span className=\"ml-1 text-[10px] text-slate-400\">\r\n                                      ({a.roleName})\r\n                                    </span>\r\n                                  ) : null}\r\n                                </button>\r\n                              ))}\r\n\r\n                            {!isAgentsLoading && otherAgents.length === 0 && (\r\n                              <div className=\"px-3 py-2 text-[11px] text-slate-400\">\r\n                                No other agents found.\r\n                              </div>\r\n                            )}\r\n                          </>\r\n                        ) : (\r\n                          <div className=\"px-3 py-2 text-[11px] text-slate-500\">\r\n                            You can only assign to yourself. Ask an admin to\r\n                            reassign.\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n\r\n                      {headerIsAssigned &&\r\n                        (headerIsAssignedToMe || canAssignOthers) && (\r\n                          <button\r\n                            type=\"button\"\r\n                            className=\"w-full text-left px-3 py-2 text-[11px] text-rose-700 hover:bg-rose-50 border-t border-slate-100 disabled:opacity-50\"\r\n                            onClick={() => {\r\n                              setAssigneeMenuOpen(false);\r\n                              handleUnassign();\r\n                            }}\r\n                            disabled={isAssigning}\r\n                          >\r\n                            Unassign\r\n                          </button>\r\n                        )}\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"relative\">\r\n                <button\r\n                  type=\"button\"\r\n                  aria-label=\"Status\"\r\n                  onClick={() => {\r\n                    if (!headerIsAssignedToMe) return;\r\n                    setAssigneeMenuOpen(false);\r\n                    setStatusMenuOpen(v => !v);\r\n                  }}\r\n                  disabled={!headerIsAssignedToMe || isUpdatingStatus}\r\n                  title={\r\n                    headerIsAssignedToMe\r\n                      ? \"Update status\"\r\n                      : \"Assign to yourself to update status\"\r\n                  }\r\n                  className={`inline-flex items-center gap-1 rounded-full border px-3 py-[3px] text-[11px] ${\r\n                    !headerIsAssignedToMe || isUpdatingStatus\r\n                      ? \"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed\"\r\n                      : `${statusPillClass} hover:opacity-90`\r\n                  }`}\r\n                >\r\n                  <CheckCircle2 className=\"w-3 h-3\" />\r\n                  {normalizedStatus}\r\n                  <ChevronDown className=\"w-3 h-3\" />\r\n                </button>\r\n\r\n                {statusMenuOpen && headerIsAssignedToMe && (\r\n                  <>\r\n                    <button\r\n                      type=\"button\"\r\n                      aria-label=\"Close status menu\"\r\n                      className=\"fixed inset-0 z-10 cursor-default\"\r\n                      onClick={() => setStatusMenuOpen(false)}\r\n                    />\r\n                    <div className=\"absolute right-0 mt-2 w-40 rounded-xl border border-slate-200 bg-white shadow-lg overflow-hidden z-20\">\r\n                      {[\"Open\", \"Pending\", \"Closed\"].map(s => (\r\n                        <button\r\n                          key={s}\r\n                          type=\"button\"\r\n                          className={`w-full text-left px-3 py-2 text-[11px] hover:bg-slate-50 ${\r\n                            s === \"Closed\"\r\n                              ? \"text-rose-700\"\r\n                              : s === \"Pending\"\r\n                              ? \"text-amber-700\"\r\n                              : \"text-emerald-700\"\r\n                          }`}\r\n                          onClick={() => {\r\n                            setStatusMenuOpen(false);\r\n                            handleUpdateConversationStatus(s);\r\n                          }}\r\n                        >\r\n                          {s}\r\n                        </button>\r\n                      ))}\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowRightPanel(v => !v)}\r\n                aria-label={\r\n                  showRightPanel ? \"Hide details panel\" : \"Show details panel\"\r\n                }\r\n                title={showRightPanel ? \"Hide details\" : \"Show details\"}\r\n                className=\"ml-2 inline-flex h-8 w-8 items-center justify-center rounded-full border border-transparent text-emerald-600 hover:bg-slate-50 hover:text-emerald-700\"\r\n              >\r\n                {showRightPanel ? (\r\n                  <ChevronRight className=\"h-4 w-4\" />\r\n                ) : (\r\n                  <ChevronLeft className=\"h-4 w-4\" />\r\n                )}\r\n              </button>\r\n            </div>\r\n          </>\r\n        ) : (\r\n          <div className=\"text-xs text-slate-400\">\r\n            Select a conversation to start chatting.\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div\r\n        ref={messagesScrollRef}\r\n        className=\"flex-1 overflow-y-auto bg-slate-50 px-4 py-3\"\r\n      >\r\n        {!selectedConversation && (\r\n          <div className=\"h-full flex items-center justify-center text-xs text-slate-400\">\r\n            No conversation selected.\r\n          </div>\r\n        )}\r\n\r\n        {selectedConversation && (\r\n          <div className=\"flex flex-col gap-2 text-xs\">\r\n            {messagesHasMore && (\r\n              <div className=\"flex justify-center\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleLoadOlderMessages}\r\n                  disabled={isMessagesLoadingOlder}\r\n                  className={`rounded-full border px-3 py-1 text-[11px] font-medium ${\r\n                    isMessagesLoadingOlder\r\n                      ? \"bg-slate-100 text-slate-400 border-slate-200 cursor-wait\"\r\n                      : \"bg-white text-slate-700 border-slate-200 hover:bg-slate-50\"\r\n                  }`}\r\n                >\r\n                  {isMessagesLoadingOlder\r\n                    ? \"Loading older...\"\r\n                    : \"Load older messages\"}\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            {isMessagesLoading && (\r\n              <div className=\"text-slate-400\">Loading messages...</div>\r\n            )}\r\n\r\n            {!isMessagesLoading && messages.length === 0 && (\r\n              <div className=\"text-slate-400 italic\">\r\n                No messages yet for this contact.\r\n              </div>\r\n            )}\r\n\r\n            {!isMessagesLoading &&\r\n              messagesWithSeparators.length > 0 &&\r\n              messagesWithSeparators.map(item => {\n                if (item.type === \"separator\") {\n                  return (\r\n                    <div key={item.id} className=\"flex justify-center my-2\">\r\n                      <span className=\"px-3 py-0.5 rounded-full bg-slate-100 text-[10px] text-slate-500\">\r\n                        {item.label}\r\n                      </span>\r\n                    </div>\r\n                  );\r\n                }\n\n                const msg = item;\n                const isInbound = !!msg.isInbound;\n                const mediaId = String(msg.mediaId ?? msg.MediaId ?? \"\").trim();\n                const mtOuter = resolveChatMediaType(msg);\n                const hasMedia =\n                  mtOuter === \"location\" ||\n                  (Boolean(mediaId) &&\n                    (mtOuter === \"image\" ||\n                      mtOuter === \"document\" ||\n                      mtOuter === \"video\" ||\n                      mtOuter === \"audio\"));\n                const timeText = formatTimeShort(msg.sentAt);\n                const showStatus = !msg.isInbound;\n                const fileName = msg.fileName ?? msg.FileName ?? \"\";\n                const rawText = String(msg.text || \"\").trim();\n                const showCaption = hasMedia\n                  ? mtOuter === \"location\"\n                    ? false\n                    : rawText &&\n                      !looksLikeAutoGeneratedMediaText({\n                        text: rawText,\n                        mediaType: mtOuter,\n                        fileName,\n                      })\n                  : true;\n                const captionText =\n                  hasMedia && showCaption && rawText ? msg.text : null;\n                const showBottomMeta =\n                  !hasMedia ||\n                  mtOuter === \"document\" ||\n                  mtOuter === \"audio\" ||\n                  mtOuter === \"location\" ||\n                  ((mtOuter === \"image\" || mtOuter === \"video\") &&\n                    Boolean(captionText));\n                const bubblePadding = hasMedia\n                  ? showBottomMeta\n                    ? \"p-2 pb-4\"\n                    : \"p-2\"\n                  : \"px-3 py-2 pb-4\";\n                const contentRightPad = showBottomMeta\n                  ? isInbound\n                    ? \"pr-8\"\n                    : \"pr-12\"\n                  : \"pr-0\";\n                const key = String(\n                  msg.id ??\n                    msg.messageLogId ??\n                    msg.serverId ??\n                    msg.messageId ??\n                    msg.providerMessageId ??\r\n                    msg.clientMessageId ??\r\n                    `${msg.sentAt ?? \"unknown\"}-${\r\n                      isInbound ? \"in\" : \"out\"\r\n                    }-${String(msg.text ?? \"\").slice(0, 32)}`\r\n                );\r\n\r\n                return (\n                  <div\n                    key={key}\n                    className={`flex ${\n                      isInbound ? \"justify-start\" : \"justify-end\"\n                    }`}\n                  >\n                    <div\n                      className={`relative max-w-[70%] ${bubblePadding} shadow-md ${\n                        isInbound\n                          ? \"bg-white text-slate-900 border border-slate-200/70 rounded-xl rounded-tl-sm\"\n                          : \"bg-[#117957] text-white border border-emerald-950/20 rounded-xl rounded-tr-sm\"\n                      }`}\n                    >\n                      <span\r\n                        aria-hidden=\"true\"\r\n                        className={`absolute top-2 w-3 h-3 rotate-45 ${\r\n                          isInbound\r\n                            ? \"left-[-5px] bg-white border-l border-b border-slate-200/70\"\r\n                            : \"right-[-5px] bg-[#117957] border-r border-t border-emerald-950/20\"\r\n                        }`}\r\n                      />\r\n                      <div\n                        className={`whitespace-pre-wrap break-words ${contentRightPad}`}\n                      >\n                        {(() => {\n                          const mt = mtOuter;\n                          const previewUrl = mediaId\n                            ? msg.localPreviewUrl ||\n                              mediaObjectUrlById?.[mediaId] ||\n                              null\n                            : null;\n\n                          if (!hasMedia) return msg.text || \"-\";\n\n                          return (\n                            <div className=\"space-y-1\">\n                              {mt === \"image\" ? (\n                                <ImageMediaTile\n                                  msg={msg}\n                                  isInbound={isInbound}\n                                  previewUrl={previewUrl}\n                                  onOpen={handleOpenMedia}\n                                  ensureImagePreview={ensureImagePreview}\n                                  timeText={showBottomMeta ? null : timeText}\n                                  status={msg.status}\n                                  showStatus={showStatus}\n                                />\n                              ) : mt === \"document\" ? (\n                                <PdfMediaCard\n                                  msg={msg}\n                                  isInbound={isInbound}\n                                  pdfMeta={\n                                    mediaId ? pdfPreviewById?.[mediaId] : null\n                                  }\n                                  onOpen={handleOpenMedia}\n                                  ensurePdfPreview={ensurePdfPreview}\n                                />\n                              ) : mt === \"video\" ? (\n                                <VideoMediaTile\n                                  msg={msg}\n                                  isInbound={isInbound}\n                                  previewUrl={previewUrl}\n                                  onOpen={handleOpenMedia}\n                                  ensureMediaPreview={ensureImagePreview}\n                                  timeText={showBottomMeta ? null : timeText}\n                                  status={msg.status}\n                                  showStatus={showStatus}\n                                />\n                              ) : mt === \"audio\" ? (\n                                <AudioMediaCard\n                                  msg={msg}\n                                  isInbound={isInbound}\n                                  previewUrl={previewUrl}\n                                  ensureMediaPreview={ensureImagePreview}\n                                />\n                              ) : mt === \"location\" ? (\n                                <LocationCard msg={msg} isInbound={isInbound} />\n                              ) : (\n                                msg.text || \"-\"\n                              )}\n                              {captionText && (\n                                <div className=\"text-[13px]\">{captionText}</div>\n                              )}\n                            </div>\n                          );\n                        })()}\n                      </div>\n                      {showBottomMeta && (\n                        <div\n                          className={`absolute bottom-[2px] right-2 text-[10px] leading-none flex items-center gap-0.5 ${\n                            isInbound ? \"text-slate-500\" : \"text-white/70\"\n                          }`}\n                        >\n                          {timeText}\n\n                          {!msg.isInbound && (\n                            <StatusIcon status={msg.status} variant=\"onDark\" />\n                          )}\n                        </div>\n                      )}\n\n                      {msg.errorMessage && (\n                        <div className=\"mt-0.5 text-[10px] text-rose-200\">\n                          {msg.errorMessage}\n                        </div>\n                      )}\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"border-t border-slate-200 bg-white px-4 py-3\">\r\n        {selectedConversation && isConversationClosed && (\r\n          <div className=\"text-[11px] text-rose-600 mb-2\">\r\n            This conversation is <span className=\"font-semibold\">closed</span>.\r\n            Reopen it to send a reply.\r\n          </div>\r\n        )}\r\n\r\n        {selectedConversation && !isConversationClosed && !isWithin24h && (\r\n          <div className=\"text-[11px] text-amber-600 mb-2\">\r\n            This conversation is <span className=\"font-semibold\">outside</span>{\" \"}\r\n            the 24-hour WhatsApp window. Free-form replies are disabled here.\r\n            Use approved templates (campaigns / flows) to re-engage.\r\n          </div>\r\n        )}\r\n\r\n        <div ref={composerRef} className=\"relative space-y-2\">\n          <ComposerTabs\n            openTab={openTab}\n            setOpenTab={setOpenTab}\n            composerRef={composerRef}\n            onQuickReplyInsert={text => {\n              insertAtCursor(text);\n            }}\n          />\n\n          <div className=\"flex items-center gap-2\">\n            <button\n              type=\"button\"\n              onClick={() => {\n                setEmojiOpen(false);\n                setOpenTab(prev => (prev === \"quickReply\" ? null : \"quickReply\"));\n              }}\n              disabled={isComposerDisabled}\n              className={`h-9 inline-flex items-center gap-1.5 rounded-lg border px-3 text-[12px] font-medium ${\n                isComposerDisabled\n                  ? \"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed\"\n                  : \"bg-white text-slate-700 border-slate-200 hover:bg-slate-50\"\n              }`}\n              title=\"Quick replies\"\n            >\n              <Zap className=\"w-4 h-4\" />\n              Quick reply\n            </button>\n\n            <div className=\"relative\">\n              <button\n                type=\"button\"\n                className={`h-9 w-9 inline-flex items-center justify-center rounded-lg border ${\n                  isComposerDisabled\n                    ? \"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed\"\n                    : \"bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:text-slate-800\"\n                }`}\n                title=\"Emoji\"\n                disabled={isComposerDisabled}\n                aria-expanded={emojiOpen}\n                onClick={() => {\n                  setOpenTab(null);\n                  setEmojiOpen(v => !v);\n                }}\n              >\n                <Smile className=\"w-4 h-4\" />\n              </button>\n\n              {emojiOpen && !isComposerDisabled && (\n                <div className=\"absolute left-0 bottom-full mb-2 z-50\">\n                  <EmojiPicker\n                    onPick={emoji => {\n                      insertAtCursor(emoji);\n                      setEmojiOpen(false);\n                    }}\n                    onClose={() => setEmojiOpen(false)}\n                  />\n                </div>\n              )}\n            </div>\n\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\"image/*,application/pdf,video/mp4,video/3gpp,audio/mpeg,audio/mp4,audio/aac,audio/ogg\"\n              className=\"hidden\"\n              onChange={e => {\n                const f = e.target.files?.[0] || null;\n                e.target.value = \"\";\n                if (!f) return;\n                handleUploadAndSendMedia?.(f);\n              }}\n            />\n\n            <button\n              type=\"button\"\n              className={`h-9 w-9 inline-flex items-center justify-center rounded-lg border ${\n                isComposerDisabled\n                  ? \"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed\"\n                  : \"bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:text-slate-800\"\n              }`}\n              title={isComposerDisabled ? \"Attach\" : \"Attach (image/PDF/video/audio)\"}\n              disabled={isComposerDisabled}\n              onClick={() => fileInputRef.current?.click()}\n            >\n              <Paperclip className=\"w-4 h-4\" />\n            </button>\n\n            <button\n              type=\"button\"\n              className={`h-9 w-9 inline-flex items-center justify-center rounded-lg border ${\n                isComposerDisabled\n                  ? \"bg-slate-50 text-slate-400 border-slate-200 cursor-not-allowed\"\n                  : \"bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:text-slate-800\"\n              }`}\n              title={isComposerDisabled ? \"Location\" : \"Send current location\"}\n              disabled={isComposerDisabled}\n              onClick={() => handleSendLocation?.()}\n            >\n              <MapPin className=\"w-4 h-4\" />\n            </button>\n\n            <textarea\n              ref={textareaRef}\n              rows={1}\n              value={newMessage}\n              onChange={e => setNewMessage(e.target.value)}\n              onKeyDown={handleTextareaKeyDown}\n              placeholder={\n                selectedConversation\n                  ? isConversationClosed\n                    ? \"Conversation is closed.\"\n                    : isWithin24h\n                    ? \"Type a reply.\"\n                    : \"24h window expired - send via template campaign.\"\n                  : \"Select a conversation first.\"\n              }\n              disabled={\n                !selectedConversation ||\n                isConversationClosed ||\n                !isWithin24h ||\n                isSending ||\n                isUploadingMedia\n              }\n              className={`flex-1 resize-none border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 ${\n                !selectedConversation || isConversationClosed || !isWithin24h\n                  ? \"bg-slate-50 text-slate-400 cursor-not-allowed\"\n                  : \"bg-white\"\n              }`}\n            />\n            <button\n              type=\"button\"\n              onClick={() => handleSendMessage?.()}\n              disabled={\n                isSending ||\n                isUploadingMedia ||\n                !newMessage.trim() ||\n                !selectedConversation ||\n                isConversationClosed ||\n                !isWithin24h\n              }\n              className={`bg-emerald-600 text-white text-sm font-medium px-4 py-2 rounded-lg shadow-sm ${\n                isSending ||\n                isUploadingMedia ||\n                !newMessage.trim() ||\n                !selectedConversation ||\n                isConversationClosed ||\n                !isWithin24h\n                  ? \"opacity-60 cursor-not-allowed\"\n                  : \"hover:bg-emerald-700\"\n              }`}\n            >\n              {isUploadingMedia ? \"Uploading...\" : isSending ? \"Sending...\" : \"Send\"}\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","import React from \"react\";\r\nimport {\r\n  User,\r\n  ExternalLink,\r\n  ChevronDown,\r\n  ChevronRight,\r\n  Tag,\r\n  Bell,\r\n  Activity,\r\n  StickyNote,\r\n  Pencil,\r\n  Trash2,\r\n  X,\r\n  ChevronLeft,\r\n} from \"lucide-react\";\r\nimport { formatDateTime } from \"../utils/formatters\";\r\n\r\nexport function RightPanel({\r\n  selectedConversation,\r\n  selectedContactId,\r\n  contactSummary,\r\n  isSummaryLoading,\r\n  showRightPanel,\r\n  setShowDetails,\r\n  showCrmPanel,\r\n  showDetails,\r\n  tagsList,\r\n  recentNotes,\r\n  recentTimeline,\r\n  nextReminder,\r\n  handleOpenFullCrm,\r\n  handleRemoveTag,\r\n  removingTagId,\r\n  setIsTagModalOpen,\r\n  normalizedStatus,\r\n  openDeleteConfirm,\r\n  handleAddReminder,\r\n  handleUpdateReminder,\r\n  isSavingReminder,\r\n  isUpdatingReminder,\r\n  reminderTitle,\r\n  setReminderTitle,\r\n  reminderDueAt,\r\n  setReminderDueAt,\r\n  reminderDescription,\r\n  setReminderDescription,\r\n  editingReminderId,\r\n  setEditingReminderId,\r\n  editReminderTitle,\r\n  setEditReminderTitle,\r\n  editReminderDueAt,\r\n  setEditReminderDueAt,\r\n  editReminderDescription,\r\n  setEditReminderDescription,\r\n  handleAddNote,\r\n  handleUpdateNote,\r\n  isSavingNote,\r\n  isUpdatingNote,\r\n  noteDraft,\r\n  setNoteDraft,\r\n  editingNoteId,\r\n  setEditingNoteId,\r\n  editNoteContent,\r\n  setEditNoteContent,\r\n}) {\r\n  const [showQuickReminderForm, setShowQuickReminderForm] =\r\n    React.useState(false);\r\n  const [showQuickNoteForm, setShowQuickNoteForm] = React.useState(false);\r\n  const [activityExpanded, setActivityExpanded] = React.useState(false);\r\n\r\n  if (!showRightPanel) return null;\r\n\r\n  return (\r\n    <div\r\n      className={`border-l border-slate-200 bg-white flex flex-col transition-all duration-300 ease-in-out ${\r\n        showDetails ? \"w-80\" : \"w-12\"\r\n      }`}\r\n    >\r\n      {!showDetails ? (\r\n        <div className=\"flex flex-col items-center py-4 gap-4\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setShowDetails(true)}\r\n            className=\"p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-700\"\r\n            title=\"Show Contact & CRM\"\r\n          >\r\n            <ChevronLeft className=\"w-5 h-5\" />\r\n          </button>\r\n          <div className=\"flex-1 w-full flex justify-center overflow-hidden\">\r\n            <div \r\n              style={{ writingMode: 'vertical-rl' }}\r\n              className=\"rotate-180 text-xs font-semibold text-slate-400 whitespace-nowrap tracking-wider uppercase select-none flex items-center gap-2\"\r\n            >\r\n              Contact & CRM\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <>\r\n          <div className=\"h-[64px] border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <User className=\"w-4 h-4 text-slate-500\" />\r\n              <span className=\"text-xs font-semibold text-slate-800\">\r\n                Contact & CRM\r\n              </span>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowDetails(v => !v)}\r\n                className=\"text-[11px] text-slate-500 hover:text-slate-700 flex items-center gap-1\"\r\n              >\r\n                Hide\r\n                <ChevronRight className=\"w-3 h-3\" />\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"p-4 text-xs text-slate-600 overflow-y-auto flex flex-col gap-3 flex-1\">\r\n            {selectedConversation ? (\r\n              <>\r\n                <div>\r\n                  <div className=\"font-semibold text-slate-800 mb-0.5\">\r\n                    {selectedConversation.contactName ||\r\n                      selectedConversation.contactPhone ||\r\n                      \"Unknown contact\"}\r\n                  </div>\r\n                  <div className=\"text-slate-500\">\r\n                    {selectedConversation.contactPhone}\r\n                  </div>\r\n                  {contactSummary?.leadSource && (\r\n                    <div className=\"text-[11px] text-slate-400 mt-0.5\">\r\n                      Lead source:{\" \"}\r\n                      <span className=\"text-slate-600\">\r\n                        {contactSummary.leadSource}\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-2 text-[11px]\">\r\n                  <div className=\"bg-slate-50 rounded-md p-2\">\r\n                    <div className=\"text-slate-400\">First seen</div>\r\n                    <div className=\"font-medium\">\r\n                      {formatDateTime(selectedConversation.firstSeenAt)}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"bg-slate-50 rounded-md p-2\">\r\n                    <div className=\"text-slate-400\">Last inbound</div>\r\n                    <div className=\"font-medium\">\r\n                      {formatDateTime(selectedConversation.lastInboundAt)}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"bg-slate-50 rounded-md p-2\">\r\n                    <div className=\"text-slate-400\">Last outbound</div>\r\n                    <div className=\"font-medium\">\r\n                      {formatDateTime(selectedConversation.lastOutboundAt)}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"bg-slate-50 rounded-md p-2\">\r\n                    <div className=\"text-slate-400\">Status</div>\r\n                    <div className=\"font-medium\">{normalizedStatus}</div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"h-px bg-slate-200 my-2\" />\r\n\r\n                {isSummaryLoading && (\r\n                  <div className=\"text-[11px] text-slate-400\">\r\n                    Loading CRM data...\r\n                  </div>\r\n                )}\r\n\r\n                {!isSummaryLoading && !contactSummary && (\r\n                  <div className=\"text-[11px] text-slate-400 italic\">\r\n                    No CRM data yet. Add a note or reminder from the CRM workspace\r\n                    to enrich this contact.\r\n                  </div>\r\n                )}\r\n\r\n                {!isSummaryLoading && contactSummary && (\r\n                  <>\r\n                    <div className=\"order-1\">\r\n                      <div className=\"flex items-center justify-between mb-1\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Tag className=\"w-3 h-3 text-slate-400\" />\r\n                          <span className=\"font-semibold text-[11px] text-slate-700\">\r\n                            Tags\r\n                          </span>\r\n                        </div>\r\n\r\n                        {selectedContactId && (\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => setIsTagModalOpen(true)}\r\n                            className=\"text-[11px] font-medium text-emerald-600 hover:text-emerald-700\"\r\n                          >\r\n                            + Tag\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n\r\n                      <div className=\"flex flex-wrap gap-1\">\r\n                        {tagsList.length > 0 ? (\r\n                          tagsList.map((tag, index) => {\r\n                            const tid = tag?.id || tag?.tagId || `idx-${index}`;\r\n                            const label = tag?.tagName || tag?.name || \"Tag\";\r\n                            const bg = tag?.colorHex || \"#EEF2FF\";\r\n                            const isRemoving =\r\n                              removingTagId === (tag?.id || tag?.tagId);\r\n\r\n                            return (\r\n                              <span\r\n                                key={tid}\r\n                                className=\"inline-flex items-center gap-1 px-2 py-0.5 text-[10px] rounded-full font-medium border border-slate-200\"\r\n                                style={{ backgroundColor: bg }}\r\n                              >\r\n                                <span>{label}</span>\r\n\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => handleRemoveTag(tag)}\r\n                                  disabled={!!removingTagId}\r\n                                  className={`ml-0.5 inline-flex items-center justify-center rounded-full border border-slate-200 bg-white/70 p-[2px] ${\r\n                                    removingTagId\r\n                                      ? \"opacity-50 cursor-not-allowed\"\r\n                                      : \"hover:bg-white\"\r\n                                  }`}\r\n                                  title=\"Remove tag\"\r\n                                >\r\n                                  <X className=\"h-3 w-3 text-slate-600\" />\r\n                                </button>\r\n\r\n                                {isRemoving && (\r\n                                  <span className=\"ml-1 text-[9px] text-slate-500\">\r\n                                    removing...\r\n                                  </span>\r\n                                )}\r\n                              </span>\r\n                            );\r\n                          })\r\n                        ) : (\r\n                          <span className=\"text-[11px] text-slate-400\">\r\n                            No tags yet. Use{\" \"}\r\n                            <span className=\"font-semibold\">+ Tag</span> or full\r\n                            CRM to add tags.\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"order-3 pt-3 border-t border-slate-200/70\">\r\n                      <div className=\"flex items-center justify-between mb-1\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Bell className=\"w-3 h-3 text-slate-400\" />\r\n                          <span className=\"font-semibold text-[11px] text-slate-700\">\r\n                            Next reminder\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {nextReminder ? (\r\n                        <div className=\"group relative bg-amber-50 border border-amber-100 rounded-md p-2\">\r\n                          <div className=\"absolute right-2 top-2 flex gap-1 opacity-0 group-hover:opacity-100 transition\">\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => {\r\n                                setEditingReminderId(nextReminder.id);\r\n                                setEditReminderTitle(nextReminder.title || \"\");\r\n                                const due = nextReminder.dueAt\r\n                                  ? new Date(nextReminder.dueAt)\r\n                                  : null;\r\n                                const dueLocal = due\r\n                                  ? `${due.getFullYear()}-${String(\r\n                                      due.getMonth() + 1\r\n                                    ).padStart(2, \"0\")}-${String(\r\n                                      due.getDate()\r\n                                    ).padStart(2, \"0\")}T${String(\r\n                                      due.getHours()\r\n                                    ).padStart(2, \"0\")}:${String(\r\n                                      due.getMinutes()\r\n                                    ).padStart(2, \"0\")}`\r\n                                  : \"\";\r\n                                setEditReminderDueAt(dueLocal);\r\n                                setEditReminderDescription(\r\n                                  nextReminder.description || \"\"\r\n                                );\r\n                              }}\r\n                              className=\"rounded-md border border-amber-200 bg-white/70 p-1 text-amber-700 hover:bg-white\"\r\n                              title=\"Edit reminder\"\r\n                            >\r\n                              <Pencil className=\"h-3.5 w-3.5\" />\r\n                            </button>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() =>\r\n                                openDeleteConfirm(\"reminder\", nextReminder)\r\n                              }\r\n                              className=\"rounded-md border border-amber-200 bg-white/70 p-1 text-rose-600 hover:bg-white\"\r\n                              title=\"Delete reminder\"\r\n                            >\r\n                              <Trash2 className=\"h-3.5 w-3.5\" />\r\n                            </button>\r\n                          </div>\r\n\r\n                          {editingReminderId === nextReminder.id ? (\r\n                            <div className=\"space-y-2\">\r\n                              <input\r\n                                type=\"text\"\r\n                                value={editReminderTitle}\r\n                                onChange={e =>\r\n                                  setEditReminderTitle(e.target.value)\r\n                                }\r\n                                className=\"w-full border border-amber-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500\"\r\n                              />\r\n                              <input\r\n                                type=\"datetime-local\"\r\n                                value={editReminderDueAt}\r\n                                onChange={e =>\r\n                                  setEditReminderDueAt(e.target.value)\r\n                                }\r\n                                className=\"w-full border border-amber-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500\"\r\n                              />\r\n                              <textarea\r\n                                rows={2}\r\n                                value={editReminderDescription}\r\n                                onChange={e =>\r\n                                  setEditReminderDescription(e.target.value)\r\n                                }\r\n                                className=\"w-full border border-amber-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500\"\r\n                              />\r\n                              <div className=\"flex justify-end gap-2\">\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => {\r\n                                    setEditingReminderId(null);\r\n                                    setEditReminderTitle(\"\");\r\n                                    setEditReminderDueAt(\"\");\r\n                                    setEditReminderDescription(\"\");\r\n                                  }}\r\n                                  disabled={isUpdatingReminder}\r\n                                  className=\"rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\r\n                                >\r\n                                  Cancel\r\n                                </button>\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() =>\r\n                                    handleUpdateReminder(nextReminder)\r\n                                  }\r\n                                  disabled={isUpdatingReminder}\r\n                                  className=\"rounded-md bg-emerald-600 px-2 py-1 text-[11px] font-semibold text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                                >\r\n                                  {isUpdatingReminder ? \"Saving...\" : \"Save\"}\r\n                                </button>\r\n                              </div>\r\n                            </div>\r\n                          ) : (\r\n                            <>\r\n                              <div className=\"flex items-center justify-between\">\r\n                                <span className=\"text-[11px] font-semibold text-amber-800\">\r\n                                  {nextReminder.title}\r\n                                </span>\r\n                                <span className=\"text-[10px] text-amber-700\">\r\n                                  {formatDateTime(nextReminder.dueAt)}\r\n                                </span>\r\n                              </div>\r\n                              {nextReminder.description && (\r\n                                <div className=\"mt-0.5 text-[11px] text-amber-900\">\r\n                                  {nextReminder.description}\r\n                                </div>\r\n                              )}\r\n                              {nextReminder.status && (\r\n                                <div className=\"mt-0.5 text-[10px] text-amber-700\">\r\n                                  Status: {nextReminder.status}\r\n                                </div>\r\n                              )}\r\n                            </>\r\n                          )}\r\n                        </div>\r\n                      ) : (\r\n                        <span className=\"text-[11px] text-slate-400\">\r\n                          No upcoming reminder for this contact.\r\n                        </span>\r\n                      )}\r\n\r\n                      {selectedContactId && (\r\n                        <div className=\"mt-2\">\r\n                          {!showQuickReminderForm ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => setShowQuickReminderForm(true)}\r\n                              className=\"inline-flex items-center gap-1 rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50\"\r\n                            >\r\n                              + Add reminder\r\n                            </button>\r\n                          ) : (\r\n                            <>\r\n                              <div className=\"flex items-center justify-between mb-1\">\r\n                                <div className=\"text-[11px] text-slate-500\">\r\n                                  Quick reminder\r\n                                </div>\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => {\r\n                                    setShowQuickReminderForm(false);\r\n                                    setReminderTitle(\"\");\r\n                                    setReminderDueAt(\"\");\r\n                                    setReminderDescription(\"\");\r\n                                  }}\r\n                                  disabled={isSavingReminder}\r\n                                  className=\"text-[11px] text-slate-500 hover:text-slate-700 disabled:opacity-60\"\r\n                                >\r\n                                  Cancel\r\n                                </button>\r\n                              </div>\r\n                              <input\r\n                                type=\"text\"\r\n                                value={reminderTitle}\r\n                                onChange={e => setReminderTitle(e.target.value)}\r\n                                placeholder=\"Reminder title\"\r\n                                className=\"w-full mb-1 border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500\"\r\n                              />\r\n                              <input\r\n                                type=\"datetime-local\"\r\n                                value={reminderDueAt}\r\n                                onChange={e => setReminderDueAt(e.target.value)}\r\n                                className=\"w-full mb-1 border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500\"\r\n                              />\r\n                              <textarea\r\n                                rows={2}\r\n                                value={reminderDescription}\r\n                                onChange={e =>\r\n                                  setReminderDescription(e.target.value)\r\n                                }\r\n                                placeholder=\"Optional description\"\r\n                                className=\"w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500\"\r\n                              />\r\n                              <div className=\"mt-1 flex justify-end\">\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={async () => {\r\n                                    const result = handleAddReminder?.();\r\n                                    if (\r\n                                      result &&\r\n                                      typeof result.then === \"function\"\r\n                                    ) {\r\n                                      try {\r\n                                        await result;\r\n                                        setShowQuickReminderForm(false);\r\n                                      } catch {\r\n                                        // Keep the form open if saving fails.\r\n                                      }\r\n                                      return;\r\n                                    }\r\n                                    setShowQuickReminderForm(false);\r\n                                  }}\r\n                                  disabled={\r\n                                    isSavingReminder ||\r\n                                    !reminderTitle.trim() ||\r\n                                    !reminderDueAt\r\n                                  }\r\n                                  className={`px-2 py-[3px] rounded-md text-[11px] font-medium ${\r\n                                    isSavingReminder ||\r\n                                    !reminderTitle.trim() ||\r\n                                    !reminderDueAt\r\n                                      ? \"bg-slate-200 text-slate-500 cursor-not-allowed\"\r\n                                      : \"bg-amber-600 text-white hover:bg-amber-700\"\r\n                                  }`}\r\n                                >\r\n                                  {isSavingReminder\r\n                                    ? \"Saving...\"\r\n                                    : \"Add reminder\"}\r\n                                </button>\r\n                              </div>\r\n                            </>\r\n                          )}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n\r\n                    <div className=\"order-2 pt-3 border-t border-slate-200/70\">\r\n                      <div className=\"flex items-center justify-between mb-1\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <StickyNote className=\"w-3 h-3 text-slate-400\" />\r\n                          <span className=\"font-semibold text-[11px] text-slate-700\">\r\n                            Recent notes\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {recentNotes.length > 0 ? (\r\n                        <div className=\"space-y-1.5\">\r\n                          {recentNotes.map(note => (\r\n                            <div\r\n                              key={note.id}\r\n                              className=\"group relative bg-slate-50 border border-slate-100 rounded-md p-2\"\r\n                            >\r\n                              <div className=\"absolute right-2 top-2 flex gap-1 opacity-0 group-hover:opacity-100 transition\">\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => {\r\n                                    setEditingNoteId(note.id);\r\n                                    setEditNoteContent(\r\n                                      note.content || note.text || \"\"\r\n                                    );\r\n                                  }}\r\n                                  className=\"rounded-md border border-slate-200 bg-white/70 p-1 text-slate-600 hover:bg-white\"\r\n                                  title=\"Edit note\"\r\n                                >\r\n                                  <Pencil className=\"h-3.5 w-3.5\" />\r\n                                </button>\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => openDeleteConfirm(\"note\", note)}\r\n                                  className=\"rounded-md border border-slate-200 bg-white/70 p-1 text-rose-600 hover:bg-white\"\r\n                                  title=\"Delete note\"\r\n                                >\r\n                                  <Trash2 className=\"h-3.5 w-3.5\" />\r\n                                </button>\r\n                              </div>\r\n\r\n                              {editingNoteId === note.id ? (\r\n                                <div className=\"space-y-2\">\r\n                                  <textarea\r\n                                    rows={3}\r\n                                    value={editNoteContent}\r\n                                    onChange={e =>\r\n                                      setEditNoteContent(e.target.value)\r\n                                    }\r\n                                    className=\"w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500\"\r\n                                  />\r\n                                  <div className=\"flex justify-end gap-2\">\r\n                                    <button\r\n                                      type=\"button\"\r\n                                      onClick={() => {\r\n                                        setEditingNoteId(null);\r\n                                        setEditNoteContent(\"\");\r\n                                      }}\r\n                                      disabled={isUpdatingNote}\r\n                                      className=\"rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\r\n                                    >\r\n                                      Cancel\r\n                                    </button>\r\n                                    <button\r\n                                      type=\"button\"\r\n                                      onClick={() => handleUpdateNote(note)}\r\n                                      disabled={isUpdatingNote}\r\n                                      className=\"rounded-md bg-emerald-600 px-2 py-1 text-[11px] font-semibold text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                                    >\r\n                                      {isUpdatingNote ? \"Saving...\" : \"Save\"}\r\n                                    </button>\r\n                                  </div>\r\n                                </div>\r\n                              ) : (\r\n                                <>\r\n                                  <div className=\"text-[11px] text-slate-700\">\r\n                                    {note.content || note.text || \"(no content)\"}\r\n                                  </div>\r\n                                  <div className=\"mt-0.5 text-[10px] text-slate-400 flex justify-between\">\r\n                                    <span>\r\n                                      {note.createdByName ||\r\n                                        note.createdBy ||\r\n                                        \"Agent\"}\r\n                                    </span>\r\n                                    <span>\r\n                                      {note.createdAt\r\n                                        ? new Date(\r\n                                            note.createdAt\r\n                                          ).toLocaleString()\r\n                                        : \"\"}\r\n                                    </span>\r\n                                  </div>\r\n                                </>\r\n                              )}\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      ) : (\r\n                        <span className=\"text-[11px] text-slate-400\">\r\n                          No notes yet.\r\n                        </span>\r\n                      )}\r\n\r\n                      {selectedContactId && (\r\n                        <div className=\"mt-2\">\r\n                          {!showQuickNoteForm ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => setShowQuickNoteForm(true)}\r\n                              className=\"inline-flex items-center gap-1 rounded-md border border-slate-200 bg-white px-2 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50\"\r\n                            >\r\n                              + Add note\r\n                            </button>\r\n                          ) : (\r\n                            <>\r\n                              <div className=\"flex items-center justify-between mb-1\">\r\n                                <div className=\"text-[11px] text-slate-500\">\r\n                                  Add a quick note\r\n                                </div>\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() => {\r\n                                    setShowQuickNoteForm(false);\r\n                                    setNoteDraft(\"\");\r\n                                  }}\r\n                                  disabled={isSavingNote}\r\n                                  className=\"text-[11px] text-slate-500 hover:text-slate-700 disabled:opacity-60\"\r\n                                >\r\n                                  Cancel\r\n                                </button>\r\n                              </div>\r\n                              <textarea\r\n                                rows={2}\r\n                                value={noteDraft}\r\n                                onChange={e => setNoteDraft(e.target.value)}\r\n                                placeholder=\"Type an internal note about this contact\"\r\n                                className=\"w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500\"\r\n                              />\r\n                              <div className=\"mt-1 flex justify-end\">\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={async () => {\r\n                                    const result = handleAddNote?.();\r\n                                    if (\r\n                                      result &&\r\n                                      typeof result.then === \"function\"\r\n                                    ) {\r\n                                      try {\r\n                                        await result;\r\n                                        setShowQuickNoteForm(false);\r\n                                      } catch {\r\n                                        // Keep the form open if saving fails.\r\n                                      }\r\n                                      return;\r\n                                    }\r\n                                    setShowQuickNoteForm(false);\r\n                                  }}\r\n                                  disabled={isSavingNote || !noteDraft.trim()}\r\n                                  className={`px-2 py-[3px] rounded-md text-[11px] font-medium ${\r\n                                    isSavingNote || !noteDraft.trim()\r\n                                      ? \"bg-slate-200 text-slate-500 cursor-not-allowed\"\r\n                                      : \"bg-emerald-600 text-white hover:bg-emerald-700\"\r\n                                  }`}\r\n                                >\r\n                                  {isSavingNote ? \"Saving...\" : \"Add note\"}\r\n                                </button>\r\n                              </div>\r\n                            </>\r\n                          )}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n\r\n                    <div className=\"order-4 pt-3 border-t border-slate-200/70\">\r\n                      <div className=\"flex items-center justify-between mb-1\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Activity className=\"w-3 h-3 text-slate-400\" />\r\n                          <span className=\"font-semibold text-[11px] text-slate-700\">\r\n                            Recent activity\r\n                          </span>\r\n                        </div>\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => setActivityExpanded(v => !v)}\r\n                          className=\"inline-flex items-center justify-center rounded-md p-1 text-slate-500 hover:text-slate-700 hover:bg-slate-50\"\r\n                          aria-expanded={activityExpanded}\r\n                          aria-label={\r\n                            activityExpanded\r\n                              ? \"Collapse activity\"\r\n                              : \"Expand activity\"\r\n                          }\r\n                        >\r\n                          {activityExpanded ? (\r\n                            <ChevronDown className=\"w-4 h-4\" />\r\n                          ) : (\r\n                            <ChevronRight className=\"w-4 h-4\" />\r\n                          )}\r\n                        </button>\r\n                      </div>\r\n\r\n                      {activityExpanded ? (\r\n                        recentTimeline.length > 0 ? (\r\n                          <div className=\"space-y-1.5\">\r\n                            {recentTimeline.map(event => (\r\n                              <div\r\n                                key={event.id}\r\n                                className=\"bg-slate-50 border border-slate-100 rounded-md p-2\"\r\n                              >\r\n                                <div className=\"text-[11px] text-slate-700\">\r\n                                  {event.title ||\r\n                                    event.shortDescription ||\r\n                                    event.description ||\r\n                                    \"Activity\"}\r\n                                </div>\r\n                                <div className=\"mt-0.5 text-[10px] text-slate-400 flex justify-between\">\r\n                                  <span>\r\n                                    {event.source ||\r\n                                      event.category ||\r\n                                      event.eventType ||\r\n                                      \"\"}\r\n                                  </span>\r\n                                  <span>\r\n                                    {event.createdAt\r\n                                      ? new Date(\r\n                                          event.createdAt\r\n                                        ).toLocaleString()\r\n                                      : \"\"}\r\n                                  </span>\r\n                                </div>\r\n                              </div>\r\n                            ))}\r\n                          </div>\r\n                        ) : (\r\n                          <span className=\"text-[11px] text-slate-400\">\r\n                            No recent activity logged yet.\r\n                          </span>\r\n                        )\r\n                      ) : null}\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </>\r\n            ) : (\r\n              <div className=\"text-slate-400 italic\">\r\n                Select a conversation to see CRM info.\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {showCrmPanel && (\r\n            <div className=\"border-t border-slate-200 p-3 text-[11px] text-slate-500 shrink-0\">\r\n              This mini-CRM view uses your existing Contacts, Tags, Notes,\r\n              Reminders, and Timeline data. Use{\" \"}\r\n              {selectedContactId ? (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleOpenFullCrm}\r\n                  className=\"inline-flex items-center gap-1 rounded-full border border-emerald-200 bg-emerald-50 px-2 py-[2px] text-[11px] font-medium text-emerald-700 hover:bg-emerald-100 align-middle\"\r\n                >\r\n                  <ExternalLink className=\"w-3 h-3\" />\r\n                  Open full CRM\r\n                </button>\r\n              ) : (\r\n                <span className=\"font-semibold text-slate-700\">\r\n                  Open full CRM\r\n                </span>\r\n              )}{\" \"}\r\n              for a 360 view.\r\n            </div>\r\n          )}\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React from \"react\";\nimport { ConfirmDialog } from \"./modals/ConfirmDialog\";\nimport { InboxAddTagModal } from \"./modals/InboxAddTagModal\";\nimport { LeftPanel } from \"./LeftPanel\";\nimport { MiddlePanel } from \"./MiddlePanel\";\nimport { RightPanel } from \"./RightPanel\";\n\nexport function ChatInboxView(props) {\n  const {\n    activeTab,\n    agents,\n    closeConfirm,\n    confirmBusy,\n    confirmState,\n    contactSummary,\n    currentUserId,\n    editNoteContent,\n    editReminderDescription,\n    editReminderDueAt,\n    editReminderTitle,\n    editingNoteId,\n    editingReminderId,\n    executeDelete,\n    fetchConversationsPage,\n    filteredConversations,\n    handleAddNote,\n    handleAddReminder,\n    handleAssignToMe,\n    handleAssignToAgent,\n    handleComposerKeyDown,\n    handleOpenFullCrm,\n    handleOpenMedia,\n    handleCloseMediaViewer,\n    handleMediaViewerPrev,\n    handleMediaViewerNext,\n    handleMediaViewerSelectIndex,\n    ensureImagePreview,\n    ensurePdfPreview,\n    handleRemoveTag,\n    handleSendMessage,\n    handleUploadAndSendMedia,\n    handleSendLocation,\n    handleUnassign,\n    handleUpdateConversationStatus,\n    handleUpdateNote,\n    handleUpdateReminder,\n    headerAssignedName,\n    headerIsAssigned,\n    headerIsAssignedToMe,\n    isAssigning,\n    isConnected,\n    isLoading,\n    isConversationsLoadingMore,\n    isMessagesLoading,\n    isMessagesLoadingOlder,\n    isSavingNote,\n    isSavingReminder,\n    isSending,\n    isUploadingMedia,\n    isSummaryLoading,\n    isTagModalOpen,\n    isConversationClosed,\n    isUpdatingStatus,\n    isUpdatingNote,\n    isUpdatingReminder,\n    isWithin24h,\n    isAgentsLoading,\n    mediaObjectUrlById,\n    pdfPreviewById,\n    mediaViewer,\n    messages,\n    messagesEndRef,\n    messagesHasMore,\n    fetchMessagesPage,\n    messagesWithSeparators,\n    newMessage,\n    nextReminder,\n    noteDraft,\n    openDeleteConfirm,\n    recentNotes,\n    recentTimeline,\n    refreshContactSummary,\n    reminderDescription,\n    reminderDueAt,\n    reminderTitle,\n    removingTagId,\n    searchTerm,\n    selectedContactId,\n    selectedConversation,\n    selectedConversationId,\n    selectedNumberId,\n    setActiveTab,\n    setEditNoteContent,\n    setEditReminderDescription,\n    setEditReminderDueAt,\n    setEditReminderTitle,\n    setEditingNoteId,\n    setEditingReminderId,\n    setIsTagModalOpen,\n    setNewMessage,\n    setNoteDraft,\n    setReminderDescription,\n    setReminderDueAt,\n    setReminderTitle,\n    setSearchTerm,\n    setSelectedConversationId,\n    setSelectedNumberId,\n    setShowDetails,\n    setShowRightPanel,\n    showCrmPanel,\n    showDetails,\n    showRightPanel,\n    tagsList,\n    conversationsHasMore,\n  } = props;\n\n  const [assigneeMenuOpen, setAssigneeMenuOpen] = React.useState(false);\n  const [statusMenuOpen, setStatusMenuOpen] = React.useState(false);\n\n  React.useEffect(() => {\n    setAssigneeMenuOpen(false);\n    setStatusMenuOpen(false);\n  }, [selectedConversationId]);\n\n  const normalizedStatus = React.useMemo(() => {\n    const raw = String(selectedConversation?.status ?? \"\").trim().toLowerCase();\n    if (raw === \"pending\") return \"Pending\";\n    if (raw === \"closed\") return \"Closed\";\n    return \"Open\";\n  }, [selectedConversation?.status]);\n\n  const statusPillClass =\n    normalizedStatus === \"Closed\"\n      ? \"bg-slate-100 text-slate-700 border-slate-200\"\n      : normalizedStatus === \"Pending\"\n      ? \"bg-amber-50 text-amber-800 border-amber-200\"\n      : \"bg-emerald-50 text-emerald-800 border-emerald-200\";\n\n  return (\n    <div className=\"h-full flex bg-slate-50\">\n      <LeftPanel\n        activeTab={activeTab}\n        setActiveTab={setActiveTab}\n        selectedNumberId={selectedNumberId}\n        setSelectedNumberId={setSelectedNumberId}\n        searchTerm={searchTerm}\n        setSearchTerm={setSearchTerm}\n        filteredConversations={filteredConversations}\n        isLoading={isLoading}\n        conversationsHasMore={conversationsHasMore}\n        isConversationsLoadingMore={isConversationsLoadingMore}\n        onLoadMoreConversations={() => fetchConversationsPage({ append: true })}\n        selectedConversationId={selectedConversationId}\n        setSelectedConversationId={setSelectedConversationId}\n        isConnected={isConnected}\n      />\n\n      <MiddlePanel\n        selectedConversation={selectedConversation}\n        messages={messages}\n        mediaObjectUrlById={mediaObjectUrlById}\n        pdfPreviewById={pdfPreviewById}\n        mediaViewer={mediaViewer}\n        handleMediaViewerPrev={handleMediaViewerPrev}\n        handleMediaViewerNext={handleMediaViewerNext}\n        handleMediaViewerSelectIndex={handleMediaViewerSelectIndex}\n        messagesEndRef={messagesEndRef}\n        messagesWithSeparators={messagesWithSeparators}\n        messagesHasMore={messagesHasMore}\n        newMessage={newMessage}\n        setNewMessage={setNewMessage}\n        isSending={isSending}\n        isUploadingMedia={isUploadingMedia}\n        handleSendMessage={handleSendMessage}\n        handleUploadAndSendMedia={handleUploadAndSendMedia}\n        handleSendLocation={handleSendLocation}\n        handleOpenMedia={handleOpenMedia}\n        handleCloseMediaViewer={handleCloseMediaViewer}\n        ensureImagePreview={ensureImagePreview}\n        ensurePdfPreview={ensurePdfPreview}\n        handleComposerKeyDown={handleComposerKeyDown}\n        headerIsAssigned={headerIsAssigned}\n        headerIsAssignedToMe={headerIsAssignedToMe}\n        headerAssignedName={headerAssignedName}\n        isWithin24h={isWithin24h}\n        normalizedStatus={normalizedStatus}\n        statusPillClass={statusPillClass}\n        agents={agents}\n        isAgentsLoading={isAgentsLoading}\n        currentUserId={currentUserId}\n        isAssigning={isAssigning}\n        handleAssignToMe={handleAssignToMe}\n        handleAssignToAgent={handleAssignToAgent}\n        handleUnassign={handleUnassign}\n        isUpdatingStatus={isUpdatingStatus}\n        handleUpdateConversationStatus={handleUpdateConversationStatus}\n        isMessagesLoading={isMessagesLoading}\n        isMessagesLoadingOlder={isMessagesLoadingOlder}\n        onLoadOlderMessages={() => fetchMessagesPage({ prepend: true })}\n        isConversationClosed={isConversationClosed}\n        showRightPanel={showRightPanel}\n        setShowRightPanel={setShowRightPanel}\n        assigneeMenuOpen={assigneeMenuOpen}\n        setAssigneeMenuOpen={setAssigneeMenuOpen}\n        statusMenuOpen={statusMenuOpen}\n        setStatusMenuOpen={setStatusMenuOpen}\n      />\n\n      <RightPanel\n        selectedConversation={selectedConversation}\n        selectedContactId={selectedContactId}\n        contactSummary={contactSummary}\n        isSummaryLoading={isSummaryLoading}\n        showRightPanel={showRightPanel}\n        setShowDetails={setShowDetails}\n        showCrmPanel={showCrmPanel}\n        showDetails={showDetails}\n        tagsList={tagsList}\n        recentNotes={recentNotes}\n        recentTimeline={recentTimeline}\n        nextReminder={nextReminder}\n        handleOpenFullCrm={handleOpenFullCrm}\n        handleRemoveTag={handleRemoveTag}\n        removingTagId={removingTagId}\n        setIsTagModalOpen={setIsTagModalOpen}\n        normalizedStatus={normalizedStatus}\n        openDeleteConfirm={openDeleteConfirm}\n        handleAddReminder={handleAddReminder}\n        handleUpdateReminder={handleUpdateReminder}\n        isSavingReminder={isSavingReminder}\n        isUpdatingReminder={isUpdatingReminder}\n        reminderTitle={reminderTitle}\n        setReminderTitle={setReminderTitle}\n        reminderDueAt={reminderDueAt}\n        setReminderDueAt={setReminderDueAt}\n        reminderDescription={reminderDescription}\n        setReminderDescription={setReminderDescription}\n        editingReminderId={editingReminderId}\n        setEditingReminderId={setEditingReminderId}\n        editReminderTitle={editReminderTitle}\n        setEditReminderTitle={setEditReminderTitle}\n        editReminderDueAt={editReminderDueAt}\n        setEditReminderDueAt={setEditReminderDueAt}\n        editReminderDescription={editReminderDescription}\n        setEditReminderDescription={setEditReminderDescription}\n        handleAddNote={handleAddNote}\n        handleUpdateNote={handleUpdateNote}\n        isSavingNote={isSavingNote}\n        isUpdatingNote={isUpdatingNote}\n        noteDraft={noteDraft}\n        setNoteDraft={setNoteDraft}\n        editingNoteId={editingNoteId}\n        setEditingNoteId={setEditingNoteId}\n        editNoteContent={editNoteContent}\n        setEditNoteContent={setEditNoteContent}\n      />\n\n      <InboxAddTagModal\n        isOpen={isTagModalOpen}\n        onClose={() => setIsTagModalOpen(false)}\n        contactId={selectedContactId}\n        currentTags={tagsList}\n        onTagAdded={refreshContactSummary}\n      />\n\n      <ConfirmDialog\n        open={confirmState.open}\n        title={confirmState.title}\n        message=\"This action cannot be undone.\"\n        confirmText=\"Delete\"\n        cancelText=\"Cancel\"\n        danger\n        loading={confirmBusy}\n        onCancel={closeConfirm}\n        onConfirm={executeDelete}\n      />\n    </div>\n  );\n}\n","import { useChatInboxController } from \"./hooks/useChatInboxController\";\r\nimport { ChatInboxView } from \"./components/ChatInboxView\";\r\n\r\nexport default function ChatInbox() {\r\n  const vm = useChatInboxController();\r\n  return <ChatInboxView {...vm} />;\r\n}\r\n"],"names":["REALTIME_TOAST_ID","isIgnorableSignalRError","err","name","String","msg","message","toLowerCase","includes","useSignalR","onMessageReceived","onUnreadChanged","arguments","length","undefined","connection","setConnection","useState","isConnected","setIsConnected","connRef","useRef","mountedRef","startingRef","useEffect","current","hubUrl","base","process","trim","replace","concat","getHubUrl","localStorage","getItem","TOKEN_KEY","console","warn","finalUrl","saBizId","encodeURIComponent","conn","signalR","withUrl","accessTokenFactory","transport","WebSockets","LongPolling","withAutomaticReconnect","configureLogging","Information","build","on","onreconnecting","onreconnected","toast","dismiss","onclose","error","toastId","async","start","log","off","_unused","state","Disconnected","stop","catch","Mail","createLucideIcon","width","height","x","y","rx","key","d","inferIsInboundFromAny","obj","_ref","_ref2","_ref3","_ref4","_ref5","_obj$isInbound","_ref6","_ref7","_ref8","_ref9","_ref0","_obj$direction","_ref1","_obj$status","rawInbound","isInbound","IsInbound","isIncoming","IsIncoming","inbound","Inbound","v","directionRaw","direction","Direction","dir","messageDirection","messageDir","DirectionType","statusRaw","status","deliveryStatus","startsWith","toIsoFromDatetimeLocal","datetimeLocal","Date","Number","isNaN","getTime","toISOString","formatDateTime","value","toLocaleString","getInitial","phone","_src$trim$0$toUpperCa","_src$trim$","toUpperCase","formatDayLabel","date","today","todayKey","toDateString","yesterday","setDate","getDate","yesterdayKey","toLocaleDateString","day","month","year","parseConversationStatus","raw","normalizePagedResult","data","_data$items","_data$nextCursor","_data$hasMore","Array","isArray","items","nextCursor","hasMore","Items","NextCursor","HasMore","Boolean","DEFAULT_CONVERSATIONS_PAGE_SIZE","DEFAULT_MESSAGES_PAGE_SIZE","CHAT_INBOX_MEDIA_MAX_BYTES","CHAT_INBOX_ALLOWED_MIME_TYPES","Set","inferChatInboxMediaType","mime","split","toFiniteNumberOrNull","n","isFinite","toLatitudeOrNull","toLongitudeOrNull","buildChatInboxMediaContentUrl","mediaId","CHAT_INBOX_ACTIVE_TAB_KEY","businessId","VALID_CHAT_INBOX_TABS","readStoredActiveTab","tab","has","useChatInboxController","_selectedConversation","_parseConversationSta","_ref90","_ref91","_contactSummary$tags","_contactSummary$recen","_contactSummary$nextR","_contactSummary$recen2","navigate","useNavigate","activeTab","setActiveTab","selectedNumberId","setSelectedNumberId","searchTerm","setSearchTerm","setItem","_unused2","allConversations","setAllConversations","isLoading","setIsLoading","conversationsNextCursor","setConversationsNextCursor","conversationsHasMore","setConversationsHasMore","isConversationsLoadingMore","setIsConversationsLoadingMore","selectedConversationId","setSelectedConversationId","newMessage","setNewMessage","messages","setMessages","isMessagesLoading","setIsMessagesLoading","messagesNextCursor","setMessagesNextCursor","messagesHasMore","setMessagesHasMore","isMessagesLoadingOlder","setIsMessagesLoadingOlder","isSending","setIsSending","isUploadingMedia","setIsUploadingMedia","isAssigning","setIsAssigning","isUpdatingStatus","setIsUpdatingStatus","agents","setAgents","isAgentsLoading","setIsAgentsLoading","contactSummary","setContactSummary","isSummaryLoading","setIsSummaryLoading","noteDraft","setNoteDraft","isSavingNote","setIsSavingNote","reminderTitle","setReminderTitle","reminderDueAt","setReminderDueAt","reminderDescription","setReminderDescription","isSavingReminder","setIsSavingReminder","editingNoteId","setEditingNoteId","editNoteContent","setEditNoteContent","isUpdatingNote","setIsUpdatingNote","editingReminderId","setEditingReminderId","editReminderTitle","setEditReminderTitle","editReminderDueAt","setEditReminderDueAt","editReminderDescription","setEditReminderDescription","isUpdatingReminder","setIsUpdatingReminder","confirmState","setConfirmState","open","type","id","title","confirmBusy","setConfirmBusy","isTagModalOpen","setIsTagModalOpen","removingTagId","setRemovingTagId","showRightPanel","setShowRightPanel","showDetails","setShowDetails","stored","_unused3","_unused4","showCrmPanel","setShowCrmPanel","showMiniTimeline","setShowMiniTimeline","messagesEndRef","lastMessagesMutationRef","clearedUnreadByConversationRef","Map","clearedUnreadByContactRef","messagesRequestAbortRef","messagesRequestIdRef","messagesLoadTimerRef","markReadTimerRef","mediaObjectUrlByIdRef","mediaObjectUrlFetchRef","mediaBlobFetchRef","localObjectUrlByTempIdRef","mediaObjectUrlById","setMediaObjectUrlById","pdfPreviewById","setPdfPreviewById","mediaViewer","setMediaViewer","url","fileName","index","loading","messagesRef","mediaViewerRef","pdfPreviewFetchRef","pdfJsImportRef","pdfJsModuleRef","selectedConversationIdRef","conversationsNextCursorRef","conversationsHasMoreRef","isConversationsLoadingMoreRef","messagesNextCursorRef","messagesHasMoreRef","isMessagesLoadingOlderRef","values","URL","revokeObjectURL","_unused5","_unused6","clear","upsertMediaObjectUrl","useCallback","objectUrl","existing","get","_unused7","set","prev","_objectSpread","fetchMediaBlob","opts","inflight","silent","promise","axiosClient","responseType","__silentToast","then","res","_error$response","_error$response$data","response","finally","delete","fetchMediaObjectUrl","cached","blob","createObjectURL","_error$response2","_error$response2$data","buildImageViewerItems","map","m","_m$mediaType","_m$mediaId","_m$fileName","_m$sentAt","mediaType","MediaType","MediaId","FileName","sentAt","sentAtUtc","createdAt","filter","sort","a","b","parse","seen","i","add","handleOpenMedia","_msg$mediaId","_msg$mediaType","_msg$fileName","mt","localPreviewUrl","_items","_items2","findIndex","push","next","document","createElement","href","target","rel","download","click","handleCloseMediaViewer","handleMediaViewerSelectIndex","_items3","_items4","idx","nextIndex","prevId","nextId","handleMediaViewerPrev","handleMediaViewerNext","ensureImagePreview","ensurePdfPreview","skipRemote","fetch","ok","_unused8","arrayBuffer","pdfjs","_pdfjs","gwo","GlobalWorkerOptions","workerSrc","publicUrl","_unused9","buffer","doc","getDocument","disableWorker","pages","numPages","thumbDataUrl","_canvas$getContext","page","getPage","viewport","getViewport","scale","canvas","ctx","getContext","call","_page$cleanup","Math","max","floor","render","canvasContext","toDataURL","cleanup","_unused0","_doc$destroy","destroy","_unused1","sizeBytes","size","scrollToBottom","scrollIntoView","behavior","block","currentUserId","useMemo","selectedConversation","find","c","selectedConversationRef","conversationsRef","getClearedUnreadEntry","conversation","byConversationId","contactId","getClearedUnreadEntryByContactId","setLocalUnreadOverride","nextUnread","entry","localUnread","updatedAt","now","getLocalUnreadOverride","markConversationUnreadCleared","selectedContactId","isWithin24h","within24h","isConversationClosed","headerIsAssigned","assignedToUserId","headerIsAssignedToMe","isAssignedToMe","headerAssignedName","assignedToUserName","filteredConversations","list","tabKey","numberId","q","_c$contactName","_c$contactPhone","_c$lastMessagePreview","contactName","contactPhone","lastMessagePreview","aUnread","unreadCount","bUnread","aTime","lastMessageAt","fetchConversationsPage","options","reset","append","limit","params","search","paged","cursor","selectedId","mapped","item","_ref10","_parseConversationSta2","isSelected","UnreadCount","numberLabel","sourceType","sourceName","mode","firstSeenAt","lastInboundAt","lastOutboundAt","keyOf","_ref11","_c$id","byKey","orderedKeys","forEach","nc","k","_error$response3","_error$response3$data","fetchConversations","apiItems","_ref12","_parseConversationSta3","prevMap","mergedTop","_nc$unreadCount","_old$unreadCount","old","mergedIds","tail","_error$response4","_error$response4$data","fetchAgents","_ref13","_a$userId","_ref14","_ref15","_ref16","_a$name","_a$email","_ref17","_a$roleName","userId","fullName","displayName","email","roleName","role","fetchMessagesPage","prepend","conv","requestId","abort","controller","AbortController","signal","mappedPage","_ref18","_ref19","_ref20","_m$direction","_m$status","_ref21","_m$providerMessageId","_ref22","_ref23","_m$messageLogId","_ref24","_ref25","_ref26","_ref27","_ref28","_ref29","_m$messageId","_ref30","_m$clientMessageId","_ref31","_m$id","_ref32","_ref33","_ref34","_m$mediaId2","_ref35","_m$mediaType2","_ref36","_m$fileName2","_ref37","_m$mimeType","_ref38","_ref39","_m$locationLatitude","_ref40","_ref41","_m$locationLongitude","_ref42","_ref43","_m$locationName","_ref44","_ref45","_m$locationAddress","providerMessageId","ProviderMessageId","messageLogId","MessageLogId","messageLogID","messageId","MessageId","wamid","Wamid","waMessageId","WaMessageId","clientMessageId","ClientMessageId","serverId","text","body","content","messageText","MessageText","messageContent","MessageContent","renderedBody","RenderedBody","mimeType","MimeType","locationLatitude","LocationLatitude","latitude","locationLongitude","LocationLongitude","longitude","locationName","LocationName","locationAddress","LocationAddress","address","timestamp","errorMessage","reverse","_ref46","_ref47","_ref48","_ref49","_msg$messageLogId","_error$response5","_error$response5$data","code","intervalId","setInterval","clearInterval","clearTimeout","setTimeout","loadMessages","payload","lastReadAtUtc","post","invoke","refreshContactSummary","_res$data$data","_res$data","handleRemoveTag","tagId","tag","tagName","removeFrom","arr","t","tags","contactTags","contactTagsDto","contactIds","request","method","_err$response","success","_error$response6","_error$response6$data","messagesWithSeparators","result","lastDateKey","dateObj","label","handleReceiveInboxMessage","_ref50","_payload$contactId","_ref51","_payload$conversation","ContactId","conversationId","ConversationId","mappedMsg","_msg$providerMessageI","_msg$messageId","_msg$clientMessageId","_msg$id","_msg$text","_msg$mimeType","_msg$locationLatitude","_msg$locationLongitud","_msg$locationName","_msg$locationAddress","_msg$type","_msg$image","_msg$video","_ref52","_msg$audio","_ref53","_msg$document","_ref54","_msg$location","_ref64","_ref65","_msg$direction","_ref66","_ref67","_msg$status","_ref68","_ref69","_ref70","_msg$createdAt","_msg$errorMessage","clientId","Id","random","toString","slice","typeFallback","Type","messageType","MessageType","image","Image","video","Video","audio","Audio","Document","location","Location","nested","_ref55","_nested$id","_ref56","_ref57","_locationLatitude","_ref58","_ref59","_locationLongitude","_ref60","_ref61","_locationName","_ref62","_ref63","_locationAddress","Latitude","Longitude","Name","Address","Status","mapHubMessageToChat","mappedMediaType","mappedHasMedia","mappedLat","mappedLon","mappedHasLocation","openConv","sameMessage","incoming","incMessageId","incClientId","_existing$serverId","_mappedMsg$errorMessa","merged","matched","_c$unreadCount","isOpen","baseUnread","trimmedText","fallbackPreview","handleUnreadCountChanged","refresh","localEntry","mergedUnread","handleMessageStatusChanged","_payload$contactId2","_payload$messageLogId","_payload$providerMess","_payload$messageId","_payload$status","nextStatus","rank","s","matchesByLogId","matchesByProviderId","matchesByMessageId","currentRank","handleSendMessage","_outbound$mediaId","_outbound$mediaType","_outbound$fileName","_outbound$mimeType","_outbound$localPrevie","_outbound$locationLat","_outbound$locationLon","_outbound$locationNam","_outbound$locationAdd","outbound","mediaTypeRaw","caption","Text","trimmedCaption","hasMedia","latNum","lonNum","hasLocation","tempId","nowIso","optimisticMsg","_saved$mediaId","_saved$mediaType","_saved$fileName","_saved$mimeType","_saved$locationLatitu","_ref71","_saved$locationLongit","_ref72","_saved$locationName","_ref73","_saved$locationAddres","to","saved","finalSentAt","finalSentAtIso","serverStatus","normalizeStatus","savedMediaId","savedMediaType","savedFileName","savedMimeType","savedLocationLatitude","savedLocationLongitude","savedLocationName","savedLocationAddress","_saved$id","_ref74","_ref75","_ref76","_saved$messageId","_ref77","_ref78","_ref79","_ref80","_ref81","_ref82","_ref83","_ref84","preview","_error$response7","_error$response7$data","isTemp","closeConfirm","tagsList","recentNotes","nextReminder","recentTimeline","executeDelete","info","_error$response17","_error$response17$dat","handleAddNote","substring","dto","source","createdBy","isPinned","isInternal","_error$response11","_error$response11$dat","_error$response12","_error$response12$dat","handleAddReminder","dueIso","description","dueAt","reminderType","priority","isRecurring","recurrencePattern","sendWhatsappNotification","linkedCampaign","_error$response13","_error$response13$dat","_error$response14","_error$response14$dat","handleAssignToMe","_error$response9","_error$response9$data","handleAssignToAgent","assigneeUserId","_agents$find$name","_agents$find","myUserId","agentName","_error$response0","_error$response0$data","handleComposerKeyDown","event","shiftKey","preventDefault","handleOpenFullCrm","handleUploadAndSendMedia","file","inferredMime","endsWith","keepLocalPreviewUrl","_ref85","_data$mediaId","_ref86","_data$mediaType","_ref87","_ref88","_data$fileName","_ref89","_data$mimeType","_unused10","form","FormData","headers","uploadedMediaId","uploadedMediaType","_error$response8","_error$response8$data","_unused11","handleSendLocation","navigator","geolocation","_pos$coords","_pos$coords2","pos","Promise","resolve","reject","getCurrentPosition","enableHighAccuracy","timeout","maximumAge","lat","coords","lon","handleUnassign","_error$response1","_error$response1$data","handleUpdateConversationStatus","normalized","newStatus","e","_e$response","_error$response10","_error$response10$dat","handleUpdateNote","_note$isInternal","note","put","_error$response15","_error$response15$dat","handleUpdateReminder","_reminder$priority","reminder","_error$response16","_error$response16$dat","openDeleteConfirm","ConfirmDialog","confirmText","cancelText","danger","onConfirm","onCancel","_jsx","className","children","_jsxs","onClick","X","disabled","InboxAddTagModal","onClose","currentTags","onTagAdded","availableTags","setAvailableTags","React","selectedTagId","setSelectedTagId","loadingTags","setLoadingTags","saving","setSaving","_response$data","allTags","existingIds","filtered","fetchTags","onSubmit","onChange","getComplianceBadges","_conv$optStatus","_conv$contact","_conv$channelStatus","_conv$contact2","optStatus","contact","channelStatus","badges","ConversationRow","badge","toLocaleTimeString","hour","minute","MOCK_NUMBERS","TABS","LeftPanel","onLoadMoreConversations","Phone","Activity","ChevronDown","Search","placeholder","Filter","StatusIcon","variant","palette","failed","read","delivered","sent","inFlight","AlertCircle","CheckCheck","Clock","CircleHelp","cx","cy","r","QuickReplyPicker","onInsert","scope","searchRef","listRef","rowRefs","setQ","setItems","setLoading","activeIndex","setActiveIndex","viewScope","setViewScope","viewScopeParam","creating","setCreating","setTitle","setBody","tagsCsv","setTagsCsv","createScope","setCreateScope","saveMsg","setSaveMsg","deletingId","setDeletingId","searchOpen","setSearchOpen","fetchList","ignore","_searchRef$current","focus","requestAnimationFrame","_listRef$current","el","handleInsert","_res$data2","checked","_Fragment","isActive","Plus","ref","onKeyDown","stopPropagation","min","_items$activeIndex","tabIndex","_items$activeIndex2","isDeleting","onMouseEnter","window","confirm","_res$data3","_res$data4","handleDelete","Trash2","Icon","Zap","StickyNote","LayoutTemplate","PLACEHOLDERS","quickReply","notes","template","ComposerTabs","openTab","setOpenTab","composerRef","onQuickReplyInsert","active","notesTab","leftTabs","close","onMouseDown","Node","root","contains","addEventListener","capture","removeEventListener","EMOJIS","char","EmojiPicker","onPick","onDocClick","autoFocus","formatBytes","bytes","units","fixed","toFixed","resolveChatMediaType","explicit","formatTimeShort","looksLikeAutoGeneratedMediaText","norm","TimeStatusOverlay","timeText","showStatus","PdfMediaCard","pdfMeta","onOpen","sizeLabel","metaLine","join","src","alt","Download","ImageMediaTile","previewUrl","VideoMediaTile","ensureMediaPreview","muted","playsInline","preload","Play","AudioMediaCard","controls","LocationCard","hasCoords","mapsUrl","MapPin","MediaViewerModal","viewer","onPrev","onNext","onSelectIndex","canPrev","canNext","_document","_document$body","_document$body$style","_document2","_document2$body","style","overflow","_document3","_document3$body","ChevronLeft","ChevronRight","autoPlay","it","thumb","MiddlePanel","normalizedStatus","statusPillClass","onLoadOlderMessages","assigneeMenuOpen","setAssigneeMenuOpen","statusMenuOpen","setStatusMenuOpen","messagesScrollRef","emojiOpen","setEmojiOpen","textareaRef","fileInputRef","hasAllAccess","can","useAuth","roleLower","isPrivilegedRole","canAssignOthers","FK","INBOX_CHAT_ASSIGN","otherAgents","_a$isBusinessOwner","isBusinessOwner","IsBusinessOwner","isOwner","IsOwner","roleCode","handleLoadOlderMessages","prevScrollHeight","scrollHeight","prevScrollTop","scrollTop","newScrollHeight","isComposerDisabled","insertAtCursor","snippet","_el$selectionStart","_newMessage$length","_el$selectionEnd","_newMessage$length2","selectionStart","end","selectionEnd","setSelectionRange","MessageCircle","User","CheckCircle2","_msg$fileName2","_msg$sentAt","mtOuter","rawText","showCaption","captionText","showBottomMeta","bubblePadding","contentRightPad","Smile","emoji","accept","_e$target$files","f","files","_fileInputRef$current","Paperclip","rows","altKey","ctrlKey","metaKey","_e$currentTarget$sele","_e$currentTarget","_e$currentTarget$sele2","_e$currentTarget2","currentTarget","cursorAtStart","RightPanel","showQuickReminderForm","setShowQuickReminderForm","showQuickNoteForm","setShowQuickNoteForm","activityExpanded","setActivityExpanded","leadSource","Tag","tid","bg","colorHex","isRemoving","backgroundColor","Bell","due","dueLocal","getFullYear","getMonth","padStart","getHours","getMinutes","Pencil","createdByName","shortDescription","category","eventType","ExternalLink","writingMode","ChatInboxView","props","ChatInbox","vm"],"sourceRoot":""}